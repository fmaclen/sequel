<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>module Sequel::Plugins::NestedAttributes - Sequel: The Database Toolkit for Ruby</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "../../";
  var index_rel_prefix = "../../";
</script>

<script src="../../js/navigation.js" defer></script>
<script src="../../js/search.js" defer></script>
<script src="../../js/search_index.js" defer></script>
<script src="../../js/searcher.js" defer></script>
<script src="../../js/darkfish.js" defer></script>

<link href="../../css/fonts.css" rel="stylesheet">
<link href="../../css/rdoc.css" rel="stylesheet">




<body id="top" role="document" class="module">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../../table_of_contents.html#pages">Pages</a>
    <a href="../../table_of_contents.html#classes">Classes</a>
    <a href="../../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="class-metadata">
    
    
    
    
    <!-- Method Quickref -->
<div id="method-list-section" class="nav-section">
  <h3>Methods</h3>

  <ul class="link-list" role="directory">
    
    <li ><a href="#method-c-apply">::apply</a>
    
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-labelledby="module-Sequel::Plugins::NestedAttributes">
  <h1 id="module-Sequel::Plugins::NestedAttributes" class="module">
    module Sequel::Plugins::NestedAttributes
  </h1>

  <section class="description">
    
<p>The nested_attributes plugin allows you to create, update, and delete associated objects directly by calling a method on the current object. Nested attributes are defined using the nested_attributes class method:</p>

<pre class="ruby"><span class="ruby-constant">Artist</span>.<span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:albums</span>
<span class="ruby-constant">Artist</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:nested_attributes</span>
<span class="ruby-constant">Artist</span>.<span class="ruby-identifier">nested_attributes</span> <span class="ruby-value">:albums</span>
</pre>

<p>The nested_attributes call defines a single method, <code><em>association</em>_attributes=</code>, (e.g. <code>albums_attributes=</code>).  So if you have an Artist instance:</p>

<pre class="ruby"><span class="ruby-identifier">a</span> = <span class="ruby-constant">Artist</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">name:</span> <span class="ruby-string">&#39;YJM&#39;</span>)
</pre>

<p>You can create new album instances related to this artist:</p>

<pre class="ruby"><span class="ruby-identifier">a</span>.<span class="ruby-identifier">albums_attributes</span> = [{<span class="ruby-value">name:</span> <span class="ruby-string">&#39;RF&#39;</span>}, {<span class="ruby-value">name:</span> <span class="ruby-string">&#39;MO&#39;</span>}]
</pre>

<p>Note that this doesn&#39;t send any queries to the database yet.  That doesn&#39;t happen till you save the object:</p>

<pre class="ruby"><span class="ruby-identifier">a</span>.<span class="ruby-identifier">save</span>
</pre>

<p>That will save the artist first, and then save both albums.  If either the artist is invalid or one of the albums is invalid, none of the objects will be saved to the database, and all related validation errors will be available in the artist&#39;s validation errors.</p>

<p>In addition to creating new associated objects, you can also update existing associated objects.  You just need to make sure that the primary key field is filled in for the associated object:</p>

<pre class="ruby"><span class="ruby-identifier">a</span>.<span class="ruby-identifier">update</span>(<span class="ruby-value">:albums_attributes</span> <span class="ruby-operator">=&gt;</span> [{<span class="ruby-value">id:</span> <span class="ruby-value">1</span>, <span class="ruby-value">name:</span> <span class="ruby-string">&#39;T&#39;</span>}])
</pre>

<p>Since the primary key field is filled in, the plugin will update the album with id 1 instead of creating a new album.</p>

<p>If you would like to delete the associated object instead of updating it, you add a _delete entry to the hash, and also pass the :destroy option when calling <code>nested_attributes</code>:</p>

<pre class="ruby"><span class="ruby-constant">Artist</span>.<span class="ruby-identifier">nested_attributes</span> <span class="ruby-value">:albums</span>, <span class="ruby-value">destroy:</span> <span class="ruby-keyword">true</span>
<span class="ruby-identifier">a</span>.<span class="ruby-identifier">update</span>(<span class="ruby-value">:albums_attributes</span> <span class="ruby-operator">=&gt;</span> [{<span class="ruby-value">id:</span> <span class="ruby-value">1</span>, <span class="ruby-value">_delete:</span> <span class="ruby-keyword">true</span>}])
</pre>

<p>This will delete the related associated object from the database.  If you want to leave the associated object in the database, but just remove it from the association, add a _remove entry in the hash, and also pass the :remove option when calling <code>nested_attributes</code>:</p>

<pre class="ruby"><span class="ruby-constant">Artist</span>.<span class="ruby-identifier">nested_attributes</span> <span class="ruby-value">:albums</span>, <span class="ruby-value">remove:</span> <span class="ruby-keyword">true</span>
<span class="ruby-identifier">a</span>.<span class="ruby-identifier">update</span>(<span class="ruby-value">:albums_attributes</span> <span class="ruby-operator">=&gt;</span> [{<span class="ruby-value">id:</span> <span class="ruby-value">1</span>, <span class="ruby-value">_remove:</span> <span class="ruby-keyword">true</span>}])
</pre>

<p>The above example was for a one_to_many association, but the plugin also works similarly for other association types.  For one_to_one and many_to_one associations, you need to pass a single hash instead of an array of hashes.</p>

<p>This plugin is mainly designed to make it easy to use on html forms, where a single form submission can contained nested attributes (and even nested attributes of those attributes). You just need to name your form inputs correctly:</p>

<pre class="ruby"><span class="ruby-identifier">artist</span>[<span class="ruby-identifier">name</span>]
<span class="ruby-identifier">artist</span>[<span class="ruby-identifier">albums_attributes</span>][<span class="ruby-value">0</span>][<span class="ruby-value">:name</span>]
<span class="ruby-identifier">artist</span>[<span class="ruby-identifier">albums_attributes</span>][<span class="ruby-value">1</span>][<span class="ruby-value">:id</span>]
<span class="ruby-identifier">artist</span>[<span class="ruby-identifier">albums_attributes</span>][<span class="ruby-value">1</span>][<span class="ruby-value">:name</span>]
</pre>

<p>Your web stack will probably parse that into a nested hash similar to:</p>

<pre class="ruby">{<span class="ruby-string">&#39;artist&#39;</span><span class="ruby-operator">=&gt;</span>{<span class="ruby-string">&#39;name&#39;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&#39;Y&#39;</span>, <span class="ruby-string">&#39;albums_attributes&#39;</span><span class="ruby-operator">=&gt;</span>{<span class="ruby-string">&#39;0&#39;</span><span class="ruby-operator">=&gt;</span>{<span class="ruby-string">&#39;name&#39;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&#39;X&#39;</span>}, <span class="ruby-string">&#39;1&#39;</span><span class="ruby-operator">=&gt;</span>{<span class="ruby-string">&#39;id&#39;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&#39;2&#39;</span>, <span class="ruby-string">&#39;name&#39;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&#39;Z&#39;</span>}}}}
</pre>

<p>Then you can do:</p>

<pre class="ruby"><span class="ruby-identifier">artist</span>.<span class="ruby-identifier">update_fields</span>(<span class="ruby-identifier">params</span>[<span class="ruby-string">&#39;artist&#39;</span>], <span class="ruby-node">%w&#39;name albums_attributes&#39;</span>)
</pre>

<p>Note that Rails 5+ does not use a <a href="../../Hash.html"><code>Hash</code></a> for submitted parameters, and therefore the above will not work.  With Rails 5+, you have to use:</p>

<pre class="ruby"><span class="ruby-identifier">artist</span>.<span class="ruby-identifier">update_fields</span>(<span class="ruby-identifier">params</span>.<span class="ruby-identifier">to_unsafe_h</span>[<span class="ruby-string">&#39;artist&#39;</span>], <span class="ruby-node">%w&#39;name albums_attributes&#39;</span>)
</pre>

<p>To save changes to the artist, create the first album and associate it to the artist, and update the other existing associated album.</p>

<p>You can pass options for individual nested attributes, which will override the default nested attributes options for that association.  This is useful for per-call filtering of the allowed fields:</p>

<pre class="ruby"><span class="ruby-identifier">a</span>.<span class="ruby-identifier">set_nested_attributes</span>(<span class="ruby-value">:albums</span>, <span class="ruby-identifier">params</span>[<span class="ruby-string">&#39;artist&#39;</span>], <span class="ruby-value">:fields</span><span class="ruby-operator">=&gt;</span><span class="ruby-node">%w&#39;name&#39;</span>)
</pre>

  </section>

  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    

    

    
     <section id="public-class-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Class Methods</h3>
       </header>

    
      <div id="method-c-apply" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">apply</span><span
            class="method-args">(model)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Depend on the validate_associated plugin.</p>
          
          

          
          <div class="method-source-code" id="apply-source">
            <pre>   <span class="ruby-comment"># File lib/sequel/plugins/nested_attributes.rb</span>
<span class="line-num">90</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">apply</span>(<span class="ruby-identifier">model</span>)
<span class="line-num">91</span>   <span class="ruby-identifier">model</span>.<span class="ruby-identifier">plugin</span>(<span class="ruby-value">:validate_associated</span>)
<span class="line-num">92</span> <span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
  </section>

</main>


<footer id="validator-badges" role="contentinfo">
  <p><a href="https://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="https://ruby.github.io/rdoc/">RDoc</a> 6.1.2.1.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

