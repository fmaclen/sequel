<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>module Sequel::Plugins::Finder::ClassMethods - Sequel: The Database Toolkit for Ruby</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "../../../";
  var index_rel_prefix = "../../../";
</script>

<script src="../../../js/navigation.js" defer></script>
<script src="../../../js/search.js" defer></script>
<script src="../../../js/search_index.js" defer></script>
<script src="../../../js/searcher.js" defer></script>
<script src="../../../js/darkfish.js" defer></script>

<link href="../../../css/fonts.css" rel="stylesheet">
<link href="../../../css/rdoc.css" rel="stylesheet">




<body id="top" role="document" class="module">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../../../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../../../table_of_contents.html#pages">Pages</a>
    <a href="../../../table_of_contents.html#classes">Classes</a>
    <a href="../../../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="class-metadata">
    
    
    
    
    <!-- Method Quickref -->
<div id="method-list-section" class="nav-section">
  <h3>Methods</h3>

  <ul class="link-list" role="directory">
    
    <li ><a href="#method-i-finder">#finder</a>
    
    <li class="calls-super" ><a href="#method-i-freeze">#freeze</a>
    
    <li ><a href="#method-i-prepared_finder">#prepared_finder</a>
    
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-labelledby="module-Sequel::Plugins::Finder::ClassMethods">
  <h1 id="module-Sequel::Plugins::Finder::ClassMethods" class="module">
    module Sequel::Plugins::Finder::ClassMethods
  </h1>

  <section class="description">
    
  </section>

  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    

    

    
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Instance Methods</h3>
       </header>

    
      <div id="method-i-finder" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">finder</span><span
            class="method-args">(meth=OPTS, opts=OPTS, &amp;block)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Create an optimized finder method using a dataset placeholder literalizer. This pre-computes the <a href="../../SQL.html"><code>SQL</code></a> to use for the query, except for given arguments.</p>

<p>There are two ways to use this.  The recommended way is to pass a symbol that represents a model class method that returns a dataset:</p>

<pre class="ruby"><span class="ruby-keyword">def</span> <span class="ruby-constant">Artist</span>.<span class="ruby-identifier ruby-title">by_name</span>(<span class="ruby-identifier">name</span>)
  <span class="ruby-identifier">where</span>(<span class="ruby-value">name:</span> <span class="ruby-identifier">name</span>)
<span class="ruby-keyword">end</span>

<span class="ruby-constant">Artist</span>.<span class="ruby-identifier">finder</span> <span class="ruby-value">:by_name</span>
</pre>

<p>This creates an optimized first_by_name method, which you can call normally:</p>

<pre class="ruby"><span class="ruby-constant">Artist</span>.<span class="ruby-identifier">first_by_name</span>(<span class="ruby-string">&quot;Joe&quot;</span>)
</pre>

<p>The alternative way to use this to pass your own block:</p>

<pre class="ruby"><span class="ruby-constant">Artist</span>.<span class="ruby-identifier">finder</span>(<span class="ruby-value">name:</span> <span class="ruby-value">:first_by_name</span>){<span class="ruby-operator">|</span><span class="ruby-identifier">pl</span>, <span class="ruby-identifier">ds</span><span class="ruby-operator">|</span> <span class="ruby-identifier">ds</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">name:</span> <span class="ruby-identifier">pl</span>.<span class="ruby-identifier">arg</span>).<span class="ruby-identifier">limit</span>(<span class="ruby-value">1</span>)}
</pre>

<p>Note that if you pass your own block, you are responsible for manually setting limits if necessary (as shown above).</p>

<p>Options:</p>
<dl class="rdoc-list note-list"><dt>:arity 
<dd>
<p>When using a symbol method name, this specifies the arity of the method. This should be used if if the method accepts an arbitrary number of arguments, or the method has default argument values.  Note that if the method is defined as a dataset method, the class method <a href="../../../Sequel.html"><code>Sequel</code></a> creates accepts an arbitrary number of arguments, so you should use this option in that case.  If you want to handle multiple possible arities, you need to call the finder method multiple times with unique :arity and :name methods each time.</p>
</dd><dt>:name 
<dd>
<p>The name of the method to create.  This must be given if you pass a block. If you use a symbol, this defaults to the symbol prefixed by the type.</p>
</dd><dt>:mod 
<dd>
<p>The module in which to create the finder method.  Defaults to the singleton class of the model.</p>
</dd><dt>:type 
<dd>
<p>The type of query to run.  Can be :first, :each, :all, or :get, defaults to :first.</p>
</dd></dl>

<p>Caveats:</p>

<p>This doesn&#39;t handle all possible cases.  For example, if you have a method such as:</p>

<pre class="ruby"><span class="ruby-keyword">def</span> <span class="ruby-constant">Artist</span>.<span class="ruby-identifier ruby-title">by_name</span>(<span class="ruby-identifier">name</span>)
  <span class="ruby-identifier">name</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">where</span>(<span class="ruby-value">name:</span> <span class="ruby-identifier">name</span>) <span class="ruby-operator">:</span> <span class="ruby-identifier">exclude</span>(<span class="ruby-value">name:</span> <span class="ruby-keyword">nil</span>)
<span class="ruby-keyword">end</span>
</pre>

<p>Then calling a finder without an argument will not work as you expect.</p>

<pre class="ruby"><span class="ruby-constant">Artist</span>.<span class="ruby-identifier">finder</span> <span class="ruby-value">:by_name</span>
<span class="ruby-constant">Artist</span>.<span class="ruby-identifier">by_name</span>(<span class="ruby-keyword">nil</span>).<span class="ruby-identifier">first</span>
<span class="ruby-comment"># WHERE (name IS NOT NULL)</span>
<span class="ruby-constant">Artist</span>.<span class="ruby-identifier">first_by_name</span>(<span class="ruby-keyword">nil</span>)
<span class="ruby-comment"># WHERE (name IS NULL)</span>
</pre>

<p>See Dataset::PlaceholderLiteralizer for additional caveats.</p>
          
          

          
          <div class="method-source-code" id="finder-source">
            <pre>    <span class="ruby-comment"># File lib/sequel/plugins/finder.rb</span>
<span class="line-num">101</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">finder</span>(<span class="ruby-identifier">meth</span>=<span class="ruby-constant">OPTS</span>, <span class="ruby-identifier">opts</span>=<span class="ruby-constant">OPTS</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
<span class="line-num">102</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">block</span>
<span class="line-num">103</span>     <span class="ruby-identifier">raise</span> <span class="ruby-constant">Error</span>, <span class="ruby-string">&quot;cannot pass both a method name argument and a block of Model.finder&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">meth</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Hash</span>)
<span class="line-num">104</span>     <span class="ruby-identifier">raise</span> <span class="ruby-constant">Error</span>, <span class="ruby-string">&quot;cannot pass two option hashes to Model.finder&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">opts</span>.<span class="ruby-identifier">equal?</span>(<span class="ruby-constant">OPTS</span>)
<span class="line-num">105</span>     <span class="ruby-identifier">opts</span> = <span class="ruby-identifier">meth</span>
<span class="line-num">106</span>     <span class="ruby-identifier">raise</span> <span class="ruby-constant">Error</span>, <span class="ruby-string">&quot;must provide method name via :name option when passing block to Model.finder&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">meth_name</span> = <span class="ruby-identifier">opts</span>[<span class="ruby-value">:name</span>]
<span class="line-num">107</span>   <span class="ruby-keyword">end</span>
<span class="line-num">108</span> 
<span class="line-num">109</span>   <span class="ruby-identifier">type</span> = <span class="ruby-identifier">opts</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-value">:type</span>, <span class="ruby-value">:first</span>)
<span class="line-num">110</span>   <span class="ruby-keyword">unless</span> <span class="ruby-identifier">prepare</span> = <span class="ruby-identifier">opts</span>[<span class="ruby-value">:prepare</span>]
<span class="line-num">111</span>     <span class="ruby-identifier">raise</span> <span class="ruby-constant">Error</span>, <span class="ruby-string">&quot;:type option to Model.finder must be :first, :all, :each, or :get&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-constant">FINDER_TYPES</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">type</span>)
<span class="line-num">112</span>   <span class="ruby-keyword">end</span>
<span class="line-num">113</span>   <span class="ruby-identifier">limit1</span> = <span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:first</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:get</span>
<span class="line-num">114</span>   <span class="ruby-identifier">meth_name</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">opts</span>[<span class="ruby-value">:name</span>] <span class="ruby-operator">||</span> <span class="ruby-value">:&quot;#{type}_#{meth}&quot;</span>
<span class="line-num">115</span> 
<span class="line-num">116</span>   <span class="ruby-identifier">argn</span> = <span class="ruby-identifier">lambda</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">model</span><span class="ruby-operator">|</span>
<span class="line-num">117</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">arity</span> = <span class="ruby-identifier">opts</span>[<span class="ruby-value">:arity</span>]
<span class="line-num">118</span>       <span class="ruby-identifier">arity</span>
<span class="line-num">119</span>     <span class="ruby-keyword">else</span>
<span class="line-num">120</span>       <span class="ruby-identifier">method</span> = <span class="ruby-identifier">block</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">model</span>.<span class="ruby-identifier">method</span>(<span class="ruby-identifier">meth</span>)
<span class="line-num">121</span>       (<span class="ruby-identifier">method</span>.<span class="ruby-identifier">arity</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">0</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">method</span>.<span class="ruby-identifier">arity</span>.<span class="ruby-identifier">abs</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">method</span>.<span class="ruby-identifier">arity</span>)
<span class="line-num">122</span>     <span class="ruby-keyword">end</span>
<span class="line-num">123</span>   <span class="ruby-keyword">end</span>
<span class="line-num">124</span> 
<span class="line-num">125</span>   <span class="ruby-identifier">loader_proc</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">prepare</span>
<span class="line-num">126</span>     <span class="ruby-identifier">proc</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">model</span><span class="ruby-operator">|</span>
<span class="line-num">127</span>       <span class="ruby-identifier">args</span> = <span class="ruby-identifier">prepare_method_args</span>(<span class="ruby-string">&#39;$a&#39;</span>, <span class="ruby-identifier">argn</span>.<span class="ruby-identifier">call</span>(<span class="ruby-identifier">model</span>))
<span class="line-num">128</span>       <span class="ruby-identifier">ds</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">block</span>
<span class="line-num">129</span>         <span class="ruby-identifier">model</span>.<span class="ruby-identifier">instance_exec</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
<span class="line-num">130</span>       <span class="ruby-keyword">else</span>
<span class="line-num">131</span>         <span class="ruby-identifier">model</span>.<span class="ruby-identifier">public_send</span>(<span class="ruby-identifier">meth</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">args</span>)
<span class="line-num">132</span>       <span class="ruby-keyword">end</span>
<span class="line-num">133</span>       <span class="ruby-identifier">ds</span> = <span class="ruby-identifier">ds</span>.<span class="ruby-identifier">limit</span>(<span class="ruby-value">1</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">limit1</span>
<span class="line-num">134</span>       <span class="ruby-identifier">model_name</span> = <span class="ruby-identifier">model</span>.<span class="ruby-identifier">name</span>
<span class="line-num">135</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">model_name</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">empty?</span>
<span class="line-num">136</span>         <span class="ruby-identifier">model_name</span> = <span class="ruby-identifier">model</span>.<span class="ruby-identifier">object_id</span>
<span class="line-num">137</span>       <span class="ruby-keyword">else</span>
<span class="line-num">138</span>         <span class="ruby-identifier">model_name</span> = <span class="ruby-identifier">model_name</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">/\W/</span>, <span class="ruby-string">&#39;_&#39;</span>)
<span class="line-num">139</span>       <span class="ruby-keyword">end</span>
<span class="line-num">140</span>       <span class="ruby-identifier">ds</span>.<span class="ruby-identifier">prepare</span>(<span class="ruby-identifier">type</span>, <span class="ruby-value">:&quot;#{model_name}_#{meth_name}&quot;</span>)
<span class="line-num">141</span>     <span class="ruby-keyword">end</span>
<span class="line-num">142</span>   <span class="ruby-keyword">else</span>
<span class="line-num">143</span>     <span class="ruby-identifier">proc</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">model</span><span class="ruby-operator">|</span>
<span class="line-num">144</span>       <span class="ruby-identifier">n</span> = <span class="ruby-identifier">argn</span>.<span class="ruby-identifier">call</span>(<span class="ruby-identifier">model</span>)
<span class="line-num">145</span>       <span class="ruby-identifier">block</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">lambda</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">pl</span>, <span class="ruby-identifier">model2</span><span class="ruby-operator">|</span>
<span class="line-num">146</span>         <span class="ruby-identifier">args</span> = (<span class="ruby-value">0</span><span class="ruby-operator">...</span><span class="ruby-identifier">n</span>).<span class="ruby-identifier">map</span>{<span class="ruby-identifier">pl</span>.<span class="ruby-identifier">arg</span>}
<span class="line-num">147</span>         <span class="ruby-identifier">ds</span> = <span class="ruby-identifier">model2</span>.<span class="ruby-identifier">public_send</span>(<span class="ruby-identifier">meth</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">args</span>)
<span class="line-num">148</span>         <span class="ruby-identifier">ds</span> = <span class="ruby-identifier">ds</span>.<span class="ruby-identifier">limit</span>(<span class="ruby-value">1</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">limit1</span>
<span class="line-num">149</span>         <span class="ruby-identifier">ds</span>
<span class="line-num">150</span>       <span class="ruby-keyword">end</span>
<span class="line-num">151</span> 
<span class="line-num">152</span>       <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Dataset</span><span class="ruby-operator">::</span><span class="ruby-constant">PlaceholderLiteralizer</span>.<span class="ruby-identifier">loader</span>(<span class="ruby-identifier">model</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>) 
<span class="line-num">153</span>     <span class="ruby-keyword">end</span>
<span class="line-num">154</span>   <span class="ruby-keyword">end</span>
<span class="line-num">155</span> 
<span class="line-num">156</span>   <span class="ruby-ivar">@finder_loaders</span>[<span class="ruby-identifier">meth_name</span>] = <span class="ruby-identifier">loader_proc</span>
<span class="line-num">157</span>   <span class="ruby-identifier">mod</span> = <span class="ruby-identifier">opts</span>[<span class="ruby-value">:mod</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">singleton_class</span>
<span class="line-num">158</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">prepare</span>
<span class="line-num">159</span>     <span class="ruby-identifier">def_prepare_method</span>(<span class="ruby-identifier">mod</span>, <span class="ruby-identifier">meth_name</span>)
<span class="line-num">160</span>   <span class="ruby-keyword">else</span>
<span class="line-num">161</span>     <span class="ruby-identifier">def_finder_method</span>(<span class="ruby-identifier">mod</span>, <span class="ruby-identifier">meth_name</span>, <span class="ruby-identifier">type</span>)
<span class="line-num">162</span>   <span class="ruby-keyword">end</span>
<span class="line-num">163</span> <span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-freeze" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">freeze</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          
            <div class="method-calls-super">
              Calls superclass method
              
            </div>
          

          
          <div class="method-source-code" id="freeze-source">
            <pre>    <span class="ruby-comment"># File lib/sequel/plugins/finder.rb</span>
<span class="line-num">165</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">freeze</span>
<span class="line-num">166</span>   <span class="ruby-ivar">@finder_loaders</span>.<span class="ruby-identifier">freeze</span>
<span class="line-num">167</span>   <span class="ruby-ivar">@finder_loaders</span>.<span class="ruby-identifier">each_key</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">k</span><span class="ruby-operator">|</span> <span class="ruby-identifier">finder_for</span>(<span class="ruby-identifier">k</span>)} <span class="ruby-keyword">if</span> <span class="ruby-ivar">@dataset</span>
<span class="line-num">168</span>   <span class="ruby-ivar">@finders</span>.<span class="ruby-identifier">freeze</span>
<span class="line-num">169</span>   <span class="ruby-keyword">super</span>
<span class="line-num">170</span> <span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-prepared_finder" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">prepared_finder</span><span
            class="method-args">(meth=OPTS, opts=OPTS, &amp;block)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Similar to finder, but uses a prepared statement instead of a placeholder literalizer. This makes the <a href="../../SQL.html"><code>SQL</code></a> used static (cannot vary per call), but allows binding argument values instead of literalizing them into the <a href="../../SQL.html"><code>SQL</code></a> query string.</p>

<p>If a block is used with this method, it is instance_execed by the model, and should accept the desired number of placeholder arguments.</p>

<p>The options are the same as the options for finder, with the following exception:</p>
<dl class="rdoc-list note-list"><dt>:type 
<dd>
<p>Specifies the type of prepared statement to create</p>
</dd></dl>
          
          

          
          <div class="method-source-code" id="prepared_finder-source">
            <pre>    <span class="ruby-comment"># File lib/sequel/plugins/finder.rb</span>
<span class="line-num">183</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">prepared_finder</span>(<span class="ruby-identifier">meth</span>=<span class="ruby-constant">OPTS</span>, <span class="ruby-identifier">opts</span>=<span class="ruby-constant">OPTS</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
<span class="line-num">184</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">block</span>
<span class="line-num">185</span>     <span class="ruby-identifier">raise</span> <span class="ruby-constant">Error</span>, <span class="ruby-string">&quot;cannot pass both a method name argument and a block of Model.finder&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">meth</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Hash</span>)
<span class="line-num">186</span>     <span class="ruby-identifier">meth</span> = <span class="ruby-identifier">meth</span>.<span class="ruby-identifier">merge</span>(<span class="ruby-value">:prepare</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">true</span>)
<span class="line-num">187</span>   <span class="ruby-keyword">else</span>
<span class="line-num">188</span>     <span class="ruby-identifier">opts</span> = <span class="ruby-identifier">opts</span>.<span class="ruby-identifier">merge</span>(<span class="ruby-value">:prepare</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">true</span>)
<span class="line-num">189</span>   <span class="ruby-keyword">end</span>
<span class="line-num">190</span>   <span class="ruby-identifier">finder</span>(<span class="ruby-identifier">meth</span>, <span class="ruby-identifier">opts</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
<span class="line-num">191</span> <span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
  </section>

</main>


<footer id="validator-badges" role="contentinfo">
  <p><a href="https://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="https://ruby.github.io/rdoc/">RDoc</a> 6.1.2.1.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

