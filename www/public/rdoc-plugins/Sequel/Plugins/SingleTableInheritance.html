<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>module Sequel::Plugins::SingleTableInheritance - Sequel: The Database Toolkit for Ruby</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "../../";
  var index_rel_prefix = "../../";
</script>

<script src="../../js/navigation.js" defer></script>
<script src="../../js/search.js" defer></script>
<script src="../../js/search_index.js" defer></script>
<script src="../../js/searcher.js" defer></script>
<script src="../../js/darkfish.js" defer></script>

<link href="../../css/fonts.css" rel="stylesheet">
<link href="../../css/rdoc.css" rel="stylesheet">




<body id="top" role="document" class="module">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../../table_of_contents.html#pages">Pages</a>
    <a href="../../table_of_contents.html#classes">Classes</a>
    <a href="../../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="class-metadata">
    
    
    
    
    <!-- Method Quickref -->
<div id="method-list-section" class="nav-section">
  <h3>Methods</h3>

  <ul class="link-list" role="directory">
    
    <li ><a href="#method-c-configure">::configure</a>
    
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-labelledby="module-Sequel::Plugins::SingleTableInheritance">
  <h1 id="module-Sequel::Plugins::SingleTableInheritance" class="module">
    module Sequel::Plugins::SingleTableInheritance
  </h1>

  <section class="description">
    
<p>The single_table_inheritance plugin allows storing all objects in the same class hierarchy in the same table.  It makes it so subclasses of this model only load rows related to the subclass, and when you retrieve rows from the main class, you get instances of the subclasses (if the rows should use the subclasses&#39;s class).</p>

<p>By default, the plugin assumes that the <code>sti_key</code> column (the first argument to the plugin) holds the class name as a string.  However, you can override this by using the <code>:model_map</code> option and/or the <code>:key_map</code> option.</p>

<p>You should only load this plugin in the parent class, not in the subclasses.</p>

<p>You shouldn&#39;t call set_dataset in the model after applying this plugin, otherwise subclasses might use the wrong dataset. You should make sure this plugin is loaded before the subclasses. Note that since you need to load the plugin before the subclasses are created, you can&#39;t use direct class references in the plugin class.  You should specify subclasses in the plugin call using class name strings or symbols, see usage below.</p>

<p>Usage:</p>

<pre class="ruby"><span class="ruby-comment"># Use the default of storing the class name in the sti_key</span>
<span class="ruby-comment"># column (:kind in this case)</span>
<span class="ruby-keyword">class</span> <span class="ruby-constant">Employee</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>
  <span class="ruby-identifier">plugin</span> <span class="ruby-value">:single_table_inheritance</span>, <span class="ruby-value">:kind</span>
<span class="ruby-keyword">end</span>

<span class="ruby-comment"># Have subclasses inherit from the appropriate class</span>
<span class="ruby-keyword">class</span> <span class="ruby-constant">Staff</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Employee</span>; <span class="ruby-keyword">end</span>
<span class="ruby-keyword">class</span> <span class="ruby-constant">Manager</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Employee</span>; <span class="ruby-keyword">end</span>

<span class="ruby-comment"># You can also use many different options to configure the plugin:</span>

<span class="ruby-comment"># Using integers to store the class type, with a :model_map hash</span>
<span class="ruby-comment"># and an sti_key of :type</span>
<span class="ruby-constant">Employee</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:single_table_inheritance</span>, <span class="ruby-value">:type</span>,
  <span class="ruby-value">model_map:</span> {<span class="ruby-value">1</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">:Staff</span>, <span class="ruby-value">2</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">:Manager</span>}

<span class="ruby-comment"># Using non-class name strings</span>
<span class="ruby-constant">Employee</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:single_table_inheritance</span>, <span class="ruby-value">:type</span>,
  <span class="ruby-value">model_map:</span> {<span class="ruby-string">&#39;line staff&#39;</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">:Staff</span>, <span class="ruby-string">&#39;supervisor&#39;</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">:Manager</span>}

<span class="ruby-comment"># By default the plugin sets the respective column value</span>
<span class="ruby-comment"># when a new instance is created.</span>
<span class="ruby-constant">Staff</span>.<span class="ruby-identifier">create</span>.<span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-string">&#39;line staff&#39;</span>
<span class="ruby-constant">Manager</span>.<span class="ruby-identifier">create</span>.<span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-string">&#39;supervisor&#39;</span>

<span class="ruby-comment"># You can customize this behavior with the :key_chooser option.</span>
<span class="ruby-comment"># This is most useful when using a non-bijective mapping.</span>
<span class="ruby-constant">Employee</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:single_table_inheritance</span>, <span class="ruby-value">:type</span>,
  <span class="ruby-value">model_map:</span> {<span class="ruby-string">&#39;line staff&#39;</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">:Staff</span>, <span class="ruby-string">&#39;supervisor&#39;</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">:Manager</span>},
  <span class="ruby-value">key_chooser:</span> <span class="ruby-identifier">lambda</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">instance</span><span class="ruby-operator">|</span> <span class="ruby-identifier">instance</span>.<span class="ruby-identifier">model</span>.<span class="ruby-identifier">sti_key_map</span>[<span class="ruby-identifier">instance</span>.<span class="ruby-identifier">model</span>.<span class="ruby-identifier">to_s</span>].<span class="ruby-identifier">first</span> <span class="ruby-operator">||</span> <span class="ruby-string">&#39;stranger&#39;</span>}

<span class="ruby-comment"># Using custom procs, with :model_map taking column values</span>
<span class="ruby-comment"># and yielding either a class, string, symbol, or nil,</span>
<span class="ruby-comment"># and :key_map taking a class object and returning the column</span>
<span class="ruby-comment"># value to use</span>
<span class="ruby-constant">Employee</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:single_table_inheritance</span>, <span class="ruby-value">:type</span>,
  <span class="ruby-value">model_map:</span> <span class="ruby-value">:reverse</span>.<span class="ruby-identifier">to_proc</span>,
  <span class="ruby-value">key_map:</span> <span class="ruby-identifier">lambda</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">klass</span><span class="ruby-operator">|</span> <span class="ruby-identifier">klass</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">reverse</span>}

<span class="ruby-comment"># You can use the same class for multiple values.</span>
<span class="ruby-comment"># This is mainly useful when the sti_key column contains multiple values</span>
<span class="ruby-comment"># which are different but do not require different code.</span>
<span class="ruby-constant">Employee</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:single_table_inheritance</span>, <span class="ruby-value">:type</span>,
  <span class="ruby-value">model_map:</span> {<span class="ruby-string">&#39;staff&#39;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;Staff&quot;</span>,
               <span class="ruby-string">&#39;manager&#39;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;Manager&quot;</span>,
               <span class="ruby-string">&#39;overpayed staff&#39;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;Staff&quot;</span>,
               <span class="ruby-string">&#39;underpayed staff&#39;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;Staff&quot;</span>}
</pre>

<p>One minor issue to note is that if you specify the <code>:key_map</code> option as a hash, instead of having it inferred from the <code>:model_map</code>, you should only use class name strings as keys, you should not use symbols as keys.</p>

  </section>

  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    

    

    
     <section id="public-class-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Class Methods</h3>
       </header>

    
      <div id="method-c-configure" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">configure</span><span
            class="method-args">(model, key, opts=OPTS)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Setup the necessary STI variables, see the module RDoc for <a href="SingleTableInheritance.html"><code>SingleTableInheritance</code></a></p>
          
          

          
          <div class="method-source-code" id="configure-source">
            <pre>    <span class="ruby-comment"># File lib/sequel/plugins/single_table_inheritance.rb</span>
<span class="line-num"> 82</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">configure</span>(<span class="ruby-identifier">model</span>, <span class="ruby-identifier">key</span>, <span class="ruby-identifier">opts</span>=<span class="ruby-constant">OPTS</span>)
<span class="line-num"> 83</span>   <span class="ruby-identifier">model</span>.<span class="ruby-identifier">instance_exec</span> <span class="ruby-keyword">do</span>
<span class="line-num"> 84</span>     <span class="ruby-ivar">@sti_key_array</span> = <span class="ruby-keyword">nil</span>
<span class="line-num"> 85</span>     <span class="ruby-ivar">@sti_key</span> = <span class="ruby-identifier">key</span> 
<span class="line-num"> 86</span>     <span class="ruby-ivar">@sti_dataset</span> = <span class="ruby-identifier">dataset</span>
<span class="line-num"> 87</span>     <span class="ruby-ivar">@sti_model_map</span> = <span class="ruby-identifier">opts</span>[<span class="ruby-value">:model_map</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">lambda</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span> <span class="ruby-identifier">v</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">v</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">v</span> <span class="ruby-operator">!=</span> <span class="ruby-string">&#39;&#39;</span>}
<span class="line-num"> 88</span>     <span class="ruby-ivar">@sti_key_map</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">km</span> = <span class="ruby-identifier">opts</span>[<span class="ruby-value">:key_map</span>]
<span class="line-num"> 89</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">km</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Hash</span>)
<span class="line-num"> 90</span>         <span class="ruby-identifier">h</span> = <span class="ruby-constant">Hash</span>.<span class="ruby-identifier">new</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">h1</span>,<span class="ruby-identifier">k</span><span class="ruby-operator">|</span> 
<span class="line-num"> 91</span>           <span class="ruby-keyword">unless</span> <span class="ruby-identifier">k</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">String</span>)
<span class="line-num"> 92</span>             <span class="ruby-identifier">h1</span>[<span class="ruby-identifier">k</span>.<span class="ruby-identifier">to_s</span>]
<span class="line-num"> 93</span>           <span class="ruby-keyword">else</span>
<span class="line-num"> 94</span>             []
<span class="line-num"> 95</span>           <span class="ruby-keyword">end</span>
<span class="line-num"> 96</span>         <span class="ruby-keyword">end</span>
<span class="line-num"> 97</span>         <span class="ruby-identifier">km</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
<span class="line-num"> 98</span>           <span class="ruby-identifier">h</span>[<span class="ruby-identifier">k</span>.<span class="ruby-identifier">to_s</span>] = [] <span class="ruby-keyword">unless</span> <span class="ruby-identifier">h</span>.<span class="ruby-identifier">key?</span>(<span class="ruby-identifier">k</span>.<span class="ruby-identifier">to_s</span>)
<span class="line-num"> 99</span>           <span class="ruby-identifier">h</span>[<span class="ruby-identifier">k</span>.<span class="ruby-identifier">to_s</span>].<span class="ruby-identifier">push</span>( <span class="ruby-operator">*</span><span class="ruby-constant">Array</span>(<span class="ruby-identifier">v</span>) )
<span class="line-num">100</span>         <span class="ruby-keyword">end</span>
<span class="line-num">101</span>         <span class="ruby-identifier">h</span>
<span class="line-num">102</span>       <span class="ruby-keyword">else</span>
<span class="line-num">103</span>         <span class="ruby-identifier">km</span>
<span class="line-num">104</span>       <span class="ruby-keyword">end</span>
<span class="line-num">105</span>     <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">sti_model_map</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Hash</span>)
<span class="line-num">106</span>       <span class="ruby-identifier">h</span> = <span class="ruby-constant">Hash</span>.<span class="ruby-identifier">new</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">h1</span>,<span class="ruby-identifier">k</span><span class="ruby-operator">|</span> 
<span class="line-num">107</span>         <span class="ruby-keyword">unless</span> <span class="ruby-identifier">k</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">String</span>)
<span class="line-num">108</span>           <span class="ruby-identifier">h1</span>[<span class="ruby-identifier">k</span>.<span class="ruby-identifier">to_s</span>]
<span class="line-num">109</span>         <span class="ruby-keyword">else</span>
<span class="line-num">110</span>           []
<span class="line-num">111</span>         <span class="ruby-keyword">end</span>
<span class="line-num">112</span>       <span class="ruby-keyword">end</span>
<span class="line-num">113</span>       <span class="ruby-identifier">sti_model_map</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
<span class="line-num">114</span>         <span class="ruby-identifier">h</span>[<span class="ruby-identifier">v</span>.<span class="ruby-identifier">to_s</span>] = [] <span class="ruby-keyword">unless</span> <span class="ruby-identifier">h</span>.<span class="ruby-identifier">key?</span>(<span class="ruby-identifier">v</span>.<span class="ruby-identifier">to_s</span>)
<span class="line-num">115</span>         <span class="ruby-identifier">h</span>[<span class="ruby-identifier">v</span>.<span class="ruby-identifier">to_s</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">k</span>
<span class="line-num">116</span>       <span class="ruby-keyword">end</span>
<span class="line-num">117</span>       <span class="ruby-identifier">h</span>
<span class="line-num">118</span>     <span class="ruby-keyword">else</span>
<span class="line-num">119</span>       <span class="ruby-identifier">lambda</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">klass</span><span class="ruby-operator">|</span> <span class="ruby-identifier">klass</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">to_s</span>}
<span class="line-num">120</span>     <span class="ruby-keyword">end</span>
<span class="line-num">121</span>     <span class="ruby-ivar">@sti_key_chooser</span> = <span class="ruby-identifier">opts</span>[<span class="ruby-value">:key_chooser</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">lambda</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">inst</span><span class="ruby-operator">|</span> <span class="ruby-constant">Array</span>(<span class="ruby-identifier">inst</span>.<span class="ruby-identifier">model</span>.<span class="ruby-identifier">sti_key_map</span>[<span class="ruby-identifier">inst</span>.<span class="ruby-identifier">model</span>]).<span class="ruby-identifier">last</span> }
<span class="line-num">122</span> 
<span class="line-num">123</span>     <span class="ruby-ivar">@dataset</span> = <span class="ruby-ivar">@dataset</span>.<span class="ruby-identifier">with_row_proc</span>(<span class="ruby-identifier">model</span>.<span class="ruby-identifier">method</span>(<span class="ruby-value">:sti_load</span>))
<span class="line-num">124</span>   <span class="ruby-keyword">end</span>
<span class="line-num">125</span> <span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
  </section>

</main>


<footer id="validator-badges" role="contentinfo">
  <p><a href="https://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="https://ruby.github.io/rdoc/">RDoc</a> 6.1.2.1.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

