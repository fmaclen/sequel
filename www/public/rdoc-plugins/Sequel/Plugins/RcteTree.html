<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>module Sequel::Plugins::RcteTree - Sequel: The Database Toolkit for Ruby</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "../../";
  var index_rel_prefix = "../../";
</script>

<script src="../../js/navigation.js" defer></script>
<script src="../../js/search.js" defer></script>
<script src="../../js/search_index.js" defer></script>
<script src="../../js/searcher.js" defer></script>
<script src="../../js/darkfish.js" defer></script>

<link href="../../css/fonts.css" rel="stylesheet">
<link href="../../css/rdoc.css" rel="stylesheet">




<body id="top" role="document" class="module">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../../table_of_contents.html#pages">Pages</a>
    <a href="../../table_of_contents.html#classes">Classes</a>
    <a href="../../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  
<div class="nav-section">
  <h3>Table of Contents</h3>

  <ul class="link-list" role="directory">
    <li><a href="#module-Sequel::Plugins::RcteTree-label-Overview">Overview</a>
    <li><a href="#module-Sequel::Plugins::RcteTree-label-Usage">Usage</a>
    <li><a href="#module-Sequel::Plugins::RcteTree-label-Options">Options</a>
  </ul>
</div>


  <div id="class-metadata">
    
    
    
    
    <!-- Method Quickref -->
<div id="method-list-section" class="nav-section">
  <h3>Methods</h3>

  <ul class="link-list" role="directory">
    
    <li ><a href="#method-c-apply">::apply</a>
    
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-labelledby="module-Sequel::Plugins::RcteTree">
  <h1 id="module-Sequel::Plugins::RcteTree" class="module">
    module Sequel::Plugins::RcteTree
  </h1>

  <section class="description">
    
<h1 id="module-Sequel::Plugins::RcteTree-label-Overview">Overview<span><a href="#module-Sequel::Plugins::RcteTree-label-Overview">&para;</a> <a href="#top">&uarr;</a></span></h1>

<p>The rcte_tree plugin deals with tree structured data stored in the database using the adjacency list model (where child rows have a foreign key pointing to the parent rows), using recursive common table expressions to load all ancestors in a single query, all descendants in a single query, and all descendants to a given level (where level 1 is children, level 2 is children and grandchildren etc.) in a single query.</p>

<h1 id="module-Sequel::Plugins::RcteTree-label-Usage">Usage<span><a href="#module-Sequel::Plugins::RcteTree-label-Usage">&para;</a> <a href="#top">&uarr;</a></span></h1>

<p>The rcte_tree plugin adds four associations to the model: parent, children, ancestors, and descendants.  Both the parent and children are fairly standard many_to_one and one_to_many associations, respectively.  However, the ancestors and descendants associations are special.  Both the ancestors and descendants associations will automatically set the parent and children associations, respectively, for current object and all of the ancestor or descendant objects, whenever they are loaded (either eagerly or lazily).  Additionally, the descendants association can take a level argument when called eagerly, which limits the returned objects to only that many levels in the tree (see the Overview).</p>

<pre class="ruby"><span class="ruby-constant">Model</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:rcte_tree</span>

<span class="ruby-comment"># Lazy loading</span>
<span class="ruby-identifier">model</span> = <span class="ruby-constant">Model</span>.<span class="ruby-identifier">first</span>
<span class="ruby-identifier">model</span>.<span class="ruby-identifier">parent</span>
<span class="ruby-identifier">model</span>.<span class="ruby-identifier">children</span>
<span class="ruby-identifier">model</span>.<span class="ruby-identifier">ancestors</span> <span class="ruby-comment"># Populates :parent association for all ancestors</span>
<span class="ruby-identifier">model</span>.<span class="ruby-identifier">descendants</span> <span class="ruby-comment"># Populates :children association for all descendants</span>

<span class="ruby-comment"># Eager loading - also populates the :parent and children associations</span>
<span class="ruby-comment"># for all ancestors and descendants</span>
<span class="ruby-constant">Model</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">id:</span> [<span class="ruby-value">1</span>, <span class="ruby-value">2</span>]).<span class="ruby-identifier">eager</span>(<span class="ruby-value">:ancestors</span>, <span class="ruby-value">:descendants</span>).<span class="ruby-identifier">all</span>

<span class="ruby-comment"># Eager loading children and grandchildren</span>
<span class="ruby-constant">Model</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">id:</span> [<span class="ruby-value">1</span>, <span class="ruby-value">2</span>]).<span class="ruby-identifier">eager</span>(<span class="ruby-value">descendants:</span> <span class="ruby-value">2</span>).<span class="ruby-identifier">all</span>
<span class="ruby-comment"># Eager loading children, grandchildren, and great grandchildren</span>
<span class="ruby-constant">Model</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">id:</span> [<span class="ruby-value">1</span>, <span class="ruby-value">2</span>]).<span class="ruby-identifier">eager</span>(<span class="ruby-value">descendants:</span> <span class="ruby-value">3</span>).<span class="ruby-identifier">all</span>
</pre>

<h1 id="module-Sequel::Plugins::RcteTree-label-Options">Options<span><a href="#module-Sequel::Plugins::RcteTree-label-Options">&para;</a> <a href="#top">&uarr;</a></span></h1>

<p>You can override the options for any specific association by making sure the plugin options contain one of the following keys:</p>
<dl class="rdoc-list note-list"><dt>:parent 
<dd>
<p>hash of options for the parent association</p>
</dd><dt>:children 
<dd>
<p>hash of options for the children association</p>
</dd><dt>:ancestors 
<dd>
<p>hash of options for the ancestors association</p>
</dd><dt>:descendants 
<dd>
<p>hash of options for the descendants association</p>
</dd></dl>

<p>Note that you can change the name of the above associations by specifying a :name key in the appropriate hash of options above.  For example:</p>

<pre class="ruby"><span class="ruby-constant">Model</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:rcte_tree</span>, <span class="ruby-value">parent:</span> {<span class="ruby-value">name:</span> <span class="ruby-value">:mother</span>},
 <span class="ruby-value">children:</span> {<span class="ruby-value">name:</span> <span class="ruby-value">:daughters</span>}, <span class="ruby-value">descendants:</span> {<span class="ruby-value">name:</span> <span class="ruby-value">:offspring</span>}
</pre>

<p>Any other keys in the main options hash are treated as options shared by all of the associations.  Here&#39;s a few options that affect the plugin:</p>
<dl class="rdoc-list note-list"><dt>:key 
<dd>
<p>The foreign key in the table that points to the primary key of the parent (default: :parent_id)</p>
</dd><dt>:primary_key 
<dd>
<p>The primary key to use (default: the model&#39;s primary key)</p>
</dd><dt>:key_alias 
<dd>
<p>The symbol identifier to use for aliasing when eager loading (default: :x_root_x)</p>
</dd><dt>:cte_name 
<dd>
<p>The symbol identifier to use for the common table expression (default: :t)</p>
</dd><dt>:level_alias 
<dd>
<p>The symbol identifier to use when eagerly loading descendants up to a given level (default: :x_level_x)</p>
</dd></dl>

  </section>

  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    

    

    
     <section id="public-class-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Class Methods</h3>
       </header>

    
      <div id="method-c-apply" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">apply</span><span
            class="method-args">(model, opts=OPTS)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Create the appropriate parent, children, ancestors, and descendants associations for the model.</p>
          
          

          
          <div class="method-source-code" id="apply-source">
            <pre>    <span class="ruby-comment"># File lib/sequel/plugins/rcte_tree.rb</span>
<span class="line-num"> 77</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">apply</span>(<span class="ruby-identifier">model</span>, <span class="ruby-identifier">opts</span>=<span class="ruby-constant">OPTS</span>)
<span class="line-num"> 78</span>   <span class="ruby-identifier">model</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:tree</span>, <span class="ruby-identifier">opts</span>
<span class="line-num"> 79</span> 
<span class="line-num"> 80</span>   <span class="ruby-identifier">opts</span> = <span class="ruby-identifier">opts</span>.<span class="ruby-identifier">dup</span>
<span class="line-num"> 81</span>   <span class="ruby-identifier">opts</span>[<span class="ruby-value">:class</span>] = <span class="ruby-identifier">model</span>
<span class="line-num"> 82</span>   <span class="ruby-identifier">opts</span>[<span class="ruby-value">:methods_module</span>] = <span class="ruby-constant">Module</span>.<span class="ruby-identifier">new</span>
<span class="line-num"> 83</span>   <span class="ruby-identifier">model</span>.<span class="ruby-identifier">send</span>(<span class="ruby-value">:include</span>, <span class="ruby-identifier">opts</span>[<span class="ruby-value">:methods_module</span>])
<span class="line-num"> 84</span>   
<span class="line-num"> 85</span>   <span class="ruby-identifier">key</span> = <span class="ruby-identifier">opts</span>[<span class="ruby-value">:key</span>] <span class="ruby-operator">||=</span> <span class="ruby-value">:parent_id</span>
<span class="line-num"> 86</span>   <span class="ruby-identifier">prkey</span> = <span class="ruby-identifier">opts</span>[<span class="ruby-value">:primary_key</span>] <span class="ruby-operator">||=</span> <span class="ruby-identifier">model</span>.<span class="ruby-identifier">primary_key</span>
<span class="line-num"> 87</span>   <span class="ruby-identifier">ka</span> = <span class="ruby-identifier">opts</span>[<span class="ruby-value">:key_alias</span>] <span class="ruby-operator">||=</span> <span class="ruby-value">:x_root_x</span>
<span class="line-num"> 88</span>   <span class="ruby-identifier">t</span> = <span class="ruby-identifier">opts</span>[<span class="ruby-value">:cte_name</span>] <span class="ruby-operator">||=</span> <span class="ruby-value">:t</span>
<span class="line-num"> 89</span>   <span class="ruby-identifier">c_all</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">model</span>.<span class="ruby-identifier">dataset</span>.<span class="ruby-identifier">recursive_cte_requires_column_aliases?</span>
<span class="line-num"> 90</span>     <span class="ruby-comment"># Work around Oracle/ruby-oci8 bug that returns integers as BigDecimals in recursive queries.</span>
<span class="line-num"> 91</span>     <span class="ruby-identifier">conv_bd</span> = <span class="ruby-identifier">model</span>.<span class="ruby-identifier">db</span>.<span class="ruby-identifier">database_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:oracle</span>
<span class="line-num"> 92</span>     <span class="ruby-identifier">col_aliases</span> = <span class="ruby-identifier">model</span>.<span class="ruby-identifier">dataset</span>.<span class="ruby-identifier">columns</span>
<span class="line-num"> 93</span>     <span class="ruby-identifier">model_table</span> = <span class="ruby-identifier">model</span>.<span class="ruby-identifier">table_name</span>
<span class="line-num"> 94</span>     <span class="ruby-identifier">col_aliases</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-constant">SQL</span><span class="ruby-operator">::</span><span class="ruby-constant">QualifiedIdentifier</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">model_table</span>, <span class="ruby-identifier">c</span>)}
<span class="line-num"> 95</span>   <span class="ruby-keyword">else</span>
<span class="line-num"> 96</span>     [<span class="ruby-constant">SQL</span><span class="ruby-operator">::</span><span class="ruby-constant">ColumnAll</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">model</span>.<span class="ruby-identifier">table_name</span>)]
<span class="line-num"> 97</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 98</span>   
<span class="line-num"> 99</span>   <span class="ruby-identifier">bd_conv</span> = <span class="ruby-identifier">lambda</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span> <span class="ruby-identifier">conv_bd</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">v</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">BigDecimal</span>) <span class="ruby-operator">?</span> <span class="ruby-identifier">v</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">v</span>}
<span class="line-num">100</span> 
<span class="line-num">101</span>   <span class="ruby-identifier">key_array</span> = <span class="ruby-constant">Array</span>(<span class="ruby-identifier">key</span>)
<span class="line-num">102</span>   <span class="ruby-identifier">prkey_array</span> = <span class="ruby-constant">Array</span>(<span class="ruby-identifier">prkey</span>)
<span class="line-num">103</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">key</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Array</span>)
<span class="line-num">104</span>     <span class="ruby-identifier">key_conv</span> = <span class="ruby-identifier">lambda</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-identifier">key_array</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">k</span><span class="ruby-operator">|</span> <span class="ruby-identifier">m</span>[<span class="ruby-identifier">k</span>]}}
<span class="line-num">105</span>     <span class="ruby-identifier">key_present</span> = <span class="ruby-identifier">lambda</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-identifier">key_conv</span>[<span class="ruby-identifier">m</span>].<span class="ruby-identifier">all?</span>}
<span class="line-num">106</span>     <span class="ruby-identifier">prkey_conv</span> = <span class="ruby-identifier">lambda</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-identifier">prkey_array</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">k</span><span class="ruby-operator">|</span> <span class="ruby-identifier">m</span>[<span class="ruby-identifier">k</span>]}}
<span class="line-num">107</span>     <span class="ruby-identifier">key_aliases</span> = (<span class="ruby-value">0</span><span class="ruby-operator">...</span><span class="ruby-identifier">key_array</span>.<span class="ruby-identifier">length</span>).<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-value">:&quot;#{ka}_#{i}&quot;</span>}
<span class="line-num">108</span>     <span class="ruby-identifier">ancestor_base_case_columns</span> = <span class="ruby-identifier">prkey_array</span>.<span class="ruby-identifier">zip</span>(<span class="ruby-identifier">key_aliases</span>).<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">k</span>, <span class="ruby-identifier">ka_</span><span class="ruby-operator">|</span> <span class="ruby-constant">SQL</span><span class="ruby-operator">::</span><span class="ruby-constant">AliasedExpression</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">k</span>, <span class="ruby-identifier">ka_</span>)} <span class="ruby-operator">+</span> <span class="ruby-identifier">c_all</span>
<span class="line-num">109</span>     <span class="ruby-identifier">descendant_base_case_columns</span> = <span class="ruby-identifier">key_array</span>.<span class="ruby-identifier">zip</span>(<span class="ruby-identifier">key_aliases</span>).<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">k</span>, <span class="ruby-identifier">ka_</span><span class="ruby-operator">|</span> <span class="ruby-constant">SQL</span><span class="ruby-operator">::</span><span class="ruby-constant">AliasedExpression</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">k</span>, <span class="ruby-identifier">ka_</span>)} <span class="ruby-operator">+</span> <span class="ruby-identifier">c_all</span>
<span class="line-num">110</span>     <span class="ruby-identifier">recursive_case_columns</span> = <span class="ruby-identifier">prkey_array</span>.<span class="ruby-identifier">zip</span>(<span class="ruby-identifier">key_aliases</span>).<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">k</span>, <span class="ruby-identifier">ka_</span><span class="ruby-operator">|</span> <span class="ruby-constant">SQL</span><span class="ruby-operator">::</span><span class="ruby-constant">QualifiedIdentifier</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">t</span>, <span class="ruby-identifier">ka_</span>)} <span class="ruby-operator">+</span> <span class="ruby-identifier">c_all</span>
<span class="line-num">111</span>     <span class="ruby-identifier">extract_key_alias</span> = <span class="ruby-identifier">lambda</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-identifier">key_aliases</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">ka_</span><span class="ruby-operator">|</span> <span class="ruby-identifier">bd_conv</span>[<span class="ruby-identifier">m</span>.<span class="ruby-identifier">values</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">ka_</span>)]}}
<span class="line-num">112</span>   <span class="ruby-keyword">else</span>
<span class="line-num">113</span>     <span class="ruby-identifier">key_present</span> = <span class="ruby-identifier">key_conv</span> = <span class="ruby-identifier">lambda</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-identifier">m</span>[<span class="ruby-identifier">key</span>]}
<span class="line-num">114</span>     <span class="ruby-identifier">prkey_conv</span> = <span class="ruby-identifier">lambda</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-identifier">m</span>[<span class="ruby-identifier">prkey</span>]}
<span class="line-num">115</span>     <span class="ruby-identifier">key_aliases</span> = [<span class="ruby-identifier">ka</span>]
<span class="line-num">116</span>     <span class="ruby-identifier">ancestor_base_case_columns</span> = [<span class="ruby-constant">SQL</span><span class="ruby-operator">::</span><span class="ruby-constant">AliasedExpression</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">prkey</span>, <span class="ruby-identifier">ka</span>)] <span class="ruby-operator">+</span> <span class="ruby-identifier">c_all</span>
<span class="line-num">117</span>     <span class="ruby-identifier">descendant_base_case_columns</span> = [<span class="ruby-constant">SQL</span><span class="ruby-operator">::</span><span class="ruby-constant">AliasedExpression</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">key</span>, <span class="ruby-identifier">ka</span>)] <span class="ruby-operator">+</span> <span class="ruby-identifier">c_all</span>
<span class="line-num">118</span>     <span class="ruby-identifier">recursive_case_columns</span> = [<span class="ruby-constant">SQL</span><span class="ruby-operator">::</span><span class="ruby-constant">QualifiedIdentifier</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">t</span>, <span class="ruby-identifier">ka</span>)] <span class="ruby-operator">+</span> <span class="ruby-identifier">c_all</span>
<span class="line-num">119</span>     <span class="ruby-identifier">extract_key_alias</span> = <span class="ruby-identifier">lambda</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-identifier">bd_conv</span>[<span class="ruby-identifier">m</span>.<span class="ruby-identifier">values</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">ka</span>)]}
<span class="line-num">120</span>   <span class="ruby-keyword">end</span>
<span class="line-num">121</span>   
<span class="line-num">122</span>   <span class="ruby-identifier">parent</span> = <span class="ruby-identifier">opts</span>.<span class="ruby-identifier">merge</span>(<span class="ruby-identifier">opts</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-value">:parent</span>, <span class="ruby-constant">OPTS</span>)).<span class="ruby-identifier">fetch</span>(<span class="ruby-value">:name</span>, <span class="ruby-value">:parent</span>)
<span class="line-num">123</span>   <span class="ruby-identifier">childrena</span> = <span class="ruby-identifier">opts</span>.<span class="ruby-identifier">merge</span>(<span class="ruby-identifier">opts</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-value">:children</span>, <span class="ruby-constant">OPTS</span>)).<span class="ruby-identifier">fetch</span>(<span class="ruby-value">:name</span>, <span class="ruby-value">:children</span>)
<span class="line-num">124</span>   
<span class="line-num">125</span>   <span class="ruby-identifier">opts</span>[<span class="ruby-value">:reciprocal</span>] = <span class="ruby-keyword">nil</span>
<span class="line-num">126</span>   <span class="ruby-identifier">a</span> = <span class="ruby-identifier">opts</span>.<span class="ruby-identifier">merge</span>(<span class="ruby-identifier">opts</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-value">:ancestors</span>, <span class="ruby-constant">OPTS</span>))
<span class="line-num">127</span>   <span class="ruby-identifier">ancestors</span> = <span class="ruby-identifier">a</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-value">:name</span>, <span class="ruby-value">:ancestors</span>)
<span class="line-num">128</span>   <span class="ruby-identifier">a</span>[<span class="ruby-value">:read_only</span>] = <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">a</span>.<span class="ruby-identifier">has_key?</span>(<span class="ruby-value">:read_only</span>)
<span class="line-num">129</span>   <span class="ruby-identifier">a</span>[<span class="ruby-value">:eager_grapher</span>] = <span class="ruby-identifier">proc</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">_</span><span class="ruby-operator">|</span>
<span class="line-num">130</span>     <span class="ruby-identifier">raise</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span>, <span class="ruby-node">&quot;the #{ancestors} association for #{self} does not support eager graphing&quot;</span>
<span class="line-num">131</span>   <span class="ruby-keyword">end</span>
<span class="line-num">132</span>   <span class="ruby-identifier">a</span>[<span class="ruby-value">:eager_loader_key</span>] = <span class="ruby-identifier">key</span>
<span class="line-num">133</span>   <span class="ruby-identifier">a</span>[<span class="ruby-value">:dataset</span>] <span class="ruby-operator">||=</span> <span class="ruby-identifier">proc</span> <span class="ruby-keyword">do</span>
<span class="line-num">134</span>     <span class="ruby-identifier">base_ds</span> = <span class="ruby-identifier">model</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">prkey_array</span>.<span class="ruby-identifier">zip</span>(<span class="ruby-identifier">key_array</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">k</span><span class="ruby-operator">|</span> <span class="ruby-identifier">get_column_value</span>(<span class="ruby-identifier">k</span>)}))
<span class="line-num">135</span>     <span class="ruby-identifier">recursive_ds</span> = <span class="ruby-identifier">model</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">t</span>, <span class="ruby-identifier">key_array</span>.<span class="ruby-identifier">zip</span>(<span class="ruby-identifier">prkey_array</span>))
<span class="line-num">136</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">c</span> = <span class="ruby-identifier">a</span>[<span class="ruby-value">:conditions</span>]
<span class="line-num">137</span>       (<span class="ruby-identifier">base_ds</span>, <span class="ruby-identifier">recursive_ds</span>) = [<span class="ruby-identifier">base_ds</span>, <span class="ruby-identifier">recursive_ds</span>].<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ds</span><span class="ruby-operator">|</span>
<span class="line-num">138</span>         (<span class="ruby-identifier">c</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Array</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">condition_specifier?</span>(<span class="ruby-identifier">c</span>)) <span class="ruby-operator">?</span> <span class="ruby-identifier">ds</span>.<span class="ruby-identifier">where</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">c</span>) <span class="ruby-operator">:</span> <span class="ruby-identifier">ds</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">c</span>)
<span class="line-num">139</span>       <span class="ruby-keyword">end</span>
<span class="line-num">140</span>     <span class="ruby-keyword">end</span>
<span class="line-num">141</span>     <span class="ruby-identifier">table_alias</span> = <span class="ruby-identifier">model</span>.<span class="ruby-identifier">dataset</span>.<span class="ruby-identifier">schema_and_table</span>(<span class="ruby-identifier">model</span>.<span class="ruby-identifier">table_name</span>)[<span class="ruby-value">1</span>].<span class="ruby-identifier">to_sym</span>
<span class="line-num">142</span>     <span class="ruby-identifier">model</span>.<span class="ruby-identifier">from</span>(<span class="ruby-constant">SQL</span><span class="ruby-operator">::</span><span class="ruby-constant">AliasedExpression</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">t</span>, <span class="ruby-identifier">table_alias</span>)).
<span class="line-num">143</span>      <span class="ruby-identifier">with_recursive</span>(<span class="ruby-identifier">t</span>, <span class="ruby-identifier">col_aliases</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">base_ds</span>.<span class="ruby-identifier">select</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">col_aliases</span>) <span class="ruby-operator">:</span> <span class="ruby-identifier">base_ds</span>.<span class="ruby-identifier">select_all</span>,
<span class="line-num">144</span>       <span class="ruby-identifier">recursive_ds</span>.<span class="ruby-identifier">select</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">c_all</span>),
<span class="line-num">145</span>       <span class="ruby-value">:args</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">col_aliases</span>)
<span class="line-num">146</span>   <span class="ruby-keyword">end</span>
<span class="line-num">147</span>   <span class="ruby-identifier">aal</span> = <span class="ruby-constant">Array</span>(<span class="ruby-identifier">a</span>[<span class="ruby-value">:after_load</span>])
<span class="line-num">148</span>   <span class="ruby-identifier">aal</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">proc</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">m</span>, <span class="ruby-identifier">ancs</span><span class="ruby-operator">|</span>
<span class="line-num">149</span>     <span class="ruby-keyword">unless</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">associations</span>.<span class="ruby-identifier">has_key?</span>(<span class="ruby-identifier">parent</span>)
<span class="line-num">150</span>       <span class="ruby-identifier">parent_map</span> = {<span class="ruby-identifier">prkey_conv</span>[<span class="ruby-identifier">m</span>]<span class="ruby-operator">=&gt;</span><span class="ruby-identifier">m</span>}
<span class="line-num">151</span>       <span class="ruby-identifier">child_map</span> = {}
<span class="line-num">152</span>       <span class="ruby-identifier">child_map</span>[<span class="ruby-identifier">key_conv</span>[<span class="ruby-identifier">m</span>]] = <span class="ruby-identifier">m</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">key_present</span>[<span class="ruby-identifier">m</span>]
<span class="line-num">153</span>       <span class="ruby-identifier">m</span>.<span class="ruby-identifier">associations</span>[<span class="ruby-identifier">parent</span>] = <span class="ruby-keyword">nil</span>
<span class="line-num">154</span>       <span class="ruby-identifier">ancs</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">obj</span><span class="ruby-operator">|</span>
<span class="line-num">155</span>         <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">associations</span>[<span class="ruby-identifier">parent</span>] = <span class="ruby-keyword">nil</span>
<span class="line-num">156</span>         <span class="ruby-identifier">parent_map</span>[<span class="ruby-identifier">prkey_conv</span>[<span class="ruby-identifier">obj</span>]] = <span class="ruby-identifier">obj</span>
<span class="line-num">157</span>         <span class="ruby-keyword">if</span> <span class="ruby-identifier">ok</span> = <span class="ruby-identifier">key_conv</span>[<span class="ruby-identifier">obj</span>]
<span class="line-num">158</span>           <span class="ruby-identifier">child_map</span>[<span class="ruby-identifier">ok</span>] = <span class="ruby-identifier">obj</span>
<span class="line-num">159</span>         <span class="ruby-keyword">end</span>
<span class="line-num">160</span>       <span class="ruby-keyword">end</span>
<span class="line-num">161</span>       <span class="ruby-identifier">parent_map</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">parent_id</span>, <span class="ruby-identifier">obj</span><span class="ruby-operator">|</span>
<span class="line-num">162</span>         <span class="ruby-keyword">if</span> <span class="ruby-identifier">child</span> = <span class="ruby-identifier">child_map</span>[<span class="ruby-identifier">parent_id</span>]
<span class="line-num">163</span>           <span class="ruby-identifier">child</span>.<span class="ruby-identifier">associations</span>[<span class="ruby-identifier">parent</span>] = <span class="ruby-identifier">obj</span>
<span class="line-num">164</span>         <span class="ruby-keyword">end</span>
<span class="line-num">165</span>       <span class="ruby-keyword">end</span>
<span class="line-num">166</span>     <span class="ruby-keyword">end</span>
<span class="line-num">167</span>   <span class="ruby-keyword">end</span>
<span class="line-num">168</span>   <span class="ruby-identifier">a</span>[<span class="ruby-value">:after_load</span>] <span class="ruby-operator">||=</span> <span class="ruby-identifier">aal</span>
<span class="line-num">169</span>   <span class="ruby-identifier">a</span>[<span class="ruby-value">:eager_loader</span>] <span class="ruby-operator">||=</span> <span class="ruby-identifier">proc</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eo</span><span class="ruby-operator">|</span>
<span class="line-num">170</span>     <span class="ruby-identifier">id_map</span> = <span class="ruby-identifier">eo</span>[<span class="ruby-value">:id_map</span>]
<span class="line-num">171</span>     <span class="ruby-identifier">parent_map</span> = {}
<span class="line-num">172</span>     <span class="ruby-identifier">children_map</span> = {}
<span class="line-num">173</span>     <span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">synchronize_with</span>(<span class="ruby-identifier">eo</span>[<span class="ruby-value">:mutex</span>]) <span class="ruby-keyword">do</span>
<span class="line-num">174</span>       <span class="ruby-identifier">eo</span>[<span class="ruby-value">:rows</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">obj</span><span class="ruby-operator">|</span>
<span class="line-num">175</span>         <span class="ruby-identifier">parent_map</span>[<span class="ruby-identifier">prkey_conv</span>[<span class="ruby-identifier">obj</span>]] = <span class="ruby-identifier">obj</span>
<span class="line-num">176</span>         (<span class="ruby-identifier">children_map</span>[<span class="ruby-identifier">key_conv</span>[<span class="ruby-identifier">obj</span>]] <span class="ruby-operator">||=</span> []) <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">obj</span>
<span class="line-num">177</span>         <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">associations</span>[<span class="ruby-identifier">ancestors</span>] = []
<span class="line-num">178</span>         <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">associations</span>[<span class="ruby-identifier">parent</span>] = <span class="ruby-keyword">nil</span>
<span class="line-num">179</span>       <span class="ruby-keyword">end</span>
<span class="line-num">180</span>     <span class="ruby-keyword">end</span>
<span class="line-num">181</span>     <span class="ruby-identifier">r</span> = <span class="ruby-identifier">model</span>.<span class="ruby-identifier">association_reflection</span>(<span class="ruby-identifier">ancestors</span>)
<span class="line-num">182</span>     <span class="ruby-identifier">base_case</span> = <span class="ruby-identifier">model</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">prkey</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">id_map</span>.<span class="ruby-identifier">keys</span>).
<span class="line-num">183</span>      <span class="ruby-identifier">select</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">ancestor_base_case_columns</span>)
<span class="line-num">184</span>     <span class="ruby-identifier">recursive_case</span> = <span class="ruby-identifier">model</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">t</span>, <span class="ruby-identifier">key_array</span>.<span class="ruby-identifier">zip</span>(<span class="ruby-identifier">prkey_array</span>)).
<span class="line-num">185</span>      <span class="ruby-identifier">select</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">recursive_case_columns</span>)
<span class="line-num">186</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">c</span> = <span class="ruby-identifier">r</span>[<span class="ruby-value">:conditions</span>]
<span class="line-num">187</span>       (<span class="ruby-identifier">base_case</span>, <span class="ruby-identifier">recursive_case</span>) = [<span class="ruby-identifier">base_case</span>, <span class="ruby-identifier">recursive_case</span>].<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ds</span><span class="ruby-operator">|</span>
<span class="line-num">188</span>         (<span class="ruby-identifier">c</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Array</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">condition_specifier?</span>(<span class="ruby-identifier">c</span>)) <span class="ruby-operator">?</span> <span class="ruby-identifier">ds</span>.<span class="ruby-identifier">where</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">c</span>) <span class="ruby-operator">:</span> <span class="ruby-identifier">ds</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">c</span>)
<span class="line-num">189</span>       <span class="ruby-keyword">end</span>
<span class="line-num">190</span>     <span class="ruby-keyword">end</span>
<span class="line-num">191</span>     <span class="ruby-identifier">table_alias</span> = <span class="ruby-identifier">model</span>.<span class="ruby-identifier">dataset</span>.<span class="ruby-identifier">schema_and_table</span>(<span class="ruby-identifier">model</span>.<span class="ruby-identifier">table_name</span>)[<span class="ruby-value">1</span>].<span class="ruby-identifier">to_sym</span>
<span class="line-num">192</span>     <span class="ruby-identifier">ds</span> = <span class="ruby-identifier">model</span>.<span class="ruby-identifier">from</span>(<span class="ruby-constant">SQL</span><span class="ruby-operator">::</span><span class="ruby-constant">AliasedExpression</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">t</span>, <span class="ruby-identifier">table_alias</span>)).
<span class="line-num">193</span>       <span class="ruby-identifier">with_recursive</span>(<span class="ruby-identifier">t</span>, <span class="ruby-identifier">base_case</span>, <span class="ruby-identifier">recursive_case</span>,
<span class="line-num">194</span>        <span class="ruby-value">:args</span><span class="ruby-operator">=&gt;</span>((<span class="ruby-identifier">key_aliases</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">col_aliases</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">col_aliases</span>))
<span class="line-num">195</span>     <span class="ruby-identifier">ds</span> = <span class="ruby-identifier">r</span>.<span class="ruby-identifier">apply_eager_dataset_changes</span>(<span class="ruby-identifier">ds</span>)
<span class="line-num">196</span>     <span class="ruby-identifier">ds</span> = <span class="ruby-identifier">ds</span>.<span class="ruby-identifier">select_append</span>(<span class="ruby-identifier">ka</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">ds</span>.<span class="ruby-identifier">opts</span>[<span class="ruby-value">:select</span>] <span class="ruby-operator">==</span> <span class="ruby-keyword">nil</span>
<span class="line-num">197</span>     <span class="ruby-identifier">model</span>.<span class="ruby-identifier">eager_load_results</span>(<span class="ruby-identifier">r</span>, <span class="ruby-identifier">eo</span>.<span class="ruby-identifier">merge</span>(<span class="ruby-value">:loader</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">false</span>, <span class="ruby-value">:initialize_rows</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">false</span>, <span class="ruby-value">:dataset</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">ds</span>, <span class="ruby-value">:id_map</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">nil</span>)) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">obj</span><span class="ruby-operator">|</span>
<span class="line-num">198</span>       <span class="ruby-identifier">opk</span> = <span class="ruby-identifier">prkey_conv</span>[<span class="ruby-identifier">obj</span>]
<span class="line-num">199</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">idm_obj</span> = <span class="ruby-identifier">parent_map</span>[<span class="ruby-identifier">opk</span>]
<span class="line-num">200</span>         <span class="ruby-identifier">key_aliases</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">ka_</span><span class="ruby-operator">|</span> <span class="ruby-identifier">idm_obj</span>.<span class="ruby-identifier">values</span>[<span class="ruby-identifier">ka_</span>] = <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">values</span>[<span class="ruby-identifier">ka_</span>]}
<span class="line-num">201</span>         <span class="ruby-identifier">obj</span> = <span class="ruby-identifier">idm_obj</span>
<span class="line-num">202</span>       <span class="ruby-keyword">else</span>
<span class="line-num">203</span>         <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">associations</span>[<span class="ruby-identifier">parent</span>] = <span class="ruby-keyword">nil</span>
<span class="line-num">204</span>         <span class="ruby-identifier">parent_map</span>[<span class="ruby-identifier">opk</span>] = <span class="ruby-identifier">obj</span>
<span class="line-num">205</span>         (<span class="ruby-identifier">children_map</span>[<span class="ruby-identifier">key_conv</span>[<span class="ruby-identifier">obj</span>]] <span class="ruby-operator">||=</span> []) <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">obj</span>
<span class="line-num">206</span>       <span class="ruby-keyword">end</span>
<span class="line-num">207</span>       
<span class="line-num">208</span>       <span class="ruby-identifier">id_map</span>[<span class="ruby-identifier">extract_key_alias</span>[<span class="ruby-identifier">obj</span>]].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">root</span><span class="ruby-operator">|</span>
<span class="line-num">209</span>         <span class="ruby-identifier">root</span>.<span class="ruby-identifier">associations</span>[<span class="ruby-identifier">ancestors</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">obj</span>
<span class="line-num">210</span>       <span class="ruby-keyword">end</span>
<span class="line-num">211</span>     <span class="ruby-keyword">end</span>
<span class="line-num">212</span>     <span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">synchronize_with</span>(<span class="ruby-identifier">eo</span>[<span class="ruby-value">:mutex</span>]) <span class="ruby-keyword">do</span>
<span class="line-num">213</span>       <span class="ruby-identifier">parent_map</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">parent_id</span>, <span class="ruby-identifier">obj</span><span class="ruby-operator">|</span>
<span class="line-num">214</span>         <span class="ruby-keyword">if</span> <span class="ruby-identifier">children</span> = <span class="ruby-identifier">children_map</span>[<span class="ruby-identifier">parent_id</span>]
<span class="line-num">215</span>           <span class="ruby-identifier">children</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">child</span><span class="ruby-operator">|</span>
<span class="line-num">216</span>             <span class="ruby-identifier">child</span>.<span class="ruby-identifier">associations</span>[<span class="ruby-identifier">parent</span>] = <span class="ruby-identifier">obj</span>
<span class="line-num">217</span>           <span class="ruby-keyword">end</span>
<span class="line-num">218</span>         <span class="ruby-keyword">end</span>
<span class="line-num">219</span>       <span class="ruby-keyword">end</span>
<span class="line-num">220</span>     <span class="ruby-keyword">end</span>
<span class="line-num">221</span>   <span class="ruby-keyword">end</span>
<span class="line-num">222</span>   <span class="ruby-identifier">model</span>.<span class="ruby-identifier">one_to_many</span> <span class="ruby-identifier">ancestors</span>, <span class="ruby-identifier">a</span>
<span class="line-num">223</span>   
<span class="line-num">224</span>   <span class="ruby-identifier">d</span> = <span class="ruby-identifier">opts</span>.<span class="ruby-identifier">merge</span>(<span class="ruby-identifier">opts</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-value">:descendants</span>, <span class="ruby-constant">OPTS</span>))
<span class="line-num">225</span>   <span class="ruby-identifier">descendants</span> = <span class="ruby-identifier">d</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-value">:name</span>, <span class="ruby-value">:descendants</span>)
<span class="line-num">226</span>   <span class="ruby-identifier">d</span>[<span class="ruby-value">:read_only</span>] = <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">d</span>.<span class="ruby-identifier">has_key?</span>(<span class="ruby-value">:read_only</span>)
<span class="line-num">227</span>   <span class="ruby-identifier">d</span>[<span class="ruby-value">:eager_grapher</span>] = <span class="ruby-identifier">proc</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">_</span><span class="ruby-operator">|</span>
<span class="line-num">228</span>     <span class="ruby-identifier">raise</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span>, <span class="ruby-node">&quot;the #{descendants} association for #{self} does not support eager graphing&quot;</span>
<span class="line-num">229</span>   <span class="ruby-keyword">end</span>
<span class="line-num">230</span>   <span class="ruby-identifier">la</span> = <span class="ruby-identifier">d</span>[<span class="ruby-value">:level_alias</span>] <span class="ruby-operator">||=</span> <span class="ruby-value">:x_level_x</span>
<span class="line-num">231</span>   <span class="ruby-identifier">d</span>[<span class="ruby-value">:dataset</span>] <span class="ruby-operator">||=</span> <span class="ruby-identifier">proc</span> <span class="ruby-keyword">do</span>
<span class="line-num">232</span>     <span class="ruby-identifier">base_ds</span> = <span class="ruby-identifier">model</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">key_array</span>.<span class="ruby-identifier">zip</span>(<span class="ruby-identifier">prkey_array</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">k</span><span class="ruby-operator">|</span> <span class="ruby-identifier">get_column_value</span>(<span class="ruby-identifier">k</span>)}))
<span class="line-num">233</span>     <span class="ruby-identifier">recursive_ds</span> = <span class="ruby-identifier">model</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">t</span>, <span class="ruby-identifier">prkey_array</span>.<span class="ruby-identifier">zip</span>(<span class="ruby-identifier">key_array</span>))
<span class="line-num">234</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">c</span> = <span class="ruby-identifier">d</span>[<span class="ruby-value">:conditions</span>]
<span class="line-num">235</span>       (<span class="ruby-identifier">base_ds</span>, <span class="ruby-identifier">recursive_ds</span>) = [<span class="ruby-identifier">base_ds</span>, <span class="ruby-identifier">recursive_ds</span>].<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ds</span><span class="ruby-operator">|</span>
<span class="line-num">236</span>         (<span class="ruby-identifier">c</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Array</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">condition_specifier?</span>(<span class="ruby-identifier">c</span>)) <span class="ruby-operator">?</span> <span class="ruby-identifier">ds</span>.<span class="ruby-identifier">where</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">c</span>) <span class="ruby-operator">:</span> <span class="ruby-identifier">ds</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">c</span>)
<span class="line-num">237</span>       <span class="ruby-keyword">end</span>
<span class="line-num">238</span>     <span class="ruby-keyword">end</span>
<span class="line-num">239</span>     <span class="ruby-identifier">table_alias</span> = <span class="ruby-identifier">model</span>.<span class="ruby-identifier">dataset</span>.<span class="ruby-identifier">schema_and_table</span>(<span class="ruby-identifier">model</span>.<span class="ruby-identifier">table_name</span>)[<span class="ruby-value">1</span>].<span class="ruby-identifier">to_sym</span>
<span class="line-num">240</span>     <span class="ruby-identifier">model</span>.<span class="ruby-identifier">from</span>(<span class="ruby-constant">SQL</span><span class="ruby-operator">::</span><span class="ruby-constant">AliasedExpression</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">t</span>, <span class="ruby-identifier">table_alias</span>)).
<span class="line-num">241</span>      <span class="ruby-identifier">with_recursive</span>(<span class="ruby-identifier">t</span>, <span class="ruby-identifier">col_aliases</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">base_ds</span>.<span class="ruby-identifier">select</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">col_aliases</span>) <span class="ruby-operator">:</span> <span class="ruby-identifier">base_ds</span>.<span class="ruby-identifier">select_all</span>,
<span class="line-num">242</span>       <span class="ruby-identifier">recursive_ds</span>.<span class="ruby-identifier">select</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">c_all</span>),
<span class="line-num">243</span>       <span class="ruby-value">:args</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">col_aliases</span>)
<span class="line-num">244</span>     <span class="ruby-keyword">end</span>
<span class="line-num">245</span>   <span class="ruby-identifier">dal</span> = <span class="ruby-constant">Array</span>(<span class="ruby-identifier">d</span>[<span class="ruby-value">:after_load</span>])
<span class="line-num">246</span>   <span class="ruby-identifier">dal</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">proc</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">m</span>, <span class="ruby-identifier">descs</span><span class="ruby-operator">|</span>
<span class="line-num">247</span>     <span class="ruby-keyword">unless</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">associations</span>.<span class="ruby-identifier">has_key?</span>(<span class="ruby-identifier">childrena</span>)
<span class="line-num">248</span>       <span class="ruby-identifier">parent_map</span> = {<span class="ruby-identifier">prkey_conv</span>[<span class="ruby-identifier">m</span>]<span class="ruby-operator">=&gt;</span><span class="ruby-identifier">m</span>}
<span class="line-num">249</span>       <span class="ruby-identifier">children_map</span> = {}
<span class="line-num">250</span>       <span class="ruby-identifier">m</span>.<span class="ruby-identifier">associations</span>[<span class="ruby-identifier">childrena</span>] = []
<span class="line-num">251</span>       <span class="ruby-identifier">descs</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">obj</span><span class="ruby-operator">|</span>
<span class="line-num">252</span>         <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">associations</span>[<span class="ruby-identifier">childrena</span>] = []
<span class="line-num">253</span>         <span class="ruby-keyword">if</span> <span class="ruby-identifier">opk</span> = <span class="ruby-identifier">prkey_conv</span>[<span class="ruby-identifier">obj</span>]
<span class="line-num">254</span>           <span class="ruby-identifier">parent_map</span>[<span class="ruby-identifier">opk</span>] = <span class="ruby-identifier">obj</span>
<span class="line-num">255</span>         <span class="ruby-keyword">end</span>
<span class="line-num">256</span>         <span class="ruby-keyword">if</span> <span class="ruby-identifier">ok</span> = <span class="ruby-identifier">key_conv</span>[<span class="ruby-identifier">obj</span>]
<span class="line-num">257</span>           (<span class="ruby-identifier">children_map</span>[<span class="ruby-identifier">ok</span>] <span class="ruby-operator">||=</span> []) <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">obj</span>
<span class="line-num">258</span>         <span class="ruby-keyword">end</span>
<span class="line-num">259</span>       <span class="ruby-keyword">end</span>
<span class="line-num">260</span>       <span class="ruby-identifier">children_map</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">parent_id</span>, <span class="ruby-identifier">objs</span><span class="ruby-operator">|</span>
<span class="line-num">261</span>         <span class="ruby-identifier">parent_obj</span> = <span class="ruby-identifier">parent_map</span>[<span class="ruby-identifier">parent_id</span>]
<span class="line-num">262</span>         <span class="ruby-identifier">parent_obj</span>.<span class="ruby-identifier">associations</span>[<span class="ruby-identifier">childrena</span>] = <span class="ruby-identifier">objs</span>
<span class="line-num">263</span>         <span class="ruby-identifier">objs</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">obj</span><span class="ruby-operator">|</span>
<span class="line-num">264</span>           <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">associations</span>[<span class="ruby-identifier">parent</span>] = <span class="ruby-identifier">parent_obj</span>
<span class="line-num">265</span>         <span class="ruby-keyword">end</span>
<span class="line-num">266</span>       <span class="ruby-keyword">end</span>
<span class="line-num">267</span>     <span class="ruby-keyword">end</span>
<span class="line-num">268</span>   <span class="ruby-keyword">end</span>
<span class="line-num">269</span>   <span class="ruby-identifier">d</span>[<span class="ruby-value">:after_load</span>] = <span class="ruby-identifier">dal</span>
<span class="line-num">270</span>   <span class="ruby-identifier">d</span>[<span class="ruby-value">:eager_loader</span>] <span class="ruby-operator">||=</span> <span class="ruby-identifier">proc</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eo</span><span class="ruby-operator">|</span>
<span class="line-num">271</span>     <span class="ruby-identifier">id_map</span> = <span class="ruby-identifier">eo</span>[<span class="ruby-value">:id_map</span>]
<span class="line-num">272</span>     <span class="ruby-identifier">associations</span> = <span class="ruby-identifier">eo</span>[<span class="ruby-value">:associations</span>]
<span class="line-num">273</span>     <span class="ruby-identifier">parent_map</span> = {}
<span class="line-num">274</span>     <span class="ruby-identifier">children_map</span> = {}
<span class="line-num">275</span>     <span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">synchronize_with</span>(<span class="ruby-identifier">eo</span>[<span class="ruby-value">:mutex</span>]) <span class="ruby-keyword">do</span>
<span class="line-num">276</span>       <span class="ruby-identifier">eo</span>[<span class="ruby-value">:rows</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">obj</span><span class="ruby-operator">|</span>
<span class="line-num">277</span>         <span class="ruby-identifier">parent_map</span>[<span class="ruby-identifier">prkey_conv</span>[<span class="ruby-identifier">obj</span>]] = <span class="ruby-identifier">obj</span>
<span class="line-num">278</span>         <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">associations</span>[<span class="ruby-identifier">descendants</span>] = []
<span class="line-num">279</span>         <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">associations</span>[<span class="ruby-identifier">childrena</span>] = []
<span class="line-num">280</span>       <span class="ruby-keyword">end</span>
<span class="line-num">281</span>     <span class="ruby-keyword">end</span>
<span class="line-num">282</span>     <span class="ruby-identifier">r</span> = <span class="ruby-identifier">model</span>.<span class="ruby-identifier">association_reflection</span>(<span class="ruby-identifier">descendants</span>)
<span class="line-num">283</span>     <span class="ruby-identifier">base_case</span> = <span class="ruby-identifier">model</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">key</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">id_map</span>.<span class="ruby-identifier">keys</span>).
<span class="line-num">284</span>      <span class="ruby-identifier">select</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">descendant_base_case_columns</span>)
<span class="line-num">285</span>     <span class="ruby-identifier">recursive_case</span> = <span class="ruby-identifier">model</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">t</span>, <span class="ruby-identifier">prkey_array</span>.<span class="ruby-identifier">zip</span>(<span class="ruby-identifier">key_array</span>)).
<span class="line-num">286</span>      <span class="ruby-identifier">select</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">recursive_case_columns</span>)
<span class="line-num">287</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">c</span> = <span class="ruby-identifier">r</span>[<span class="ruby-value">:conditions</span>]
<span class="line-num">288</span>       (<span class="ruby-identifier">base_case</span>, <span class="ruby-identifier">recursive_case</span>) = [<span class="ruby-identifier">base_case</span>, <span class="ruby-identifier">recursive_case</span>].<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ds</span><span class="ruby-operator">|</span>
<span class="line-num">289</span>         (<span class="ruby-identifier">c</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Array</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">condition_specifier?</span>(<span class="ruby-identifier">c</span>)) <span class="ruby-operator">?</span> <span class="ruby-identifier">ds</span>.<span class="ruby-identifier">where</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">c</span>) <span class="ruby-operator">:</span> <span class="ruby-identifier">ds</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">c</span>)
<span class="line-num">290</span>       <span class="ruby-keyword">end</span>
<span class="line-num">291</span>     <span class="ruby-keyword">end</span>
<span class="line-num">292</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">associations</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Integer</span>)
<span class="line-num">293</span>       <span class="ruby-identifier">level</span> = <span class="ruby-identifier">associations</span>
<span class="line-num">294</span>       <span class="ruby-identifier">no_cache_level</span> = <span class="ruby-identifier">level</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>
<span class="line-num">295</span>       <span class="ruby-identifier">associations</span> = {}
<span class="line-num">296</span>       <span class="ruby-identifier">base_case</span> = <span class="ruby-identifier">base_case</span>.<span class="ruby-identifier">select_append</span>(<span class="ruby-constant">SQL</span><span class="ruby-operator">::</span><span class="ruby-constant">AliasedExpression</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">cast</span>(<span class="ruby-value">0</span>, <span class="ruby-constant">Integer</span>), <span class="ruby-identifier">la</span>))
<span class="line-num">297</span>       <span class="ruby-identifier">recursive_case</span> = <span class="ruby-identifier">recursive_case</span>.<span class="ruby-identifier">select_append</span>(<span class="ruby-constant">SQL</span><span class="ruby-operator">::</span><span class="ruby-constant">AliasedExpression</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">SQL</span><span class="ruby-operator">::</span><span class="ruby-constant">QualifiedIdentifier</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">t</span>, <span class="ruby-identifier">la</span>) <span class="ruby-operator">+</span> <span class="ruby-value">1</span>, <span class="ruby-identifier">la</span>)).<span class="ruby-identifier">where</span>(<span class="ruby-constant">SQL</span><span class="ruby-operator">::</span><span class="ruby-constant">QualifiedIdentifier</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">t</span>, <span class="ruby-identifier">la</span>) <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">level</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>)
<span class="line-num">298</span>     <span class="ruby-keyword">end</span>
<span class="line-num">299</span>     <span class="ruby-identifier">table_alias</span> = <span class="ruby-identifier">model</span>.<span class="ruby-identifier">dataset</span>.<span class="ruby-identifier">schema_and_table</span>(<span class="ruby-identifier">model</span>.<span class="ruby-identifier">table_name</span>)[<span class="ruby-value">1</span>].<span class="ruby-identifier">to_sym</span>
<span class="line-num">300</span>     <span class="ruby-identifier">ds</span> = <span class="ruby-identifier">model</span>.<span class="ruby-identifier">from</span>(<span class="ruby-constant">SQL</span><span class="ruby-operator">::</span><span class="ruby-constant">AliasedExpression</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">t</span>, <span class="ruby-identifier">table_alias</span>)).
<span class="line-num">301</span>       <span class="ruby-identifier">with_recursive</span>(<span class="ruby-identifier">t</span>, <span class="ruby-identifier">base_case</span>, <span class="ruby-identifier">recursive_case</span>,
<span class="line-num">302</span>         <span class="ruby-value">:args</span><span class="ruby-operator">=&gt;</span>((<span class="ruby-identifier">key_aliases</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">col_aliases</span> <span class="ruby-operator">+</span> (<span class="ruby-identifier">level</span> <span class="ruby-operator">?</span> [<span class="ruby-identifier">la</span>] <span class="ruby-operator">:</span> [])) <span class="ruby-keyword">if</span> <span class="ruby-identifier">col_aliases</span>))
<span class="line-num">303</span>     <span class="ruby-identifier">ds</span> = <span class="ruby-identifier">r</span>.<span class="ruby-identifier">apply_eager_dataset_changes</span>(<span class="ruby-identifier">ds</span>)
<span class="line-num">304</span>     <span class="ruby-identifier">ds</span> = <span class="ruby-identifier">ds</span>.<span class="ruby-identifier">select_append</span>(<span class="ruby-identifier">ka</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">ds</span>.<span class="ruby-identifier">opts</span>[<span class="ruby-value">:select</span>] <span class="ruby-operator">==</span> <span class="ruby-keyword">nil</span>
<span class="line-num">305</span>     <span class="ruby-identifier">model</span>.<span class="ruby-identifier">eager_load_results</span>(<span class="ruby-identifier">r</span>, <span class="ruby-identifier">eo</span>.<span class="ruby-identifier">merge</span>(<span class="ruby-value">:loader</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">false</span>, <span class="ruby-value">:initialize_rows</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">false</span>, <span class="ruby-value">:dataset</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">ds</span>, <span class="ruby-value">:id_map</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">nil</span>, <span class="ruby-value">:associations</span><span class="ruby-operator">=&gt;</span><span class="ruby-constant">OPTS</span>)) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">obj</span><span class="ruby-operator">|</span>
<span class="line-num">306</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">level</span>
<span class="line-num">307</span>         <span class="ruby-identifier">no_cache</span> = <span class="ruby-identifier">no_cache_level</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">values</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">la</span>)
<span class="line-num">308</span>       <span class="ruby-keyword">end</span>
<span class="line-num">309</span>       
<span class="line-num">310</span>       <span class="ruby-identifier">opk</span> = <span class="ruby-identifier">prkey_conv</span>[<span class="ruby-identifier">obj</span>]
<span class="line-num">311</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">idm_obj</span> = <span class="ruby-identifier">parent_map</span>[<span class="ruby-identifier">opk</span>]
<span class="line-num">312</span>         <span class="ruby-identifier">key_aliases</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">ka_</span><span class="ruby-operator">|</span> <span class="ruby-identifier">idm_obj</span>.<span class="ruby-identifier">values</span>[<span class="ruby-identifier">ka_</span>] = <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">values</span>[<span class="ruby-identifier">ka_</span>]}
<span class="line-num">313</span>         <span class="ruby-identifier">obj</span> = <span class="ruby-identifier">idm_obj</span>
<span class="line-num">314</span>       <span class="ruby-keyword">else</span>
<span class="line-num">315</span>         <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">associations</span>[<span class="ruby-identifier">childrena</span>] = [] <span class="ruby-keyword">unless</span> <span class="ruby-identifier">no_cache</span>
<span class="line-num">316</span>         <span class="ruby-identifier">parent_map</span>[<span class="ruby-identifier">opk</span>] = <span class="ruby-identifier">obj</span>
<span class="line-num">317</span>       <span class="ruby-keyword">end</span>
<span class="line-num">318</span>       
<span class="line-num">319</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">root</span> = <span class="ruby-identifier">id_map</span>[<span class="ruby-identifier">extract_key_alias</span>[<span class="ruby-identifier">obj</span>]].<span class="ruby-identifier">first</span>
<span class="line-num">320</span>         <span class="ruby-identifier">root</span>.<span class="ruby-identifier">associations</span>[<span class="ruby-identifier">descendants</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">obj</span>
<span class="line-num">321</span>       <span class="ruby-keyword">end</span>
<span class="line-num">322</span>       
<span class="line-num">323</span>       (<span class="ruby-identifier">children_map</span>[<span class="ruby-identifier">key_conv</span>[<span class="ruby-identifier">obj</span>]] <span class="ruby-operator">||=</span> []) <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">obj</span>
<span class="line-num">324</span>     <span class="ruby-keyword">end</span>
<span class="line-num">325</span>     <span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">synchronize_with</span>(<span class="ruby-identifier">eo</span>[<span class="ruby-value">:mutex</span>]) <span class="ruby-keyword">do</span>
<span class="line-num">326</span>       <span class="ruby-identifier">children_map</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">parent_id</span>, <span class="ruby-identifier">objs</span><span class="ruby-operator">|</span>
<span class="line-num">327</span>         <span class="ruby-identifier">objs</span> = <span class="ruby-identifier">objs</span>.<span class="ruby-identifier">uniq</span>
<span class="line-num">328</span>         <span class="ruby-identifier">parent_obj</span> = <span class="ruby-identifier">parent_map</span>[<span class="ruby-identifier">parent_id</span>]
<span class="line-num">329</span>         <span class="ruby-identifier">parent_obj</span>.<span class="ruby-identifier">associations</span>[<span class="ruby-identifier">childrena</span>] = <span class="ruby-identifier">objs</span>
<span class="line-num">330</span>         <span class="ruby-identifier">objs</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">obj</span><span class="ruby-operator">|</span>
<span class="line-num">331</span>           <span class="ruby-identifier">obj</span>.<span class="ruby-identifier">associations</span>[<span class="ruby-identifier">parent</span>] = <span class="ruby-identifier">parent_obj</span>
<span class="line-num">332</span>         <span class="ruby-keyword">end</span>
<span class="line-num">333</span>       <span class="ruby-keyword">end</span>
<span class="line-num">334</span>     <span class="ruby-keyword">end</span>
<span class="line-num">335</span>   <span class="ruby-keyword">end</span>
<span class="line-num">336</span>   <span class="ruby-identifier">model</span>.<span class="ruby-identifier">one_to_many</span> <span class="ruby-identifier">descendants</span>, <span class="ruby-identifier">d</span>
<span class="line-num">337</span> <span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
  </section>

</main>


<footer id="validator-badges" role="contentinfo">
  <p><a href="https://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="https://ruby.github.io/rdoc/">RDoc</a> 6.1.2.1.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

