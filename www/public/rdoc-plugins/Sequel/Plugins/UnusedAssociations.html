<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>module Sequel::Plugins::UnusedAssociations - Sequel: The Database Toolkit for Ruby</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "../../";
  var index_rel_prefix = "../../";
</script>

<script src="../../js/navigation.js" defer></script>
<script src="../../js/search.js" defer></script>
<script src="../../js/search_index.js" defer></script>
<script src="../../js/searcher.js" defer></script>
<script src="../../js/darkfish.js" defer></script>

<link href="../../css/fonts.css" rel="stylesheet">
<link href="../../css/rdoc.css" rel="stylesheet">




<body id="top" role="document" class="module">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../../table_of_contents.html#pages">Pages</a>
    <a href="../../table_of_contents.html#classes">Classes</a>
    <a href="../../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  
<div class="nav-section">
  <h3>Table of Contents</h3>

  <ul class="link-list" role="directory">
    <li><a href="#module-Sequel::Plugins::UnusedAssociations-label-Basic+Usage">Basic Usage</a>
    <li><a href="#module-Sequel::Plugins::UnusedAssociations-label-Combining+Coverage+Results">Combining Coverage Results</a>
    <li><a href="#module-Sequel::Plugins::UnusedAssociations-label-Automatic+Usage+of+Unused+Association+Data">Automatic Usage of Unused Association Data</a>
    <li><a href="#module-Sequel::Plugins::UnusedAssociations-label-Automatic+Usage+with+Combined+Coverage+Results">Automatic Usage with Combined Coverage Results</a>
    <li><a href="#module-Sequel::Plugins::UnusedAssociations-label-Caveats">Caveats</a>
  </ul>
</div>


  <div id="class-metadata">
    
    
    
    
    <!-- Method Quickref -->
<div id="method-list-section" class="nav-section">
  <h3>Methods</h3>

  <ul class="link-list" role="directory">
    
    <li ><a href="#method-c-apply">::apply</a>
    
    <li ><a href="#method-c-configure">::configure</a>
    
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-labelledby="module-Sequel::Plugins::UnusedAssociations">
  <h1 id="module-Sequel::Plugins::UnusedAssociations" class="module">
    module Sequel::Plugins::UnusedAssociations
  </h1>

  <section class="description">
    
<p>The unused_associations plugin detects which model associations are not used and can be removed, and which model association methods are not used and can skip being defined. The advantage of removing unused associations and unused association methods is decreased memory usage, since each method defined takes memory and adds more work for the garbage collector.</p>

<p>In order to detect which associations are used, this relies on the method coverage support added in Ruby 2.5. To allow flexibility to override association methods, the association methods that <a href="../../Sequel.html"><code>Sequel</code></a> defines are defined in a module included in the class instead of directly in the class.  Unfortunately, that makes it difficult to directly use the coverage data to find unused associations. The advantage of this plugin is that it is able to figure out from the coverage information whether the association methods <a href="../../Sequel.html"><code>Sequel</code></a> defines are actually used.</p>

<h1 id="module-Sequel::Plugins::UnusedAssociations-label-Basic+Usage">Basic Usage<span><a href="#module-Sequel::Plugins::UnusedAssociations-label-Basic+Usage">&para;</a> <a href="#top">&uarr;</a></span></h1>

<p>The expected usage of the unused_associations plugin is to load it into the base class for models in your application, which will often be Sequel::Model:</p>

<pre class="ruby"><span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:unused_associations</span>
</pre>

<p>Then you run your test suite with method coverage enabled, passing the coverage result to <code>update_associations_coverage</code>. <code>update_associations_coverage</code> returns a data structure containing method coverage information for all subclasses of the base class. You can pass the coverage information to <code>update_unused_associations_data</code>, which will return a data structure with information on unused associations.</p>

<pre class="ruby"><span class="ruby-identifier">require</span> <span class="ruby-string">&#39;coverage&#39;</span>
<span class="ruby-constant">Coverage</span>.<span class="ruby-identifier">start</span>(<span class="ruby-value">methods:</span> <span class="ruby-keyword">true</span>)
<span class="ruby-comment"># load sequel after starting coverage, then run your tests</span>
<span class="ruby-identifier">cov_data</span> = <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>.<span class="ruby-identifier">update_associations_coverage</span>
<span class="ruby-identifier">unused_associations_data</span> = <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>.<span class="ruby-identifier">update_unused_associations_data</span>(<span class="ruby-value">coverage_data:</span> <span class="ruby-identifier">cov_data</span>)
</pre>

<p>You can take that unused association data and pass it to the <code>unused_associations</code> method to get a array of information on associations which have not been used.  Each entry in the array will contain a class name and association name for each unused association, both as a string:</p>

<pre class="ruby"><span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>.<span class="ruby-identifier">unused_associations</span>(<span class="ruby-value">unused_associations_data:</span> <span class="ruby-identifier">unused_associations_data</span>)
<span class="ruby-comment"># =&gt; [[&quot;Class1&quot;, &quot;assoc1&quot;], ...]</span>
</pre>

<p>You can use the output of the <code>unused_associations</code> method to determine which associations are not used at all in your application, and can be eliminiated.</p>

<p>You can also take that unused association data and pass it to the <code>unused_association_options</code> method, which will return an array of information on associations which are used, but have related methods defined that are not used. The first two entries in each array are the class name and association name as a string, and the third entry is a hash of association options:</p>

<pre class="ruby"><span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>.<span class="ruby-identifier">unused_association_options</span>(<span class="ruby-value">unused_associations_data:</span> <span class="ruby-identifier">unused_associations_data</span>)
<span class="ruby-comment"># =&gt; [[&quot;Class2&quot;, &quot;assoc2&quot;, {:read_only=&gt;true}], ...]</span>
</pre>

<p>You can use the output of the <code>unused_association_options</code> to find out which association options can be provided when defining the association so that the association method will not define methods that are not used.</p>

<h1 id="module-Sequel::Plugins::UnusedAssociations-label-Combining+Coverage+Results">Combining Coverage Results<span><a href="#module-Sequel::Plugins::UnusedAssociations-label-Combining+Coverage+Results">&para;</a> <a href="#top">&uarr;</a></span></h1>

<p>It is common to want to combine results from multiple separate coverage runs.  For example, if you have multiple test suites for your application, one for model or unit tests and one for web or integration tests, you would want to combine the coverage information from all test suites before determining that the associations are not used.</p>

<p>The unused_associations plugin supports combining multiple coverage results using the :coverage_file plugin option:</p>

<pre class="ruby"><span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:unused_associations</span>,
  <span class="ruby-value">coverage_file:</span> <span class="ruby-string">&#39;unused_associations_coverage.json&#39;</span>
</pre>

<p>With the coverage file option, <code>update_associations_coverage</code> will look in the given file for existing coverage information, if it exists.  If the file exists, the data from it will be merged with the coverage result passed to the method. Before returning, the coverage file will be updated with the merged result.  When using the :coverage_file plugin option, you can each of your test suites update the coverage information:</p>

<pre class="ruby"><span class="ruby-identifier">require</span> <span class="ruby-string">&#39;coverage&#39;</span>
<span class="ruby-constant">Coverage</span>.<span class="ruby-identifier">start</span>(<span class="ruby-value">methods:</span> <span class="ruby-keyword">true</span>)
<span class="ruby-comment"># run this test suite</span>
<span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>.<span class="ruby-identifier">update_associations_coverage</span>
</pre>

<p>After all test suites have been run, you can run <code>update_unused_associations_data</code>, without an argument:</p>

<pre class="ruby"><span class="ruby-identifier">unused_associations_data</span> = <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>.<span class="ruby-identifier">update_unused_associations_data</span>
</pre>

<p>With no argument, <code>update_unused_associations_data</code> will get the coverage data from the coverage file, and then use that to prepare the information.  You can then use the returned value the same as before to get the data on unused associations. To prevent stale coverage information, calling <code>update_unused_associations_data</code> when using the :coverage_file plugin option will remove the coverage file by default (you can use the :keep_coverage option to prevent the deletion of the coverage file).</p>

<h1 id="module-Sequel::Plugins::UnusedAssociations-label-Automatic+Usage+of+Unused+Association+Data">Automatic Usage of Unused Association Data<span><a href="#module-Sequel::Plugins::UnusedAssociations-label-Automatic+Usage+of+Unused+Association+Data">&para;</a> <a href="#top">&uarr;</a></span></h1>

<p>Since it can be a pain to manually update all of your code to remove unused assocations or add options to prevent the definition of unused associations, the unused_associations plugin comes with support to take previously saved unused association data, and use it to not create unused associations, and to automatically use the appropriate options so that unused association methods are not created.</p>

<p>To use this option, you first need to save the unused association data previously prepared.  You can do this by passing an :file option when loading the plugin.</p>

<pre class="ruby"><span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:unused_associations</span>,
  <span class="ruby-value">file:</span> <span class="ruby-string">&#39;unused_associations.json&#39;</span>
</pre>

<p>With the :file option provided, you no longer need to use the return value of <code>update_unused_associations_data</code>, as the file will be updated with the information:</p>

<pre class="ruby"><span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>.<span class="ruby-identifier">update_unused_associations_data</span>(<span class="ruby-value">coverage_data:</span> <span class="ruby-identifier">cov_data</span>)
</pre>

<p>Then, to use the saved unused associations data, add the :modify_associations plugin option:</p>

<pre class="ruby"><span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:unused_associations</span>,
  <span class="ruby-value">file:</span> <span class="ruby-string">&#39;unused_associations.json&#39;</span>,
  <span class="ruby-value">modify_associations:</span> <span class="ruby-keyword">true</span>
</pre>

<p>With the :modify_associations used, and the unused association data file is available, when subclasses attempt to create an unused association, the attempt will be ignored.  If the subclasses attempt to create an association where not all association methods are used, the plugin will automatically set the appropriate options so that the unused association methods are not defined.</p>

<p>When you are testing which associations are used, make sure not to set the :modify_associations plugin option, or make sure that the unused associations data file does not exist.</p>

<h2 id="module-Sequel::Plugins::UnusedAssociations-label-Automatic+Usage+with+Combined+Coverage+Results">Automatic Usage with Combined Coverage Results<span><a href="#module-Sequel::Plugins::UnusedAssociations-label-Automatic+Usage+with+Combined+Coverage+Results">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>If you have multiple test suites and want to automatically use the unused association data, you should provide both :file and :coverage_file options when loading the plugin:</p>

<pre class="ruby"><span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:unused_associations</span>,
  <span class="ruby-value">file:</span> <span class="ruby-string">&#39;unused_associations.json&#39;</span>,
  <span class="ruby-value">coverage_file:</span> <span class="ruby-string">&#39;unused_associations_coverage.json&#39;</span>
</pre>

<p>Then each test suite just needs to run <code>update_associations_coverage</code> to update the coverage information:</p>

<pre class="ruby"><span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>.<span class="ruby-identifier">update_associations_coverage</span>
</pre>

<p>After all test suites have been run, you can run <code>update_unused_associations_data</code> to update the unused association data file (and remove the coverage file):</p>

<pre class="ruby"><span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>.<span class="ruby-identifier">update_unused_associations_data</span>
</pre>

<p>Then you can add the :modify_associations plugin option to automatically use the unused association data.</p>

<h1 id="module-Sequel::Plugins::UnusedAssociations-label-Caveats">Caveats<span><a href="#module-Sequel::Plugins::UnusedAssociations-label-Caveats">&para;</a> <a href="#top">&uarr;</a></span></h1>

<p>Since this plugin is based on coverage information, if you do not have tests that cover all usage of associations in your application, you can end up with coverage that shows the association is not used, when it is used in code that is not covered.  The output of plugin can still be useful in such cases, as long as you are manually checking it.  However, you should avoid using the :modify_associations unless you have confidence that your tests cover all usage of associations in your application. You can specify the :is_used association option for any association that you know is used. If an association uses the :is_used association option, this plugin will not modify it if the :modify_associations option is used.</p>

<p>This plugin does not handle anonymous classes. Any unused associations defined in anonymous classes will not be reported by this plugin.</p>

<p>This plugin only considers the public instance methods the association defines, and direct access to the related association reflection via Sequel::Model.association_reflection to determine if the association was used.  If the association metadata was accessed another way, it&#39;s possible this plugin will show the association as unused.</p>

<p>As this relies on the method coverage added in Ruby 2.5, it does not work on older versions of Ruby.  It also does not work on JRuby, as JRuby does not implement method coverage.</p>

  </section>

  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    

    

    
     <section id="public-class-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Class Methods</h3>
       </header>

    
      <div id="method-c-apply" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">apply</span><span
            class="method-args">(mod, opts=OPTS)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Load the subclasses plugin, as the unused associations plugin is designed to handle all subclasses of the class it is loaded into.</p>
          
          

          
          <div class="method-source-code" id="apply-source">
            <pre>    <span class="ruby-comment"># File lib/sequel/plugins/unused_associations.rb</span>
<span class="line-num">230</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">apply</span>(<span class="ruby-identifier">mod</span>, <span class="ruby-identifier">opts</span>=<span class="ruby-constant">OPTS</span>)
<span class="line-num">231</span>   <span class="ruby-identifier">mod</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:subclasses</span>
<span class="line-num">232</span> <span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-configure" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">configure</span><span
            class="method-args">(mod, opts=OPTS)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Plugin options:</p>
<dl class="rdoc-list note-list"><dt>:coverage_file 
<dd>
<p>The file to store the coverage information, when combining coverage information from multiple test suites.</p>
</dd><dt>:file 
<dd>
<p>The file to store and/or load the unused associations data.</p>
</dd><dt>:modify_associations 
<dd>
<p>Whether to use the unused associations data to skip defining associations or association methods.</p>
</dd><dt>:unused_associations_data 
<dd>
<p>The unused associations data to use if the :modify_associations is used (by default, the :modify_associations option will use the data from the file specified by the :file option). This is same data returned by the <code>update_unused_associations_data</code> method.</p>
</dd></dl>
          
          

          
          <div class="method-source-code" id="configure-source">
            <pre>    <span class="ruby-comment"># File lib/sequel/plugins/unused_associations.rb</span>
<span class="line-num">248</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">configure</span>(<span class="ruby-identifier">mod</span>, <span class="ruby-identifier">opts</span>=<span class="ruby-constant">OPTS</span>)
<span class="line-num">249</span>   <span class="ruby-identifier">mod</span>.<span class="ruby-identifier">instance_exec</span> <span class="ruby-keyword">do</span>
<span class="line-num">250</span>     <span class="ruby-ivar">@unused_associations_coverage_file</span> = <span class="ruby-identifier">opts</span>[<span class="ruby-value">:coverage_file</span>]
<span class="line-num">251</span>     <span class="ruby-ivar">@unused_associations_file</span> = <span class="ruby-identifier">opts</span>[<span class="ruby-value">:file</span>]
<span class="line-num">252</span>     <span class="ruby-ivar">@unused_associations_data</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">opts</span>[<span class="ruby-value">:modify_associations</span>]
<span class="line-num">253</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">opts</span>[<span class="ruby-value">:unused_associations_data</span>]
<span class="line-num">254</span>         <span class="ruby-identifier">opts</span>[<span class="ruby-value">:unused_associations_data</span>]
<span class="line-num">255</span>       <span class="ruby-keyword">elsif</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">file?</span>(<span class="ruby-identifier">opts</span>[<span class="ruby-value">:file</span>])
<span class="line-num">256</span>         <span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">parse_json</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">binread</span>(<span class="ruby-identifier">opts</span>[<span class="ruby-value">:file</span>]))
<span class="line-num">257</span>       <span class="ruby-keyword">end</span>
<span class="line-num">258</span>     <span class="ruby-keyword">end</span>
<span class="line-num">259</span>   <span class="ruby-keyword">end</span>
<span class="line-num">260</span> <span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
  </section>

</main>


<footer id="validator-badges" role="contentinfo">
  <p><a href="https://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="https://ruby.github.io/rdoc/">RDoc</a> 6.1.2.1.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

