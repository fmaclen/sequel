<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>module Sequel::Plugins::PgAutoConstraintValidations - Sequel: The Database Toolkit for Ruby</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "../../";
  var index_rel_prefix = "../../";
</script>

<script src="../../js/navigation.js" defer></script>
<script src="../../js/search.js" defer></script>
<script src="../../js/search_index.js" defer></script>
<script src="../../js/searcher.js" defer></script>
<script src="../../js/darkfish.js" defer></script>

<link href="../../css/fonts.css" rel="stylesheet">
<link href="../../css/rdoc.css" rel="stylesheet">




<body id="top" role="document" class="module">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../../table_of_contents.html#pages">Pages</a>
    <a href="../../table_of_contents.html#classes">Classes</a>
    <a href="../../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="class-metadata">
    
    
    
    
    <!-- Method Quickref -->
<div id="method-list-section" class="nav-section">
  <h3>Methods</h3>

  <ul class="link-list" role="directory">
    
    <li ><a href="#method-c-configure">::configure</a>
    
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-labelledby="module-Sequel::Plugins::PgAutoConstraintValidations">
  <h1 id="module-Sequel::Plugins::PgAutoConstraintValidations" class="module">
    module Sequel::Plugins::PgAutoConstraintValidations
  </h1>

  <section class="description">
    
<p>The pg_auto_constraint_validations plugin automatically converts some constraint violation exceptions that are raised by INSERT/UPDATE queries into validation failures.  This can allow for using the same error handling code for both regular validation errors (checked before attempting the INSERT/UPDATE), and constraint violations (raised during the INSERT/UPDATE).</p>

<p>This handles the following constraint violations:</p>
<ul><li>
<p>NOT NULL</p>
</li><li>
<p>CHECK</p>
</li><li>
<p>UNIQUE (except expression/functional indexes)</p>
</li><li>
<p>FOREIGN KEY (both referencing and referenced by)</p>
</li></ul>

<p>If the plugin cannot convert the constraint violation error to a validation error, it just reraises the initial exception, so this should not cause problems if the plugin doesn&#39;t know how to convert the exception.</p>

<p>This plugin is not intended as a replacement for other validations, it is intended as a last resort.  The purpose of validations is to provide nice error messages for the user, and the error messages generated by this plugin are fairly generic by default.  The error messages can be customized per constraint type using the :messages plugin option, and individually per constraint using <code>pg_auto_constraint_validation_override</code> (see below).</p>

<p>This plugin only works on the postgres adapter when using the pg 0.16+ driver, PostgreSQL 9.3+ server, and PostgreSQL 9.3+ client library (libpq). In other cases it will be a no-op.</p>

<p>Example:</p>

<pre class="ruby"><span class="ruby-identifier">album</span> = <span class="ruby-constant">Album</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">:artist_id</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">1</span>) <span class="ruby-comment"># Assume no such artist exists</span>
<span class="ruby-keyword">begin</span>
  <span class="ruby-identifier">album</span>.<span class="ruby-identifier">save</span>
<span class="ruby-keyword">rescue</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">ValidationFailed</span>
  <span class="ruby-identifier">album</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">on</span>(<span class="ruby-value">:artist_id</span>) <span class="ruby-comment"># [&#39;is invalid&#39;]</span>
<span class="ruby-keyword">end</span>
</pre>

<p>While the database usually provides enough information to correctly associated constraint violations with model columns, there are cases where it does not. In those cases, you can override the handling of specific constraint violations to be associated to particular column(s), and use a specific error message:</p>

<pre class="ruby"><span class="ruby-constant">Album</span>.<span class="ruby-identifier">pg_auto_constraint_validation_override</span>(<span class="ruby-value">:constraint_name</span>, [<span class="ruby-value">:column1</span>], <span class="ruby-string">&quot;validation error message&quot;</span>)
</pre>

<p>Using the pg_auto_constraint_validations plugin requires 5 queries per model at load time in order to gather the necessary metadata.  For applications with a large number of models, this can result in a noticeable delay during model initialization.  To mitigate this issue, you can cache the necessary metadata in a file with the :cache_file option:</p>

<pre class="ruby"><span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:pg_auto_constraint_validations</span>, <span class="ruby-value">cache_file:</span> <span class="ruby-string">&#39;db/pgacv.cache&#39;</span>
</pre>

<p>The file does not have to exist when loading the plugin.  If it exists, the plugin will load the cache and use the cached results instead of issuing queries if there is an entry in the cache.  If there is no entry in the cache, it will update the in-memory cache with the metadata results.  To save the in in-memory cache back to the cache file, run:</p>

<pre class="ruby"><span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>.<span class="ruby-identifier">dump_pg_auto_constraint_validations_cache</span>
</pre>

<p>Note that when using the :cache_file option, it is up to the application to ensure that the dumped cached metadata reflects the current state of the database.  <a href="../../Sequel.html"><code>Sequel</code></a> does no checking to ensure this, as checking would take time and the purpose of this code is to take a shortcut.</p>

<p>The cached schema is dumped in Marshal format, since it is the fastest and it handles all ruby objects used in the metadata.  Because of this, you should not attempt to load the metadata from a untrusted file.</p>

<p>Usage:</p>

<pre class="ruby"><span class="ruby-comment"># Make all model subclasses automatically convert constraint violations</span>
<span class="ruby-comment"># to validation failures (called before loading subclasses)</span>
<span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:pg_auto_constraint_validations</span>

<span class="ruby-comment"># Make the Album class automatically convert constraint violations</span>
<span class="ruby-comment"># to validation failures</span>
<span class="ruby-constant">Album</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:pg_auto_constraint_validations</span>
</pre>

  </section>

  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    
    <section class="constants-list">
      <header>
        <h3>Constants</h3>
      </header>
      <dl>
      
        <dt id="DEFAULT_ERROR_MESSAGES">DEFAULT_ERROR_MESSAGES
        
        <dd><p>The default error messages for each constraint violation type.</p>
        
      
      </dl>
    </section>
    

    

    
     <section id="public-class-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Class Methods</h3>
       </header>

    
      <div id="method-c-configure" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">configure</span><span
            class="method-args">(model, opts=OPTS)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Setup the constraint violation metadata.  Options:</p>
<dl class="rdoc-list note-list"><dt>:cache_file 
<dd>
<p>File storing cached metadata, to avoid queries for each model</p>
</dd><dt>:messages 
<dd>
<p>Override the default error messages for each constraint violation type (:not_null, :check, :unique, :foreign_key, :referenced_by)</p>
</dd></dl>
          
          

          
          <div class="method-source-code" id="configure-source">
            <pre>    <span class="ruby-comment"># File lib/sequel/plugins/pg_auto_constraint_validations.rb</span>
<span class="line-num"> 98</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">configure</span>(<span class="ruby-identifier">model</span>, <span class="ruby-identifier">opts</span>=<span class="ruby-constant">OPTS</span>)
<span class="line-num"> 99</span>   <span class="ruby-identifier">model</span>.<span class="ruby-identifier">instance_exec</span> <span class="ruby-keyword">do</span>
<span class="line-num">100</span>     <span class="ruby-keyword">if</span> <span class="ruby-ivar">@pg_auto_constraint_validations_cache_file</span> = <span class="ruby-identifier">opts</span>[<span class="ruby-value">:cache_file</span>]
<span class="line-num">101</span>       <span class="ruby-ivar">@pg_auto_constraint_validations_cache</span> = <span class="ruby-keyword">if</span> <span class="ruby-operator">::</span><span class="ruby-constant">File</span>.<span class="ruby-identifier">file?</span>(<span class="ruby-ivar">@pg_auto_constraint_validations_cache_file</span>)
<span class="line-num">102</span>         <span class="ruby-identifier">cache</span> = <span class="ruby-constant">Marshal</span>.<span class="ruby-identifier">load</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">read</span>(<span class="ruby-ivar">@pg_auto_constraint_validations_cache_file</span>))
<span class="line-num">103</span>         <span class="ruby-identifier">cache</span>.<span class="ruby-identifier">each_value</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">hash</span><span class="ruby-operator">|</span>
<span class="line-num">104</span>           <span class="ruby-identifier">hash</span>.<span class="ruby-identifier">freeze</span>.<span class="ruby-identifier">each_value</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:freeze</span>)
<span class="line-num">105</span>         <span class="ruby-keyword">end</span>
<span class="line-num">106</span>       <span class="ruby-keyword">else</span>
<span class="line-num">107</span>         {}
<span class="line-num">108</span>       <span class="ruby-keyword">end</span>
<span class="line-num">109</span>     <span class="ruby-keyword">else</span>
<span class="line-num">110</span>       <span class="ruby-ivar">@pg_auto_constraint_validations_cache</span> = <span class="ruby-keyword">nil</span>
<span class="line-num">111</span>     <span class="ruby-keyword">end</span>
<span class="line-num">112</span> 
<span class="line-num">113</span>     <span class="ruby-identifier">setup_pg_auto_constraint_validations</span>
<span class="line-num">114</span>     <span class="ruby-ivar">@pg_auto_constraint_validations_messages</span> = (<span class="ruby-ivar">@pg_auto_constraint_validations_messages</span> <span class="ruby-operator">||</span> <span class="ruby-constant">DEFAULT_ERROR_MESSAGES</span>).<span class="ruby-identifier">merge</span>(<span class="ruby-identifier">opts</span>[<span class="ruby-value">:messages</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">OPTS</span>).<span class="ruby-identifier">freeze</span>
<span class="line-num">115</span>   <span class="ruby-keyword">end</span>
<span class="line-num">116</span>   <span class="ruby-keyword">nil</span>
<span class="line-num">117</span> <span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
  </section>

</main>


<footer id="validator-badges" role="contentinfo">
  <p><a href="https://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="https://ruby.github.io/rdoc/">RDoc</a> 6.1.2.1.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

