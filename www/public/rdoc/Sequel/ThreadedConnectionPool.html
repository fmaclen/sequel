<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>class Sequel::ThreadedConnectionPool - Sequel: The Database Toolkit for Ruby</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "../";
  var index_rel_prefix = "../";
</script>

<script src="../js/navigation.js" defer></script>
<script src="../js/search.js" defer></script>
<script src="../js/search_index.js" defer></script>
<script src="../js/searcher.js" defer></script>
<script src="../js/darkfish.js" defer></script>

<link href="../css/fonts.css" rel="stylesheet">
<link href="../css/rdoc.css" rel="stylesheet">




<body id="top" role="document" class="class">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../table_of_contents.html#pages">Pages</a>
    <a href="../table_of_contents.html#classes">Classes</a>
    <a href="../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="class-metadata">
    
    <div id="parent-class-section" class="nav-section">
  <h3>Parent</h3>

  
  <p class="link"><a href="ConnectionPool.html">Sequel::ConnectionPool</a>
  
</div>

    
    
    <!-- Method Quickref -->
<div id="method-list-section" class="nav-section">
  <h3>Methods</h3>

  <ul class="link-list" role="directory">
    
    <li class="calls-super" ><a href="#method-c-new">::new</a>
    
    <li ><a href="#method-i-all_connections">#all_connections</a>
    
    <li ><a href="#method-i-disconnect">#disconnect</a>
    
    <li ><a href="#method-i-hold">#hold</a>
    
    <li ><a href="#method-i-pool_type">#pool_type</a>
    
    <li ><a href="#method-i-size">#size</a>
    
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-labelledby="class-Sequel::ThreadedConnectionPool">
  <h1 id="class-Sequel::ThreadedConnectionPool" class="class">
    class Sequel::ThreadedConnectionPool
  </h1>

  <section class="description">
    
<p>A connection pool allowing multi-threaded access to a pool of connections. This is the default connection pool used by <a href="../Sequel.html"><code>Sequel</code></a>.</p>

  </section>

  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    
    <section class="constants-list">
      <header>
        <h3>Constants</h3>
      </header>
      <dl>
      
        <dt id="USE_WAITER">USE_WAITER
        
        <dd>
        
      
      </dl>
    </section>
    

    
    <section class="attribute-method-details" class="method-section">
      <header>
        <h3>Attributes</h3>
      </header>

      
      <div id="attribute-i-allocated" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">allocated</span><span
            class="attribute-access-type">[R]</span>
        </div>

        <div class="method-description">
        
        <p>A hash with thread keys and connection values for currently allocated connections. The calling code should already have the mutex before calling this.</p>
        
        </div>
      </div>
      
      <div id="attribute-i-available_connections" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">available_connections</span><span
            class="attribute-access-type">[R]</span>
        </div>

        <div class="method-description">
        
        <p>An array of connections that are available for use by the pool. The calling code should already have the mutex before calling this.</p>
        
        </div>
      </div>
      
      <div id="attribute-i-max_size" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">max_size</span><span
            class="attribute-access-type">[R]</span>
        </div>

        <div class="method-description">
        
        <p>The maximum number of connections this pool will create (per shard/server if sharding).</p>
        
        </div>
      </div>
      
    </section>
    

    
     <section id="public-class-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Class Methods</h3>
       </header>

    
      <div id="method-c-new" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new</span><span
            class="method-args">(db, opts = OPTS)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>The following additional options are respected:</p>
<dl class="rdoc-list note-list"><dt>:max_connections 
<dd>
<p>The maximum number of connections the connection pool will open (default 4)</p>
</dd><dt>:pool_timeout 
<dd>
<p>The amount of seconds to wait to acquire a connection before raising a PoolTimeoutError (default 5)</p>
</dd></dl>
          
          
            <div class="method-calls-super">
              Calls superclass method
              <a href="ConnectionPool.html#method-c-new"><code>Sequel::ConnectionPool::new</code></a>
            </div>
          

          
          <div class="method-source-code" id="new-source">
            <pre>   <span class="ruby-comment"># File lib/sequel/connection_pool/threaded.rb</span>
<span class="line-num">26</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">initialize</span>(<span class="ruby-identifier">db</span>, <span class="ruby-identifier">opts</span> = <span class="ruby-constant">OPTS</span>)
<span class="line-num">27</span>   <span class="ruby-keyword">super</span>
<span class="line-num">28</span>   <span class="ruby-ivar">@max_size</span> = <span class="ruby-constant">Integer</span>(<span class="ruby-identifier">opts</span>[<span class="ruby-value">:max_connections</span>] <span class="ruby-operator">||</span> <span class="ruby-value">4</span>)
<span class="line-num">29</span>   <span class="ruby-identifier">raise</span>(<span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span>, <span class="ruby-string">&#39;:max_connections must be positive&#39;</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@max_size</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">1</span>
<span class="line-num">30</span>   <span class="ruby-ivar">@mutex</span> = <span class="ruby-constant">Mutex</span>.<span class="ruby-identifier">new</span>  
<span class="line-num">31</span>   <span class="ruby-ivar">@connection_handling</span> = <span class="ruby-identifier">opts</span>[<span class="ruby-value">:connection_handling</span>]
<span class="line-num">32</span>   <span class="ruby-ivar">@available_connections</span> = []
<span class="line-num">33</span>   <span class="ruby-ivar">@allocated</span> = {}
<span class="line-num">34</span>   <span class="ruby-ivar">@timeout</span> = <span class="ruby-constant">Float</span>(<span class="ruby-identifier">opts</span>[<span class="ruby-value">:pool_timeout</span>] <span class="ruby-operator">||</span> <span class="ruby-value">5</span>)
<span class="line-num">35</span>   <span class="ruby-ivar">@waiter</span> = <span class="ruby-constant">ConditionVariable</span>.<span class="ruby-identifier">new</span>
<span class="line-num">36</span> <span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Instance Methods</h3>
       </header>

    
      <div id="method-i-all_connections" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">all_connections</span><span
            class="method-args">() { |c| ... }</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Yield all of the available connections, and the one currently allocated to this thread.  This will not yield connections currently allocated to other threads, as it is not safe to operate on them.  This holds the mutex while it is yielding all of the available connections, which means that until the method&#39;s block returns, the pool is locked.</p>
          
          

          
          <div class="method-source-code" id="all_connections-source">
            <pre>   <span class="ruby-comment"># File lib/sequel/connection_pool/threaded.rb</span>
<span class="line-num">43</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">all_connections</span>
<span class="line-num">44</span>   <span class="ruby-identifier">hold</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span>
<span class="line-num">45</span>     <span class="ruby-identifier">sync</span> <span class="ruby-keyword">do</span>
<span class="line-num">46</span>       <span class="ruby-keyword">yield</span> <span class="ruby-identifier">c</span>
<span class="line-num">47</span>       <span class="ruby-ivar">@available_connections</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">conn</span><span class="ruby-operator">|</span> <span class="ruby-keyword">yield</span> <span class="ruby-identifier">conn</span>}
<span class="line-num">48</span>     <span class="ruby-keyword">end</span>
<span class="line-num">49</span>   <span class="ruby-keyword">end</span>
<span class="line-num">50</span> <span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-disconnect" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">disconnect</span><span
            class="method-args">(opts=OPTS)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Removes all connections currently available, optionally yielding each connection to the given block. This method has the effect of  disconnecting from the database, assuming that no connections are currently being used.  If you want to be able to disconnect connections that are currently in use, use the ShardedThreadedConnectionPool, which can do that. This connection pool does not, for performance reasons. To use the sharded pool, pass the <code>servers: {}</code> option when connecting to the database.</p>

<p>Once a connection is requested using <a href="ThreadedConnectionPool.html#method-i-hold"><code>hold</code></a>, the connection pool creates new connections to the database.</p>
          
          

          
          <div class="method-source-code" id="disconnect-source">
            <pre>   <span class="ruby-comment"># File lib/sequel/connection_pool/threaded.rb</span>
<span class="line-num">62</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">disconnect</span>(<span class="ruby-identifier">opts</span>=<span class="ruby-constant">OPTS</span>)
<span class="line-num">63</span>   <span class="ruby-identifier">conns</span> = <span class="ruby-keyword">nil</span>
<span class="line-num">64</span>   <span class="ruby-identifier">sync</span> <span class="ruby-keyword">do</span>
<span class="line-num">65</span>     <span class="ruby-identifier">conns</span> = <span class="ruby-ivar">@available_connections</span>.<span class="ruby-identifier">dup</span>
<span class="line-num">66</span>     <span class="ruby-ivar">@available_connections</span>.<span class="ruby-identifier">clear</span>
<span class="line-num">67</span>     <span class="ruby-ivar">@waiter</span>.<span class="ruby-identifier">signal</span>
<span class="line-num">68</span>   <span class="ruby-keyword">end</span>
<span class="line-num">69</span>   <span class="ruby-identifier">conns</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">conn</span><span class="ruby-operator">|</span> <span class="ruby-identifier">disconnect_connection</span>(<span class="ruby-identifier">conn</span>)}
<span class="line-num">70</span> <span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-hold" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">hold</span><span
            class="method-args">(server=nil) { |conn| ... }</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Chooses the first available connection, or if none are available, creates a new connection.  Passes the connection to the supplied block:</p>

<pre class="ruby"><span class="ruby-identifier">pool</span>.<span class="ruby-identifier">hold</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">conn</span><span class="ruby-operator">|</span> <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-string">&#39;DROP TABLE posts&#39;</span>)}
</pre>

<p>Pool#hold is re-entrant, meaning it can be called recursively in the same thread without blocking.</p>

<p>If no connection is immediately available and the pool is already using the maximum number of connections, Pool#hold will block until a connection is available or the timeout expires.  If the timeout expires before a connection can be acquired, a Sequel::PoolTimeout is raised.</p>
          
          

          
          <div class="method-source-code" id="hold-source">
            <pre>    <span class="ruby-comment"># File lib/sequel/connection_pool/threaded.rb</span>
<span class="line-num"> 85</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">hold</span>(<span class="ruby-identifier">server</span>=<span class="ruby-keyword">nil</span>)
<span class="line-num"> 86</span>   <span class="ruby-identifier">t</span> = <span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">current</span>
<span class="line-num"> 87</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">conn</span> = <span class="ruby-identifier">owned_connection</span>(<span class="ruby-identifier">t</span>)
<span class="line-num"> 88</span>     <span class="ruby-keyword">return</span> <span class="ruby-keyword">yield</span>(<span class="ruby-identifier">conn</span>)
<span class="line-num"> 89</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 90</span>   <span class="ruby-keyword">begin</span>
<span class="line-num"> 91</span>     <span class="ruby-identifier">conn</span> = <span class="ruby-identifier">acquire</span>(<span class="ruby-identifier">t</span>)
<span class="line-num"> 92</span>     <span class="ruby-keyword">yield</span> <span class="ruby-identifier">conn</span>
<span class="line-num"> 93</span>   <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">DatabaseDisconnectError</span>, <span class="ruby-operator">*</span><span class="ruby-ivar">@error_classes</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
<span class="line-num"> 94</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">disconnect_error?</span>(<span class="ruby-identifier">e</span>)
<span class="line-num"> 95</span>       <span class="ruby-identifier">oconn</span> = <span class="ruby-identifier">conn</span>
<span class="line-num"> 96</span>       <span class="ruby-identifier">conn</span> = <span class="ruby-keyword">nil</span>
<span class="line-num"> 97</span>       <span class="ruby-identifier">disconnect_connection</span>(<span class="ruby-identifier">oconn</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">oconn</span>
<span class="line-num"> 98</span>       <span class="ruby-identifier">sync</span> <span class="ruby-keyword">do</span> 
<span class="line-num"> 99</span>         <span class="ruby-ivar">@allocated</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">t</span>)
<span class="line-num">100</span>         <span class="ruby-ivar">@waiter</span>.<span class="ruby-identifier">signal</span>
<span class="line-num">101</span>       <span class="ruby-keyword">end</span>
<span class="line-num">102</span>     <span class="ruby-keyword">end</span>
<span class="line-num">103</span>     <span class="ruby-identifier">raise</span>
<span class="line-num">104</span>   <span class="ruby-keyword">ensure</span>
<span class="line-num">105</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">conn</span>
<span class="line-num">106</span>       <span class="ruby-identifier">sync</span>{<span class="ruby-identifier">release</span>(<span class="ruby-identifier">t</span>)}
<span class="line-num">107</span>       <span class="ruby-keyword">if</span> <span class="ruby-ivar">@connection_handling</span> <span class="ruby-operator">==</span> <span class="ruby-value">:disconnect</span>
<span class="line-num">108</span>         <span class="ruby-identifier">disconnect_connection</span>(<span class="ruby-identifier">conn</span>)
<span class="line-num">109</span>       <span class="ruby-keyword">end</span>
<span class="line-num">110</span>     <span class="ruby-keyword">end</span>
<span class="line-num">111</span>   <span class="ruby-keyword">end</span>
<span class="line-num">112</span> <span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-pool_type" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">pool_type</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="pool_type-source">
            <pre>    <span class="ruby-comment"># File lib/sequel/connection_pool/threaded.rb</span>
<span class="line-num">114</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">pool_type</span>
<span class="line-num">115</span>   <span class="ruby-value">:threaded</span>
<span class="line-num">116</span> <span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-size" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">size</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>The total number of connections opened, either available or allocated. The calling code should not have the mutex before calling this.</p>
          
          

          
          <div class="method-source-code" id="size-source">
            <pre>    <span class="ruby-comment"># File lib/sequel/connection_pool/threaded.rb</span>
<span class="line-num">120</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">size</span>
<span class="line-num">121</span>   <span class="ruby-ivar">@mutex</span>.<span class="ruby-identifier">synchronize</span>{<span class="ruby-identifier">_size</span>}
<span class="line-num">122</span> <span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
  </section>

</main>


<footer id="validator-badges" role="contentinfo">
  <p><a href="https://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="https://ruby.github.io/rdoc/">RDoc</a> 6.1.2.1.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

