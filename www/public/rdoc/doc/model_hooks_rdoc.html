<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>model_hooks - Sequel: The Database Toolkit for Ruby</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "../";
  var index_rel_prefix = "../";
</script>

<script src="../js/navigation.js" defer></script>
<script src="../js/search.js" defer></script>
<script src="../js/search_index.js" defer></script>
<script src="../js/searcher.js" defer></script>
<script src="../js/darkfish.js" defer></script>

<link href="../css/fonts.css" rel="stylesheet">
<link href="../css/rdoc.css" rel="stylesheet">




<body id="top" role="document" class="file">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../table_of_contents.html#pages">Pages</a>
    <a href="../table_of_contents.html#classes">Classes</a>
    <a href="../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  
<div class="nav-section">
  <h3>Table of Contents</h3>

  <ul class="link-list" role="directory">
    <li><a href="#label-Model+Hooks">Model Hooks</a>
    <li><a href="#label-Overview">Overview</a>
    <li><a href="#label-Basic+Usage">Basic Usage</a>
    <li><a href="#label-Available+Hooks">Available Hooks</a>
    <li><a href="#label-Transaction-related+Hooks">Transaction-related Hooks</a>
    <li><a href="#label-Running+Hooks">Running Hooks</a>
    <li><a href="#label-Skipping+Hooks">Skipping Hooks</a>
    <li><a href="#label-Canceling+Actions+in+Hooks">Canceling Actions in Hooks</a>
    <li><a href="#label-Conditional+Hooks">Conditional Hooks</a>
    <li><a href="#label-Using+Hooks+in+Multiple+Classes">Using Hooks in Multiple Classes</a>
    <li><a href="#label-Plugin">Plugin</a>
    <li><a href="#label-Simple+Module">Simple Module</a>
    <li><a href="#label-super+Ordering"><code>super</code> Ordering</a>
    <li><a href="#label-Around+Hooks">Around Hooks</a>
    <li><a href="#label-Hook+related+plugins">Hook related plugins</a>
    <li><a href="#label-instance_hooks"><code>instance_hooks</code></a>
    <li><a href="#label-hook_class_methods"><code>hook_class_methods</code></a>
    <li><a href="#label-after_initialize"><code>after_initialize</code></a>
  </ul>
</div>


  <div id="project-metadata">
    <div id="fileindex-section" class="nav-section">
  <h3>Pages</h3>

  <ul class="link-list">
  
    <li><a href="../CHANGELOG.html">CHANGELOG</a>
  
    <li><a href="../MIT-LICENSE.html">MIT-LICENSE</a>
  
    <li><a href="../README_rdoc.html">README</a>
  
    <li><a href="../doc/CHANGELOG_old.html">CHANGELOG.old</a>
  
    <li><a href="../doc/advanced_associations_rdoc.html">advanced_associations</a>
  
    <li><a href="../doc/association_basics_rdoc.html">association_basics</a>
  
    <li><a href="../doc/bin_sequel_rdoc.html">bin_sequel</a>
  
    <li><a href="../doc/cheat_sheet_rdoc.html">cheat_sheet</a>
  
    <li><a href="../doc/code_order_rdoc.html">code_order</a>
  
    <li><a href="../doc/core_extensions_rdoc.html">core_extensions</a>
  
    <li><a href="../doc/dataset_basics_rdoc.html">dataset_basics</a>
  
    <li><a href="../doc/dataset_filtering_rdoc.html">dataset_filtering</a>
  
    <li><a href="../doc/extensions_rdoc.html">extensions</a>
  
    <li><a href="../doc/fork_safety_rdoc.html">fork_safety</a>
  
    <li><a href="../doc/mass_assignment_rdoc.html">mass_assignment</a>
  
    <li><a href="../doc/migration_rdoc.html">migration</a>
  
    <li><a href="../doc/model_dataset_method_design_rdoc.html">model_dataset_method_design</a>
  
    <li><a href="../doc/model_hooks_rdoc.html">model_hooks</a>
  
    <li><a href="../doc/model_plugins_rdoc.html">model_plugins</a>
  
    <li><a href="../doc/mssql_stored_procedures_rdoc.html">mssql_stored_procedures</a>
  
    <li><a href="../doc/object_model_rdoc.html">object_model</a>
  
    <li><a href="../doc/opening_databases_rdoc.html">opening_databases</a>
  
    <li><a href="../doc/postgresql_rdoc.html">postgresql</a>
  
    <li><a href="../doc/prepared_statements_rdoc.html">prepared_statements</a>
  
    <li><a href="../doc/querying_rdoc.html">querying</a>
  
    <li><a href="../doc/reflection_rdoc.html">reflection</a>
  
    <li><a href="../doc/release_notes/1_0_txt.html">1.0</a>
  
    <li><a href="../doc/release_notes/1_1_txt.html">1.1</a>
  
    <li><a href="../doc/release_notes/1_3_txt.html">1.3</a>
  
    <li><a href="../doc/release_notes/1_4_0_txt.html">1.4.0</a>
  
    <li><a href="../doc/release_notes/1_5_0_txt.html">1.5.0</a>
  
    <li><a href="../doc/release_notes/2_0_0_txt.html">2.0.0</a>
  
    <li><a href="../doc/release_notes/2_1_0_txt.html">2.1.0</a>
  
    <li><a href="../doc/release_notes/2_10_0_txt.html">2.10.0</a>
  
    <li><a href="../doc/release_notes/2_11_0_txt.html">2.11.0</a>
  
    <li><a href="../doc/release_notes/2_12_0_txt.html">2.12.0</a>
  
    <li><a href="../doc/release_notes/2_2_0_txt.html">2.2.0</a>
  
    <li><a href="../doc/release_notes/2_3_0_txt.html">2.3.0</a>
  
    <li><a href="../doc/release_notes/2_4_0_txt.html">2.4.0</a>
  
    <li><a href="../doc/release_notes/2_5_0_txt.html">2.5.0</a>
  
    <li><a href="../doc/release_notes/2_6_0_txt.html">2.6.0</a>
  
    <li><a href="../doc/release_notes/2_7_0_txt.html">2.7.0</a>
  
    <li><a href="../doc/release_notes/2_8_0_txt.html">2.8.0</a>
  
    <li><a href="../doc/release_notes/2_9_0_txt.html">2.9.0</a>
  
    <li><a href="../doc/release_notes/3_0_0_txt.html">3.0.0</a>
  
    <li><a href="../doc/release_notes/3_1_0_txt.html">3.1.0</a>
  
    <li><a href="../doc/release_notes/3_10_0_txt.html">3.10.0</a>
  
    <li><a href="../doc/release_notes/3_11_0_txt.html">3.11.0</a>
  
    <li><a href="../doc/release_notes/3_12_0_txt.html">3.12.0</a>
  
    <li><a href="../doc/release_notes/3_13_0_txt.html">3.13.0</a>
  
    <li><a href="../doc/release_notes/3_14_0_txt.html">3.14.0</a>
  
    <li><a href="../doc/release_notes/3_15_0_txt.html">3.15.0</a>
  
    <li><a href="../doc/release_notes/3_16_0_txt.html">3.16.0</a>
  
    <li><a href="../doc/release_notes/3_17_0_txt.html">3.17.0</a>
  
    <li><a href="../doc/release_notes/3_18_0_txt.html">3.18.0</a>
  
    <li><a href="../doc/release_notes/3_19_0_txt.html">3.19.0</a>
  
    <li><a href="../doc/release_notes/3_2_0_txt.html">3.2.0</a>
  
    <li><a href="../doc/release_notes/3_20_0_txt.html">3.20.0</a>
  
    <li><a href="../doc/release_notes/3_21_0_txt.html">3.21.0</a>
  
    <li><a href="../doc/release_notes/3_22_0_txt.html">3.22.0</a>
  
    <li><a href="../doc/release_notes/3_23_0_txt.html">3.23.0</a>
  
    <li><a href="../doc/release_notes/3_24_0_txt.html">3.24.0</a>
  
    <li><a href="../doc/release_notes/3_25_0_txt.html">3.25.0</a>
  
    <li><a href="../doc/release_notes/3_26_0_txt.html">3.26.0</a>
  
    <li><a href="../doc/release_notes/3_27_0_txt.html">3.27.0</a>
  
    <li><a href="../doc/release_notes/3_28_0_txt.html">3.28.0</a>
  
    <li><a href="../doc/release_notes/3_29_0_txt.html">3.29.0</a>
  
    <li><a href="../doc/release_notes/3_3_0_txt.html">3.3.0</a>
  
    <li><a href="../doc/release_notes/3_30_0_txt.html">3.30.0</a>
  
    <li><a href="../doc/release_notes/3_31_0_txt.html">3.31.0</a>
  
    <li><a href="../doc/release_notes/3_32_0_txt.html">3.32.0</a>
  
    <li><a href="../doc/release_notes/3_33_0_txt.html">3.33.0</a>
  
    <li><a href="../doc/release_notes/3_34_0_txt.html">3.34.0</a>
  
    <li><a href="../doc/release_notes/3_35_0_txt.html">3.35.0</a>
  
    <li><a href="../doc/release_notes/3_36_0_txt.html">3.36.0</a>
  
    <li><a href="../doc/release_notes/3_37_0_txt.html">3.37.0</a>
  
    <li><a href="../doc/release_notes/3_38_0_txt.html">3.38.0</a>
  
    <li><a href="../doc/release_notes/3_39_0_txt.html">3.39.0</a>
  
    <li><a href="../doc/release_notes/3_4_0_txt.html">3.4.0</a>
  
    <li><a href="../doc/release_notes/3_40_0_txt.html">3.40.0</a>
  
    <li><a href="../doc/release_notes/3_41_0_txt.html">3.41.0</a>
  
    <li><a href="../doc/release_notes/3_42_0_txt.html">3.42.0</a>
  
    <li><a href="../doc/release_notes/3_43_0_txt.html">3.43.0</a>
  
    <li><a href="../doc/release_notes/3_44_0_txt.html">3.44.0</a>
  
    <li><a href="../doc/release_notes/3_45_0_txt.html">3.45.0</a>
  
    <li><a href="../doc/release_notes/3_46_0_txt.html">3.46.0</a>
  
    <li><a href="../doc/release_notes/3_47_0_txt.html">3.47.0</a>
  
    <li><a href="../doc/release_notes/3_48_0_txt.html">3.48.0</a>
  
    <li><a href="../doc/release_notes/3_5_0_txt.html">3.5.0</a>
  
    <li><a href="../doc/release_notes/3_6_0_txt.html">3.6.0</a>
  
    <li><a href="../doc/release_notes/3_7_0_txt.html">3.7.0</a>
  
    <li><a href="../doc/release_notes/3_8_0_txt.html">3.8.0</a>
  
    <li><a href="../doc/release_notes/3_9_0_txt.html">3.9.0</a>
  
    <li><a href="../doc/release_notes/4_0_0_txt.html">4.0.0</a>
  
    <li><a href="../doc/release_notes/4_1_0_txt.html">4.1.0</a>
  
    <li><a href="../doc/release_notes/4_10_0_txt.html">4.10.0</a>
  
    <li><a href="../doc/release_notes/4_11_0_txt.html">4.11.0</a>
  
    <li><a href="../doc/release_notes/4_12_0_txt.html">4.12.0</a>
  
    <li><a href="../doc/release_notes/4_13_0_txt.html">4.13.0</a>
  
    <li><a href="../doc/release_notes/4_14_0_txt.html">4.14.0</a>
  
    <li><a href="../doc/release_notes/4_15_0_txt.html">4.15.0</a>
  
    <li><a href="../doc/release_notes/4_16_0_txt.html">4.16.0</a>
  
    <li><a href="../doc/release_notes/4_17_0_txt.html">4.17.0</a>
  
    <li><a href="../doc/release_notes/4_18_0_txt.html">4.18.0</a>
  
    <li><a href="../doc/release_notes/4_19_0_txt.html">4.19.0</a>
  
    <li><a href="../doc/release_notes/4_2_0_txt.html">4.2.0</a>
  
    <li><a href="../doc/release_notes/4_20_0_txt.html">4.20.0</a>
  
    <li><a href="../doc/release_notes/4_21_0_txt.html">4.21.0</a>
  
    <li><a href="../doc/release_notes/4_22_0_txt.html">4.22.0</a>
  
    <li><a href="../doc/release_notes/4_23_0_txt.html">4.23.0</a>
  
    <li><a href="../doc/release_notes/4_24_0_txt.html">4.24.0</a>
  
    <li><a href="../doc/release_notes/4_25_0_txt.html">4.25.0</a>
  
    <li><a href="../doc/release_notes/4_26_0_txt.html">4.26.0</a>
  
    <li><a href="../doc/release_notes/4_27_0_txt.html">4.27.0</a>
  
    <li><a href="../doc/release_notes/4_28_0_txt.html">4.28.0</a>
  
    <li><a href="../doc/release_notes/4_29_0_txt.html">4.29.0</a>
  
    <li><a href="../doc/release_notes/4_3_0_txt.html">4.3.0</a>
  
    <li><a href="../doc/release_notes/4_30_0_txt.html">4.30.0</a>
  
    <li><a href="../doc/release_notes/4_31_0_txt.html">4.31.0</a>
  
    <li><a href="../doc/release_notes/4_32_0_txt.html">4.32.0</a>
  
    <li><a href="../doc/release_notes/4_33_0_txt.html">4.33.0</a>
  
    <li><a href="../doc/release_notes/4_34_0_txt.html">4.34.0</a>
  
    <li><a href="../doc/release_notes/4_35_0_txt.html">4.35.0</a>
  
    <li><a href="../doc/release_notes/4_36_0_txt.html">4.36.0</a>
  
    <li><a href="../doc/release_notes/4_37_0_txt.html">4.37.0</a>
  
    <li><a href="../doc/release_notes/4_38_0_txt.html">4.38.0</a>
  
    <li><a href="../doc/release_notes/4_39_0_txt.html">4.39.0</a>
  
    <li><a href="../doc/release_notes/4_4_0_txt.html">4.4.0</a>
  
    <li><a href="../doc/release_notes/4_40_0_txt.html">4.40.0</a>
  
    <li><a href="../doc/release_notes/4_41_0_txt.html">4.41.0</a>
  
    <li><a href="../doc/release_notes/4_42_0_txt.html">4.42.0</a>
  
    <li><a href="../doc/release_notes/4_43_0_txt.html">4.43.0</a>
  
    <li><a href="../doc/release_notes/4_44_0_txt.html">4.44.0</a>
  
    <li><a href="../doc/release_notes/4_45_0_txt.html">4.45.0</a>
  
    <li><a href="../doc/release_notes/4_46_0_txt.html">4.46.0</a>
  
    <li><a href="../doc/release_notes/4_47_0_txt.html">4.47.0</a>
  
    <li><a href="../doc/release_notes/4_48_0_txt.html">4.48.0</a>
  
    <li><a href="../doc/release_notes/4_49_0_txt.html">4.49.0</a>
  
    <li><a href="../doc/release_notes/4_5_0_txt.html">4.5.0</a>
  
    <li><a href="../doc/release_notes/4_6_0_txt.html">4.6.0</a>
  
    <li><a href="../doc/release_notes/4_7_0_txt.html">4.7.0</a>
  
    <li><a href="../doc/release_notes/4_8_0_txt.html">4.8.0</a>
  
    <li><a href="../doc/release_notes/4_9_0_txt.html">4.9.0</a>
  
    <li><a href="../doc/release_notes/5_0_0_txt.html">5.0.0</a>
  
    <li><a href="../doc/release_notes/5_1_0_txt.html">5.1.0</a>
  
    <li><a href="../doc/release_notes/5_10_0_txt.html">5.10.0</a>
  
    <li><a href="../doc/release_notes/5_11_0_txt.html">5.11.0</a>
  
    <li><a href="../doc/release_notes/5_12_0_txt.html">5.12.0</a>
  
    <li><a href="../doc/release_notes/5_13_0_txt.html">5.13.0</a>
  
    <li><a href="../doc/release_notes/5_14_0_txt.html">5.14.0</a>
  
    <li><a href="../doc/release_notes/5_15_0_txt.html">5.15.0</a>
  
    <li><a href="../doc/release_notes/5_16_0_txt.html">5.16.0</a>
  
    <li><a href="../doc/release_notes/5_17_0_txt.html">5.17.0</a>
  
    <li><a href="../doc/release_notes/5_18_0_txt.html">5.18.0</a>
  
    <li><a href="../doc/release_notes/5_19_0_txt.html">5.19.0</a>
  
    <li><a href="../doc/release_notes/5_2_0_txt.html">5.2.0</a>
  
    <li><a href="../doc/release_notes/5_20_0_txt.html">5.20.0</a>
  
    <li><a href="../doc/release_notes/5_21_0_txt.html">5.21.0</a>
  
    <li><a href="../doc/release_notes/5_22_0_txt.html">5.22.0</a>
  
    <li><a href="../doc/release_notes/5_23_0_txt.html">5.23.0</a>
  
    <li><a href="../doc/release_notes/5_24_0_txt.html">5.24.0</a>
  
    <li><a href="../doc/release_notes/5_25_0_txt.html">5.25.0</a>
  
    <li><a href="../doc/release_notes/5_26_0_txt.html">5.26.0</a>
  
    <li><a href="../doc/release_notes/5_27_0_txt.html">5.27.0</a>
  
    <li><a href="../doc/release_notes/5_28_0_txt.html">5.28.0</a>
  
    <li><a href="../doc/release_notes/5_29_0_txt.html">5.29.0</a>
  
    <li><a href="../doc/release_notes/5_3_0_txt.html">5.3.0</a>
  
    <li><a href="../doc/release_notes/5_30_0_txt.html">5.30.0</a>
  
    <li><a href="../doc/release_notes/5_31_0_txt.html">5.31.0</a>
  
    <li><a href="../doc/release_notes/5_32_0_txt.html">5.32.0</a>
  
    <li><a href="../doc/release_notes/5_33_0_txt.html">5.33.0</a>
  
    <li><a href="../doc/release_notes/5_34_0_txt.html">5.34.0</a>
  
    <li><a href="../doc/release_notes/5_35_0_txt.html">5.35.0</a>
  
    <li><a href="../doc/release_notes/5_36_0_txt.html">5.36.0</a>
  
    <li><a href="../doc/release_notes/5_37_0_txt.html">5.37.0</a>
  
    <li><a href="../doc/release_notes/5_38_0_txt.html">5.38.0</a>
  
    <li><a href="../doc/release_notes/5_39_0_txt.html">5.39.0</a>
  
    <li><a href="../doc/release_notes/5_4_0_txt.html">5.4.0</a>
  
    <li><a href="../doc/release_notes/5_40_0_txt.html">5.40.0</a>
  
    <li><a href="../doc/release_notes/5_41_0_txt.html">5.41.0</a>
  
    <li><a href="../doc/release_notes/5_42_0_txt.html">5.42.0</a>
  
    <li><a href="../doc/release_notes/5_43_0_txt.html">5.43.0</a>
  
    <li><a href="../doc/release_notes/5_44_0_txt.html">5.44.0</a>
  
    <li><a href="../doc/release_notes/5_45_0_txt.html">5.45.0</a>
  
    <li><a href="../doc/release_notes/5_46_0_txt.html">5.46.0</a>
  
    <li><a href="../doc/release_notes/5_47_0_txt.html">5.47.0</a>
  
    <li><a href="../doc/release_notes/5_48_0_txt.html">5.48.0</a>
  
    <li><a href="../doc/release_notes/5_49_0_txt.html">5.49.0</a>
  
    <li><a href="../doc/release_notes/5_5_0_txt.html">5.5.0</a>
  
    <li><a href="../doc/release_notes/5_50_0_txt.html">5.50.0</a>
  
    <li><a href="../doc/release_notes/5_51_0_txt.html">5.51.0</a>
  
    <li><a href="../doc/release_notes/5_52_0_txt.html">5.52.0</a>
  
    <li><a href="../doc/release_notes/5_53_0_txt.html">5.53.0</a>
  
    <li><a href="../doc/release_notes/5_54_0_txt.html">5.54.0</a>
  
    <li><a href="../doc/release_notes/5_55_0_txt.html">5.55.0</a>
  
    <li><a href="../doc/release_notes/5_6_0_txt.html">5.6.0</a>
  
    <li><a href="../doc/release_notes/5_7_0_txt.html">5.7.0</a>
  
    <li><a href="../doc/release_notes/5_8_0_txt.html">5.8.0</a>
  
    <li><a href="../doc/release_notes/5_9_0_txt.html">5.9.0</a>
  
    <li><a href="../doc/schema_modification_rdoc.html">schema_modification</a>
  
    <li><a href="../doc/security_rdoc.html">security</a>
  
    <li><a href="../doc/sharding_rdoc.html">sharding</a>
  
    <li><a href="../doc/sql_rdoc.html">sql</a>
  
    <li><a href="../doc/testing_rdoc.html">testing</a>
  
    <li><a href="../doc/thread_safety_rdoc.html">thread_safety</a>
  
    <li><a href="../doc/transactions_rdoc.html">transactions</a>
  
    <li><a href="../doc/validations_rdoc.html">validations</a>
  
    <li><a href="../doc/virtual_rows_rdoc.html">virtual_rows</a>
  
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-label="Page doc/model_hooks.rdoc">

<h1 id="label-Model+Hooks">Model Hooks<span><a href="#label-Model+Hooks">&para;</a> <a href="#top">&uarr;</a></span></h1>

<p>This guide is based on <a href="http://guides.rubyonrails.org/activerecord_validations_callbacks.html">guides.rubyonrails.org/activerecord_validations_callbacks.html</a></p>

<h2 id="label-Overview">Overview<span><a href="#label-Overview">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>Model hooks are used to specify actions that occur at a given point in a model instance&#39;s lifecycle, such as before or after the model object is saved, created, updated, destroyed, or validated.  There are also around hooks for all types, which wrap the before hooks, the behavior, and the after hooks.</p>

<h2 id="label-Basic+Usage">Basic Usage<span><a href="#label-Basic+Usage">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p><code>Sequel::Model</code> uses instance methods for hooks.  To define a hook on a model, you just add an instance method to the model class:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Album</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">before_create</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">created_at</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
    <span class="ruby-keyword">super</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>The one important thing to note here is the call to <code>super</code> inside the hook.  Whenever you override one of Sequel::Model&#39;s methods, you should be calling <code>super</code> to get the default behavior.  Many of the plugins that ship with <a href="../Sequel.html"><code>Sequel</code></a> work by overriding the hook methods and calling <code>super</code>.  If you use these plugins and override the hook methods but do not call <code>super</code>, it&#39;s likely the plugins will not work correctly.</p>

<h2 id="label-Available+Hooks">Available Hooks<span><a href="#label-Available+Hooks">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p><a href="../Sequel.html"><code>Sequel</code></a> calls hooks in the following order when saving/creating a new object (one that does not already exist in the database):</p>
<ul><li>
<p><code>around_validation</code></p>
<ul><li>
<p><code>before_validation</code></p>
</li><li>
<p><code>validate</code> method called</p>
</li><li>
<p><code>after_validation</code></p>
</li></ul>
</li><li>
<p><code>around_save</code></p>
<ul><li>
<p><code>before_save</code></p>
</li><li>
<p><code>around_create</code></p>
<ul><li>
<p><code>before_create</code></p>
</li><li>
<p>INSERT QUERY</p>
</li><li>
<p><code>after_create</code></p>
</li></ul>
</li><li>
<p><code>after_save</code></p>
</li></ul>
</li></ul>

<p><a href="../Sequel.html"><code>Sequel</code></a> calls hooks in the following order when saving an existing object:</p>
<ul><li>
<p><code>around_validation</code></p>
<ul><li>
<p><code>before_validation</code></p>
</li><li>
<p><code>validate</code> method called</p>
</li><li>
<p><code>after_validation</code></p>
</li></ul>
</li><li>
<p><code>around_save</code></p>
<ul><li>
<p><code>before_save</code></p>
</li><li>
<p><code>around_update</code></p>
<ul><li>
<p><code>before_update</code></p>
</li><li>
<p>UPDATE QUERY</p>
</li><li>
<p><code>after_update</code></p>
</li></ul>
</li><li>
<p><code>after_save</code></p>
</li></ul>
</li></ul>

<p>Note that all of the hook calls are the same, except that <code>around_create</code>, <code>before_create</code> and <code>after_create</code> are used for a new object, and <code>around_update</code>, <code>before_update</code> and <code>after_update</code> are used for an existing object.  Note that <code>around_save</code>, <code>before_save</code>, and <code>after_save</code> are called in both cases.</p>

<p>Note that the validation hooks are still called if <code>validate: false</code> option is passed to save.  If you call <code>Model#valid?</code> manually, then only the validation hooks are called:</p>
<ul><li>
<p><code>around_validation</code></p>
<ul><li>
<p><code>before_validation</code></p>
</li><li>
<p><code>validate</code> method called</p>
</li><li>
<p><code>after_validation</code></p>
</li></ul>
</li></ul>

<p><a href="../Sequel.html"><code>Sequel</code></a> calls hooks in the following order when destroying an existing object:</p>
<ul><li>
<p><code>around_destroy</code></p>
<ul><li>
<p><code>before_destroy</code></p>
</li><li>
<p>DELETE QUERY</p>
</li><li>
<p><code>after_destroy</code></p>
</li></ul>
</li></ul>

<p>Note that these hooks are only called when using <code>Model#destroy</code>, they are not called if you use <code>Model#delete</code>.</p>

<h2 id="label-Transaction-related+Hooks">Transaction-related Hooks<span><a href="#label-Transaction-related+Hooks">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p><a href="../Sequel/Model.html"><code>Sequel::Model</code></a> no longer offers transaction hooks for model instances.  However, you can use the database transaction hooks inside model <code>before_save</code> and <code>after_save</code> hooks:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Album</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">before_save</span>
    <span class="ruby-identifier">db</span>.<span class="ruby-identifier">after_rollback</span>{<span class="ruby-identifier">rollback_action</span>}
    <span class="ruby-keyword">super</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">after_save</span>
    <span class="ruby-keyword">super</span>
    <span class="ruby-identifier">db</span>.<span class="ruby-identifier">after_commit</span>{<span class="ruby-identifier">commit_action</span>}
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h2 id="label-Running+Hooks">Running Hooks<span><a href="#label-Running+Hooks">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p><a href="../Sequel.html"><code>Sequel</code></a> does not provide a simple way to turn off the running of save/create/update hooks.  If you attempt to save a model object, the save hooks are always called.  All model instance methods that modify the database call save in some manner, so you can be sure that if you define the hooks, they will be called when you save the object.</p>

<p>However, you should note that there are plenty of ways to modify the database without saving a model object.  One example is by using plain datasets, or one of the model&#39;s dataset methods:</p>

<pre class="ruby"><span class="ruby-constant">Album</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">name:</span> <span class="ruby-string">&#39;RF&#39;</span>).<span class="ruby-identifier">update</span>(<span class="ruby-value">copies_sold:</span> <span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">+</span>(<span class="ruby-value">:copies_sold</span>, <span class="ruby-value">1</span>))
<span class="ruby-comment"># UPDATE albums SET copies_sold = copies_sold + 1 WHERE name = &#39;RF&#39;</span>
</pre>

<p>In this case, the <code>update</code> method is called on the dataset returned by <code>Album.where</code>.  Even if there is only a single object with the name RF, this will not call any hooks.  If you want model hooks to be called, you need to make sure to operate on a model object:</p>

<pre class="ruby"><span class="ruby-identifier">album</span> = <span class="ruby-constant">Album</span>.<span class="ruby-identifier">first</span>(<span class="ruby-value">name:</span> <span class="ruby-string">&#39;RF&#39;</span>)
<span class="ruby-identifier">album</span>.<span class="ruby-identifier">update</span>(<span class="ruby-value">copies_sold:</span> <span class="ruby-identifier">album</span>.<span class="ruby-identifier">copies_sold</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>)
<span class="ruby-comment"># UPDATE albums SET copies_sold = 2 WHERE id = 1</span>
</pre>

<p>For the destroy hooks, you need to make sure you call <code>destroy</code> on the object:</p>

<pre class="ruby"><span class="ruby-identifier">album</span>.<span class="ruby-identifier">destroy</span> <span class="ruby-comment"># runs destroy hooks</span>
</pre>

<h2 id="label-Skipping+Hooks">Skipping Hooks<span><a href="#label-Skipping+Hooks">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p><a href="../Sequel.html"><code>Sequel</code></a> makes it easy to skip destroy hooks by calling <code>delete</code> instead of <code>destroy</code>:</p>

<pre class="ruby"><span class="ruby-identifier">album</span>.<span class="ruby-identifier">delete</span> <span class="ruby-comment"># does not run destroy hooks</span>
</pre>

<p>However, skipping hooks is a bad idea in general and should be avoided.  As mentioned above, <a href="../Sequel.html"><code>Sequel</code></a> doesn&#39;t allow you to turn off the running of save hooks. If you know what you are doing and really want to skip them, you need to drop down to the dataset level to do so.  This can be done for a specific model object by using the <code>this</code> method for a dataset that represents a single object:</p>

<pre class="ruby"><span class="ruby-identifier">album</span>.<span class="ruby-identifier">this</span> <span class="ruby-comment"># dataset</span>
</pre>

<p>The <code>this</code> dataset works just like any other dataset, so you can call <code>update</code> on it to modify it:</p>

<pre class="ruby"><span class="ruby-identifier">album</span>.<span class="ruby-identifier">this</span>.<span class="ruby-identifier">update</span>(<span class="ruby-value">copies_sold:</span> <span class="ruby-identifier">album</span>.<span class="ruby-identifier">copies_sold</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>)
</pre>

<p>If you want to insert a row into the model&#39;s table without running the creation hooks, you can use <code>Model.insert</code> instead of <code>Model.create</code>:</p>

<pre class="ruby"><span class="ruby-constant">Album</span>.<span class="ruby-identifier">insert</span>(<span class="ruby-value">name:</span> <span class="ruby-string">&#39;RF&#39;</span>) <span class="ruby-comment"># does not run hooks</span>
</pre>

<h2 id="label-Canceling+Actions+in+Hooks">Canceling Actions in Hooks<span><a href="#label-Canceling+Actions+in+Hooks">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>Sometimes want to cancel an action in a before hook, so the action is not performed.  For example, you may want to not allow destroying or saving a record in certain cases.  In those cases, you can call <code>cancel_action</code> inside the <code>before_*</code> hook, which will stop processing the hook and will either raise a <code>Sequel::HookFailed</code> exception (the default), or return <code>nil</code> if <code>raise_on_save_failure</code> is <code>false</code>).  You can use this to implement validation-like behavior, that will run even if validations are skipped:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Album</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">before_save</span>
    <span class="ruby-identifier">cancel_action</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">name</span> <span class="ruby-operator">==</span> <span class="ruby-string">&#39;&#39;</span>
    <span class="ruby-keyword">super</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>For around hooks, neglecting to call <code>super</code> halts hook processing in the same way as calling <code>cancel_action</code> in a before hook.  It&#39;s probably a bad idea to use <code>cancel_action</code> hook processing in after hooks, or after yielding in around hooks, since by then the main processing has already taken place.</p>

<p>By default, <a href="../Sequel.html"><code>Sequel</code></a> runs hooks other than validation hooks inside a transaction, so if you cancel the action by calling <code>cancel_action</code> in any hook, <a href="../Sequel.html"><code>Sequel</code></a> will rollback the transaction.  However, note that the implicit use of transactions when saving and destroying model objects is conditional (it depends on the model instance&#39;s <code>use_transactions</code> setting and the <code>:transaction</code> option passed to save).</p>

<h2 id="label-Conditional+Hooks">Conditional Hooks<span><a href="#label-Conditional+Hooks">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>Sometimes you only take to take a certain action in a hook if the object meets a certain condition.  For example, let&#39;s say you only want to make sure a timestamp is set when updating if the object is at a certain status level:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Album</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">before_update</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">timestamp</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">status_id</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">3</span>
    <span class="ruby-keyword">super</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Note how this hook action is made conditional just be using the standard ruby <code>if</code> conditional.  <a href="../Sequel.html"><code>Sequel</code></a> makes it easy to handle conditional hook actions by using standard ruby conditionals inside the instance methods.</p>

<h2 id="label-Using+Hooks+in+Multiple+Classes">Using Hooks in Multiple Classes<span><a href="#label-Using+Hooks+in+Multiple+Classes">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>If you want all your model classes to use the same hook, you can just define that hook in Sequel::Model:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">before_create</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">created_at</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
    <span class="ruby-keyword">super</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Just remember to call <code>super</code> whenever you override the method in a subclass.  Note that <code>super</code> is also used when overriding the hook in <code>Sequel::Model</code> itself.  This is important as if you add any plugins to <a href="../Sequel/Model.html"><code>Sequel::Model</code></a> itself, if you override a hook in <code>Sequel::Model</code> and do not call <code>super</code>, the plugin may not work correctly.</p>

<p>If you don&#39;t want all classes to use the same hook, but want to reuse hooks in multiple classes, you should use a plugin or a simple module:</p>

<h3 id="label-Plugin">Plugin<span><a href="#label-Plugin">&para;</a> <a href="#top">&uarr;</a></span></h3>

<pre class="ruby"><span class="ruby-keyword">module</span> <span class="ruby-constant">SetCreatedAt</span>
  <span class="ruby-keyword">module</span> <span class="ruby-constant">InstanceMethods</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">before_create</span>
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">created_at</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
      <span class="ruby-keyword">super</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
<span class="ruby-constant">Album</span>.<span class="ruby-identifier">plugin</span>(<span class="ruby-constant">SetCreatedAt</span>)
<span class="ruby-constant">Artist</span>.<span class="ruby-identifier">plugin</span>(<span class="ruby-constant">SetCreatedAt</span>)
</pre>

<h3 id="label-Simple+Module">Simple Module<span><a href="#label-Simple+Module">&para;</a> <a href="#top">&uarr;</a></span></h3>

<pre class="ruby"><span class="ruby-keyword">module</span> <span class="ruby-constant">SetCreatedAt</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">before_create</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">created_at</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
    <span class="ruby-keyword">super</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
<span class="ruby-constant">Album</span>.<span class="ruby-identifier">send</span>(<span class="ruby-value">:include</span>, <span class="ruby-constant">SetCreatedAt</span>)
<span class="ruby-constant">Artist</span>.<span class="ruby-identifier">send</span>(<span class="ruby-value">:include</span>, <span class="ruby-constant">SetCreatedAt</span>)
</pre>

<h2 id="label-super+Ordering"><code>super</code> Ordering<span><a href="#label-super+Ordering">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>While it&#39;s not enforced anywhere, it&#39;s a good idea to make <code>super</code> the last expression when you override a before hook, and the first expression when you override an after hook:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Album</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">before_save</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">updated_at</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
    <span class="ruby-keyword">super</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">after_save</span>
    <span class="ruby-keyword">super</span>
    <span class="ruby-constant">AuditLog</span>.<span class="ruby-identifier">create</span>(<span class="ruby-value">:log</span><span class="ruby-operator">=&gt;</span><span class="ruby-node">&quot;Album #{name} created&quot;</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>This allows the following general principles to be true:</p>
<ul><li>
<p>before hooks are run in reverse order of inclusion</p>
</li><li>
<p>after hooks are run in order of inclusion</p>
</li></ul>

<p>So if you define the same before hook in both a model and a plugin that the model uses, the hooks will be called in this order:</p>
<ul><li>
<p>model before hook</p>
</li><li>
<p>plugin before hook</p>
</li><li>
<p>plugin after hook</p>
</li><li>
<p>model after hook</p>
</li></ul>

<p>Again, <a href="../Sequel.html"><code>Sequel</code></a> does not enforce that, and you are free to call <code>super</code> in an order other than the recommended one (just make sure that you call it).</p>

<h2 id="label-Around+Hooks">Around Hooks<span><a href="#label-Around+Hooks">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>Around hooks should only be used if you cannot accomplish the same results with before and after hooks.  For example, if you want to catch database errors caused by the <code>INSERT</code> or <code>UPDATE</code> query when saving a model object and raise them as validation errors, you cannot use a before or after hook.  You have use an <code>around_save</code> hook:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Album</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">around_save</span>
    <span class="ruby-keyword">super</span>
  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">DatabaseError</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
    <span class="ruby-comment"># parse database error, set error on self, and reraise a Sequel::ValidationFailed</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Likewise, let&#39;s say that upon retrieval, you associate an object with a file descriptor, and you want to ensure that the file descriptor is closed after the object is saved to the database.  Let&#39;s assume you are always saving the object and you are not using validations.  You could not use an <code>after_save</code> hook safely, since if the database raises an error, the <code>after_save</code> method will not be called.  In this case, an <code>around_save</code> hook is also the correct choice:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Album</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">around_save</span>
    <span class="ruby-keyword">super</span>
  <span class="ruby-keyword">ensure</span>
    <span class="ruby-ivar">@file_descriptor</span>.<span class="ruby-identifier">close</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h2 id="label-Hook+related+plugins">Hook related plugins<span><a href="#label-Hook+related+plugins">&para;</a> <a href="#top">&uarr;</a></span></h2>

<h3 id="label-instance_hooks"><code>instance_hooks</code><span><a href="#label-instance_hooks">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p><a href="../Sequel.html"><code>Sequel</code></a> also ships with an <code>instance_hooks</code> plugin that allows you to define before and after hooks on a per instance basis.  It&#39;s very useful as it allows you to delay action on an instance until before or after saving.  This can be important if you want to modify a group of related objects together (which is how the <code>nested_attributes</code> plugin uses <code>instance_hooks</code>).</p>

<h3 id="label-hook_class_methods"><code>hook_class_methods</code><span><a href="#label-hook_class_methods">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>While it&#39;s recommended to write your hooks as instance methods, <a href="../Sequel.html"><code>Sequel</code></a> ships with a <code>hook_class_methods</code> plugin that allows you to define hooks via class methods. It exists mostly for legacy compatibility, but is still supported.  However, it does not implement around hooks.</p>

<h3 id="label-after_initialize"><code>after_initialize</code><span><a href="#label-after_initialize">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The after_initialize plugin adds an after_initialize hook, that is called for all model instances on creation (both new instances and instances retrieved from the database).  It exists mostly for legacy compatibility, but it is still supported.</p>

</main>



<footer id="validator-badges" role="contentinfo">
  <p><a href="https://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="https://ruby.github.io/rdoc/">RDoc</a> 6.1.2.1.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

