<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>association_basics - Sequel: The Database Toolkit for Ruby</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "../";
  var index_rel_prefix = "../";
</script>

<script src="../js/navigation.js" defer></script>
<script src="../js/search.js" defer></script>
<script src="../js/search_index.js" defer></script>
<script src="../js/searcher.js" defer></script>
<script src="../js/darkfish.js" defer></script>

<link href="../css/fonts.css" rel="stylesheet">
<link href="../css/rdoc.css" rel="stylesheet">




<body id="top" role="document" class="file">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../table_of_contents.html#pages">Pages</a>
    <a href="../table_of_contents.html#classes">Classes</a>
    <a href="../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  
<div class="nav-section">
  <h3>Table of Contents</h3>

  <ul class="link-list" role="directory">
    <li><a href="#label-Association+Basics">Association Basics</a>
    <li><a href="#label-Why+Associations-3F">Why Associations?</a>
    <li><a href="#label-The+Types+of+Associations">The Types of Associations</a>
    <li><a href="#label-many_to_one">many_to_one</a>
    <li><a href="#label-one_to_many+and+one_to_one">one_to_many and one_to_one</a>
    <li><a href="#label-many_to_many+and+one_through_one">many_to_many and one_through_one</a>
    <li><a href="#label-Differences+Between+many_to_one+and+one_to_one">Differences Between many_to_one and one_to_one</a>
    <li><a href="#label-Most+Common+Options">Most Common Options</a>
    <li><a href="#label-3Akey">:key</a>
    <li><a href="#label-3Aclass">:class</a>
    <li><a href="#label-Self-referential+Associations">Self-referential Associations</a>
    <li><a href="#label-Methods+Added">Methods Added</a>
    <li><a href="#label-Caching">Caching</a>
    <li><a href="#label-Dataset+Method">Dataset Method</a>
    <li><a href="#label-Dynamic+Association+Modification">Dynamic Association Modification</a>
    <li><a href="#label-Filtering+By+Associations">Filtering By Associations</a>
    <li><a href="#label-Name+Collisions">Name Collisions</a>
    <li><a href="#label-Database+Schema">Database Schema</a>
    <li><a href="#label-many_to_one-2Fone_to_many">many_to_one/one_to_many</a>
    <li><a href="#label-many_to_many">many_to_many</a>
    <li><a href="#label-Association+Scope">Association Scope</a>
    <li><a href="#label-Method+Details">Method Details</a>
    <li><a href="#label-association-28opts-3D-7B-7D-29+-28e.g.+albums-29"><em>association</em>(opts={}) (e.g. albums)</a>
    <li><a href="#label-association-3D-28object_to_associate-29+-28e.g.+artist-3D-29+-5Bmany_to_one+and+one_to_one-5D"><em>association</em>=(object_to_associate) (e.g. artist=) [<code>many_to_one</code> and <code>one_to_one</code>]</a>
    <li><a href="#label-add_association-28object_to_associate-29+-28e.g.+add_album-29+-5Bone_to_many+and+many_to_many-5D">add_<em>association</em>(object_to_associate) (e.g. add_album) [<code>one_to_many</code> and <code>many_to_many</code>]</a>
    <li><a href="#label-remove_association-28object_to_disassociate-29+-28e.g.+remove_album-29+-5Bone_to_many+and+many_to_many-5D">remove_<em>association</em>(object_to_disassociate) (e.g. remove_album) [<code>one_to_many</code> and <code>many_to_many</code>]</a>
    <li><a href="#label-remove_all_association+-28e.g.+remove_all_albums-29+-5Bone_to_many+and+many_to_many-5D">remove_all_<em>association</em> (e.g. remove_all_albums) [<code>one_to_many</code> and <code>many_to_many</code>]</a>
    <li><a href="#label-association_dataset+-28e.g.+albums_dataset-29"><em>association</em>_dataset (e.g. albums_dataset)</a>
    <li><a href="#label-Overriding+Method+Behavior">Overriding Method Behavior</a>
    <li><a href="#label-3Asetter+-28_association-3D+method-29">:setter (_<em>association</em>= method)</a>
    <li><a href="#label-3Aadder+-28_add_association+method-29">:adder (_add_<em>association</em> method)</a>
    <li><a href="#label-3Aremover+-28_remove_association+method-29">:remover (_remove_<em>association</em> method)</a>
    <li><a href="#label-3Aclearer+-28_remove_all_association+method-29">:clearer (_remove_all_<em>association</em> method)</a>
    <li><a href="#label-3Ano_dataset_method">:no_dataset_method</a>
    <li><a href="#label-3Ano_association_method">:no_association_method</a>
    <li><a href="#label-Association+Options">Association Options</a>
    <li><a href="#label-Association+Dataset+Modification+Options">Association Dataset Modification Options</a>
    <li><a href="#label-block">block</a>
    <li><a href="#label-3Aclass">:class</a>
    <li><a href="#label-3Akey">:key</a>
    <li><a href="#label-3Aconditions">:conditions</a>
    <li><a href="#label-3Aorder">:order</a>
    <li><a href="#label-3Aselect">:select</a>
    <li><a href="#label-3Alimit">:limit</a>
    <li><a href="#label-3Ajoin_table+-5Bmany_to_many-2C+one_through_one-5D">:join_table [<code>many_to_many</code>, <code>one_through_one</code>]</a>
    <li><a href="#label-3Aleft_key+-5Bmany_to_many-2C+one_through_one-5D">:left_key [<code>many_to_many</code>, <code>one_through_one</code>]</a>
    <li><a href="#label-3Aright_key+-5Bmany_to_many-2C+one_through_one-5D">:right_key [<code>many_to_many</code>, <code>one_through_one</code>]</a>
    <li><a href="#label-3Adistinct">:distinct</a>
    <li><a href="#label-3Aclone">:clone</a>
    <li><a href="#label-3Adataset">:dataset</a>
    <li><a href="#label-3Aextend">:extend</a>
    <li><a href="#label-3Aprimary_key+-5Bmany_to_one-2C+one_to_one-2C+one_to_many-5D">:primary_key [<code>many_to_one</code>, <code>one_to_one</code>, <code>one_to_many</code>]</a>
    <li><a href="#label-3Aleft_primary_key+-5Bmany_to_many-2C+one_through_one-5D">:left_primary_key [<code>many_to_many</code>, <code>one_through_one</code>]</a>
    <li><a href="#label-3Aright_primary_key+-5Bmany_to_many-2C+one_through_one-5D">:right_primary_key [<code>many_to_many</code>, <code>one_through_one</code>]</a>
    <li><a href="#label-3Ajoin_table_block+-5Bmany_to_many-2C+one_through_one-5D">:join_table_block [<code>many_to_many</code>, <code>one_through_one</code>]</a>
    <li><a href="#label-3Ajoin_table_db+-5Bmany_to_many-2C+one_through_one-5D">:join_table_db [<code>many_to_many</code>, <code>one_through_one</code>]</a>
    <li><a href="#label-Callback+Options">Callback Options</a>
    <li><a href="#label-3Abefore_add+-5Bone_to_many-2C+many_to_many-5D">:before_add [<code>one_to_many</code>, <code>many_to_many</code>]</a>
    <li><a href="#label-3Aafter_add+-5Bone_to_many-2C+many_to_many-5D">:after_add [<code>one_to_many</code>, <code>many_to_many</code>]</a>
    <li><a href="#label-3Abefore_remove+-5Bone_to_many-2C+many_to_many-5D">:before_remove [<code>one_to_many</code>, <code>many_to_many</code>]</a>
    <li><a href="#label-3Aafter_remove+-5Bone_to_many-2C+many_to_many-5D">:after_remove [<code>one_to_many</code>, <code>many_to_many</code>]</a>
    <li><a href="#label-3Abefore_set+-5Bmany_to_one-2C+one_to_one-5D">:before_set [<code>many_to_one</code>, <code>one_to_one</code>]</a>
    <li><a href="#label-3Aafter_set+-5Bmany_to_one-2C+one_to_one-5D">:after_set [<code>many_to_one</code>, <code>one_to_one</code>]</a>
    <li><a href="#label-3Aafter_load">:after_load</a>
    <li><a href="#label-3Auniq+-5Bmany_to_many-5D">:uniq [<code>many_to_many</code>]</a>
    <li><a href="#label-Eager+Loading+via+eager+-28query+per+association-29+Options">Eager Loading via eager (query per association) Options</a>
    <li><a href="#label-3Aeager">:eager</a>
    <li><a href="#label-3Aeager_loader">:eager_loader</a>
    <li><a href="#label-3Aeager_loader_key">:eager_loader_key</a>
    <li><a href="#label-3Aeager_block">:eager_block</a>
    <li><a href="#label-Eager+Loading+via+eager_graph+-28one+query+with+joins-29+Options">Eager Loading via eager_graph (one query with joins) Options</a>
    <li><a href="#label-3Aeager_graph">:eager_graph</a>
    <li><a href="#label-3Agraph_conditions">:graph_conditions</a>
    <li><a href="#label-3Agraph_block">:graph_block</a>
    <li><a href="#label-3Agraph_join_type">:graph_join_type</a>
    <li><a href="#label-3Agraph_select">:graph_select</a>
    <li><a href="#label-3Agraph_only_conditions">:graph_only_conditions</a>
    <li><a href="#label-3Agraph_alias_base">:graph_alias_base</a>
    <li><a href="#label-3Aeager_grapher">:eager_grapher</a>
    <li><a href="#label-3Aorder_eager_graph">:order_eager_graph</a>
    <li><a href="#label-3Agraph_order">:graph_order</a>
    <li><a href="#label-3Agraph_join_table_conditions+-5Bmany_to_many-2C+one_through_one-5D">:graph_join_table_conditions [<code>many_to_many</code>, <code>one_through_one</code>]</a>
    <li><a href="#label-3Agraph_join_table_block+-5Bmany_to_many-2C+one_through_one-5D">:graph_join_table_block [<code>many_to_many</code>, <code>one_through_one</code>]</a>
    <li><a href="#label-3Agraph_join_table_join_type+-5Bmany_to_many-2C+one_through_one-5D">:graph_join_table_join_type [<code>many_to_many</code>, <code>one_through_one</code>]</a>
    <li><a href="#label-3Agraph_join_table_only_conditions+-5Bmany_to_many-2C+one_through_one-5D">:graph_join_table_only_conditions [<code>many_to_many</code>, <code>one_through_one</code>]</a>
    <li><a href="#label-Associations+Based+on+SQL+Expressions+Options">Associations Based on SQL Expressions Options</a>
    <li><a href="#label-3Akey_column+-5Bmany_to_one-5D">:key_column [<code>many_to_one</code>]</a>
    <li><a href="#label-3Aprimary_key_method+-5Bmany_to_one-5D">:primary_key_method [<code>many_to_one</code>]</a>
    <li><a href="#label-3Aprimary_key_column+-5Bone_to_many-2C+one_to_one-5D">:primary_key_column [<code>one_to_many</code>, <code>one_to_one</code>]</a>
    <li><a href="#label-3Akey_method+-5Bone_to_many-2C+one_to_one-5D">:key_method [<code>one_to_many</code>, <code>one_to_one</code>]</a>
    <li><a href="#label-3Aleft_primary_key_column+-5Bmany_to_many-2C+one_through_one-5D">:left_primary_key_column [<code>many_to_many</code>, <code>one_through_one</code>]</a>
    <li><a href="#label-3Aright_primary_key_method+-5Bmany_to_many-2C+one_through_one-5D">:right_primary_key_method [<code>many_to_many</code>, <code>one_through_one</code>]</a>
    <li><a href="#label-Advanced+Options">Advanced Options</a>
    <li><a href="#label-3Areciprocal">:reciprocal</a>
    <li><a href="#label-3Aread_only">:read_only</a>
    <li><a href="#label-3Avalidate">:validate</a>
    <li><a href="#label-3Araise_on_save_failure+-5Bone_to_many+associations-5D">:raise_on_save_failure [<code>one_to_many</code> associations]</a>
    <li><a href="#label-3Aallow_eager">:allow_eager</a>
    <li><a href="#label-3Aallow_eager_graph">:allow_eager_graph</a>
    <li><a href="#label-3Aallow_filtering_by">:allow_filtering_by</a>
    <li><a href="#label-3Ainstance_specific">:instance_specific</a>
    <li><a href="#label-3Acartesian_product_number+">:cartesian_product_number </a>
    <li><a href="#label-3Aclass_namespace">:class_namespace</a>
    <li><a href="#label-3Amethods_module">:methods_module</a>
    <li><a href="#label-3Aeager_limit_strategy">:eager_limit_strategy</a>
    <li><a href="#label-3Asubqueries_per_union">:subqueries_per_union</a>
    <li><a href="#label-3Afilter_limit_strategy">:filter_limit_strategy</a>
  </ul>
</div>


  <div id="project-metadata">
    <div id="fileindex-section" class="nav-section">
  <h3>Pages</h3>

  <ul class="link-list">
  
    <li><a href="../CHANGELOG.html">CHANGELOG</a>
  
    <li><a href="../MIT-LICENSE.html">MIT-LICENSE</a>
  
    <li><a href="../README_rdoc.html">README</a>
  
    <li><a href="../doc/CHANGELOG_old.html">CHANGELOG.old</a>
  
    <li><a href="../doc/advanced_associations_rdoc.html">advanced_associations</a>
  
    <li><a href="../doc/association_basics_rdoc.html">association_basics</a>
  
    <li><a href="../doc/bin_sequel_rdoc.html">bin_sequel</a>
  
    <li><a href="../doc/cheat_sheet_rdoc.html">cheat_sheet</a>
  
    <li><a href="../doc/code_order_rdoc.html">code_order</a>
  
    <li><a href="../doc/core_extensions_rdoc.html">core_extensions</a>
  
    <li><a href="../doc/dataset_basics_rdoc.html">dataset_basics</a>
  
    <li><a href="../doc/dataset_filtering_rdoc.html">dataset_filtering</a>
  
    <li><a href="../doc/extensions_rdoc.html">extensions</a>
  
    <li><a href="../doc/fork_safety_rdoc.html">fork_safety</a>
  
    <li><a href="../doc/mass_assignment_rdoc.html">mass_assignment</a>
  
    <li><a href="../doc/migration_rdoc.html">migration</a>
  
    <li><a href="../doc/model_dataset_method_design_rdoc.html">model_dataset_method_design</a>
  
    <li><a href="../doc/model_hooks_rdoc.html">model_hooks</a>
  
    <li><a href="../doc/model_plugins_rdoc.html">model_plugins</a>
  
    <li><a href="../doc/mssql_stored_procedures_rdoc.html">mssql_stored_procedures</a>
  
    <li><a href="../doc/object_model_rdoc.html">object_model</a>
  
    <li><a href="../doc/opening_databases_rdoc.html">opening_databases</a>
  
    <li><a href="../doc/postgresql_rdoc.html">postgresql</a>
  
    <li><a href="../doc/prepared_statements_rdoc.html">prepared_statements</a>
  
    <li><a href="../doc/querying_rdoc.html">querying</a>
  
    <li><a href="../doc/reflection_rdoc.html">reflection</a>
  
    <li><a href="../doc/release_notes/1_0_txt.html">1.0</a>
  
    <li><a href="../doc/release_notes/1_1_txt.html">1.1</a>
  
    <li><a href="../doc/release_notes/1_3_txt.html">1.3</a>
  
    <li><a href="../doc/release_notes/1_4_0_txt.html">1.4.0</a>
  
    <li><a href="../doc/release_notes/1_5_0_txt.html">1.5.0</a>
  
    <li><a href="../doc/release_notes/2_0_0_txt.html">2.0.0</a>
  
    <li><a href="../doc/release_notes/2_1_0_txt.html">2.1.0</a>
  
    <li><a href="../doc/release_notes/2_10_0_txt.html">2.10.0</a>
  
    <li><a href="../doc/release_notes/2_11_0_txt.html">2.11.0</a>
  
    <li><a href="../doc/release_notes/2_12_0_txt.html">2.12.0</a>
  
    <li><a href="../doc/release_notes/2_2_0_txt.html">2.2.0</a>
  
    <li><a href="../doc/release_notes/2_3_0_txt.html">2.3.0</a>
  
    <li><a href="../doc/release_notes/2_4_0_txt.html">2.4.0</a>
  
    <li><a href="../doc/release_notes/2_5_0_txt.html">2.5.0</a>
  
    <li><a href="../doc/release_notes/2_6_0_txt.html">2.6.0</a>
  
    <li><a href="../doc/release_notes/2_7_0_txt.html">2.7.0</a>
  
    <li><a href="../doc/release_notes/2_8_0_txt.html">2.8.0</a>
  
    <li><a href="../doc/release_notes/2_9_0_txt.html">2.9.0</a>
  
    <li><a href="../doc/release_notes/3_0_0_txt.html">3.0.0</a>
  
    <li><a href="../doc/release_notes/3_1_0_txt.html">3.1.0</a>
  
    <li><a href="../doc/release_notes/3_10_0_txt.html">3.10.0</a>
  
    <li><a href="../doc/release_notes/3_11_0_txt.html">3.11.0</a>
  
    <li><a href="../doc/release_notes/3_12_0_txt.html">3.12.0</a>
  
    <li><a href="../doc/release_notes/3_13_0_txt.html">3.13.0</a>
  
    <li><a href="../doc/release_notes/3_14_0_txt.html">3.14.0</a>
  
    <li><a href="../doc/release_notes/3_15_0_txt.html">3.15.0</a>
  
    <li><a href="../doc/release_notes/3_16_0_txt.html">3.16.0</a>
  
    <li><a href="../doc/release_notes/3_17_0_txt.html">3.17.0</a>
  
    <li><a href="../doc/release_notes/3_18_0_txt.html">3.18.0</a>
  
    <li><a href="../doc/release_notes/3_19_0_txt.html">3.19.0</a>
  
    <li><a href="../doc/release_notes/3_2_0_txt.html">3.2.0</a>
  
    <li><a href="../doc/release_notes/3_20_0_txt.html">3.20.0</a>
  
    <li><a href="../doc/release_notes/3_21_0_txt.html">3.21.0</a>
  
    <li><a href="../doc/release_notes/3_22_0_txt.html">3.22.0</a>
  
    <li><a href="../doc/release_notes/3_23_0_txt.html">3.23.0</a>
  
    <li><a href="../doc/release_notes/3_24_0_txt.html">3.24.0</a>
  
    <li><a href="../doc/release_notes/3_25_0_txt.html">3.25.0</a>
  
    <li><a href="../doc/release_notes/3_26_0_txt.html">3.26.0</a>
  
    <li><a href="../doc/release_notes/3_27_0_txt.html">3.27.0</a>
  
    <li><a href="../doc/release_notes/3_28_0_txt.html">3.28.0</a>
  
    <li><a href="../doc/release_notes/3_29_0_txt.html">3.29.0</a>
  
    <li><a href="../doc/release_notes/3_3_0_txt.html">3.3.0</a>
  
    <li><a href="../doc/release_notes/3_30_0_txt.html">3.30.0</a>
  
    <li><a href="../doc/release_notes/3_31_0_txt.html">3.31.0</a>
  
    <li><a href="../doc/release_notes/3_32_0_txt.html">3.32.0</a>
  
    <li><a href="../doc/release_notes/3_33_0_txt.html">3.33.0</a>
  
    <li><a href="../doc/release_notes/3_34_0_txt.html">3.34.0</a>
  
    <li><a href="../doc/release_notes/3_35_0_txt.html">3.35.0</a>
  
    <li><a href="../doc/release_notes/3_36_0_txt.html">3.36.0</a>
  
    <li><a href="../doc/release_notes/3_37_0_txt.html">3.37.0</a>
  
    <li><a href="../doc/release_notes/3_38_0_txt.html">3.38.0</a>
  
    <li><a href="../doc/release_notes/3_39_0_txt.html">3.39.0</a>
  
    <li><a href="../doc/release_notes/3_4_0_txt.html">3.4.0</a>
  
    <li><a href="../doc/release_notes/3_40_0_txt.html">3.40.0</a>
  
    <li><a href="../doc/release_notes/3_41_0_txt.html">3.41.0</a>
  
    <li><a href="../doc/release_notes/3_42_0_txt.html">3.42.0</a>
  
    <li><a href="../doc/release_notes/3_43_0_txt.html">3.43.0</a>
  
    <li><a href="../doc/release_notes/3_44_0_txt.html">3.44.0</a>
  
    <li><a href="../doc/release_notes/3_45_0_txt.html">3.45.0</a>
  
    <li><a href="../doc/release_notes/3_46_0_txt.html">3.46.0</a>
  
    <li><a href="../doc/release_notes/3_47_0_txt.html">3.47.0</a>
  
    <li><a href="../doc/release_notes/3_48_0_txt.html">3.48.0</a>
  
    <li><a href="../doc/release_notes/3_5_0_txt.html">3.5.0</a>
  
    <li><a href="../doc/release_notes/3_6_0_txt.html">3.6.0</a>
  
    <li><a href="../doc/release_notes/3_7_0_txt.html">3.7.0</a>
  
    <li><a href="../doc/release_notes/3_8_0_txt.html">3.8.0</a>
  
    <li><a href="../doc/release_notes/3_9_0_txt.html">3.9.0</a>
  
    <li><a href="../doc/release_notes/4_0_0_txt.html">4.0.0</a>
  
    <li><a href="../doc/release_notes/4_1_0_txt.html">4.1.0</a>
  
    <li><a href="../doc/release_notes/4_10_0_txt.html">4.10.0</a>
  
    <li><a href="../doc/release_notes/4_11_0_txt.html">4.11.0</a>
  
    <li><a href="../doc/release_notes/4_12_0_txt.html">4.12.0</a>
  
    <li><a href="../doc/release_notes/4_13_0_txt.html">4.13.0</a>
  
    <li><a href="../doc/release_notes/4_14_0_txt.html">4.14.0</a>
  
    <li><a href="../doc/release_notes/4_15_0_txt.html">4.15.0</a>
  
    <li><a href="../doc/release_notes/4_16_0_txt.html">4.16.0</a>
  
    <li><a href="../doc/release_notes/4_17_0_txt.html">4.17.0</a>
  
    <li><a href="../doc/release_notes/4_18_0_txt.html">4.18.0</a>
  
    <li><a href="../doc/release_notes/4_19_0_txt.html">4.19.0</a>
  
    <li><a href="../doc/release_notes/4_2_0_txt.html">4.2.0</a>
  
    <li><a href="../doc/release_notes/4_20_0_txt.html">4.20.0</a>
  
    <li><a href="../doc/release_notes/4_21_0_txt.html">4.21.0</a>
  
    <li><a href="../doc/release_notes/4_22_0_txt.html">4.22.0</a>
  
    <li><a href="../doc/release_notes/4_23_0_txt.html">4.23.0</a>
  
    <li><a href="../doc/release_notes/4_24_0_txt.html">4.24.0</a>
  
    <li><a href="../doc/release_notes/4_25_0_txt.html">4.25.0</a>
  
    <li><a href="../doc/release_notes/4_26_0_txt.html">4.26.0</a>
  
    <li><a href="../doc/release_notes/4_27_0_txt.html">4.27.0</a>
  
    <li><a href="../doc/release_notes/4_28_0_txt.html">4.28.0</a>
  
    <li><a href="../doc/release_notes/4_29_0_txt.html">4.29.0</a>
  
    <li><a href="../doc/release_notes/4_3_0_txt.html">4.3.0</a>
  
    <li><a href="../doc/release_notes/4_30_0_txt.html">4.30.0</a>
  
    <li><a href="../doc/release_notes/4_31_0_txt.html">4.31.0</a>
  
    <li><a href="../doc/release_notes/4_32_0_txt.html">4.32.0</a>
  
    <li><a href="../doc/release_notes/4_33_0_txt.html">4.33.0</a>
  
    <li><a href="../doc/release_notes/4_34_0_txt.html">4.34.0</a>
  
    <li><a href="../doc/release_notes/4_35_0_txt.html">4.35.0</a>
  
    <li><a href="../doc/release_notes/4_36_0_txt.html">4.36.0</a>
  
    <li><a href="../doc/release_notes/4_37_0_txt.html">4.37.0</a>
  
    <li><a href="../doc/release_notes/4_38_0_txt.html">4.38.0</a>
  
    <li><a href="../doc/release_notes/4_39_0_txt.html">4.39.0</a>
  
    <li><a href="../doc/release_notes/4_4_0_txt.html">4.4.0</a>
  
    <li><a href="../doc/release_notes/4_40_0_txt.html">4.40.0</a>
  
    <li><a href="../doc/release_notes/4_41_0_txt.html">4.41.0</a>
  
    <li><a href="../doc/release_notes/4_42_0_txt.html">4.42.0</a>
  
    <li><a href="../doc/release_notes/4_43_0_txt.html">4.43.0</a>
  
    <li><a href="../doc/release_notes/4_44_0_txt.html">4.44.0</a>
  
    <li><a href="../doc/release_notes/4_45_0_txt.html">4.45.0</a>
  
    <li><a href="../doc/release_notes/4_46_0_txt.html">4.46.0</a>
  
    <li><a href="../doc/release_notes/4_47_0_txt.html">4.47.0</a>
  
    <li><a href="../doc/release_notes/4_48_0_txt.html">4.48.0</a>
  
    <li><a href="../doc/release_notes/4_49_0_txt.html">4.49.0</a>
  
    <li><a href="../doc/release_notes/4_5_0_txt.html">4.5.0</a>
  
    <li><a href="../doc/release_notes/4_6_0_txt.html">4.6.0</a>
  
    <li><a href="../doc/release_notes/4_7_0_txt.html">4.7.0</a>
  
    <li><a href="../doc/release_notes/4_8_0_txt.html">4.8.0</a>
  
    <li><a href="../doc/release_notes/4_9_0_txt.html">4.9.0</a>
  
    <li><a href="../doc/release_notes/5_0_0_txt.html">5.0.0</a>
  
    <li><a href="../doc/release_notes/5_1_0_txt.html">5.1.0</a>
  
    <li><a href="../doc/release_notes/5_10_0_txt.html">5.10.0</a>
  
    <li><a href="../doc/release_notes/5_11_0_txt.html">5.11.0</a>
  
    <li><a href="../doc/release_notes/5_12_0_txt.html">5.12.0</a>
  
    <li><a href="../doc/release_notes/5_13_0_txt.html">5.13.0</a>
  
    <li><a href="../doc/release_notes/5_14_0_txt.html">5.14.0</a>
  
    <li><a href="../doc/release_notes/5_15_0_txt.html">5.15.0</a>
  
    <li><a href="../doc/release_notes/5_16_0_txt.html">5.16.0</a>
  
    <li><a href="../doc/release_notes/5_17_0_txt.html">5.17.0</a>
  
    <li><a href="../doc/release_notes/5_18_0_txt.html">5.18.0</a>
  
    <li><a href="../doc/release_notes/5_19_0_txt.html">5.19.0</a>
  
    <li><a href="../doc/release_notes/5_2_0_txt.html">5.2.0</a>
  
    <li><a href="../doc/release_notes/5_20_0_txt.html">5.20.0</a>
  
    <li><a href="../doc/release_notes/5_21_0_txt.html">5.21.0</a>
  
    <li><a href="../doc/release_notes/5_22_0_txt.html">5.22.0</a>
  
    <li><a href="../doc/release_notes/5_23_0_txt.html">5.23.0</a>
  
    <li><a href="../doc/release_notes/5_24_0_txt.html">5.24.0</a>
  
    <li><a href="../doc/release_notes/5_25_0_txt.html">5.25.0</a>
  
    <li><a href="../doc/release_notes/5_26_0_txt.html">5.26.0</a>
  
    <li><a href="../doc/release_notes/5_27_0_txt.html">5.27.0</a>
  
    <li><a href="../doc/release_notes/5_28_0_txt.html">5.28.0</a>
  
    <li><a href="../doc/release_notes/5_29_0_txt.html">5.29.0</a>
  
    <li><a href="../doc/release_notes/5_3_0_txt.html">5.3.0</a>
  
    <li><a href="../doc/release_notes/5_30_0_txt.html">5.30.0</a>
  
    <li><a href="../doc/release_notes/5_31_0_txt.html">5.31.0</a>
  
    <li><a href="../doc/release_notes/5_32_0_txt.html">5.32.0</a>
  
    <li><a href="../doc/release_notes/5_33_0_txt.html">5.33.0</a>
  
    <li><a href="../doc/release_notes/5_34_0_txt.html">5.34.0</a>
  
    <li><a href="../doc/release_notes/5_35_0_txt.html">5.35.0</a>
  
    <li><a href="../doc/release_notes/5_36_0_txt.html">5.36.0</a>
  
    <li><a href="../doc/release_notes/5_37_0_txt.html">5.37.0</a>
  
    <li><a href="../doc/release_notes/5_38_0_txt.html">5.38.0</a>
  
    <li><a href="../doc/release_notes/5_39_0_txt.html">5.39.0</a>
  
    <li><a href="../doc/release_notes/5_4_0_txt.html">5.4.0</a>
  
    <li><a href="../doc/release_notes/5_40_0_txt.html">5.40.0</a>
  
    <li><a href="../doc/release_notes/5_41_0_txt.html">5.41.0</a>
  
    <li><a href="../doc/release_notes/5_42_0_txt.html">5.42.0</a>
  
    <li><a href="../doc/release_notes/5_43_0_txt.html">5.43.0</a>
  
    <li><a href="../doc/release_notes/5_44_0_txt.html">5.44.0</a>
  
    <li><a href="../doc/release_notes/5_45_0_txt.html">5.45.0</a>
  
    <li><a href="../doc/release_notes/5_46_0_txt.html">5.46.0</a>
  
    <li><a href="../doc/release_notes/5_47_0_txt.html">5.47.0</a>
  
    <li><a href="../doc/release_notes/5_48_0_txt.html">5.48.0</a>
  
    <li><a href="../doc/release_notes/5_49_0_txt.html">5.49.0</a>
  
    <li><a href="../doc/release_notes/5_5_0_txt.html">5.5.0</a>
  
    <li><a href="../doc/release_notes/5_50_0_txt.html">5.50.0</a>
  
    <li><a href="../doc/release_notes/5_51_0_txt.html">5.51.0</a>
  
    <li><a href="../doc/release_notes/5_52_0_txt.html">5.52.0</a>
  
    <li><a href="../doc/release_notes/5_53_0_txt.html">5.53.0</a>
  
    <li><a href="../doc/release_notes/5_54_0_txt.html">5.54.0</a>
  
    <li><a href="../doc/release_notes/5_55_0_txt.html">5.55.0</a>
  
    <li><a href="../doc/release_notes/5_6_0_txt.html">5.6.0</a>
  
    <li><a href="../doc/release_notes/5_7_0_txt.html">5.7.0</a>
  
    <li><a href="../doc/release_notes/5_8_0_txt.html">5.8.0</a>
  
    <li><a href="../doc/release_notes/5_9_0_txt.html">5.9.0</a>
  
    <li><a href="../doc/schema_modification_rdoc.html">schema_modification</a>
  
    <li><a href="../doc/security_rdoc.html">security</a>
  
    <li><a href="../doc/sharding_rdoc.html">sharding</a>
  
    <li><a href="../doc/sql_rdoc.html">sql</a>
  
    <li><a href="../doc/testing_rdoc.html">testing</a>
  
    <li><a href="../doc/thread_safety_rdoc.html">thread_safety</a>
  
    <li><a href="../doc/transactions_rdoc.html">transactions</a>
  
    <li><a href="../doc/validations_rdoc.html">validations</a>
  
    <li><a href="../doc/virtual_rows_rdoc.html">virtual_rows</a>
  
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-label="Page doc/association_basics.rdoc">

<h1 id="label-Association+Basics">Association Basics<span><a href="#label-Association+Basics">&para;</a> <a href="#top">&uarr;</a></span></h1>

<p>This guide is based on <a href="http://guides.rubyonrails.org/association_basics.html">guides.rubyonrails.org/association_basics.html</a></p>

<h2 id="label-Why+Associations-3F">Why Associations?<span><a href="#label-Why+Associations-3F">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>Associations exist to simplify code that deals with related rows in separate database tables.  Without associations, if you had classes such as:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Artist</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Album</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>
<span class="ruby-keyword">end</span>
</pre>

<p>And you wanted to get all of the albums for a given artist (assuming each album was associated with only one artist):</p>

<pre class="ruby"><span class="ruby-constant">Album</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">artist_id:</span> <span class="ruby-ivar">@artist</span>.<span class="ruby-identifier">id</span>).<span class="ruby-identifier">all</span>
</pre>

<p>Or maybe you want to add an album for a given artist:</p>

<pre class="ruby"><span class="ruby-constant">Album</span>.<span class="ruby-identifier">create</span>(<span class="ruby-value">artist_id:</span> <span class="ruby-ivar">@artist</span>.<span class="ruby-identifier">id</span>, <span class="ruby-value">name:</span> <span class="ruby-string">&#39;RF&#39;</span>)
</pre>

<p>With associations, you can make the above code simpler, by setting up associations between the two models:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Artist</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>
  <span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:albums</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Album</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>
  <span class="ruby-identifier">many_to_one</span> <span class="ruby-value">:artist</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Then, the code to retrieve albums related to the artist is simpler:</p>

<pre class="ruby"><span class="ruby-ivar">@artist</span>.<span class="ruby-identifier">albums</span>
</pre>

<p>As is the code to add a related album to an artist:</p>

<pre class="ruby"><span class="ruby-ivar">@artist</span>.<span class="ruby-identifier">add_album</span>(<span class="ruby-value">name:</span> <span class="ruby-string">&#39;RF&#39;</span>)
</pre>

<p>It also makes it easier to create queries that use joins based on the association:</p>

<pre class="ruby"><span class="ruby-constant">Artist</span>.<span class="ruby-identifier">association_join</span>(<span class="ruby-value">:albums</span>)
<span class="ruby-comment"># SELECT * FROM artists</span>
<span class="ruby-comment"># INNER JOIN albums ON (albums.artist_id = artists.id)</span>
</pre>

<h2 id="label-The+Types+of+Associations">The Types of Associations<span><a href="#label-The+Types+of+Associations">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p><a href="../Sequel.html"><code>Sequel</code></a> has five different association types built in:</p>
<ul><li>
<p>many_to_one</p>
</li><li>
<p>one_to_many</p>
</li><li>
<p>one_to_one</p>
</li><li>
<p>many_to_many</p>
</li><li>
<p>one_through_one</p>
</li></ul>

<p>It ships with additional association types via plugins.</p>

<h3 id="label-many_to_one">many_to_one<span><a href="#label-many_to_one">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The many_to_one association is used when the table for the current class contains a foreign key that references the primary key in the table for the associated class.  It is named &#39;many_to_one&#39; because there can be many rows in the current table for each row in the associated table.</p>

<pre class="ruby"><span class="ruby-comment"># Database schema:</span>
<span class="ruby-comment">#  albums             artists</span>
<span class="ruby-comment">#   :id           /--&gt; :id</span>
<span class="ruby-comment">#   :artist_id --/     :name</span>
<span class="ruby-comment">#   :name</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Album</span>
  <span class="ruby-comment"># Uses singular form of associated model name</span>
  <span class="ruby-identifier">many_to_one</span> <span class="ruby-value">:artist</span>
<span class="ruby-keyword">end</span>
</pre>

<h3 id="label-one_to_many+and+one_to_one">one_to_many and one_to_one<span><a href="#label-one_to_many+and+one_to_one">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The one_to_many association is used when the table for the associated class contains a foreign key that references the primary key in the table for the current class.  It is named &#39;one_to_many&#39; because for each row in the current table there can be many rows in the associated table:</p>

<p>The one_to_one association can be thought of as a subset of the one_to_many association, but where there can only be either 0 or 1 records in the associated table.  This is useful if there is a unique constraint on the foreign key field in the associated table. It&#39;s also useful if you want to impose an order on the association and just want the first record returned.</p>

<pre class="ruby"><span class="ruby-comment"># Database schema:</span>
<span class="ruby-comment">#  artists            albums</span>
<span class="ruby-comment">#   :id   &lt;----\       :id</span>
<span class="ruby-comment">#   :name       \----- :artist_id</span>
<span class="ruby-comment">#                      :name</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Artist</span>
  <span class="ruby-comment"># Uses plural form of associated model name</span>
  <span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:albums</span>

  <span class="ruby-comment"># Uses singular form of associated model name</span>
  <span class="ruby-identifier">one_to_one</span> <span class="ruby-value">:album</span>
<span class="ruby-keyword">end</span>
</pre>

<h3 id="label-many_to_many+and+one_through_one">many_to_many and one_through_one<span><a href="#label-many_to_many+and+one_through_one">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The many_to_many association allows each row in the current table to be associated to many rows in the associated table, and each row in the associated table to many rows in the current table, by using a join table to associate the two tables.</p>

<p>The one_through_one association can be thought of as a subset of the many_to_many association, but where there can only be 0 or 1 records in the associated table. This is useful if there is a unique constraint on the foreign key in the join table that references the current table.  It&#39;s also useful if you want to impose an order on the association and just want the first record returned.  The one_through_one association is so named because it sets up a one-to-one association through a single join table.</p>

<pre class="ruby"><span class="ruby-comment"># Database schema:</span>
<span class="ruby-comment">#  albums</span>
<span class="ruby-comment">#   :id   &lt;----\</span>
<span class="ruby-comment">#   :name       \     albums_artists</span>
<span class="ruby-comment">#                \---- :album_id</span>
<span class="ruby-comment">#  artists       /---- :artist_id</span>
<span class="ruby-comment">#   :id   &lt;-----/</span>
<span class="ruby-comment">#   :name</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Artist</span>
  <span class="ruby-comment"># Uses plural form of associated model name</span>
  <span class="ruby-identifier">many_to_many</span> <span class="ruby-value">:albums</span>

  <span class="ruby-comment"># Uses singular form of associated model name</span>
  <span class="ruby-identifier">one_through_one</span> <span class="ruby-value">:album</span>
<span class="ruby-keyword">end</span>
</pre>

<h3 id="label-Differences+Between+many_to_one+and+one_to_one">Differences Between many_to_one and one_to_one<span><a href="#label-Differences+Between+many_to_one+and+one_to_one">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>If you want to setup a 1-1 relationship between two models, where the foreign key in one table references the associated table directly, you have to use many_to_one in one model, and one_to_one in the other model.  How do you know which to use in which model?</p>

<p>The simplest way to remember is that the model whose table has the foreign key uses many_to_one, and the other model uses one_to_one:</p>

<pre class="ruby"><span class="ruby-comment"># Database schema:</span>
<span class="ruby-comment">#  artists            albums</span>
<span class="ruby-comment">#   :id   &lt;----\       :id</span>
<span class="ruby-comment">#   :name       \----- :artist_id</span>
<span class="ruby-comment">#                      :name</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Artist</span>
  <span class="ruby-identifier">one_to_one</span> <span class="ruby-value">:album</span>
<span class="ruby-keyword">end</span>
<span class="ruby-keyword">class</span> <span class="ruby-constant">Album</span>
  <span class="ruby-identifier">many_to_one</span> <span class="ruby-value">:artist</span>
<span class="ruby-keyword">end</span>
</pre>

<h2 id="label-Most+Common+Options">Most Common Options<span><a href="#label-Most+Common+Options">&para;</a> <a href="#top">&uarr;</a></span></h2>

<h3 id="label-3Akey">:key<span><a href="#label-3Akey">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The :key option must be used if the default column symbol that <a href="../Sequel.html"><code>Sequel</code></a> would use is not the correct column.  For example:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Album</span>
  <span class="ruby-comment"># Assumes :key is :artist_id, based on association name of :artist</span>
  <span class="ruby-identifier">many_to_one</span> <span class="ruby-value">:artist</span>
<span class="ruby-keyword">end</span>
<span class="ruby-keyword">class</span> <span class="ruby-constant">Artist</span>
  <span class="ruby-comment"># Assumes :key is :artist_id, based on class name of Artist</span>
  <span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:albums</span>
<span class="ruby-keyword">end</span>
</pre>

<p>However, if your schema looks like:</p>

<pre class="ruby"><span class="ruby-comment"># Database schema:</span>
<span class="ruby-comment">#  artists            albums</span>
<span class="ruby-comment">#   :id   &lt;----\       :id</span>
<span class="ruby-comment">#   :name       \----- :artistid # Note missing underscore</span>
<span class="ruby-comment">#                      :name</span>
</pre>

<p>Then the default :key option will not be correct.  To fix this, you need to specify an explicit :key option:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Album</span>
  <span class="ruby-identifier">many_to_one</span> <span class="ruby-value">:artist</span>, <span class="ruby-value">key:</span> <span class="ruby-value">:artistid</span>
<span class="ruby-keyword">end</span>
<span class="ruby-keyword">class</span> <span class="ruby-constant">Artist</span>
  <span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:albums</span>, <span class="ruby-value">key:</span> <span class="ruby-value">:artistid</span>
<span class="ruby-keyword">end</span>
</pre>

<p>For many_to_many associations, the :left_key and :right_key options can be used to specify the column names in the join table, and the :join_table option can be used to specify the name of the join table:</p>

<pre class="ruby"><span class="ruby-comment"># Database schema:</span>
<span class="ruby-comment">#  albums</span>
<span class="ruby-comment">#   :id   &lt;----\</span>
<span class="ruby-comment">#   :name       \     albumsartists</span>
<span class="ruby-comment">#                \---- :albumid</span>
<span class="ruby-comment">#  artists       /---- :artistid</span>
<span class="ruby-comment">#   :id   &lt;-----/</span>
<span class="ruby-comment">#   :name</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Artist</span>
  <span class="ruby-comment"># Note that :left_key refers to the foreign key pointing to the</span>
  <span class="ruby-comment"># current table, and :right_key the foreign key pointing to the</span>
  <span class="ruby-comment"># associated table.</span>
  <span class="ruby-identifier">many_to_many</span> <span class="ruby-value">:albums</span>, <span class="ruby-value">left_key:</span> <span class="ruby-value">:artistid</span>, <span class="ruby-value">right_key:</span> <span class="ruby-value">:albumid</span>,
    <span class="ruby-value">join_table:</span> <span class="ruby-value">:albumsartists</span>
<span class="ruby-keyword">end</span>
<span class="ruby-keyword">class</span> <span class="ruby-constant">Album</span>
  <span class="ruby-identifier">many_to_many</span> <span class="ruby-value">:artists</span>, <span class="ruby-value">left_key:</span> <span class="ruby-value">:albumid</span>, <span class="ruby-value">right_key:</span> <span class="ruby-value">:artistid</span>,
    <span class="ruby-value">join_table:</span> <span class="ruby-value">:albumsartists</span>
<span class="ruby-keyword">end</span>
</pre>

<h3 id="label-3Aclass">:class<span><a href="#label-3Aclass">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>If the class of the association cannot be guessed directly by looking at the association name, you need to specify it via the :class option.  For example, if you have two separate foreign keys in the albums table that both point to the artists table, maybe to indicate one artist is the vocalist and one is the composer, you&#39;d have to use the :class option:</p>

<pre class="ruby"><span class="ruby-comment"># Database schema:</span>
<span class="ruby-comment">#  artists            albums</span>
<span class="ruby-comment">#   :id   &lt;----\       :id</span>
<span class="ruby-comment">#   :name       \----- :vocalist_id</span>
<span class="ruby-comment">#                \---- :composer_id</span>
<span class="ruby-comment">#                      :name</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Album</span>
  <span class="ruby-identifier">many_to_one</span> <span class="ruby-value">:vocalist</span>, <span class="ruby-value">class:</span> <span class="ruby-value">:Artist</span>
  <span class="ruby-identifier">many_to_one</span> <span class="ruby-value">:composer</span>, <span class="ruby-value">class:</span> <span class="ruby-value">:Artist</span>
<span class="ruby-keyword">end</span>
<span class="ruby-keyword">class</span> <span class="ruby-constant">Artist</span>
  <span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:vocalist_albums</span>, <span class="ruby-value">class:</span> <span class="ruby-value">:Album</span>, <span class="ruby-value">key:</span> <span class="ruby-value">:vocalist_id</span>
  <span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:composer_albums</span>, <span class="ruby-value">class:</span> <span class="ruby-value">:Album</span>, <span class="ruby-value">key:</span> <span class="ruby-value">:composer_id</span>
<span class="ruby-keyword">end</span>
</pre>

<h2 id="label-Self-referential+Associations">Self-referential Associations<span><a href="#label-Self-referential+Associations">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>Self-referential associations are easy to handle in <a href="../Sequel.html"><code>Sequel</code></a>.  The simplest example is a tree structure:</p>

<pre class="ruby"><span class="ruby-comment"># Database schema:</span>
<span class="ruby-comment">#  nodes</span>
<span class="ruby-comment">#   :id        &lt;--\</span>
<span class="ruby-comment">#   :parent_id ---/</span>
<span class="ruby-comment">#   :name</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Node</span>
  <span class="ruby-identifier">many_to_one</span> <span class="ruby-value">:parent</span>, <span class="ruby-value">class:</span> <span class="ruby-keyword">self</span>
  <span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:children</span>, <span class="ruby-value">key:</span> <span class="ruby-value">:parent_id</span>, <span class="ruby-value">class:</span> <span class="ruby-keyword">self</span>
<span class="ruby-keyword">end</span>
</pre>

<p>For many_to_many self_referential associations, it&#39;s fairly similar.  Here&#39;s an example of a directed graph:</p>

<pre class="ruby"><span class="ruby-comment"># Database schema:</span>
<span class="ruby-comment">#  nodes              edges</span>
<span class="ruby-comment">#   :id   &lt;----------- :successor_id</span>
<span class="ruby-comment">#   :name       \----- :predecessor_id</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Node</span>
  <span class="ruby-identifier">many_to_many</span> <span class="ruby-value">:direct_predecessors</span>, <span class="ruby-value">left_key:</span> <span class="ruby-value">:successor_id</span>,
    <span class="ruby-value">right_key:</span> <span class="ruby-value">:predecessor_id</span>, <span class="ruby-value">join_table:</span> <span class="ruby-value">:edges</span>, <span class="ruby-value">class:</span> <span class="ruby-keyword">self</span>
  <span class="ruby-identifier">many_to_many</span> <span class="ruby-value">:direct_successors</span>, <span class="ruby-value">right_key:</span> <span class="ruby-value">:successor_id</span>,
    <span class="ruby-value">left_key:</span> <span class="ruby-value">:predecessor_id</span>, <span class="ruby-value">join_table:</span> <span class="ruby-value">:edges</span>, <span class="ruby-value">class:</span> <span class="ruby-keyword">self</span>
<span class="ruby-keyword">end</span>
</pre>

<h2 id="label-Methods+Added">Methods Added<span><a href="#label-Methods+Added">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>When you create an association, it&#39;s going to add instance methods to the class related to the association.</p>

<p>All associations are going to have an instance method added with the same name as the association:</p>

<pre class="ruby"><span class="ruby-ivar">@artist</span>.<span class="ruby-identifier">albums</span>
<span class="ruby-ivar">@album</span>.<span class="ruby-identifier">artists</span>
</pre>

<p>many_to_one and one_to_one associations will also have a setter method added to change the associated object:</p>

<pre class="ruby"><span class="ruby-ivar">@album</span>.<span class="ruby-identifier">artist</span> = <span class="ruby-constant">Artist</span>.<span class="ruby-identifier">create</span>(<span class="ruby-value">name:</span> <span class="ruby-string">&#39;YJM&#39;</span>)
</pre>

<p>many_to_many and one_to_many associations will have three methods added:</p>
<dl class="rdoc-list note-list"><dt>add_* 
<dd>
<p>to associate an object to the current object</p>
</dd><dt>remove_* 
<dd>
<p>to disassociate an object from the current object</p>
</dd><dt>remove_all_* 
<dd>
<p>to dissociate all currently associated objects</p>
</dd></dl>

<p>Examples:</p>

<pre class="ruby"><span class="ruby-ivar">@artist</span>.<span class="ruby-identifier">add_album</span>(<span class="ruby-ivar">@album</span>)
<span class="ruby-ivar">@artist</span>.<span class="ruby-identifier">remove_album</span>(<span class="ruby-ivar">@album</span>)
<span class="ruby-ivar">@artist</span>.<span class="ruby-identifier">remove_all_albums</span>
</pre>

<p>Note that the remove_all_* method does not call remove hooks defined on the association, it just issues a single query to the database.  If you want to remove all associated objects and call remove hooks, iterate over the array of associated objects and call remove_* for each:</p>

<pre class="ruby"><span class="ruby-ivar">@artist</span>.<span class="ruby-identifier">albums</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">album</span><span class="ruby-operator">|</span>
  <span class="ruby-ivar">@artist</span>.<span class="ruby-identifier">remove_album</span>(<span class="ruby-identifier">album</span>)
<span class="ruby-keyword">end</span>
</pre>

<h2 id="label-Caching">Caching<span><a href="#label-Caching">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>Associations are cached after being retrieved:</p>

<pre class="ruby"><span class="ruby-ivar">@artist</span>.<span class="ruby-identifier">album</span> <span class="ruby-comment"># Not cached - Database Query</span>
<span class="ruby-ivar">@artist</span>.<span class="ruby-identifier">album</span> <span class="ruby-comment"># Cached - No Database Query</span>

<span class="ruby-ivar">@album</span>.<span class="ruby-identifier">artists</span> <span class="ruby-comment"># Not cached - Database Query</span>
<span class="ruby-ivar">@album</span>.<span class="ruby-identifier">artists</span> <span class="ruby-comment"># Cached - No Database Query</span>
</pre>

<p>You can choose to ignore the cached versions and do a database query to retrieve results by passing a :reload=&gt;true option to the association method:</p>

<pre class="ruby"><span class="ruby-ivar">@album</span>.<span class="ruby-identifier">artists</span> <span class="ruby-comment"># Not cached - Database Query</span>
<span class="ruby-ivar">@album</span>.<span class="ruby-identifier">artists</span> <span class="ruby-comment"># Cached - No Database Query</span>
<span class="ruby-ivar">@album</span>.<span class="ruby-identifier">artists</span>(<span class="ruby-value">:reload</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">true</span>) <span class="ruby-comment"># Ignore cache - Database Query</span>
</pre>

<p>If you reload/refresh the object, it will automatically clear the associations cache for the object:</p>

<pre class="ruby"><span class="ruby-ivar">@album</span>.<span class="ruby-identifier">artists</span> <span class="ruby-comment"># Not cached - Database Query</span>
<span class="ruby-ivar">@album</span>.<span class="ruby-identifier">artists</span> <span class="ruby-comment"># Cached - No Database Query</span>
<span class="ruby-ivar">@album</span>.<span class="ruby-identifier">reload</span>
<span class="ruby-ivar">@album</span>.<span class="ruby-identifier">artists</span> <span class="ruby-comment"># Not Cached - Database Query</span>
</pre>

<p>If you want direct access to the associations cache, use the associations instance method:</p>

<pre class="ruby"><span class="ruby-ivar">@album</span>.<span class="ruby-identifier">associations</span> <span class="ruby-comment"># {}</span>
<span class="ruby-ivar">@album</span>.<span class="ruby-identifier">associations</span>[<span class="ruby-value">:artists</span>] <span class="ruby-comment"># nil</span>
<span class="ruby-ivar">@album</span>.<span class="ruby-identifier">artists</span> <span class="ruby-comment"># [&lt;Artist ...&gt;, ...]</span>
<span class="ruby-ivar">@album</span>.<span class="ruby-identifier">associations</span>[<span class="ruby-value">:artists</span>] <span class="ruby-comment"># [&lt;Artist ...&gt;, ...]</span>
</pre>

<h2 id="label-Dataset+Method">Dataset Method<span><a href="#label-Dataset+Method">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>In addition to the above methods, associations also add an instance method ending in <code>_dataset</code> that returns a dataset representing the objects in the associated table:</p>

<pre class="ruby"><span class="ruby-ivar">@album</span>.<span class="ruby-identifier">artist_id</span>
<span class="ruby-comment"># 10</span>
<span class="ruby-ivar">@album</span>.<span class="ruby-identifier">artist_dataset</span>
<span class="ruby-comment"># SELECT * FROM artists WHERE (id = 10) LIMIT 1</span>

<span class="ruby-ivar">@artist</span>.<span class="ruby-identifier">id</span>
<span class="ruby-comment"># 20</span>
<span class="ruby-ivar">@artist</span>.<span class="ruby-identifier">albums_dataset</span>
<span class="ruby-comment"># SELECT * FROM albums WHERE (artist_id = 20)</span>
</pre>

<p>The association dataset is just like any other <a href="../Sequel.html"><code>Sequel</code></a> dataset, in that it can be further filtered, ordered, etc.:</p>

<pre class="ruby"><span class="ruby-ivar">@artist</span>.<span class="ruby-identifier">albums_dataset</span>.
 <span class="ruby-identifier">where</span>(<span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">like</span>(<span class="ruby-value">:name</span>, <span class="ruby-string">&#39;A%&#39;</span>)).
 <span class="ruby-identifier">order</span>(<span class="ruby-value">:copies_sold</span>).
 <span class="ruby-identifier">limit</span>(<span class="ruby-value">10</span>)
<span class="ruby-comment"># SELECT * FROM albums</span>
<span class="ruby-comment"># WHERE ((artist_id = 20) AND (name LIKE &#39;A%&#39; ESCAPE &#39;\&#39;))</span>
<span class="ruby-comment"># ORDER BY copies_sold LIMIT 10</span>
</pre>

<p>Records retrieved using the <code>_dataset</code> method are not cached in the associations cache.</p>

<pre class="ruby"><span class="ruby-ivar">@album</span>.<span class="ruby-identifier">artists_dataset</span>.<span class="ruby-identifier">all</span> <span class="ruby-comment"># [&lt;Artist ...&gt;, ...]</span>
<span class="ruby-ivar">@album</span>.<span class="ruby-identifier">associations</span>[<span class="ruby-value">:artists</span>] <span class="ruby-comment"># nil</span>
</pre>

<h2 id="label-Dynamic+Association+Modification">Dynamic Association Modification<span><a href="#label-Dynamic+Association+Modification">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>Similar to the <code>_dataset</code> method, you can provide a block to the association method to customize the dataset that will be used to retrieve the records.  So you can apply a filter in either of these two ways:</p>

<pre class="ruby"><span class="ruby-ivar">@artist</span>.<span class="ruby-identifier">albums_dataset</span>.<span class="ruby-identifier">where</span>(<span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">like</span>(<span class="ruby-value">:name</span>, <span class="ruby-string">&#39;A%&#39;</span>))
<span class="ruby-ivar">@artist</span>.<span class="ruby-identifier">albums</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">ds</span><span class="ruby-operator">|</span> <span class="ruby-identifier">ds</span>.<span class="ruby-identifier">where</span>(<span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">like</span>(<span class="ruby-value">:name</span>, <span class="ruby-string">&#39;A%&#39;</span>))}
</pre>

<p>While they both apply the same filter, using the <code>_dataset</code> method does not apply any of the association callbacks or handle association reciprocals (see below for details about callbacks and reciprocals).  Using a block instead handles all those things, and also caches its results in the associations cache (ignoring any previously cached value).</p>

<h2 id="label-Filtering+By+Associations">Filtering By Associations<span><a href="#label-Filtering+By+Associations">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>In addition to using the association method to get associated objects, you can also use associated objects in filters.  For example, to get all albums for a given artist, you would usually do:</p>

<pre class="ruby"><span class="ruby-ivar">@artist</span>.<span class="ruby-identifier">albums</span>
<span class="ruby-comment"># or @artist.albums_dataset for a dataset</span>
</pre>

<p>You can also do the following:</p>

<pre class="ruby"><span class="ruby-constant">Album</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">artist:</span> <span class="ruby-ivar">@artist</span>).<span class="ruby-identifier">all</span>
<span class="ruby-comment"># or leave off the .all for a dataset</span>
</pre>

<p>For filtering by a single association, this isn&#39;t very useful.  However, unlike using the association method, using a filter allows you to filter by multiple associations:</p>

<pre class="ruby"><span class="ruby-constant">Album</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">artist:</span> <span class="ruby-ivar">@artist</span>, <span class="ruby-value">publisher:</span> <span class="ruby-ivar">@publisher</span>)
</pre>

<p>This will return all albums by that artist and published by that publisher. This isn&#39;t possible using just the association method approach, though you can combine the approaches:</p>

<pre class="ruby"><span class="ruby-ivar">@artist</span>.<span class="ruby-identifier">albums_dataset</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">publisher:</span> <span class="ruby-ivar">@publisher</span>)
</pre>

<p>This doesn&#39;t just work for <code>many_to_one</code> associations, it also works for the other associations:</p>

<pre class="ruby"><span class="ruby-constant">Album</span>.<span class="ruby-identifier">one_to_one</span> <span class="ruby-value">:album_info</span>
<span class="ruby-comment"># The album related to that AlbumInfo instance</span>
<span class="ruby-constant">Album</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">album_info:</span> <span class="ruby-constant">AlbumInfo</span>[<span class="ruby-value">2</span>])

<span class="ruby-constant">Album</span>.<span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:tracks</span>
<span class="ruby-comment"># The album related to that Track instance</span>
<span class="ruby-constant">Album</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">tracks:</span> <span class="ruby-constant">Track</span>[<span class="ruby-value">3</span>])

<span class="ruby-constant">Album</span>.<span class="ruby-identifier">many_to_many</span> <span class="ruby-value">:tags</span>
<span class="ruby-comment"># All albums related to that Tag instance</span>
<span class="ruby-constant">Album</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">tags:</span> <span class="ruby-constant">Tag</span>[<span class="ruby-value">4</span>])

<span class="ruby-constant">Album</span>.<span class="ruby-identifier">one_through_one</span> <span class="ruby-value">:tag</span>
<span class="ruby-comment"># All albums related to that Tag instance</span>
<span class="ruby-constant">Album</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">tag:</span> <span class="ruby-constant">Tag</span>[<span class="ruby-value">4</span>])
</pre>

<p>Note that for <code>one_to_many</code> and <code>many_to_many</code> associations, you still use the plural form even though only a single model object is given.</p>

<p>You can also exclude by associations:</p>

<pre class="ruby"><span class="ruby-constant">Album</span>.<span class="ruby-identifier">exclude</span>(<span class="ruby-value">artist:</span> <span class="ruby-ivar">@artist</span>).<span class="ruby-identifier">all</span>
</pre>

<p>This will return all albums not by that artist.</p>

<p>You can also provide an array with multiple model objects:</p>

<pre class="ruby"><span class="ruby-constant">Album</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">artist:</span> [<span class="ruby-ivar">@artist1</span>, <span class="ruby-ivar">@artist2</span>]).<span class="ruby-identifier">all</span>
</pre>

<p>Similar to using an array of integers or strings, this will return all albums whose artist is one of those two artists.  You can also use <code>exclude</code> if you want all albums not by either of those artists:</p>

<pre class="ruby"><span class="ruby-constant">Album</span>.<span class="ruby-identifier">exclude</span>(<span class="ruby-value">artist:</span> [<span class="ruby-ivar">@artist1</span>, <span class="ruby-ivar">@artist2</span>]).<span class="ruby-identifier">all</span>
</pre>

<p>If you are using a <code>one_to_many</code> or <code>many_to_many</code> association, you may want to return records where the records matches all of multiple records, instead of matching any of them.  For example:</p>

<pre class="ruby"><span class="ruby-constant">Album</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">tags:</span> [<span class="ruby-ivar">@tag1</span>, <span class="ruby-ivar">@tag2</span>])
</pre>

<p>This matches albums that are associated with either @tag1 or @tag2 or both.  If you only want ones that you are associated with both, you can use separate filter calls:</p>

<pre class="ruby"><span class="ruby-constant">Album</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">tags:</span> <span class="ruby-ivar">@tag1</span>).<span class="ruby-identifier">where</span>(<span class="ruby-value">tags:</span> <span class="ruby-ivar">@tag2</span>)
</pre>

<p>Or the array form of condition specifiers:</p>

<pre class="ruby"><span class="ruby-constant">Album</span>.<span class="ruby-identifier">where</span>([[<span class="ruby-value">:tags</span>, <span class="ruby-ivar">@tag1</span>], [<span class="ruby-value">:tags</span>, <span class="ruby-ivar">@tag2</span>]])
</pre>

<p>These will return albums associated with both @tag1 and @tag2.</p>

<p>You can also provide a dataset value when filtering by associations:</p>

<pre class="ruby"><span class="ruby-constant">Album</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">artist:</span> <span class="ruby-constant">Artist</span>.<span class="ruby-identifier">where</span>(<span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">like</span>(<span class="ruby-value">:name</span>, <span class="ruby-string">&#39;A%&#39;</span>))).<span class="ruby-identifier">all</span>
</pre>

<p>This will return all albums whose artist starts with &#39;A&#39;. Like the other forms, this can be inverted:</p>

<pre class="ruby"><span class="ruby-constant">Album</span>.<span class="ruby-identifier">exclude</span>(<span class="ruby-value">artist:</span> <span class="ruby-constant">Artist</span>.<span class="ruby-identifier">where</span>(<span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">like</span>(<span class="ruby-value">:name</span>, <span class="ruby-string">&#39;A%&#39;</span>))).<span class="ruby-identifier">all</span>
</pre>

<p>This will return all albums whose artist does not start with &#39;A&#39;.</p>

<p>Filtering by associations even works for associations that have conditions added via the :conditions option or a block:</p>

<pre class="ruby"><span class="ruby-constant">Album</span>.<span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:popular_tags</span>, <span class="ruby-value">clone:</span> <span class="ruby-value">:tags</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ds</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">ds</span>.<span class="ruby-identifier">where</span>{<span class="ruby-identifier">times_used</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1000</span>}
<span class="ruby-keyword">end</span>
<span class="ruby-constant">Album</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">popular_tags:</span> [<span class="ruby-ivar">@tag1</span>, <span class="ruby-ivar">@tag2</span>])
</pre>

<p>This will return all albums that whose popular tags would include at least one of those tags.</p>

<p>Note that filtering by associations does not work for associations that use blocks with instance-specific code.</p>

<h2 id="label-Name+Collisions">Name Collisions<span><a href="#label-Name+Collisions">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>Because associations create instance methods, it&#39;s possible to override existing instance methods if you name an association the same as an existing method.  For example, <code>values</code> and <code>associations</code> would be bad association names.</p>

<h2 id="label-Database+Schema">Database Schema<span><a href="#label-Database+Schema">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>Creating an association doesn&#39;t modify the database schema.  <a href="../Sequel.html"><code>Sequel</code></a> assumes your associations reflect the existing database schema.  If not, you should modify your schema before creating the associations.</p>

<h3 id="label-many_to_one-2Fone_to_many">many_to_one/one_to_many<span><a href="#label-many_to_one-2Fone_to_many">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>For example, for the following model code:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Album</span>
  <span class="ruby-identifier">many_to_one</span> <span class="ruby-value">:artist</span>
<span class="ruby-keyword">end</span>
<span class="ruby-keyword">class</span> <span class="ruby-constant">Artist</span>
  <span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:albums</span>
<span class="ruby-keyword">end</span>
</pre>

<p>You probably want the following database schema:</p>

<pre class="ruby"><span class="ruby-comment">#  albums             artists</span>
<span class="ruby-comment">#   :id           /--&gt; :id</span>
<span class="ruby-comment">#   :artist_id --/     :name</span>
<span class="ruby-comment">#   :name</span>
</pre>

<p>Which could be created using the following <a href="../Sequel.html"><code>Sequel</code></a> code:</p>

<pre class="ruby"><span class="ruby-constant">DB</span>.<span class="ruby-identifier">create_table</span>(<span class="ruby-value">:artists</span>) <span class="ruby-keyword">do</span>
  <span class="ruby-comment"># Primary key must be set explicitly</span>
  <span class="ruby-identifier">primary_key</span> <span class="ruby-value">:id</span>
  <span class="ruby-constant">String</span> <span class="ruby-value">:name</span>, <span class="ruby-value">:null</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">false</span>, <span class="ruby-value">:unique</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span>
<span class="ruby-constant">DB</span>.<span class="ruby-identifier">create_table</span>(<span class="ruby-value">:albums</span>) <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">primary_key</span> <span class="ruby-value">:id</span>
  <span class="ruby-comment"># Table that foreign key references needs to be set explicitly</span>
  <span class="ruby-comment"># for a database foreign key reference to be created.</span>
  <span class="ruby-identifier">foreign_key</span> <span class="ruby-value">:artist_id</span>, <span class="ruby-value">:artists</span>, <span class="ruby-value">:null</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">false</span>
  <span class="ruby-constant">String</span> <span class="ruby-value">:name</span>, <span class="ruby-value">:null</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">false</span>, <span class="ruby-value">:unique</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span>
</pre>

<p>If you already had a schema such as:</p>

<pre class="ruby"><span class="ruby-comment"># Database schema:</span>
<span class="ruby-comment">#  albums             artists</span>
<span class="ruby-comment">#   :id                :id</span>
<span class="ruby-comment">#   :name              :name</span>
</pre>

<p>Then you just need to add the column:</p>

<pre class="ruby"><span class="ruby-constant">DB</span>.<span class="ruby-identifier">alter_table</span>(<span class="ruby-value">:albums</span>) <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">add_foreign_key</span> <span class="ruby-value">:artist_id</span>, <span class="ruby-value">:artists</span>, <span class="ruby-value">:null</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">false</span>
<span class="ruby-keyword">end</span>
</pre>

<h3 id="label-many_to_many">many_to_many<span><a href="#label-many_to_many">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>With many_to_many associations, the default join table for the association uses the sorted underscored names of both model classes.  For example, with the following model code:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Album</span>
  <span class="ruby-identifier">many_to_many</span> <span class="ruby-value">:artists</span>
<span class="ruby-keyword">end</span>
<span class="ruby-keyword">class</span> <span class="ruby-constant">Artist</span>
  <span class="ruby-identifier">many_to_many</span> <span class="ruby-value">:albums</span>
<span class="ruby-keyword">end</span>
</pre>

<p>The default join table name would be <code>albums_artists</code>, not <code>artists_albums</code>, because:</p>

<pre class="ruby">[<span class="ruby-string">&quot;artists&quot;</span>, <span class="ruby-string">&quot;albums&quot;</span>].<span class="ruby-identifier">sort</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&#39;_&#39;</span>)
<span class="ruby-comment"># &quot;albums_artists&quot;</span>
</pre>

<p>Assume you already had the albums and artists tables created, and you just wanted to add an albums_artists join table to create the following schema:</p>

<pre class="ruby"><span class="ruby-comment"># Database schema:</span>
<span class="ruby-comment">#  albums</span>
<span class="ruby-comment">#   :id   &lt;----\</span>
<span class="ruby-comment">#   :name       \     albums_artists</span>
<span class="ruby-comment">#                \---- :album_id</span>
<span class="ruby-comment">#  artists       /---- :artist_id</span>
<span class="ruby-comment">#   :id   &lt;-----/</span>
<span class="ruby-comment">#   :name</span>
</pre>

<p>You could use the following <a href="../Sequel.html"><code>Sequel</code></a> code:</p>

<pre class="ruby"><span class="ruby-constant">DB</span>.<span class="ruby-identifier">create_join_table</span>(<span class="ruby-value">:album_id</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">:albums</span>, <span class="ruby-value">:artist_id</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">:artists</span>)
<span class="ruby-comment"># or</span>
<span class="ruby-constant">DB</span>.<span class="ruby-identifier">create_table</span>(<span class="ruby-value">:albums_artists</span>) <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">foreign_key</span> <span class="ruby-value">:album_id</span>, <span class="ruby-value">:albums</span>, <span class="ruby-value">:null</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">false</span>
  <span class="ruby-identifier">foreign_key</span> <span class="ruby-value">:artist_id</span>, <span class="ruby-value">:artists</span>, <span class="ruby-value">:null</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">false</span>
  <span class="ruby-identifier">primary_key</span> [<span class="ruby-value">:album_id</span>, <span class="ruby-value">:artist_id</span>]
  <span class="ruby-identifier">index</span> [<span class="ruby-value">:artist_id</span>, <span class="ruby-value">:album_id</span>]
<span class="ruby-keyword">end</span>
</pre>

<h2 id="label-Association+Scope">Association Scope<span><a href="#label-Association+Scope">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>If you nest your <a href="../Sequel/Model.html"><code>Sequel::Model</code></a> classes inside modules, then you should know that <a href="../Sequel.html"><code>Sequel</code></a> will only look in the same module for associations by default. So the following code will work fine:</p>

<pre class="ruby"><span class="ruby-keyword">module</span> <span class="ruby-constant">App</span>
  <span class="ruby-keyword">class</span> <span class="ruby-constant">Artist</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>
    <span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:albums</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">class</span> <span class="ruby-constant">Album</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>
    <span class="ruby-identifier">many_to_one</span> <span class="ruby-value">:artist</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>However, if you enclose your model classes inside two different modules, things will not work by default:</p>

<pre class="ruby"><span class="ruby-keyword">module</span> <span class="ruby-constant">App1</span>
  <span class="ruby-keyword">class</span> <span class="ruby-constant">Artist</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>
    <span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:albums</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
<span class="ruby-keyword">module</span> <span class="ruby-constant">App2</span>
  <span class="ruby-keyword">class</span> <span class="ruby-constant">Album</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>
    <span class="ruby-identifier">many_to_one</span> <span class="ruby-value">:artist</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>To fix this, you need to specify the full model class name using the :class option:</p>

<pre class="ruby"><span class="ruby-keyword">module</span> <span class="ruby-constant">App1</span>
  <span class="ruby-keyword">class</span> <span class="ruby-constant">Artist</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>
    <span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:albums</span>, <span class="ruby-value">class:</span> <span class="ruby-string">&quot;App2::Album&quot;</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
<span class="ruby-keyword">module</span> <span class="ruby-constant">App2</span>
  <span class="ruby-keyword">class</span> <span class="ruby-constant">Album</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>
    <span class="ruby-identifier">many_to_one</span> <span class="ruby-value">:artist</span>, <span class="ruby-value">class:</span> <span class="ruby-string">&quot;App1::Artist&quot;</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>If both classes are in the same module, but the default class name used is not correct, you need to specify the full class name with the :class option:</p>

<pre class="ruby"><span class="ruby-keyword">module</span> <span class="ruby-constant">App1</span>
  <span class="ruby-keyword">class</span> <span class="ruby-constant">AlbumArtist</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>
    <span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:albums</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">class</span> <span class="ruby-constant">Album</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>
    <span class="ruby-identifier">many_to_one</span> <span class="ruby-value">:artist</span>, <span class="ruby-value">class:</span> <span class="ruby-string">&quot;App1::AlbumArtist&quot;</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h2 id="label-Method+Details">Method Details<span><a href="#label-Method+Details">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>In all of these methods, <em>association</em> is replaced by the symbol you pass to the association.</p>

<h3 id="label-association-28opts-3D-7B-7D-29+-28e.g.+albums-29"><em>association</em>(opts={}) (e.g. albums)<span><a href="#label-association-28opts-3D-7B-7D-29+-28e.g.+albums-29">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>For <code>many_to_one</code> and <code>one_to_one</code> associations, the <em>association</em> method returns either the single object associated, or nil if no object is associated.</p>

<pre class="ruby"><span class="ruby-ivar">@artist</span> = <span class="ruby-ivar">@album</span>.<span class="ruby-identifier">artist</span>
</pre>

<p>For <code>one_to_many</code> and <code>many_to_many</code> associations, the <em>association</em> method returns an array of associated objects, which may be empty if no objects are currently associated.</p>

<pre class="ruby"><span class="ruby-ivar">@albums</span> = <span class="ruby-ivar">@artist</span>.<span class="ruby-identifier">albums</span>
</pre>

<h3 id="label-association-3D-28object_to_associate-29+-28e.g.+artist-3D-29+-5Bmany_to_one+and+one_to_one-5D"><em>association</em>=(object_to_associate) (e.g. artist=) [<code>many_to_one</code> and <code>one_to_one</code>]<span><a href="#label-association-3D-28object_to_associate-29+-28e.g.+artist-3D-29+-5Bmany_to_one+and+one_to_one-5D">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The <em>association</em>= method sets up an association of the passed object to the current object.  For <code>many_to_one</code> associations, this sets the foreign key for the current object to point to the associated object&#39;s primary key.</p>

<pre class="ruby"><span class="ruby-ivar">@album</span>.<span class="ruby-identifier">artist</span> = <span class="ruby-ivar">@artist</span>
</pre>

<p>For <code>one_to_one</code> associations, this sets the foreign key of the associated object to the primary key value of the current object.</p>

<p>For <code>many_to_one</code> associations, this does not save the current object. For <code>one_to_one</code> associations, this does save the associated object.</p>

<h3 id="label-add_association-28object_to_associate-29+-28e.g.+add_album-29+-5Bone_to_many+and+many_to_many-5D">add_<em>association</em>(object_to_associate) (e.g. add_album) [<code>one_to_many</code> and <code>many_to_many</code>]<span><a href="#label-add_association-28object_to_associate-29+-28e.g.+add_album-29+-5Bone_to_many+and+many_to_many-5D">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The add_<em>association</em> method associates the passed object to the current object.  For <code>one_to_many</code> associations, it sets the foreign key of the associated object to the primary key value of the current object, and saves the associated object.  For <code>many_to_many</code> associations, this inserts a row into the join table with the foreign keys set to the primary key values of the current and associated objects.  Note that the singular form of the association name is used in this method.</p>

<pre class="ruby"><span class="ruby-ivar">@artist</span>.<span class="ruby-identifier">add_album</span>(<span class="ruby-ivar">@album</span>)
</pre>

<p>In addition to passing an actual associated object, you can pass a hash, and a new associated object will be created from them:</p>

<pre class="ruby"><span class="ruby-ivar">@artist</span>.<span class="ruby-identifier">add_album</span>(<span class="ruby-value">name:</span> <span class="ruby-string">&#39;RF&#39;</span>) <span class="ruby-comment"># creates Album object</span>
</pre>

<p>The add_<em>association</em> method returns the new associated object:</p>

<pre class="ruby"><span class="ruby-ivar">@album</span> = <span class="ruby-ivar">@artist</span>.<span class="ruby-identifier">add_album</span>(<span class="ruby-value">name:</span> <span class="ruby-string">&#39;RF&#39;</span>)
</pre>

<p>Note that the add_* methods for <code>one_to_many</code> persist the changes by saving the passed in (or newly created) object.  However, to avoid silent failures of these methods, they explicitly raise exceptions even when raise_on_save_failure is false for the associated model. You can disable this behavior (i.e. return nil instead of raising exceptions on a save failure) by setting the <code>:raise_on_save_failure=&gt;false</code> option for the association.</p>

<h3 id="label-remove_association-28object_to_disassociate-29+-28e.g.+remove_album-29+-5Bone_to_many+and+many_to_many-5D">remove_<em>association</em>(object_to_disassociate) (e.g. remove_album) [<code>one_to_many</code> and <code>many_to_many</code>]<span><a href="#label-remove_association-28object_to_disassociate-29+-28e.g.+remove_album-29+-5Bone_to_many+and+many_to_many-5D">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The remove_<em>association</em> method disassociates the passed object from the current object.  For <code>one_to_many</code> associations, it sets the foreign key of the associated object to NULL, and saves the associated object.  For <code>many_to_many</code> associations, this deletes the matching row in the join table. Similar to the add_<em>association</em> method, the singular form of the association name is used in this method.</p>

<pre class="ruby"><span class="ruby-ivar">@artist</span>.<span class="ruby-identifier">remove_album</span>(<span class="ruby-ivar">@album</span>)
</pre>

<p>Note that this does not delete <code>@album</code> from the database, it only disassociates it from the <code>@artist</code>.  To delete <code>@album</code> from the database:</p>

<pre class="ruby"><span class="ruby-ivar">@album</span>.<span class="ruby-identifier">destroy</span>
</pre>

<p>The add_<em>association</em> and remove_<em>association</em> methods should be thought of as adding and removing from the association, not from the database.</p>

<p>In addition to passing the object directly to remove_<em>association</em>, you can also pass the associated object&#39;s primary key:</p>

<pre class="ruby"><span class="ruby-ivar">@artist</span>.<span class="ruby-identifier">remove_album</span>(<span class="ruby-value">10</span>)
</pre>

<p>This will look up the associated object using the key, and remove that album.</p>

<p>The remove_<em>association</em> method returns the now disassociated object:</p>

<pre class="ruby"><span class="ruby-ivar">@album</span> = <span class="ruby-ivar">@artist</span>.<span class="ruby-identifier">remove_album</span>(<span class="ruby-value">10</span>)
</pre>

<h3 id="label-remove_all_association+-28e.g.+remove_all_albums-29+-5Bone_to_many+and+many_to_many-5D">remove_all_<em>association</em> (e.g. remove_all_albums) [<code>one_to_many</code> and <code>many_to_many</code>]<span><a href="#label-remove_all_association+-28e.g.+remove_all_albums-29+-5Bone_to_many+and+many_to_many-5D">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The remove_all_<em>association</em> method disassociates all currently associated objects.  For <code>one_to_many</code> associations, it sets the foreign key of all associated objects to NULL in a single query.  For <code>many_to_many</code> associations, this deletes all matching rows in the join table. Unlike the add_<em>association</em> and remove_<em>association</em> method, the plural form of the association name is used in this method. The remove_all_<em>association</em> method returns the previously cached associated records, or nil if there were no cached associated records.</p>

<h3 id="label-association_dataset+-28e.g.+albums_dataset-29"><em>association</em>_dataset (e.g. albums_dataset)<span><a href="#label-association_dataset+-28e.g.+albums_dataset-29">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The <em>association</em>_dataset method returns a dataset that represents all associated objects.  This dataset is like any other <a href="../Sequel.html"><code>Sequel</code></a> dataset, in that it can be filtered, ordered, etc.:</p>

<pre class="ruby"><span class="ruby-identifier">ds</span> = <span class="ruby-ivar">@artist</span>.<span class="ruby-identifier">albums_dataset</span>.<span class="ruby-identifier">where</span>(<span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">like</span>(<span class="ruby-value">:name</span>, <span class="ruby-string">&#39;A%&#39;</span>)).<span class="ruby-identifier">order</span>(<span class="ruby-value">:copies_sold</span>)
</pre>

<p>Unlike most other <a href="../Sequel.html"><code>Sequel</code></a> datasets, association datasets have a couple of added methods:</p>

<pre class="ruby"><span class="ruby-identifier">ds</span>.<span class="ruby-identifier">model_object</span> <span class="ruby-comment"># @artist</span>
<span class="ruby-identifier">ds</span>.<span class="ruby-identifier">association_reflection</span> <span class="ruby-comment"># same as Artist.association_reflection(:albums)</span>
</pre>

<p>For a more info on Sequel&#39;s reflection capabilities see the <a href="reflection_rdoc.html">Reflection page</a>.</p>

<h2 id="label-Overriding+Method+Behavior">Overriding Method Behavior<span><a href="#label-Overriding+Method+Behavior">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p><a href="../Sequel.html"><code>Sequel</code></a> is designed to be very flexible.  If the default behavior of the association modification methods isn&#39;t what you desire, you can override the methods in your classes.  However, you should be aware that for each of the association modification methods described, there is a private method that is preceded by an underscore that does the actual modification.  The public method without the underscore handles caching and callbacks, and shouldn&#39;t be overridden by the user.</p>

<p>In addition to overriding the private method in your class, you can also use association options to change which method <a href="../Sequel.html"><code>Sequel</code></a> defines.  The only difference between the two is that if you use an association option to change the method <a href="../Sequel.html"><code>Sequel</code></a> defines, you cannot call super to get the default behavior.</p>

<h3 id="label-3Asetter+-28_association-3D+method-29">:setter (_<em>association</em>= method)<span><a href="#label-3Asetter+-28_association-3D+method-29">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>Let&#39;s say you want to set a specific field whenever associating an object using the association setter method.  For example, let&#39;s say you have a file_under column for each album to tell you where to file it.  If the album is associated with an artist, it should be filed under the artist&#39;s name and the album&#39;s name, otherwise it should just use the album&#39;s name.</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Album</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>
  <span class="ruby-identifier">many_to_one</span> <span class="ruby-value">:artist</span>, <span class="ruby-value">setter:</span> (<span class="ruby-identifier">lambda</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">artist</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">artist</span>
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">artist_id</span> = <span class="ruby-identifier">artist</span>.<span class="ruby-identifier">id</span>
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">file_under</span> = <span class="ruby-node">&quot;#{artist.name}-#{name}&quot;</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">artist_id</span> = <span class="ruby-keyword">nil</span>
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">file_under</span> = <span class="ruby-identifier">name</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>)
<span class="ruby-keyword">end</span>
</pre>

<p>The above example is contrived, as you would generally use a before_save model hook to handle such a modification.  However, if you only modify the album&#39;s artist using the artist= method, this approach may perform better.</p>

<h3 id="label-3Aadder+-28_add_association+method-29">:adder (_add_<em>association</em> method)<span><a href="#label-3Aadder+-28_add_association+method-29">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>Continuing with the same example, here&#39;s how you would handle the same case if you also wanted to handle the Artist#add_album method:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Artist</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>
  <span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:albums</span>, <span class="ruby-value">adder:</span> (<span class="ruby-identifier">lambda</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">album</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">album</span>.<span class="ruby-identifier">update</span>(<span class="ruby-value">artist_id:</span> <span class="ruby-identifier">id</span>, <span class="ruby-value">file_under:</span> <span class="ruby-node">&quot;#{name}-#{album.name}&quot;</span>)
  <span class="ruby-keyword">end</span>)
<span class="ruby-keyword">end</span>
</pre>

<p>You can set this to <code>nil</code> to not create a add_<em>association</em> method.</p>

<h3 id="label-3Aremover+-28_remove_association+method-29">:remover (_remove_<em>association</em> method)<span><a href="#label-3Aremover+-28_remove_association+method-29">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>Continuing with the same example, here&#39;s how you would handle the same case if you also wanted to handle the Artist#remove_album method:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Artist</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>
  <span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:albums</span>, <span class="ruby-value">remover:</span> (<span class="ruby-identifier">lambda</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">album</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">album</span>.<span class="ruby-identifier">update</span>(<span class="ruby-value">artist_id:</span> <span class="ruby-keyword">nil</span>, <span class="ruby-value">file_under:</span> <span class="ruby-identifier">album</span>.<span class="ruby-identifier">name</span>)
  <span class="ruby-keyword">end</span>)
<span class="ruby-keyword">end</span>
</pre>

<p>You can set this to <code>nil</code> to not create a remove_<em>association</em> method.</p>

<h3 id="label-3Aclearer+-28_remove_all_association+method-29">:clearer (_remove_all_<em>association</em> method)<span><a href="#label-3Aclearer+-28_remove_all_association+method-29">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>Continuing with the same example, here&#39;s how you would handle the same case if you also wanted to handle the Artist#remove_all_albums method:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Artist</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>
  <span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:albums</span>, <span class="ruby-value">clearer:</span> (<span class="ruby-identifier">lambda</span> <span class="ruby-keyword">do</span>
    <span class="ruby-comment"># This is Dataset#update, not Model#update, so the file_under: :name</span>
    <span class="ruby-comment"># ends up being &quot;SET file_under = name&quot; in SQL.</span>
    <span class="ruby-identifier">albums_dataset</span>.<span class="ruby-identifier">update</span>(<span class="ruby-value">artist_id:</span> <span class="ruby-keyword">nil</span>, <span class="ruby-value">file_under:</span> <span class="ruby-value">:name</span>)
  <span class="ruby-keyword">end</span>)
<span class="ruby-keyword">end</span>
</pre>

<p>You can set this to <code>nil</code> to not create a remove_all_<em>association</em> method.</p>

<h3 id="label-3Ano_dataset_method">:no_dataset_method<span><a href="#label-3Ano_dataset_method">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>Setting this to true will not result in the <em>association</em>_dataset method not being defined. This can save memory if you only use the <em>association</em> method and do not call the <em>association</em>_dataset method directly or indirectly.</p>

<h3 id="label-3Ano_association_method">:no_association_method<span><a href="#label-3Ano_association_method">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>Setting this to true will not result in the <em>association</em> method not being defined. This can save memory if you only use the <em>association</em>_dataset method and do not call the <em>association</em> method directly or indirectly.</p>

<h2 id="label-Association+Options">Association Options<span><a href="#label-Association+Options">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>Sequel&#39;s associations mostly share the same options.  For ease of understanding, they are grouped here by section.</p>

<p>The defaults for any of these options can be set at the class level using <code>Sequel::Model.default_association_options</code>.  To make associations read only by default:</p>

<pre class="ruby"><span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>.<span class="ruby-identifier">default_association_options</span>[<span class="ruby-value">:read_only</span>] = <span class="ruby-keyword">true</span>
</pre>

<p>Many of these options are specific to particular association types, and the defaults can be set on a per association type basis.  To make one_to_many associations read only by default:</p>

<pre class="ruby"><span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>.<span class="ruby-identifier">default_association_type_options</span>[<span class="ruby-value">:one_to_many</span>] = {<span class="ruby-value">read_only:</span> <span class="ruby-keyword">true</span>}
</pre>

<h3 id="label-Association+Dataset+Modification+Options">Association Dataset Modification Options<span><a href="#label-Association+Dataset+Modification+Options">&para;</a> <a href="#top">&uarr;</a></span></h3>

<h4 id="label-block">block<span><a href="#label-block">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>All association defining methods take a block that is passed the default dataset and should return a modified copy of the dataset to use for the association.  For example, if you wanted an association that returns all albums of an artist that went gold (sold at least 500,000 copies):</p>

<pre class="ruby"><span class="ruby-constant">Artist</span>.<span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:gold_albums</span>, <span class="ruby-value">class:</span> <span class="ruby-value">:Album</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ds</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">ds</span>.<span class="ruby-identifier">where</span>{<span class="ruby-identifier">copies_sold</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">500000</span>}
<span class="ruby-keyword">end</span>
</pre>

<p>The result of the block is cached as an optimization.  One of the side effects of that is that if your block depends on external state, it won&#39;t work correctly unless you setup a delayed evaluation.  For example:</p>

<pre class="ruby"><span class="ruby-constant">Artist</span>.<span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:gold_albums</span>, <span class="ruby-value">class:</span> <span class="ruby-value">:Album</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ds</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">ds</span>.<span class="ruby-identifier">where</span>{<span class="ruby-identifier">copies_sold</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">$gold_limit</span>}
<span class="ruby-keyword">end</span>
</pre>

<p>In this case if you change <code>$gold_limit</code> later, the changes won&#39;t effect the association.  If you want to pick up changes to <code>$gold_limit</code>, you need to setup a delayed evaluation:</p>

<pre class="ruby"><span class="ruby-constant">Artist</span>.<span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:gold_albums</span>, <span class="ruby-value">class:</span> <span class="ruby-value">:Album</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ds</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">ds</span>.<span class="ruby-identifier">where</span>{<span class="ruby-identifier">copies_sold</span> <span class="ruby-operator">&gt;</span> <span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">delay</span>{<span class="ruby-identifier">$gold_limit</span>}}
<span class="ruby-keyword">end</span>
</pre>

<h4 id="label-3Aclass">:class<span><a href="#label-3Aclass">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>This is the class of the associated objects that will be used.  It&#39;s one of the most commonly used options.  If it is not given, it guesses based on the name of the association, including considering the namespace of the current model.  If a *_to_many association is used, this uses the singular form of the association name.  For example:</p>

<pre class="ruby"><span class="ruby-constant">Album</span>.<span class="ruby-identifier">many_to_one</span> <span class="ruby-value">:artist</span> <span class="ruby-comment"># guesses Artist</span>
<span class="ruby-constant">Artist</span>.<span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:albums</span> <span class="ruby-comment"># guesses Album</span>
<span class="ruby-constant">Foo</span><span class="ruby-operator">::</span><span class="ruby-constant">Artist</span>.<span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:albums</span> <span class="ruby-comment"># guesses Foo::Album</span>
</pre>

<p>However, for more complex associations, especially ones that add additional filters beyond the foreign/primary key relationships, the default class guessed will be wrong:</p>

<pre class="ruby"><span class="ruby-comment"># guesses GoldAlbum</span>
<span class="ruby-constant">Artist</span>.<span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:gold_albums</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ds</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">ds</span>.<span class="ruby-identifier">where</span>{<span class="ruby-identifier">copies_sold</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">500000</span>}
<span class="ruby-keyword">end</span>
</pre>

<p>You can specify the :class option using the class itself, a Symbol, or a String:</p>

<pre class="ruby"><span class="ruby-constant">Album</span>.<span class="ruby-identifier">many_to_one</span> <span class="ruby-value">:artist</span>, <span class="ruby-value">class:</span> <span class="ruby-constant">Artist</span>   <span class="ruby-comment"># Class</span>
<span class="ruby-constant">Album</span>.<span class="ruby-identifier">many_to_one</span> <span class="ruby-value">:artist</span>, <span class="ruby-value">class:</span> <span class="ruby-value">:Artist</span>  <span class="ruby-comment"># Symbol</span>
<span class="ruby-constant">Album</span>.<span class="ruby-identifier">many_to_one</span> <span class="ruby-value">:artist</span>, <span class="ruby-value">class:</span> <span class="ruby-string">&quot;Artist&quot;</span> <span class="ruby-comment"># String</span>
</pre>

<p>If you are namespacing your models, and you need to specify the :class option, the path you give to the :class option should be the full path to the associated class including any namespaces:</p>

<pre class="ruby"><span class="ruby-constant">Foo</span><span class="ruby-operator">::</span><span class="ruby-constant">Album</span>.<span class="ruby-identifier">many_to_one</span> <span class="ruby-value">:artist</span>                       <span class="ruby-comment"># Uses Foo::Artist</span>
<span class="ruby-constant">Foo</span><span class="ruby-operator">::</span><span class="ruby-constant">Album</span>.<span class="ruby-identifier">many_to_one</span> <span class="ruby-value">:artist</span>, <span class="ruby-value">class:</span> <span class="ruby-string">&quot;Artist&quot;</span>      <span class="ruby-comment"># Uses Artist</span>
<span class="ruby-constant">Foo</span><span class="ruby-operator">::</span><span class="ruby-constant">Album</span>.<span class="ruby-identifier">many_to_one</span> <span class="ruby-value">:artist</span>, <span class="ruby-value">class:</span> <span class="ruby-string">&quot;Foo::Artist&quot;</span> <span class="ruby-comment"># Uses Foo::Artist</span>
</pre>

<h4 id="label-3Akey">:key<span><a href="#label-3Akey">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>For <code>many_to_one</code> associations, this is the foreign_key in the current model&#39;s table that references the associated model&#39;s primary key as a symbol. Defaults to :<em>association</em>_id.</p>

<pre class="ruby"><span class="ruby-constant">Album</span>.<span class="ruby-identifier">many_to_one</span> <span class="ruby-value">:artist</span>, <span class="ruby-value">key:</span> <span class="ruby-value">:artistid</span>
</pre>

<p>For <code>one_to_one</code> and <code>one_to_many</code> associations, is the foreign key in associated model&#39;s table that references current model&#39;s primary key, as a symbol.  Defaults to :“#{self.name.underscore}_id”.</p>

<pre class="ruby"><span class="ruby-constant">Artist</span>.<span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:albums</span>, <span class="ruby-value">key:</span> <span class="ruby-value">:artistid</span>
</pre>

<p>In both cases an array of symbols can be used for a composite key association:</p>

<pre class="ruby"><span class="ruby-constant">Apartment</span>.<span class="ruby-identifier">many_to_one</span> <span class="ruby-value">:building</span>, <span class="ruby-value">key:</span> [<span class="ruby-value">:city</span>, <span class="ruby-value">:address</span>]
</pre>

<h4 id="label-3Aconditions">:conditions<span><a href="#label-3Aconditions">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>The conditions to use to filter the association, can be any argument passed to <code>where</code>. If you use a hash or an array of two element arrays, this will also be used as a filter when using eager_graph or association_join to load the association.</p>

<p>If you do not use a hash or array of two element arrays, you should use the :graph_conditions, :graph_only_conditions, or :graph_block option or you will not be able to use eager_graph or association_join with the association.</p>

<pre class="ruby"><span class="ruby-constant">Artist</span>.<span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:good_albums</span>, <span class="ruby-value">class:</span> <span class="ruby-value">:Album</span>, <span class="ruby-value">conditions:</span> {<span class="ruby-value">:good</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">true</span>}
<span class="ruby-ivar">@artist</span>.<span class="ruby-identifier">good_albums</span>
<span class="ruby-comment"># SELECT * FROM albums WHERE ((artist_id = 1) AND (good IS TRUE))</span>
</pre>

<h4 id="label-3Aorder">:order<span><a href="#label-3Aorder">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>The column(s) by which to order the association dataset.  Can be a singular column or an array.</p>

<pre class="ruby"><span class="ruby-constant">Artist</span>.<span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:albums_by_name</span>, <span class="ruby-value">class:</span> <span class="ruby-value">:Album</span>, <span class="ruby-value">order:</span> <span class="ruby-value">:name</span>
<span class="ruby-constant">Artist</span>.<span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:albums_by_num_tracks</span>, <span class="ruby-value">class:</span> <span class="ruby-value">:Album</span>, <span class="ruby-value">order:</span> [<span class="ruby-value">:num_tracks</span>, <span class="ruby-value">:name</span>]
</pre>

<h4 id="label-3Aselect">:select<span><a href="#label-3Aselect">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>The columns to SELECT when loading the association.  For most associations, it defaults to nil, so * is used.  For <code>many_to_many</code> associations, it defaults to the associated class&#39;s table_name.*, which means it doesn&#39;t include the columns from the join table.  This is to prevent the common issue where the join table includes columns with the same name as columns in the associated table, in which case the joined table&#39;s columns would usually end up clobbering the values in the associated table. If you want to include the join table attributes, you can use this option, but beware that the join table columns can clash with columns from the associated table, so you should alias any columns that have the same name in both the join table and the associated table.  Example:</p>

<pre class="ruby"><span class="ruby-constant">Artist</span>.<span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:albums</span>, <span class="ruby-value">select:</span> [<span class="ruby-value">:id</span>, <span class="ruby-value">:name</span>]
<span class="ruby-constant">Album</span>.<span class="ruby-identifier">many_to_many</span> <span class="ruby-value">:tags</span>, <span class="ruby-value">select:</span> [<span class="ruby-constant">Sequel</span>[<span class="ruby-value">:tags</span>].<span class="ruby-identifier">*</span>, <span class="ruby-constant">Sequel</span>[<span class="ruby-value">:albums_tags</span>][<span class="ruby-value">:number</span>]]
</pre>

<h4 id="label-3Alimit">:limit<span><a href="#label-3Alimit">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>Limit the number of records to the provided value:</p>

<pre class="ruby"><span class="ruby-constant">Artist</span>.<span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:best_selling_albums</span>, <span class="ruby-value">class:</span> <span class="ruby-value">:Album</span>, <span class="ruby-value">order:</span> <span class="ruby-value">:copies_sold</span>, <span class="ruby-value">limit:</span> <span class="ruby-value">5</span>
</pre>

<p>Use an array with two arguments for the value to specify a limit and an offset.</p>

<pre class="ruby"><span class="ruby-constant">Artist</span>.<span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:next_best_selling_albums</span>, <span class="ruby-value">class:</span> <span class="ruby-value">:Album</span>, <span class="ruby-value">order:</span> <span class="ruby-value">:copies_sold</span>, <span class="ruby-value">limit:</span> [<span class="ruby-value">10</span>, <span class="ruby-value">5</span>]
<span class="ruby-comment"># LIMIT 10 OFFSET 5</span>
</pre>

<p>This probably doesn&#39;t make a lot of sense for *_to_one associations, though you could use it to specify an offset.</p>

<h4 id="label-3Ajoin_table+-5Bmany_to_many-2C+one_through_one-5D">:join_table [<code>many_to_many</code>, <code>one_through_one</code>]<span><a href="#label-3Ajoin_table+-5Bmany_to_many-2C+one_through_one-5D">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>Name of table that includes the foreign keys to both the current model and the associated model, as a symbol.  Defaults to the name of current model and name of associated model, pluralized, underscored, sorted, and joined with &#39;_&#39;. Here&#39;s an example of the defaults:</p>

<pre class="ruby"><span class="ruby-constant">Artist</span>.<span class="ruby-identifier">many_to_many</span> <span class="ruby-value">:albums</span>, <span class="ruby-value">join_table:</span> <span class="ruby-value">:albums_artists</span>
<span class="ruby-constant">Album</span>.<span class="ruby-identifier">many_to_many</span> <span class="ruby-value">:artists</span>, <span class="ruby-value">join_table:</span> <span class="ruby-value">:albums_artists</span>
<span class="ruby-constant">Person</span>.<span class="ruby-identifier">many_to_many</span> <span class="ruby-value">:colleges</span>, <span class="ruby-value">join_table:</span> <span class="ruby-value">:colleges_people</span>
</pre>

<h4 id="label-3Aleft_key+-5Bmany_to_many-2C+one_through_one-5D">:left_key [<code>many_to_many</code>, <code>one_through_one</code>]<span><a href="#label-3Aleft_key+-5Bmany_to_many-2C+one_through_one-5D">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>Foreign key in join table that points to current model&#39;s primary key, as a symbol.  Defaults to :“#{model_name.underscore}_id”.</p>

<pre class="ruby"><span class="ruby-constant">Album</span>.<span class="ruby-identifier">many_to_many</span> <span class="ruby-value">:tags</span>, <span class="ruby-value">left_key:</span> <span class="ruby-value">:album_id</span>
</pre>

<p>Can use an array of symbols for a composite key association.</p>

<h4 id="label-3Aright_key+-5Bmany_to_many-2C+one_through_one-5D">:right_key [<code>many_to_many</code>, <code>one_through_one</code>]<span><a href="#label-3Aright_key+-5Bmany_to_many-2C+one_through_one-5D">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>Foreign key in join table that points to associated model&#39;s primary key, as a symbol.  Defaults to :“#{association_name.singularize}_id” for <code>many_to_many</code> and :“#{association_name}_id” for <code>one_through_one</code>.</p>

<pre class="ruby"><span class="ruby-constant">Album</span>.<span class="ruby-identifier">many_to_many</span> <span class="ruby-value">:tags</span>, <span class="ruby-value">right_key:</span> <span class="ruby-value">:tag_id</span>
</pre>

<p>Can use an array of symbols for a composite key association.</p>

<h4 id="label-3Adistinct">:distinct<span><a href="#label-3Adistinct">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>Use the DISTINCT clause when selecting associating object, both when lazy loading and eager loading via eager (but not when using eager_graph).</p>

<p>This is most useful for many_to_many associations that use join tables that contain more than just the foreign keys, where you are storing additional information.  For example, if you have a database of people, degree types, and colleges, and you want to return all people from a given college, you may want to use :distinct so that if a person has two separate degrees from the same college, they won&#39;t show up twice.</p>

<h4 id="label-3Aclone">:clone<span><a href="#label-3Aclone">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>The :clone option clones an existing association, taking the options you specified for that association, and making a copy of them for this association.  Other options provided by this association are then merged into the cloned options.</p>

<p>This is commonly used if you have a bunch of similar associations that you want to DRY up:</p>

<pre class="ruby"><span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:english_verses</span>, <span class="ruby-value">class:</span> <span class="ruby-value">:LyricVerse</span>, <span class="ruby-value">key:</span> <span class="ruby-value">:lyricsongid</span>,
  <span class="ruby-value">order:</span> <span class="ruby-value">:number</span>, <span class="ruby-value">conditions:</span> {<span class="ruby-value">languageid:</span> <span class="ruby-value">1</span>}
<span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:romaji_verses</span>, <span class="ruby-value">clone:</span> <span class="ruby-value">:english_verses</span>, <span class="ruby-value">conditions:</span> {<span class="ruby-value">languageid:</span> <span class="ruby-value">2</span>}
<span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:japanese_verses</span>, <span class="ruby-value">clone:</span> <span class="ruby-value">:english_verses</span>, <span class="ruby-value">conditions:</span> {<span class="ruby-value">languageid:</span> <span class="ruby-value">3</span>}
</pre>

<p>Note that for the final two asociations, you didn&#39;t have to specify the :class, :key, or :order options, as they were copied by the :clone option.  By specifying the :conditions option for the final two associations, it overrides the :conditions option of the first association, it doesn&#39;t attempt to merge them.</p>

<p>In addition to the options hash, the :clone option will copy a block argument from the existing situation.  If you want a cloned association to not have the same block as the association you are cloning from, specify the block: nil option in addition to the :clone option.</p>

<h4 id="label-3Adataset">:dataset<span><a href="#label-3Adataset">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>This is generally only specified for custom associations that aren&#39;t based on primary/foreign key relationships.  It should be a proc that is instance_execed to get the base dataset to use before the other options are applied.</p>

<p>If the proc accepts an argument, it is passed the related association reflection. For best performance, it&#39;s recommended that custom associations call the <code>associated_dataset</code> method on the association reflection as the starting point for the dataset to return.  The <code>associated_dataset</code> method will return a dataset based on the associated class with most of the association options already applied, and the proc should return a modified copy of this dataset.</p>

<p>Here&#39;s an example of an association of songs to artists through lyrics, where the artist can perform any one of four tasks for the lyric:</p>

<pre class="ruby"><span class="ruby-constant">Artist</span>.<span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:songs</span>, <span class="ruby-value">dataset:</span> (<span class="ruby-identifier">lambda</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">r</span>.<span class="ruby-identifier">associated_dataset</span>.<span class="ruby-identifier">select_all</span>(<span class="ruby-value">:songs</span>).
   <span class="ruby-identifier">join</span>(<span class="ruby-value">:lyrics</span>, <span class="ruby-value">id:</span> <span class="ruby-value">:lyricid</span>, <span class="ruby-identifier">id</span><span class="ruby-operator">=&gt;</span>[<span class="ruby-value">:composer_id</span>, <span class="ruby-value">:arranger_id</span>, <span class="ruby-value">:vocalist_id</span>, <span class="ruby-value">:lyricist_id</span>])
<span class="ruby-keyword">end</span>)
<span class="ruby-constant">Artist</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">songs_dataset</span>
<span class="ruby-comment"># SELECT songs.* FROM songs</span>
<span class="ruby-comment"># INNER JOIN lyrics ON ((lyrics.id = songs.lyric_id)</span>
<span class="ruby-comment">#   AND (1 IN (composer_id, arranger_id, vocalist_id, lyricist_id))</span>
</pre>

<h4 id="label-3Aextend">:extend<span><a href="#label-3Aextend">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>A module or array of modules to extend the dataset with.  These are used to set up association extensions.  For more information , please see the <a href="advanced_associations_rdoc.html">Advanced Associations page</a>.</p>

<h4 id="label-3Aprimary_key+-5Bmany_to_one-2C+one_to_one-2C+one_to_many-5D">:primary_key [<code>many_to_one</code>, <code>one_to_one</code>, <code>one_to_many</code>]<span><a href="#label-3Aprimary_key+-5Bmany_to_one-2C+one_to_one-2C+one_to_many-5D">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>The column that the :key option references, as a symbol. For <code>many_to_one</code> associations, this column is in the associated table. For <code>one_to_one</code> and <code>one_to_many</code> associations, this column is in the current table.  In both cases, it defaults to the primary key of the table. Can use an array of symbols for a composite key association.</p>

<pre class="ruby"><span class="ruby-constant">Artist</span>.<span class="ruby-identifier">set_primary_key</span> <span class="ruby-value">:arid</span>
<span class="ruby-constant">Artist</span>.<span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:albums</span>, <span class="ruby-value">primary_key:</span> <span class="ruby-value">:arid</span>
<span class="ruby-constant">Album</span>.<span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:artist</span>, <span class="ruby-value">primary_key:</span> <span class="ruby-value">:arid</span>
</pre>

<h4 id="label-3Aleft_primary_key+-5Bmany_to_many-2C+one_through_one-5D">:left_primary_key [<code>many_to_many</code>, <code>one_through_one</code>]<span><a href="#label-3Aleft_primary_key+-5Bmany_to_many-2C+one_through_one-5D">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>Column in current table that :left_key option points to, as a symbol. Defaults to primary key of current table.</p>

<pre class="ruby"><span class="ruby-constant">Album</span>.<span class="ruby-identifier">set_primary_key</span> <span class="ruby-value">:alid</span>
<span class="ruby-constant">Album</span>.<span class="ruby-identifier">many_to_many</span> <span class="ruby-value">:tags</span>, <span class="ruby-value">left_primary_key:</span> <span class="ruby-value">:alid</span>
</pre>

<p>Can use an array of symbols for a composite key association.</p>

<h4 id="label-3Aright_primary_key+-5Bmany_to_many-2C+one_through_one-5D">:right_primary_key [<code>many_to_many</code>, <code>one_through_one</code>]<span><a href="#label-3Aright_primary_key+-5Bmany_to_many-2C+one_through_one-5D">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>Column in associated table that :right_key points to, as a symbol. Defaults to primary key of the associated table.</p>

<pre class="ruby"><span class="ruby-constant">Tag</span>.<span class="ruby-identifier">set_primary_key</span> <span class="ruby-value">:tid</span>
<span class="ruby-constant">Album</span>.<span class="ruby-identifier">many_to_many</span> <span class="ruby-value">:tags</span>, <span class="ruby-value">right_primary_key:</span> <span class="ruby-value">:tid</span>
</pre>

<p>Can use an array of symbols for a composite key association.</p>

<h4 id="label-3Ajoin_table_block+-5Bmany_to_many-2C+one_through_one-5D">:join_table_block [<code>many_to_many</code>, <code>one_through_one</code>]<span><a href="#label-3Ajoin_table_block+-5Bmany_to_many-2C+one_through_one-5D">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>A proc that can be used to modify the dataset used in the add/remove/remove_all methods.  It&#39;s separate from the association block, as that is called on a join of the join table and the associated table, whereas this option just applies to the join table.  It can be used to make sure that filters are used when deleting.</p>

<pre class="ruby"><span class="ruby-constant">Artist</span>.<span class="ruby-identifier">many_to_many</span> <span class="ruby-value">:lead_guitar_albums</span>, <span class="ruby-value">class:</span> <span class="ruby-value">:Album</span>, <span class="ruby-value">:join_table_block</span><span class="ruby-operator">=&gt;</span>(<span class="ruby-identifier">lambda</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ds</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">ds</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">instrument_id:</span> <span class="ruby-value">5</span>)
<span class="ruby-keyword">end</span>)
</pre>

<h4 id="label-3Ajoin_table_db+-5Bmany_to_many-2C+one_through_one-5D">:join_table_db [<code>many_to_many</code>, <code>one_through_one</code>]<span><a href="#label-3Ajoin_table_db+-5Bmany_to_many-2C+one_through_one-5D">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>A <a href="../Sequel/Database.html"><code>Sequel::Database</code></a> to use for the join table.  Specifying this option switches the loading to use a separate query for the join table.  This is useful if the join table is not located in the same database as the associated table, or if the database account with access to the associated table doesn&#39;t have access to the join table.</p>

<p>For example, if the Album class uses a different <a href="../Sequel/Database.html"><code>Sequel::Database</code></a> than the Artist class, and the join table is in the database that the Artist class uses:</p>

<pre class="ruby"><span class="ruby-constant">Artist</span>.<span class="ruby-identifier">many_to_many</span> <span class="ruby-value">:lead_guitar_albums</span>, <span class="ruby-value">class:</span> <span class="ruby-value">:Album</span>, <span class="ruby-value">:join_table_db</span><span class="ruby-operator">=&gt;</span><span class="ruby-constant">Artist</span>.<span class="ruby-identifier">db</span>
</pre>

<p>This option also affects the add/remove/remove_all methods, by changing which database is used for inserts/deletes from the join table (add/remove/remove_all defaults to use the current model&#39;s database instead of the associated model&#39;s database).</p>

<h3 id="label-Callback+Options">Callback Options<span><a href="#label-Callback+Options">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>All callbacks can be specified as a Symbol, Proc, or array of both/either specifying a callback to call.  Symbols are interpreted as instance methods that are called with the associated object.  Procs are called with the receiver as the first argument and the associated object as the second argument.  If an array is given, all of them are called in order.</p>

<p>Before callbacks are often used to check preconditions, they can call Model#cancel_action  to signal <a href="../Sequel.html"><code>Sequel</code></a> to abort the modification.  If any before callback calls cancel_action, the remaining before callbacks are not called and the modification is aborted.</p>

<h4 id="label-3Abefore_add+-5Bone_to_many-2C+many_to_many-5D">:before_add [<code>one_to_many</code>, <code>many_to_many</code>]<span><a href="#label-3Abefore_add+-5Bone_to_many-2C+many_to_many-5D">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>Called before adding an object to the association:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Artist</span>
  <span class="ruby-comment"># Don&#39;t allow adding an album to an artist if it has no tracks</span>
  <span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:albums</span>, <span class="ruby-value">before_add:</span> <span class="ruby-identifier">lambda</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">ar</span>, <span class="ruby-identifier">al</span><span class="ruby-operator">|</span> <span class="ruby-identifier">ar</span>.<span class="ruby-identifier">cancel_action</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">al</span>.<span class="ruby-identifier">num_tracks</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>}
<span class="ruby-keyword">end</span>
</pre>

<h4 id="label-3Aafter_add+-5Bone_to_many-2C+many_to_many-5D">:after_add [<code>one_to_many</code>, <code>many_to_many</code>]<span><a href="#label-3Aafter_add+-5Bone_to_many-2C+many_to_many-5D">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>Called after adding an object to the association:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Artist</span>
  <span class="ruby-comment"># Log all associations of albums to an audit logging table</span>
  <span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:albums</span>, <span class="ruby-value">after_add:</span> <span class="ruby-value">:log_add_album</span>

  <span class="ruby-identifier">private</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">log_add_album</span>(<span class="ruby-identifier">album</span>)
    <span class="ruby-constant">DB</span>[<span class="ruby-value">:audit_logs</span>].<span class="ruby-identifier">insert</span>(<span class="ruby-value">log:</span> <span class="ruby-node">&quot;Album #{album.inspect} associated to #{inspect}&quot;</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h4 id="label-3Abefore_remove+-5Bone_to_many-2C+many_to_many-5D">:before_remove [<code>one_to_many</code>, <code>many_to_many</code>]<span><a href="#label-3Abefore_remove+-5Bone_to_many-2C+many_to_many-5D">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>Called before removing an object from the association using <code>remove_<em>association</em></code>:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Artist</span>
  <span class="ruby-comment"># Don&#39;t allow removing a self-titled album</span>
  <span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:albums</span>, <span class="ruby-value">before_remove:</span> <span class="ruby-identifier">lambda</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">ar</span>, <span class="ruby-identifier">al</span><span class="ruby-operator">|</span> <span class="ruby-identifier">ar</span>.<span class="ruby-identifier">cancel_action</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">al</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">ar</span>.<span class="ruby-identifier">name</span>}
<span class="ruby-keyword">end</span>
</pre>

<p>This is not called when using <code>remove_all_<em>association</em></code>.</p>

<h4 id="label-3Aafter_remove+-5Bone_to_many-2C+many_to_many-5D">:after_remove [<code>one_to_many</code>, <code>many_to_many</code>]<span><a href="#label-3Aafter_remove+-5Bone_to_many-2C+many_to_many-5D">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>Called after removing an object from the association using <code>remove_<em>association</em></code>:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Artist</span>
  <span class="ruby-comment"># Log all disassociations of albums to an audit logging table</span>
  <span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:albums</span>, <span class="ruby-value">after_remove:</span> <span class="ruby-value">:log_remove_album</span>

  <span class="ruby-identifier">private</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">log_remove_album</span>(<span class="ruby-identifier">album</span>)
    <span class="ruby-constant">DB</span>[<span class="ruby-value">:audit_logs</span>].<span class="ruby-identifier">insert</span>(<span class="ruby-value">log:</span> <span class="ruby-node">&quot;Album #{album.inspect} disassociated from #{inspect}&quot;</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>This is not called when using <code>remove_all_<em>association</em></code>.</p>

<h4 id="label-3Abefore_set+-5Bmany_to_one-2C+one_to_one-5D">:before_set [<code>many_to_one</code>, <code>one_to_one</code>]<span><a href="#label-3Abefore_set+-5Bmany_to_one-2C+one_to_one-5D">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>Called before the _<em>association</em>= method is called to modify the objects:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Album</span>
  <span class="ruby-comment"># Don&#39;t associate the album with an artist if the year the album was</span>
  <span class="ruby-comment"># released is less than the year the artist/band started.</span>
  <span class="ruby-identifier">many_to_one</span> <span class="ruby-value">:artist</span>, <span class="ruby-value">before_set:</span> <span class="ruby-identifier">lambda</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">al</span>, <span class="ruby-identifier">ar</span><span class="ruby-operator">|</span> <span class="ruby-identifier">al</span>.<span class="ruby-identifier">cancel_action</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">al</span>.<span class="ruby-identifier">year</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">ar</span>.<span class="ruby-identifier">year_started</span>}
<span class="ruby-keyword">end</span>
</pre>

<h4 id="label-3Aafter_set+-5Bmany_to_one-2C+one_to_one-5D">:after_set [<code>many_to_one</code>, <code>one_to_one</code>]<span><a href="#label-3Aafter_set+-5Bmany_to_one-2C+one_to_one-5D">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>Called after the _<em>association</em>= method is called to modify the objects:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Album</span>
  <span class="ruby-comment"># Log all disassociations of albums to an audit logging table</span>
  <span class="ruby-identifier">many_to_one</span> <span class="ruby-value">:artist</span>, <span class="ruby-value">after_set:</span> <span class="ruby-value">:log_artist_set</span>

  <span class="ruby-identifier">private</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">log_artist_set</span>(<span class="ruby-identifier">artist</span>)
    <span class="ruby-constant">DB</span>[<span class="ruby-value">:audit_logs</span>].<span class="ruby-identifier">insert</span>(<span class="ruby-value">log:</span> <span class="ruby-node">&quot;Artist for album #{inspect} set to #{artist.inspect}&quot;</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h4 id="label-3Aafter_load">:after_load<span><a href="#label-3Aafter_load">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>Called after retrieving the associated records from the database.</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Artist</span>
  <span class="ruby-comment"># Cache all album names to a single string when retrieving the albums.</span>
  <span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:albums</span>, <span class="ruby-value">after_load:</span> <span class="ruby-value">:cache_album_names</span>

  <span class="ruby-identifier">attr_reader</span> <span class="ruby-value">:album_names</span>

  <span class="ruby-identifier">private</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">cache_album_names</span>(<span class="ruby-identifier">albums</span>)
    <span class="ruby-ivar">@album_names</span> = <span class="ruby-identifier">albums</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:name</span>).<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;, &quot;</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Generally used if you know you will always want a certain action done when retrieving the association.</p>

<p>For <code>one_to_many</code> and <code>many_to_many</code> associations, both the argument to symbol callbacks and the second argument to proc callbacks will be an array of associated objects instead of a single object.</p>

<h4 id="label-3Auniq+-5Bmany_to_many-5D">:uniq [<code>many_to_many</code>]<span><a href="#label-3Auniq+-5Bmany_to_many-5D">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>Adds a after_load callback that makes the array of objects unique. In many cases, using the :distinct option is a better approach.</p>

<h3 id="label-Eager+Loading+via+eager+-28query+per+association-29+Options">Eager Loading via eager (query per association) Options<span><a href="#label-Eager+Loading+via+eager+-28query+per+association-29+Options">&para;</a> <a href="#top">&uarr;</a></span></h3>

<h4 id="label-3Aeager">:eager<span><a href="#label-3Aeager">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>The associations to eagerly load via eager when loading the associated object(s). This is useful for example if you always want to eagerly load dependent associations when loading this association.</p>

<p>For example, if you know that any time that you want to load an artist&#39;s albums, you are also going to want access to the album&#39;s tracks as well:</p>

<pre class="ruby"><span class="ruby-comment"># Eager load tracks when loading the albums</span>
<span class="ruby-constant">Artist</span>.<span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:albums</span>, <span class="ruby-value">eager:</span> <span class="ruby-value">:tracks</span>
</pre>

<p>You can also use a hash or array to specify multiple dependent associations to eagerly load:</p>

<pre class="ruby"><span class="ruby-comment"># Eager load the albums&#39; tracks and the tracks&#39; tags when loading the albums</span>
<span class="ruby-constant">Artist</span>.<span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:albums</span>, <span class="ruby-value">eager:</span> {<span class="ruby-value">tracks:</span> <span class="ruby-value">:tags</span>}
<span class="ruby-comment"># Eager load the albums&#39; tags and tracks when loading the albums</span>
<span class="ruby-constant">Artist</span>.<span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:albums</span>, <span class="ruby-value">eager:</span> [<span class="ruby-value">:tags</span>, <span class="ruby-value">:tracks</span>]
<span class="ruby-comment"># Eager load the albums&#39; tags, tracks, and tracks&#39; tags when loading the albums</span>
<span class="ruby-constant">Artist</span>.<span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:albums</span>, <span class="ruby-value">eager:</span> [<span class="ruby-value">:tags</span>, {<span class="ruby-value">tracks:</span> <span class="ruby-value">:tags</span>}]
</pre>

<h4 id="label-3Aeager_loader">:eager_loader<span><a href="#label-3Aeager_loader">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>A custom loader to use when eagerly load associated objects via eager. For many details and examples of custom eager loaders, please see the <a href="advanced_associations_rdoc.html">Advanced Associations guide</a>.</p>

<h4 id="label-3Aeager_loader_key">:eager_loader_key<span><a href="#label-3Aeager_loader_key">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>A symbol for the key column to use to populate the key hash for the eager loader.  Generally does not need to be set manually, defaults to the key method used.  Can be set to nil to not populate the key hash (better for performance if a custom eager loader does not use the key_hash).</p>

<h4 id="label-3Aeager_block">:eager_block<span><a href="#label-3Aeager_block">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>If given, should be a proc to use instead of the association method block when eagerly loading.  To not use a block when eager loading when one is used normally, set to nil.  It&#39;s very uncommon to need this option.</p>

<h3 id="label-Eager+Loading+via+eager_graph+-28one+query+with+joins-29+Options">Eager Loading via eager_graph (one query with joins) Options<span><a href="#label-Eager+Loading+via+eager_graph+-28one+query+with+joins-29+Options">&para;</a> <a href="#top">&uarr;</a></span></h3>

<h4 id="label-3Aeager_graph">:eager_graph<span><a href="#label-3Aeager_graph">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>The associations to eagerly load via eager_graph when loading the associated object(s). This is useful for example if you always want to eagerly load dependent associations when loading this association, but you want to filter or order the association based on dependent associations:</p>

<pre class="ruby"><span class="ruby-constant">Artist</span>.<span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:albums_with_short_tracks</span>, <span class="ruby-value">class:</span> <span class="ruby-value">:Album</span>, <span class="ruby-value">eager_graph:</span> <span class="ruby-value">:tracks</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ds</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">ds</span>.<span class="ruby-identifier">where</span>{<span class="ruby-identifier">tracks</span>[<span class="ruby-value">:seconds</span>] <span class="ruby-operator">&lt;</span> <span class="ruby-value">120</span>}
<span class="ruby-keyword">end</span>
<span class="ruby-constant">Artist</span>.<span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:albums_by_track_name</span>, <span class="ruby-value">class:</span> <span class="ruby-value">:Album</span>, <span class="ruby-value">eager_graph:</span> <span class="ruby-value">:tracks</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ds</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">ds</span>.<span class="ruby-identifier">order</span>{<span class="ruby-identifier">tracks</span>[<span class="ruby-value">:name</span>]}
<span class="ruby-keyword">end</span>
</pre>

<p>You can also use a hash or array of arguments for :eager_graph, similar to what the :eager option accepts.</p>

<h4 id="label-3Agraph_conditions">:graph_conditions<span><a href="#label-3Agraph_conditions">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>The additional conditions to use on the SQL join when eagerly loading the association via eager_graph.  Should be a hash or an array of two element arrays.  If not specified, the :conditions option is used if it is a hash or array of two element arrays.</p>

<pre class="ruby"><span class="ruby-constant">Artist</span>.<span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:active_albums</span>, <span class="ruby-value">class:</span> <span class="ruby-value">:Album</span>, <span class="ruby-value">graph_conditions:</span> {<span class="ruby-value">active:</span> <span class="ruby-keyword">true</span>}
</pre>

<p>Note that these conditions on the association are in addition to the default conditions specified by the foreign/primary keys.  If you want to replace the conditions specified by the foreign/primary keys, you need the :graph_only_conditions options.</p>

<h4 id="label-3Agraph_block">:graph_block<span><a href="#label-3Agraph_block">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>The block to pass to Dataset#join_table when eagerly loading the association via eager_graph.  This is useful to specify conditions that can&#39;t be specified in a hash or array of two element arrays.</p>

<pre class="ruby"><span class="ruby-constant">Artist</span>.<span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:gold_albums</span>, <span class="ruby-value">class:</span> <span class="ruby-value">:Album</span>,
  <span class="ruby-value">graph_block:</span> <span class="ruby-identifier">proc</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">j</span>,<span class="ruby-identifier">lj</span>,<span class="ruby-identifier">js</span><span class="ruby-operator">|</span> <span class="ruby-constant">Sequel</span>[<span class="ruby-identifier">j</span>][<span class="ruby-value">:copies_sold</span>] <span class="ruby-operator">&gt;</span> <span class="ruby-value">500000</span>}
</pre>

<h4 id="label-3Agraph_join_type">:graph_join_type<span><a href="#label-3Agraph_join_type">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>The type of SQL join to use when eagerly loading the association via eager_graph.  Defaults to :left_outer.  This is useful if you want to ensure that only artists that have albums are returned:</p>

<pre class="ruby"><span class="ruby-constant">Artist</span>.<span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:albums</span>, <span class="ruby-value">graph_join_type:</span> <span class="ruby-value">:inner</span>
<span class="ruby-comment"># Will exclude artists without an album</span>
<span class="ruby-constant">Artist</span>.<span class="ruby-identifier">eager_graph</span>(<span class="ruby-value">:albums</span>).<span class="ruby-identifier">all</span>
</pre>

<h4 id="label-3Agraph_select">:graph_select<span><a href="#label-3Agraph_select">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>A column or array of columns to select from the associated table when eagerly loading the association via eager_graph. Defaults to all columns in the associated table.</p>

<h4 id="label-3Agraph_only_conditions">:graph_only_conditions<span><a href="#label-3Agraph_only_conditions">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>The conditions to use on the SQL join when eagerly loading the association via eager_graph, instead of the default conditions specified by the foreign/primary keys.  This option causes the :graph_conditions option to be ignored.  This can be useful if the keys you are using are strings and you want to do a case insensitive comparison.  For example, let&#39;s say that instead of integer keys, you used string keys based on the album or artist name, and that the album was associated to the artist by name.  However, you weren&#39;t enforcing case sensitivity between the keys, so you still want to return albums where the artist&#39;s name differs in case:</p>

<pre class="ruby"><span class="ruby-constant">Artist</span>.<span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:albums</span>, <span class="ruby-value">key:</span> <span class="ruby-value">:artist_name</span>, 
  <span class="ruby-value">graph_only_conditions:</span> <span class="ruby-keyword">nil</span>, 
  <span class="ruby-value">graph_block:</span> (<span class="ruby-identifier">proc</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">j</span>,<span class="ruby-identifier">lj</span>,<span class="ruby-identifier">js</span><span class="ruby-operator">|</span>
    {<span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">function</span>(<span class="ruby-value">:lower</span>, <span class="ruby-constant">Sequel</span>[<span class="ruby-identifier">j</span>][<span class="ruby-value">:artist_name</span>])<span class="ruby-operator">=&gt;</span> <span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">function</span>(<span class="ruby-value">:lower</span>, <span class="ruby-constant">Sequel</span>[<span class="ruby-identifier">lj</span>][<span class="ruby-value">:name</span>])}
  <span class="ruby-keyword">end</span>)
</pre>

<p>Note how :graph_only_conditions is set to nil to ignore any existing conditions, and :graph_block is used to set up the case insensitive comparison.</p>

<p>Another case where :graph_only_conditions may be used is if you want to use a JOIN USING or NATURAL JOIN for the graph:</p>

<pre class="ruby"><span class="ruby-comment"># JOIN USING</span>
<span class="ruby-constant">Artist</span>.<span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:albums</span>, <span class="ruby-value">key:</span> <span class="ruby-value">:artist_name</span>, <span class="ruby-value">graph_only_conditions:</span> [<span class="ruby-value">:artist_name</span>]

<span class="ruby-comment"># NATURAL JOIN</span>
<span class="ruby-constant">Artist</span>.<span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:albums</span>, <span class="ruby-value">key:</span> <span class="ruby-value">:artist_name</span>, <span class="ruby-value">graph_only_conditions:</span> <span class="ruby-keyword">nil</span>, <span class="ruby-value">graph_join_type:</span> <span class="ruby-value">:natural</span>
</pre>

<h4 id="label-3Agraph_alias_base">:graph_alias_base<span><a href="#label-3Agraph_alias_base">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>The base name to use for the table alias when eager graphing.  Defaults to the name of the association.  If the alias name has already been used in the query, <a href="../Sequel.html"><code>Sequel</code></a> will create a unique alias by appending a numeric suffix (e.g. alias_0, alias_1, …) until the alias is unique.</p>

<p>This is mostly useful if you have associations with the same name in many models, and you want to be able to easily tell which table alias corresponds to which association when eagerly graphing multiple associations with the same name.</p>

<p>You can override this option on a per-eager_graph basis by specifying the association as an SQL::AliasedExpression instead of a symbol:</p>

<pre class="ruby"><span class="ruby-constant">Album</span>.<span class="ruby-identifier">eager_graph</span>(<span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">as</span>(<span class="ruby-value">:artist</span>, <span class="ruby-value">:a</span>))
</pre>

<h4 id="label-3Aeager_grapher">:eager_grapher<span><a href="#label-3Aeager_grapher">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>Sets up a custom grapher to use when eager loading the objects via eager_graph. This is the eager_graph analogue to the :eager_loader option. This isn&#39;t generally needed, as one of the other eager_graph related association options is usually sufficient.</p>

<p>If specified, should be a proc that accepts a single hash argument, which will contain at least the following keys:</p>
<dl class="rdoc-list note-list"><dt>:callback 
<dd>
<p>A callback proc used to dynamically modify the dataset to graph into the current dataset, before such graphing is done. This is nil if no callback proc is used.</p>
</dd><dt>:implicit_qualifier 
<dd>
<p>The alias that was used for the current table (since you can cascade associations).</p>
</dd><dt>:join_type 
<dd>
<p>Override the join type to use when graphing.</p>
</dd><dt>:limit_strategy 
<dd>
<p>The limit strategy symbol to use when graphing (for limited associations only)</p>
</dd><dt>:self 
<dd>
<p>The dataset that is doing the eager loading</p>
</dd><dt>:table_alias 
<dd>
<p>An alias to use for the table to graph for this association.</p>
</dd></dl>

<p>Example:</p>

<pre class="ruby"><span class="ruby-constant">Artist</span>.<span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:self_title_albums</span>, <span class="ruby-value">class:</span> <span class="ruby-value">:Album</span>,
 <span class="ruby-value">:eager_grapher</span><span class="ruby-operator">=&gt;</span>(<span class="ruby-identifier">lambda</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">eo</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">eo</span>[<span class="ruby-value">:self</span>].<span class="ruby-identifier">graph</span>(<span class="ruby-value">:albums</span>, {<span class="ruby-value">artist_id:</span> <span class="ruby-value">:id</span>, <span class="ruby-value">name:</span> <span class="ruby-value">:name</span>},
    <span class="ruby-value">table_alias:</span> <span class="ruby-identifier">eo</span>[<span class="ruby-value">:table_alias</span>], <span class="ruby-value">implicit_qualifier:</span> <span class="ruby-identifier">eo</span>[<span class="ruby-value">:implicit_qualifier</span>])
<span class="ruby-keyword">end</span>)
</pre>

<h4 id="label-3Aorder_eager_graph">:order_eager_graph<span><a href="#label-3Aorder_eager_graph">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>Whether to add the order to the dataset&#39;s order when graphing via eager_graph. Defaults to true, so set to false to disable.</p>

<p><a href="../Sequel.html"><code>Sequel</code></a> has to do some guess work when attempting to add the association&#39;s order to an eager_graphed dataset.  In most cases it does so correctly, but if it has problems, you&#39;ll probably want to set this option to false.</p>

<h4 id="label-3Agraph_order">:graph_order<span><a href="#label-3Agraph_order">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>Override the order added when using eager_graph, instead of using the one defined in :order.  This is useful if :order contains qualified identifiers, as the qualifiers may not match the aliases automatically used by eager_graph. This should contain unqualified identifiers, and eager_graph will automatically qualify them with the appropriate alias.</p>

<h4 id="label-3Agraph_join_table_conditions+-5Bmany_to_many-2C+one_through_one-5D">:graph_join_table_conditions [<code>many_to_many</code>, <code>one_through_one</code>]<span><a href="#label-3Agraph_join_table_conditions+-5Bmany_to_many-2C+one_through_one-5D">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>The additional conditions to use on the SQL join for the join table when eagerly loading the association via eager_graph. Should be a hash or an array of two element arrays.</p>

<p>Let&#39;s say you have a database of people, colleges, and a table called degrees_received that includes a string field specifying the name of the degree, and you want to eager load all colleges for people where the person has received a specific degree:</p>

<pre class="ruby"><span class="ruby-constant">Person</span>.<span class="ruby-identifier">many_to_many</span> <span class="ruby-value">:bs_degree_colleges</span>, <span class="ruby-value">class:</span> <span class="ruby-value">:College</span>,
  <span class="ruby-value">join_table:</span> <span class="ruby-value">:degrees_received</span>, 
  <span class="ruby-value">graph_join_table_conditions:</span> {<span class="ruby-value">degree:</span> <span class="ruby-string">&#39;BS&#39;</span>}
</pre>

<h4 id="label-3Agraph_join_table_block+-5Bmany_to_many-2C+one_through_one-5D">:graph_join_table_block [<code>many_to_many</code>, <code>one_through_one</code>]<span><a href="#label-3Agraph_join_table_block+-5Bmany_to_many-2C+one_through_one-5D">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>The block to pass to join_table for the join table when eagerly loading the association via eager_graph.  This is used for similar reasons as :graph_block, but is only used for <code>many_to_many</code> associations when graphing the join table into the dataset.  It&#39;s used in the same place as :graph_join_table_conditions but like :graph_block, is needed for situations where the conditions can&#39;t be specified as a hash or array of two element arrays.</p>

<p>Let&#39;s say you have a database of people, colleges, and a table called degrees_received that includes a string field specifying the name of the degree, and you want to eager load all colleges for people where the person has received a bachelor&#39;s degree (degree starting with B):</p>

<pre class="ruby"><span class="ruby-constant">Person</span>.<span class="ruby-identifier">many_to_many</span> <span class="ruby-value">:bachelor_degree_colleges</span>, <span class="ruby-value">class:</span> <span class="ruby-value">:College</span>,
  <span class="ruby-value">join_table:</span> <span class="ruby-value">:degrees_received</span>,
  <span class="ruby-value">graph_join_table_block:</span> <span class="ruby-identifier">proc</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">j</span>,<span class="ruby-identifier">lj</span>,<span class="ruby-identifier">js</span><span class="ruby-operator">|</span> <span class="ruby-constant">Sequel</span>[<span class="ruby-identifier">j</span>][<span class="ruby-value">:degree</span>].<span class="ruby-identifier">like</span>(<span class="ruby-string">&#39;B%&#39;</span>)}
</pre>

<p>This should be done when graphing the join table, instead of when graphing the final table, as :degree is a column of the join table.</p>

<h4 id="label-3Agraph_join_table_join_type+-5Bmany_to_many-2C+one_through_one-5D">:graph_join_table_join_type [<code>many_to_many</code>, <code>one_through_one</code>]<span><a href="#label-3Agraph_join_table_join_type+-5Bmany_to_many-2C+one_through_one-5D">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>The type of SQL join to use for the join table when eagerly loading the association via eager_graph.  Defaults to the :graph_join_type option or :left_outer.  This exists mainly for consistency in the unlikely case that you want to use a different join type when JOINing to the join table then you want to use for JOINing to the final table</p>

<h4 id="label-3Agraph_join_table_only_conditions+-5Bmany_to_many-2C+one_through_one-5D">:graph_join_table_only_conditions [<code>many_to_many</code>, <code>one_through_one</code>]<span><a href="#label-3Agraph_join_table_only_conditions+-5Bmany_to_many-2C+one_through_one-5D">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>The conditions to use on the SQL join for the join table when eagerly loading the association via eager_graph, instead of the default conditions specified by the foreign/primary keys.  This option causes the :graph_join_table_conditions option to be ignored.  This is only useful if you want to replace the default foreign/primary key conditions that <a href="../Sequel.html"><code>Sequel</code></a> would use when eagerly graphing.</p>

<h3 id="label-Associations+Based+on+SQL+Expressions+Options">Associations Based on SQL Expressions Options<span><a href="#label-Associations+Based+on+SQL+Expressions+Options">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>Sequel&#39;s associations can work not just with columns, but also with arbitrary SQL expressions.  For example, on PostgreSQL, you can store foreign keys to other tables in hstore, json, or jsonb columns, and <a href="../Sequel.html"><code>Sequel</code></a> can work with such constructs, including full support for eager loading.</p>

<p>There&#39;s actually two parts to supporting associations based on SQL expressions.  First is you must have an instance method in the model that returns the value that the SQL expression would return. Second is you must have an SQL expression object.  If <a href="../Sequel.html"><code>Sequel</code></a> has access to a model instance and needs to get the value of the expression, it calls the method to get the value.  If <a href="../Sequel.html"><code>Sequel</code></a> does not have access to a model instance, but needs to use the SQL expression in a query, it will use the SQL expression object.</p>

<p>Below is an example storing foreign keys to other tables in a PostgreSQL hstore column, using the <code>pg_json</code> and <code>pg_json_ops</code> extensions.</p>

<pre class="ruby"><span class="ruby-comment"># Example schema:</span>
<span class="ruby-comment">#  albums          artists</span>
<span class="ruby-comment">#   :id       /---&gt; :id</span>
<span class="ruby-comment">#   :meta ---/      :name</span>
<span class="ruby-comment">#   :name</span>
<span class="ruby-keyword">class</span> <span class="ruby-constant">Album</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>
  <span class="ruby-identifier">many_to_one</span> <span class="ruby-value">:artist</span>, <span class="ruby-value">key_column:</span> <span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">pg_jsonb</span>(<span class="ruby-value">:meta</span>)[<span class="ruby-string">&#39;artist_id&#39;</span>].<span class="ruby-identifier">cast</span>(<span class="ruby-constant">String</span>).<span class="ruby-identifier">cast</span>(<span class="ruby-constant">Integer</span>)

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">artist_id</span>
    <span class="ruby-identifier">meta</span>[<span class="ruby-string">&#39;artist_id&#39;</span>].<span class="ruby-identifier">to_i</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
<span class="ruby-keyword">class</span> <span class="ruby-constant">Artist</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>
  <span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:albums</span>, <span class="ruby-value">key:</span> <span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">pg_jsonb</span>(<span class="ruby-value">:meta</span>)[<span class="ruby-string">&#39;artist_id&#39;</span>].<span class="ruby-identifier">cast</span>(<span class="ruby-constant">String</span>).<span class="ruby-identifier">cast</span>(<span class="ruby-constant">Integer</span>), <span class="ruby-value">key_method:</span> <span class="ruby-value">:artist_id</span>
<span class="ruby-keyword">end</span>

<span class="ruby-comment"># Example schema:</span>
<span class="ruby-comment">#  albums   albums_artists   artists</span>
<span class="ruby-comment">#   :id  &lt;----- :meta -------&gt; :id</span>
<span class="ruby-comment">#   :name                      :name</span>
<span class="ruby-keyword">class</span> <span class="ruby-constant">Album</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>
  <span class="ruby-identifier">many_to_many</span> <span class="ruby-value">:artists</span>, <span class="ruby-value">left_key:</span> <span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">pg_jsonb</span>(<span class="ruby-value">:meta</span>)[<span class="ruby-string">&#39;album_id&#39;</span>].<span class="ruby-identifier">cast</span>(<span class="ruby-constant">String</span>).<span class="ruby-identifier">cast</span>(<span class="ruby-constant">Integer</span>),
    <span class="ruby-value">right_key:</span> <span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">pg_jsonb</span>(<span class="ruby-value">:meta</span>)[<span class="ruby-string">&#39;artist_id&#39;</span>].<span class="ruby-identifier">cast</span>(<span class="ruby-constant">String</span>).<span class="ruby-identifier">cast</span>(<span class="ruby-constant">Integer</span>)
<span class="ruby-keyword">end</span>
<span class="ruby-keyword">class</span> <span class="ruby-constant">Artist</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>
  <span class="ruby-identifier">many_to_many</span> <span class="ruby-value">:albums</span>, <span class="ruby-value">left_key:</span> <span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">pg_jsonb</span>(<span class="ruby-value">:meta</span>)[<span class="ruby-string">&#39;artist_id&#39;</span>].<span class="ruby-identifier">cast</span>(<span class="ruby-constant">String</span>).<span class="ruby-identifier">cast</span>(<span class="ruby-constant">Integer</span>),
    <span class="ruby-value">right_key:</span> <span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">pg_jsonb</span>(<span class="ruby-value">:meta</span>)[<span class="ruby-string">&#39;album_id&#39;</span>].<span class="ruby-identifier">cast</span>(<span class="ruby-constant">String</span>).<span class="ruby-identifier">cast</span>(<span class="ruby-constant">Integer</span>)
<span class="ruby-keyword">end</span>
</pre>

<h4 id="label-3Akey_column+-5Bmany_to_one-5D">:key_column [<code>many_to_one</code>]<span><a href="#label-3Akey_column+-5Bmany_to_one-5D">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>Like the :key option, but :key references the method name, while :key_column references the underlying column/expression.</p>

<h4 id="label-3Aprimary_key_method+-5Bmany_to_one-5D">:primary_key_method [<code>many_to_one</code>]<span><a href="#label-3Aprimary_key_method+-5Bmany_to_one-5D">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>Like the :primary_key option, but :primary_key references the column/expression name, while :primary_key_method references the method name.</p>

<h4 id="label-3Aprimary_key_column+-5Bone_to_many-2C+one_to_one-5D">:primary_key_column [<code>one_to_many</code>, <code>one_to_one</code>]<span><a href="#label-3Aprimary_key_column+-5Bone_to_many-2C+one_to_one-5D">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>Like the :primary_key option, but :primary_key references the method name, while :primary_key_column references the underlying column/expression.</p>

<h4 id="label-3Akey_method+-5Bone_to_many-2C+one_to_one-5D">:key_method [<code>one_to_many</code>, <code>one_to_one</code>]<span><a href="#label-3Akey_method+-5Bone_to_many-2C+one_to_one-5D">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>Like the :key option, but :key references the column/expression name, while :key_method references the method name.</p>

<h4 id="label-3Aleft_primary_key_column+-5Bmany_to_many-2C+one_through_one-5D">:left_primary_key_column [<code>many_to_many</code>, <code>one_through_one</code>]<span><a href="#label-3Aleft_primary_key_column+-5Bmany_to_many-2C+one_through_one-5D">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>Like the :left_primary_key option, but :left_primary_key references the method name, while :left_primary_key_column references the underlying column/expression.</p>

<h4 id="label-3Aright_primary_key_method+-5Bmany_to_many-2C+one_through_one-5D">:right_primary_key_method [<code>many_to_many</code>, <code>one_through_one</code>]<span><a href="#label-3Aright_primary_key_method+-5Bmany_to_many-2C+one_through_one-5D">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>Like the :right_primary_key option, but :right_primary_key references the column/expression name, while :right_primary_key_method references the method name.</p>

<h3 id="label-Advanced+Options">Advanced Options<span><a href="#label-Advanced+Options">&para;</a> <a href="#top">&uarr;</a></span></h3>

<h4 id="label-3Areciprocal">:reciprocal<span><a href="#label-3Areciprocal">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>The symbol name of the reciprocal association, if it exists.  By default, <a href="../Sequel.html"><code>Sequel</code></a> will try to determine it by looking at the associated model&#39;s associations for a association that matches the current association&#39;s key(s). Set to nil to not use a reciprocal.</p>

<p>Reciprocals are used in <a href="../Sequel.html"><code>Sequel</code></a> to modify the matching cached associations in associated objects when calling association methods on the current object. For example, when you retrieve objects in a one_to_many association, <a href="../Sequel.html"><code>Sequel</code></a> will automatically set the matching many_to_one association in the associated objects.  The result of this is that code that does this:</p>

<pre class="ruby"><span class="ruby-ivar">@artist</span>.<span class="ruby-identifier">albums</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">album</span><span class="ruby-operator">|</span> <span class="ruby-identifier">album</span>.<span class="ruby-identifier">artist</span>.<span class="ruby-identifier">name</span>}
</pre>

<p>only does one database query, because when the @artist&#39;s albums are retrieved, the cached artist association for each album is set to @artist.</p>

<p>In addition to the one_to_many retrieval case, the association modification methods affect the reciprocals as well:</p>

<pre class="ruby"><span class="ruby-comment"># Sets the cached artist association for @album to @artist</span>
<span class="ruby-ivar">@artist</span>.<span class="ruby-identifier">add_album</span>(<span class="ruby-ivar">@album</span>)

<span class="ruby-comment"># Sets the cached artist association for @album to nil</span>
<span class="ruby-ivar">@artist</span>.<span class="ruby-identifier">remove_album</span>(<span class="ruby-ivar">@album</span>)

<span class="ruby-comment"># Sets the cached artist association to nil for the @artist&#39;s</span>
<span class="ruby-comment"># cached albums association</span>
<span class="ruby-ivar">@artist</span>.<span class="ruby-identifier">remove_all_albums</span>

<span class="ruby-comment"># Remove @album from the artist1&#39;s cached albums association, and add @album</span>
<span class="ruby-comment"># to @artist2&#39;s cached albums association.</span>
<span class="ruby-ivar">@album</span>.<span class="ruby-identifier">artist</span> <span class="ruby-comment"># @artist1</span>
<span class="ruby-ivar">@album</span>.<span class="ruby-identifier">artist</span> = <span class="ruby-ivar">@artist2</span>
</pre>

<p><a href="../Sequel.html"><code>Sequel</code></a> can usually guess the correct reciprocal, but if you have multiple associations to the same associated class that use the same keys, you may want to specify the :reciprocal option manually to ensure the correct one is used.</p>

<h4 id="label-3Aread_only">:read_only<span><a href="#label-3Aread_only">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>For <code>many_to_one</code> and <code>one_to_one</code> associations, do not add a setter method. For <code>one_to_many</code> and <code>many_to_many</code>, do not add the add_<em>association</em>, remove_<em>association</em>, or remove_all_<em>association</em> methods.</p>

<p>If you are not using the association modification methods, setting this value to true will save memory.</p>

<h4 id="label-3Avalidate">:validate<span><a href="#label-3Avalidate">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>Set to false to not validate when implicitly saving any associated object. When using the <code>one_to_many</code> association modification methods, the <code>one_to_one</code> setter method, or creating a new object by passing a hash to the add_<em>association</em> method, <a href="../Sequel.html"><code>Sequel</code></a> will automatically save the object. If you don&#39;t want to validate objects when these implicit saves are done, the validate option should be set to false.</p>

<h4 id="label-3Araise_on_save_failure+-5Bone_to_many+associations-5D">:raise_on_save_failure [<code>one_to_many</code> associations]<span><a href="#label-3Araise_on_save_failure+-5Bone_to_many+associations-5D">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>Set to false to not raise an exception when validation or a before hook fails when implicitly saving an associated object in the add_* or remove_* methods.  This mirrors the raise_on_save_failure model setting, which these methods do not respect (by design).</p>

<p>If you use this option, you must explicitly check all add_* and remove_* return values to see if they were successful.</p>

<h4 id="label-3Aallow_eager">:allow_eager<span><a href="#label-3Aallow_eager">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>If set to false, you cannot load the association eagerly via eager or eager_graph.</p>

<pre class="ruby"><span class="ruby-constant">Artist</span>.<span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:albums</span>, <span class="ruby-value">allow_eager:</span> <span class="ruby-keyword">false</span>
<span class="ruby-constant">Artist</span>.<span class="ruby-identifier">eager</span>(<span class="ruby-value">:albums</span>)       <span class="ruby-comment"># Raises Sequel::Error</span>
<span class="ruby-constant">Artist</span>.<span class="ruby-identifier">eager_graph</span>(<span class="ruby-value">:albums</span>) <span class="ruby-comment"># Raises Sequel::Error</span>
</pre>

<p>This is usually used if the association dataset depends on specific values in model instance that would not be valid when eager loading for multiple instances.</p>

<h4 id="label-3Aallow_eager_graph">:allow_eager_graph<span><a href="#label-3Aallow_eager_graph">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>If set to false, you cannot load the association eagerly via eager_graph.</p>

<pre class="ruby"><span class="ruby-constant">Artist</span>.<span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:albums</span>, <span class="ruby-value">allow_eager_graph:</span> <span class="ruby-keyword">false</span>
<span class="ruby-constant">Artist</span>.<span class="ruby-identifier">eager</span>(<span class="ruby-value">:albums</span>)       <span class="ruby-comment"># Allowed</span>
<span class="ruby-constant">Artist</span>.<span class="ruby-identifier">eager_graph</span>(<span class="ruby-value">:albums</span>) <span class="ruby-comment"># Raises Sequel::Error</span>
</pre>

<p>This is useful if you still want to allow loading via eager, but do not want to allow loading via eager graph, possibly because the association does not support joins.</p>

<h4 id="label-3Aallow_filtering_by">:allow_filtering_by<span><a href="#label-3Aallow_filtering_by">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>If set to false, you cannot use the association when filtering.</p>

<pre class="ruby"><span class="ruby-constant">Artist</span>.<span class="ruby-identifier">one_to_many</span> <span class="ruby-value">:albums</span>, <span class="ruby-value">allow_filtering_by:</span> <span class="ruby-keyword">false</span>
<span class="ruby-constant">Artist</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">:albums</span><span class="ruby-operator">=&gt;</span><span class="ruby-constant">Album</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">:name</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&#39;A&#39;</span>)).<span class="ruby-identifier">all</span> <span class="ruby-comment"># Raises Sequel::Error</span>
</pre>

<p>This is useful if such filtering cannot work, such as when a subquery cannot be used because the necessary tables are not in the same database.</p>

<h4 id="label-3Ainstance_specific">:instance_specific<span><a href="#label-3Ainstance_specific">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>This allows you to override the setting of whether the dataset contains instance specific code.  If you are passing a block to the association, <a href="../Sequel.html"><code>Sequel</code></a> sets this to true by default, which disables some optimizations that would be invalid if the association is instance specific.  If you know that the block does not contain instance specific code, you can set this to false to reenable the optimizations.  Instance specific code is mostly commonly calling model instance methods inside an association block, but also includes cases where the association block can return different values based on the runtime environment, such as calls to <code>Time.now</code> in the block. Associations that use the :dataset option are always considered instance specific, even if explicitly specified otherwise.</p>

<h4 id="label-3Acartesian_product_number+">:cartesian_product_number <span><a href="#label-3Acartesian_product_number+">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>The number of joins completed by this association that could cause more than one row for each row in the current table (default: 0 for *_one associations, 1 for *_to_many associations).</p>

<p>This should only be modified in specific cases.  For example, if you have a one_to_one association that can actually return more than one row (where the default association method will just return the first), or a many_to_many association where there is a unique index in the join table so that you know only one object will ever be associated through the association.</p>

<h4 id="label-3Aclass_namespace">:class_namespace<span><a href="#label-3Aclass_namespace">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>If the :class option is specified as a symbol or string, the default namespace in which to look up the class. If the :class option is not specified as a symbol or string, this option is ignored.  This namespace can be overridden by starting the string or symbol with <code>::</code>:</p>

<pre class="ruby"><span class="ruby-constant">Foo</span><span class="ruby-operator">::</span><span class="ruby-constant">Album</span>.<span class="ruby-identifier">many_to_one</span> <span class="ruby-value">:artist</span>, <span class="ruby-value">class:</span> <span class="ruby-string">&quot;Artist&quot;</span>                                <span class="ruby-comment"># Uses Artist</span>
<span class="ruby-constant">Foo</span><span class="ruby-operator">::</span><span class="ruby-constant">Album</span>.<span class="ruby-identifier">many_to_one</span> <span class="ruby-value">:artist</span>, <span class="ruby-value">class:</span> <span class="ruby-string">&quot;Artist&quot;</span>, <span class="ruby-value">class_namespace:</span> <span class="ruby-string">&#39;Foo&#39;</span>        <span class="ruby-comment"># Uses Foo::Artist</span>
<span class="ruby-constant">Foo</span><span class="ruby-operator">::</span><span class="ruby-constant">Album</span>.<span class="ruby-identifier">many_to_one</span> <span class="ruby-value">:artist</span>, <span class="ruby-value">class:</span> <span class="ruby-string">&quot;Foo::Artist&quot;</span>, <span class="ruby-value">class_namespace:</span> <span class="ruby-string">&#39;Foo&#39;</span>   <span class="ruby-comment"># Uses Foo::Foo::Artist</span>
<span class="ruby-constant">Foo</span><span class="ruby-operator">::</span><span class="ruby-constant">Album</span>.<span class="ruby-identifier">many_to_one</span> <span class="ruby-value">:artist</span>, <span class="ruby-value">class:</span> <span class="ruby-string">&quot;::Artist&quot;</span>, <span class="ruby-value">class_namespace:</span> <span class="ruby-string">&#39;Foo&#39;</span>      <span class="ruby-comment"># Uses Artist</span>
<span class="ruby-constant">Foo</span><span class="ruby-operator">::</span><span class="ruby-constant">Album</span>.<span class="ruby-identifier">many_to_one</span> <span class="ruby-value">:artist</span>, <span class="ruby-value">class:</span> <span class="ruby-string">&quot;::Foo::Artist&quot;</span>, <span class="ruby-value">class_namespace:</span> <span class="ruby-string">&#39;Foo&#39;</span> <span class="ruby-comment"># Uses Foo::Artist</span>
</pre>

<h4 id="label-3Amethods_module">:methods_module<span><a href="#label-3Amethods_module">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>The module that the methods created by the association will be placed into.  Defaults to the module containing the model&#39;s columns.  Any module given to this option is not included in the model&#39;s class automatically, so you are responsible for doing that manually.</p>

<p>This is only useful in rare cases, such as when a plugin that adds associations depends on another plugin that defines instance methods of the same name.  In that case, the instance methods of the dependent plugin would override the association methods created by the main plugin.</p>

<h4 id="label-3Aeager_limit_strategy">:eager_limit_strategy<span><a href="#label-3Aeager_limit_strategy">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>This setting determines what strategy to use for eager loading the associations that use the :limit setting to limit the number of returned records. You can&#39;t use LIMIT directly, since you want a limit for each group of associated records, not a LIMIT on the total number of records returned by the dataset.</p>

<p>In general, <a href="../Sequel.html"><code>Sequel</code></a> picks an appropriate strategy, so it is not usually necessary to specify a strategy.  You can specify true for this option to have <a href="../Sequel.html"><code>Sequel</code></a> choose which strategy to use (this is the default).  You can specify a symbol to manually choose a strategy.  The available strategies are:</p>
<dl class="rdoc-list note-list"><dt>:union 
<dd>
<p>Uses one or more UNION queries with a subquery for each record you are eagerly loading for (this is the default strategy).</p>
</dd><dt>:distinct_on 
<dd>
<p>Uses DISTINCT ON to ensure only the first matching record is loaded (only used for one_*_one associations without offsets on PostgreSQL).</p>
</dd><dt>:window_function 
<dd>
<p>Uses a ROW_NUMBER window functions to ensure the correctly limited/offset records are returned.</p>
</dd><dt>:ruby 
<dd>
<p>Uses ruby array slicing to emulate database limiting/offsetting.</p>
</dd></dl>

<h4 id="label-3Asubqueries_per_union">:subqueries_per_union<span><a href="#label-3Asubqueries_per_union">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>The number of subqueries per union query to use when eager loading for a limited association using a union strategy.  This defaults to 40, but the optimum number depends on the database in use and the latency between the database and the application.</p>

<h4 id="label-3Afilter_limit_strategy">:filter_limit_strategy<span><a href="#label-3Afilter_limit_strategy">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>The strategy to use when filtering by limited associations.  In general <a href="../Sequel.html"><code>Sequel</code></a> will choose either a :distinct_on, :window_function, or :correlated_subquery strategy based on the association type and what the database supports, but you can override that if necessary using this option.</p>

</main>



<footer id="validator-badges" role="contentinfo">
  <p><a href="https://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="https://ruby.github.io/rdoc/">RDoc</a> 6.1.2.1.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

