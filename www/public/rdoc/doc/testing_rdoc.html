<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>testing - Sequel: The Database Toolkit for Ruby</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "../";
  var index_rel_prefix = "../";
</script>

<script src="../js/navigation.js" defer></script>
<script src="../js/search.js" defer></script>
<script src="../js/search_index.js" defer></script>
<script src="../js/searcher.js" defer></script>
<script src="../js/darkfish.js" defer></script>

<link href="../css/fonts.css" rel="stylesheet">
<link href="../css/rdoc.css" rel="stylesheet">




<body id="top" role="document" class="file">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../table_of_contents.html#pages">Pages</a>
    <a href="../table_of_contents.html#classes">Classes</a>
    <a href="../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  
<div class="nav-section">
  <h3>Table of Contents</h3>

  <ul class="link-list" role="directory">
    <li><a href="#label-Testing+with+Sequel">Testing with Sequel</a>
    <li><a href="#label-Transactional+tests">Transactional tests</a>
    <li><a href="#label-minitest-2Fspec">minitest/spec</a>
    <li><a href="#label-with+minitest-hooks++++">with minitest-hooks    </a>
    <li><a href="#label-without+minitest-hooks++">without minitest-hooks  </a>
    <li><a href="#label-minitest-2Ftest">minitest/test</a>
    <li><a href="#label-rspec+-3E-3D+2.8">rspec &gt;= 2.8</a>
    <li><a href="#label-Transactional+testing+with+multiple+databases">Transactional testing with multiple databases</a>
    <li><a href="#label-Transactional+testing+with+savepoints">Transactional testing with savepoints</a>
    <li><a href="#label-Nontransactional+tests">Nontransactional tests</a>
    <li><a href="#label-minitest-2Fspec+or+rspec">minitest/spec or rspec</a>
    <li><a href="#label-minitest-2Ftest">minitest/test</a>
    <li><a href="#label-Testing+Sequel+Itself">Testing Sequel Itself</a>
    <li><a href="#label-rake">rake</a>
    <li><a href="#label-rake+spec_core">rake spec_core</a>
    <li><a href="#label-rake+spec_model">rake spec_model</a>
    <li><a href="#label-rake+spec_plugin">rake spec_plugin</a>
    <li><a href="#label-rake+spec_core_ext">rake spec_core_ext</a>
    <li><a href="#label-rake+spec_bin">rake spec_bin</a>
    <li><a href="#label-rake+spec_adapter+-28e.g.+rake+spec_postgres-29">rake spec_<em>adapter</em> (e.g. rake spec_postgres)</a>
    <li><a href="#label-Environment+variables">Environment variables</a>
    <li><a href="#label-Connection+Strings">Connection Strings</a>
    <li><a href="#label-Other">Other</a>
  </ul>
</div>


  <div id="project-metadata">
    <div id="fileindex-section" class="nav-section">
  <h3>Pages</h3>

  <ul class="link-list">
  
    <li><a href="../CHANGELOG.html">CHANGELOG</a>
  
    <li><a href="../MIT-LICENSE.html">MIT-LICENSE</a>
  
    <li><a href="../README_rdoc.html">README</a>
  
    <li><a href="../doc/CHANGELOG_old.html">CHANGELOG.old</a>
  
    <li><a href="../doc/advanced_associations_rdoc.html">advanced_associations</a>
  
    <li><a href="../doc/association_basics_rdoc.html">association_basics</a>
  
    <li><a href="../doc/bin_sequel_rdoc.html">bin_sequel</a>
  
    <li><a href="../doc/cheat_sheet_rdoc.html">cheat_sheet</a>
  
    <li><a href="../doc/code_order_rdoc.html">code_order</a>
  
    <li><a href="../doc/core_extensions_rdoc.html">core_extensions</a>
  
    <li><a href="../doc/dataset_basics_rdoc.html">dataset_basics</a>
  
    <li><a href="../doc/dataset_filtering_rdoc.html">dataset_filtering</a>
  
    <li><a href="../doc/extensions_rdoc.html">extensions</a>
  
    <li><a href="../doc/fork_safety_rdoc.html">fork_safety</a>
  
    <li><a href="../doc/mass_assignment_rdoc.html">mass_assignment</a>
  
    <li><a href="../doc/migration_rdoc.html">migration</a>
  
    <li><a href="../doc/model_dataset_method_design_rdoc.html">model_dataset_method_design</a>
  
    <li><a href="../doc/model_hooks_rdoc.html">model_hooks</a>
  
    <li><a href="../doc/model_plugins_rdoc.html">model_plugins</a>
  
    <li><a href="../doc/mssql_stored_procedures_rdoc.html">mssql_stored_procedures</a>
  
    <li><a href="../doc/object_model_rdoc.html">object_model</a>
  
    <li><a href="../doc/opening_databases_rdoc.html">opening_databases</a>
  
    <li><a href="../doc/postgresql_rdoc.html">postgresql</a>
  
    <li><a href="../doc/prepared_statements_rdoc.html">prepared_statements</a>
  
    <li><a href="../doc/querying_rdoc.html">querying</a>
  
    <li><a href="../doc/reflection_rdoc.html">reflection</a>
  
    <li><a href="../doc/release_notes/1_0_txt.html">1.0</a>
  
    <li><a href="../doc/release_notes/1_1_txt.html">1.1</a>
  
    <li><a href="../doc/release_notes/1_3_txt.html">1.3</a>
  
    <li><a href="../doc/release_notes/1_4_0_txt.html">1.4.0</a>
  
    <li><a href="../doc/release_notes/1_5_0_txt.html">1.5.0</a>
  
    <li><a href="../doc/release_notes/2_0_0_txt.html">2.0.0</a>
  
    <li><a href="../doc/release_notes/2_1_0_txt.html">2.1.0</a>
  
    <li><a href="../doc/release_notes/2_10_0_txt.html">2.10.0</a>
  
    <li><a href="../doc/release_notes/2_11_0_txt.html">2.11.0</a>
  
    <li><a href="../doc/release_notes/2_12_0_txt.html">2.12.0</a>
  
    <li><a href="../doc/release_notes/2_2_0_txt.html">2.2.0</a>
  
    <li><a href="../doc/release_notes/2_3_0_txt.html">2.3.0</a>
  
    <li><a href="../doc/release_notes/2_4_0_txt.html">2.4.0</a>
  
    <li><a href="../doc/release_notes/2_5_0_txt.html">2.5.0</a>
  
    <li><a href="../doc/release_notes/2_6_0_txt.html">2.6.0</a>
  
    <li><a href="../doc/release_notes/2_7_0_txt.html">2.7.0</a>
  
    <li><a href="../doc/release_notes/2_8_0_txt.html">2.8.0</a>
  
    <li><a href="../doc/release_notes/2_9_0_txt.html">2.9.0</a>
  
    <li><a href="../doc/release_notes/3_0_0_txt.html">3.0.0</a>
  
    <li><a href="../doc/release_notes/3_1_0_txt.html">3.1.0</a>
  
    <li><a href="../doc/release_notes/3_10_0_txt.html">3.10.0</a>
  
    <li><a href="../doc/release_notes/3_11_0_txt.html">3.11.0</a>
  
    <li><a href="../doc/release_notes/3_12_0_txt.html">3.12.0</a>
  
    <li><a href="../doc/release_notes/3_13_0_txt.html">3.13.0</a>
  
    <li><a href="../doc/release_notes/3_14_0_txt.html">3.14.0</a>
  
    <li><a href="../doc/release_notes/3_15_0_txt.html">3.15.0</a>
  
    <li><a href="../doc/release_notes/3_16_0_txt.html">3.16.0</a>
  
    <li><a href="../doc/release_notes/3_17_0_txt.html">3.17.0</a>
  
    <li><a href="../doc/release_notes/3_18_0_txt.html">3.18.0</a>
  
    <li><a href="../doc/release_notes/3_19_0_txt.html">3.19.0</a>
  
    <li><a href="../doc/release_notes/3_2_0_txt.html">3.2.0</a>
  
    <li><a href="../doc/release_notes/3_20_0_txt.html">3.20.0</a>
  
    <li><a href="../doc/release_notes/3_21_0_txt.html">3.21.0</a>
  
    <li><a href="../doc/release_notes/3_22_0_txt.html">3.22.0</a>
  
    <li><a href="../doc/release_notes/3_23_0_txt.html">3.23.0</a>
  
    <li><a href="../doc/release_notes/3_24_0_txt.html">3.24.0</a>
  
    <li><a href="../doc/release_notes/3_25_0_txt.html">3.25.0</a>
  
    <li><a href="../doc/release_notes/3_26_0_txt.html">3.26.0</a>
  
    <li><a href="../doc/release_notes/3_27_0_txt.html">3.27.0</a>
  
    <li><a href="../doc/release_notes/3_28_0_txt.html">3.28.0</a>
  
    <li><a href="../doc/release_notes/3_29_0_txt.html">3.29.0</a>
  
    <li><a href="../doc/release_notes/3_3_0_txt.html">3.3.0</a>
  
    <li><a href="../doc/release_notes/3_30_0_txt.html">3.30.0</a>
  
    <li><a href="../doc/release_notes/3_31_0_txt.html">3.31.0</a>
  
    <li><a href="../doc/release_notes/3_32_0_txt.html">3.32.0</a>
  
    <li><a href="../doc/release_notes/3_33_0_txt.html">3.33.0</a>
  
    <li><a href="../doc/release_notes/3_34_0_txt.html">3.34.0</a>
  
    <li><a href="../doc/release_notes/3_35_0_txt.html">3.35.0</a>
  
    <li><a href="../doc/release_notes/3_36_0_txt.html">3.36.0</a>
  
    <li><a href="../doc/release_notes/3_37_0_txt.html">3.37.0</a>
  
    <li><a href="../doc/release_notes/3_38_0_txt.html">3.38.0</a>
  
    <li><a href="../doc/release_notes/3_39_0_txt.html">3.39.0</a>
  
    <li><a href="../doc/release_notes/3_4_0_txt.html">3.4.0</a>
  
    <li><a href="../doc/release_notes/3_40_0_txt.html">3.40.0</a>
  
    <li><a href="../doc/release_notes/3_41_0_txt.html">3.41.0</a>
  
    <li><a href="../doc/release_notes/3_42_0_txt.html">3.42.0</a>
  
    <li><a href="../doc/release_notes/3_43_0_txt.html">3.43.0</a>
  
    <li><a href="../doc/release_notes/3_44_0_txt.html">3.44.0</a>
  
    <li><a href="../doc/release_notes/3_45_0_txt.html">3.45.0</a>
  
    <li><a href="../doc/release_notes/3_46_0_txt.html">3.46.0</a>
  
    <li><a href="../doc/release_notes/3_47_0_txt.html">3.47.0</a>
  
    <li><a href="../doc/release_notes/3_48_0_txt.html">3.48.0</a>
  
    <li><a href="../doc/release_notes/3_5_0_txt.html">3.5.0</a>
  
    <li><a href="../doc/release_notes/3_6_0_txt.html">3.6.0</a>
  
    <li><a href="../doc/release_notes/3_7_0_txt.html">3.7.0</a>
  
    <li><a href="../doc/release_notes/3_8_0_txt.html">3.8.0</a>
  
    <li><a href="../doc/release_notes/3_9_0_txt.html">3.9.0</a>
  
    <li><a href="../doc/release_notes/4_0_0_txt.html">4.0.0</a>
  
    <li><a href="../doc/release_notes/4_1_0_txt.html">4.1.0</a>
  
    <li><a href="../doc/release_notes/4_10_0_txt.html">4.10.0</a>
  
    <li><a href="../doc/release_notes/4_11_0_txt.html">4.11.0</a>
  
    <li><a href="../doc/release_notes/4_12_0_txt.html">4.12.0</a>
  
    <li><a href="../doc/release_notes/4_13_0_txt.html">4.13.0</a>
  
    <li><a href="../doc/release_notes/4_14_0_txt.html">4.14.0</a>
  
    <li><a href="../doc/release_notes/4_15_0_txt.html">4.15.0</a>
  
    <li><a href="../doc/release_notes/4_16_0_txt.html">4.16.0</a>
  
    <li><a href="../doc/release_notes/4_17_0_txt.html">4.17.0</a>
  
    <li><a href="../doc/release_notes/4_18_0_txt.html">4.18.0</a>
  
    <li><a href="../doc/release_notes/4_19_0_txt.html">4.19.0</a>
  
    <li><a href="../doc/release_notes/4_2_0_txt.html">4.2.0</a>
  
    <li><a href="../doc/release_notes/4_20_0_txt.html">4.20.0</a>
  
    <li><a href="../doc/release_notes/4_21_0_txt.html">4.21.0</a>
  
    <li><a href="../doc/release_notes/4_22_0_txt.html">4.22.0</a>
  
    <li><a href="../doc/release_notes/4_23_0_txt.html">4.23.0</a>
  
    <li><a href="../doc/release_notes/4_24_0_txt.html">4.24.0</a>
  
    <li><a href="../doc/release_notes/4_25_0_txt.html">4.25.0</a>
  
    <li><a href="../doc/release_notes/4_26_0_txt.html">4.26.0</a>
  
    <li><a href="../doc/release_notes/4_27_0_txt.html">4.27.0</a>
  
    <li><a href="../doc/release_notes/4_28_0_txt.html">4.28.0</a>
  
    <li><a href="../doc/release_notes/4_29_0_txt.html">4.29.0</a>
  
    <li><a href="../doc/release_notes/4_3_0_txt.html">4.3.0</a>
  
    <li><a href="../doc/release_notes/4_30_0_txt.html">4.30.0</a>
  
    <li><a href="../doc/release_notes/4_31_0_txt.html">4.31.0</a>
  
    <li><a href="../doc/release_notes/4_32_0_txt.html">4.32.0</a>
  
    <li><a href="../doc/release_notes/4_33_0_txt.html">4.33.0</a>
  
    <li><a href="../doc/release_notes/4_34_0_txt.html">4.34.0</a>
  
    <li><a href="../doc/release_notes/4_35_0_txt.html">4.35.0</a>
  
    <li><a href="../doc/release_notes/4_36_0_txt.html">4.36.0</a>
  
    <li><a href="../doc/release_notes/4_37_0_txt.html">4.37.0</a>
  
    <li><a href="../doc/release_notes/4_38_0_txt.html">4.38.0</a>
  
    <li><a href="../doc/release_notes/4_39_0_txt.html">4.39.0</a>
  
    <li><a href="../doc/release_notes/4_4_0_txt.html">4.4.0</a>
  
    <li><a href="../doc/release_notes/4_40_0_txt.html">4.40.0</a>
  
    <li><a href="../doc/release_notes/4_41_0_txt.html">4.41.0</a>
  
    <li><a href="../doc/release_notes/4_42_0_txt.html">4.42.0</a>
  
    <li><a href="../doc/release_notes/4_43_0_txt.html">4.43.0</a>
  
    <li><a href="../doc/release_notes/4_44_0_txt.html">4.44.0</a>
  
    <li><a href="../doc/release_notes/4_45_0_txt.html">4.45.0</a>
  
    <li><a href="../doc/release_notes/4_46_0_txt.html">4.46.0</a>
  
    <li><a href="../doc/release_notes/4_47_0_txt.html">4.47.0</a>
  
    <li><a href="../doc/release_notes/4_48_0_txt.html">4.48.0</a>
  
    <li><a href="../doc/release_notes/4_49_0_txt.html">4.49.0</a>
  
    <li><a href="../doc/release_notes/4_5_0_txt.html">4.5.0</a>
  
    <li><a href="../doc/release_notes/4_6_0_txt.html">4.6.0</a>
  
    <li><a href="../doc/release_notes/4_7_0_txt.html">4.7.0</a>
  
    <li><a href="../doc/release_notes/4_8_0_txt.html">4.8.0</a>
  
    <li><a href="../doc/release_notes/4_9_0_txt.html">4.9.0</a>
  
    <li><a href="../doc/release_notes/5_0_0_txt.html">5.0.0</a>
  
    <li><a href="../doc/release_notes/5_1_0_txt.html">5.1.0</a>
  
    <li><a href="../doc/release_notes/5_10_0_txt.html">5.10.0</a>
  
    <li><a href="../doc/release_notes/5_11_0_txt.html">5.11.0</a>
  
    <li><a href="../doc/release_notes/5_12_0_txt.html">5.12.0</a>
  
    <li><a href="../doc/release_notes/5_13_0_txt.html">5.13.0</a>
  
    <li><a href="../doc/release_notes/5_14_0_txt.html">5.14.0</a>
  
    <li><a href="../doc/release_notes/5_15_0_txt.html">5.15.0</a>
  
    <li><a href="../doc/release_notes/5_16_0_txt.html">5.16.0</a>
  
    <li><a href="../doc/release_notes/5_17_0_txt.html">5.17.0</a>
  
    <li><a href="../doc/release_notes/5_18_0_txt.html">5.18.0</a>
  
    <li><a href="../doc/release_notes/5_19_0_txt.html">5.19.0</a>
  
    <li><a href="../doc/release_notes/5_2_0_txt.html">5.2.0</a>
  
    <li><a href="../doc/release_notes/5_20_0_txt.html">5.20.0</a>
  
    <li><a href="../doc/release_notes/5_21_0_txt.html">5.21.0</a>
  
    <li><a href="../doc/release_notes/5_22_0_txt.html">5.22.0</a>
  
    <li><a href="../doc/release_notes/5_23_0_txt.html">5.23.0</a>
  
    <li><a href="../doc/release_notes/5_24_0_txt.html">5.24.0</a>
  
    <li><a href="../doc/release_notes/5_25_0_txt.html">5.25.0</a>
  
    <li><a href="../doc/release_notes/5_26_0_txt.html">5.26.0</a>
  
    <li><a href="../doc/release_notes/5_27_0_txt.html">5.27.0</a>
  
    <li><a href="../doc/release_notes/5_28_0_txt.html">5.28.0</a>
  
    <li><a href="../doc/release_notes/5_29_0_txt.html">5.29.0</a>
  
    <li><a href="../doc/release_notes/5_3_0_txt.html">5.3.0</a>
  
    <li><a href="../doc/release_notes/5_30_0_txt.html">5.30.0</a>
  
    <li><a href="../doc/release_notes/5_31_0_txt.html">5.31.0</a>
  
    <li><a href="../doc/release_notes/5_32_0_txt.html">5.32.0</a>
  
    <li><a href="../doc/release_notes/5_33_0_txt.html">5.33.0</a>
  
    <li><a href="../doc/release_notes/5_34_0_txt.html">5.34.0</a>
  
    <li><a href="../doc/release_notes/5_35_0_txt.html">5.35.0</a>
  
    <li><a href="../doc/release_notes/5_36_0_txt.html">5.36.0</a>
  
    <li><a href="../doc/release_notes/5_37_0_txt.html">5.37.0</a>
  
    <li><a href="../doc/release_notes/5_38_0_txt.html">5.38.0</a>
  
    <li><a href="../doc/release_notes/5_39_0_txt.html">5.39.0</a>
  
    <li><a href="../doc/release_notes/5_4_0_txt.html">5.4.0</a>
  
    <li><a href="../doc/release_notes/5_40_0_txt.html">5.40.0</a>
  
    <li><a href="../doc/release_notes/5_41_0_txt.html">5.41.0</a>
  
    <li><a href="../doc/release_notes/5_42_0_txt.html">5.42.0</a>
  
    <li><a href="../doc/release_notes/5_43_0_txt.html">5.43.0</a>
  
    <li><a href="../doc/release_notes/5_44_0_txt.html">5.44.0</a>
  
    <li><a href="../doc/release_notes/5_45_0_txt.html">5.45.0</a>
  
    <li><a href="../doc/release_notes/5_46_0_txt.html">5.46.0</a>
  
    <li><a href="../doc/release_notes/5_47_0_txt.html">5.47.0</a>
  
    <li><a href="../doc/release_notes/5_48_0_txt.html">5.48.0</a>
  
    <li><a href="../doc/release_notes/5_49_0_txt.html">5.49.0</a>
  
    <li><a href="../doc/release_notes/5_5_0_txt.html">5.5.0</a>
  
    <li><a href="../doc/release_notes/5_50_0_txt.html">5.50.0</a>
  
    <li><a href="../doc/release_notes/5_51_0_txt.html">5.51.0</a>
  
    <li><a href="../doc/release_notes/5_52_0_txt.html">5.52.0</a>
  
    <li><a href="../doc/release_notes/5_53_0_txt.html">5.53.0</a>
  
    <li><a href="../doc/release_notes/5_54_0_txt.html">5.54.0</a>
  
    <li><a href="../doc/release_notes/5_55_0_txt.html">5.55.0</a>
  
    <li><a href="../doc/release_notes/5_6_0_txt.html">5.6.0</a>
  
    <li><a href="../doc/release_notes/5_7_0_txt.html">5.7.0</a>
  
    <li><a href="../doc/release_notes/5_8_0_txt.html">5.8.0</a>
  
    <li><a href="../doc/release_notes/5_9_0_txt.html">5.9.0</a>
  
    <li><a href="../doc/schema_modification_rdoc.html">schema_modification</a>
  
    <li><a href="../doc/security_rdoc.html">security</a>
  
    <li><a href="../doc/sharding_rdoc.html">sharding</a>
  
    <li><a href="../doc/sql_rdoc.html">sql</a>
  
    <li><a href="../doc/testing_rdoc.html">testing</a>
  
    <li><a href="../doc/thread_safety_rdoc.html">thread_safety</a>
  
    <li><a href="../doc/transactions_rdoc.html">transactions</a>
  
    <li><a href="../doc/validations_rdoc.html">validations</a>
  
    <li><a href="../doc/virtual_rows_rdoc.html">virtual_rows</a>
  
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-label="Page doc/testing.rdoc">

<h1 id="label-Testing+with+Sequel">Testing with <a href="../Sequel.html"><code>Sequel</code></a><span><a href="#label-Testing+with+Sequel">&para;</a> <a href="#top">&uarr;</a></span></h1>

<p>Whether or not you use <a href="../Sequel.html"><code>Sequel</code></a> in your application, you are usually going to want to have tests that ensure that your code works.  When you are using <a href="../Sequel.html"><code>Sequel</code></a>, it&#39;s helpful to integrate it into your testing framework, and it&#39;s generally best to run each test in its own transaction if possible.  That keeps all tests isolated from each other, and it&#39;s simple as it handles all of the cleanup for you.  <a href="../Sequel.html"><code>Sequel</code></a> doesn&#39;t ship with helpers for common libraries, as the exact code you need is often application-specific, but this page offers some examples that you can either use directly or build on.</p>

<h2 id="label-Transactional+tests">Transactional tests<span><a href="#label-Transactional+tests">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>These run each test in its own transaction, the recommended way to test.</p>

<h3 id="label-minitest-2Fspec">minitest/spec<span><a href="#label-minitest-2Fspec">&para;</a> <a href="#top">&uarr;</a></span></h3>

<h4 id="label-with+minitest-hooks++++">with minitest-hooks    <span><a href="#label-with+minitest-hooks++++">&para;</a> <a href="#top">&uarr;</a></span></h4>

<pre class="ruby"><span class="ruby-identifier">require</span> <span class="ruby-string">&#39;minitest/hooks/default&#39;</span>

<span class="ruby-constant">DB</span> = <span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">postgres</span> <span class="ruby-comment"># change if using sqlite etc</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Minitest</span><span class="ruby-operator">::</span><span class="ruby-constant">HooksSpec</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">around</span>
    <span class="ruby-constant">DB</span>.<span class="ruby-identifier">transaction</span>(<span class="ruby-value">:rollback</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">:always</span>, <span class="ruby-value">:auto_savepoint</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">true</span>){<span class="ruby-keyword">super</span>}
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h4 id="label-without+minitest-hooks++">without minitest-hooks  <span><a href="#label-without+minitest-hooks++">&para;</a> <a href="#top">&uarr;</a></span></h4>

<pre class="ruby"><span class="ruby-constant">DB</span> = <span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">postgres</span> <span class="ruby-comment"># change if using sqlite etc</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Minitest</span><span class="ruby-operator">::</span><span class="ruby-constant">Spec</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">run</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
    <span class="ruby-constant">DB</span>.<span class="ruby-identifier">transaction</span>(<span class="ruby-value">:rollback</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">:always</span>, <span class="ruby-value">:auto_savepoint</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">true</span>){<span class="ruby-keyword">super</span>}
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h3 id="label-minitest-2Ftest">minitest/test<span><a href="#label-minitest-2Ftest">&para;</a> <a href="#top">&uarr;</a></span></h3>

<pre class="ruby"><span class="ruby-constant">DB</span> = <span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">postgres</span> <span class="ruby-comment"># change if using sqlite etc</span>

<span class="ruby-comment"># Use this class as the base class for your tests</span>
<span class="ruby-keyword">class</span> <span class="ruby-constant">SequelTestCase</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Minitest</span><span class="ruby-operator">::</span><span class="ruby-constant">Test</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">run</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
    <span class="ruby-constant">DB</span>.<span class="ruby-identifier">transaction</span>(<span class="ruby-value">:rollback</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">:always</span>, <span class="ruby-value">:auto_savepoint</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">true</span>){<span class="ruby-keyword">super</span>}
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h3 id="label-rspec+-3E-3D+2.8">rspec &gt;= 2.8<span><a href="#label-rspec+-3E-3D+2.8">&para;</a> <a href="#top">&uarr;</a></span></h3>

<pre class="ruby"><span class="ruby-constant">DB</span> = <span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">postgres</span> <span class="ruby-comment"># change the database if you are using sqlite etc.</span>

<span class="ruby-constant">RSpec</span>.<span class="ruby-identifier">configure</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">c</span>.<span class="ruby-identifier">around</span>(<span class="ruby-value">:each</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">example</span><span class="ruby-operator">|</span>
    <span class="ruby-constant">DB</span>.<span class="ruby-identifier">transaction</span>(<span class="ruby-value">:rollback</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">:always</span>, <span class="ruby-value">:auto_savepoint</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">true</span>){<span class="ruby-identifier">example</span>.<span class="ruby-identifier">run</span>}
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h2 id="label-Transactional+testing+with+multiple+databases">Transactional testing with multiple databases<span><a href="#label-Transactional+testing+with+multiple+databases">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>You can use the Sequel.transaction method to run a transaction on multiple databases, rolling all of them back.  Instead of:</p>

<pre class="ruby"><span class="ruby-constant">DB</span>.<span class="ruby-identifier">transaction</span>(<span class="ruby-value">:rollback</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">:always</span>)
</pre>

<p>Use Sequel.transaction with an array of databases:</p>

<pre class="ruby"><span class="ruby-constant">Sequel</span>.<span class="ruby-identifier">transaction</span>([<span class="ruby-constant">DB1</span>, <span class="ruby-constant">DB2</span>, <span class="ruby-constant">DB3</span>], <span class="ruby-value">:rollback</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">:always</span>)
</pre>

<h2 id="label-Transactional+testing+with+savepoints">Transactional testing with savepoints<span><a href="#label-Transactional+testing+with+savepoints">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>Using minitest/spec and minitest-hooks, and assuming your database supports it, you can use transactions around entire test suites, using savepoints around each test.  This can sigificantly speed up any test suite where there is a lot of shared setup in a before all hook.  By using savepoints per test, each test is isolated from each other, rolling back changes after it completes, and by using transactions per test suite, you only pay the cost to load the data once for the test suite, and it is automatically rolled back after the test suite completes.</p>

<p>Example:</p>

<pre class="ruby"><span class="ruby-identifier">require</span> <span class="ruby-string">&#39;minitest/hooks/default&#39;</span>
<span class="ruby-keyword">class</span> <span class="ruby-constant">Minitest</span><span class="ruby-operator">::</span><span class="ruby-constant">HooksSpec</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">around</span>
    <span class="ruby-constant">DB</span>.<span class="ruby-identifier">transaction</span>(<span class="ruby-value">:rollback</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">:always</span>, <span class="ruby-value">:savepoint</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">true</span>, <span class="ruby-value">:auto_savepoint</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">true</span>){<span class="ruby-keyword">super</span>}
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">around_all</span>
    <span class="ruby-constant">DB</span>.<span class="ruby-identifier">transaction</span>(<span class="ruby-value">:rollback</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">:always</span>){<span class="ruby-keyword">super</span>}
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>

<span class="ruby-identifier">describe</span> <span class="ruby-string">&quot;some large test suite&quot;</span> <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">before</span>(<span class="ruby-value">:all</span>) <span class="ruby-keyword">do</span>
    <span class="ruby-constant">DB</span>[<span class="ruby-value">:table</span>].<span class="ruby-identifier">import</span> <span class="ruby-comment"># Large number of rows</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h2 id="label-Nontransactional+tests">Nontransactional tests<span><a href="#label-Nontransactional+tests">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>In some cases, it is not possible to use transactions.  For example, if you are testing a web application that is running in a separate process, you don&#39;t have access to that process&#39;s database connections, so you can&#39;t run your examples in transactions.  In that case, the best way to handle things is to cleanup after each test by deleting or truncating the database tables used in the test.</p>

<p>The order in which you delete/truncate the tables is important if you are using referential integrity in your database (which you should be doing).  If you are using referential integrity, you need to make sure to delete in tables referencing other tables before the tables that are being referenced.  For example, if you have an <code>albums</code> table with an <code>artist_id</code> field referencing the <code>artists</code> table, you want to delete/truncate the <code>albums</code> table before the <code>artists</code> table.  Note that if you have cyclic references in your database, you will probably need to write your own custom cleaning code.</p>

<h3 id="label-minitest-2Fspec+or+rspec">minitest/spec or rspec<span><a href="#label-minitest-2Fspec+or+rspec">&para;</a> <a href="#top">&uarr;</a></span></h3>

<pre class="ruby"><span class="ruby-identifier">describe</span> <span class="ruby-string">&quot;some test suite&quot;</span> <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">after</span> <span class="ruby-keyword">do</span>
    [<span class="ruby-value">:table1</span>, <span class="ruby-value">:table2</span>].<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">x</span><span class="ruby-operator">|</span> <span class="ruby-constant">DB</span>.<span class="ruby-identifier">from</span>(<span class="ruby-identifier">x</span>).<span class="ruby-identifier">truncate</span>}
    <span class="ruby-comment"># or</span>
    [<span class="ruby-value">:table1</span>, <span class="ruby-value">:table2</span>].<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">x</span><span class="ruby-operator">|</span> <span class="ruby-constant">DB</span>.<span class="ruby-identifier">from</span>(<span class="ruby-identifier">x</span>).<span class="ruby-identifier">delete</span>}
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h3 id="label-minitest-2Ftest">minitest/test<span><a href="#label-minitest-2Ftest">&para;</a> <a href="#top">&uarr;</a></span></h3>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">SomeTestClass</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Minitest</span><span class="ruby-operator">::</span><span class="ruby-constant">Test</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">teardown</span>
    [<span class="ruby-value">:table1</span>, <span class="ruby-value">:table2</span>].<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">x</span><span class="ruby-operator">|</span> <span class="ruby-constant">DB</span>.<span class="ruby-identifier">from</span>(<span class="ruby-identifier">x</span>).<span class="ruby-identifier">truncate</span>}
    <span class="ruby-comment"># or</span>
    [<span class="ruby-value">:table1</span>, <span class="ruby-value">:table2</span>].<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">x</span><span class="ruby-operator">|</span> <span class="ruby-constant">DB</span>.<span class="ruby-identifier">from</span>(<span class="ruby-identifier">x</span>).<span class="ruby-identifier">delete</span>}
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h1 id="label-Testing+Sequel+Itself">Testing <a href="../Sequel.html"><code>Sequel</code></a> Itself<span><a href="#label-Testing+Sequel+Itself">&para;</a> <a href="#top">&uarr;</a></span></h1>

<p><a href="../Sequel.html"><code>Sequel</code></a> has multiple separate test suites.  All test suites use minitest/spec, with the minitest-hooks, minitest-global_expectations, and minitest-shared_description extensions.  To install the dependencies necessary to test <a href="../Sequel.html"><code>Sequel</code></a>, run <code>gem install --development sequel</code>.</p>

<h2 id="label-rake">rake<span><a href="#label-rake">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>The default rake task runs Sequel&#39;s core, model, plugin, and extension specs, the same as <code>rake spec</code> or <code>rake spec_core spec_model spec_plugin</code>.</p>

<h2 id="label-rake+spec_core">rake spec_core<span><a href="#label-rake+spec_core">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>The <code>spec_core</code> rake task runs Sequel&#39;s core specs.  These specs use a mocked database connection, and test for specific SQL used and for generally correct behavior.</p>

<h2 id="label-rake+spec_model">rake spec_model<span><a href="#label-rake+spec_model">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>The <code>spec_model</code> rake task runs Sequel&#39;s model specs.  These specs also use a mocked database connection, and operate similar to the core tests.</p>

<h2 id="label-rake+spec_plugin">rake spec_plugin<span><a href="#label-rake+spec_plugin">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>The <code>spec_plugin</code> rake task runs the specs for the plugins and extensions that ship with <a href="../Sequel.html"><code>Sequel</code></a>.  These also use a mocked database connection, and operate very similarly to the general <a href="../Sequel.html"><code>Sequel</code></a> core and model specs.</p>

<h2 id="label-rake+spec_core_ext">rake spec_core_ext<span><a href="#label-rake+spec_core_ext">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>The <code>spec_core_ext</code> rake task runs the specs for the <a href="core_extensions_rdoc.html">core_extensions</a> extension.  These are run separately from the other extension tests to make sure none of the other extensions require the core_extensions.</p>

<h2 id="label-rake+spec_bin">rake spec_bin<span><a href="#label-rake+spec_bin">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>The <code>spec_bin</code> rake task runs the specs for bin/sequel.  These use an SQLite3 database, and require either the sqlite3 (non-JRuby) or jdbc-sqlite3 (JRuby) gem.</p>

<h2 id="label-rake+spec_adapter+-28e.g.+rake+spec_postgres-29">rake spec_<em>adapter</em> (e.g. rake spec_postgres)<span><a href="#label-rake+spec_adapter+-28e.g.+rake+spec_postgres-29">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>The <code>spec_<em>adapter</em></code> specs run against a real database connection with nothing mocked, and test for correct results.  They are slower than the standard specs, but they will catch errors that are mocked out by the default specs, as well as show issues that only occur on a certain database, adapter, or a combination of the two.</p>

<p>These specs are broken down into two parts.  For each database, there are specific specs that only apply to that database, and these are called the adapter specs.  There are also shared specs that apply to all (or almost all) databases, these are called the integration specs. For database types that don&#39;t have specific adapter tests, you can use <code>rake spec_integration</code> to just run the shared integration tests.</p>

<p>Each adapter needs a specific gem installed in order to run.  Please see the <a href="opening_databases_rdoc.html">connecting to a database guide</a> for which gem you need to install for the adapter you are testing.</p>

<h2 id="label-Environment+variables">Environment variables<span><a href="#label-Environment+variables">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p><a href="../Sequel.html"><code>Sequel</code></a> uses environment variables when testing to specify either the database to be tested or specify how testing should be done.  You can also specify the databases to test by copying <code>spec/spec_config.rb.example</code> to <code>spec/spec_config.rb</code> and modifying it.  See that file for details.  It may be necessary to use <code>spec_config.rb</code> as opposed to an environment variable if your database connection cannot be specified by a connection string.</p>

<p><a href="../Sequel.html"><code>Sequel</code></a> does not create test databases automatically, except for file-based databases such as SQLite/H2/HSQLDB/Derby.  It&#39;s up to the user to create the test databases manually and give <a href="../Sequel.html"><code>Sequel</code></a> a valid connection string in an environment variable (or setup the connection object in <code>spec_config.rb</code>).</p>

<h3 id="label-Connection+Strings">Connection Strings<span><a href="#label-Connection+Strings">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The SEQUEL_INTEGRATION_URL environment variable specifies the Database connection URL to use for the adapter and integration specs.  Additionally, when running the adapter specs, you can also use the SEQUEL_<em>ADAPTER</em>_URL environment variable (e.g. SEQUEL_POSTGRES_URL for spec_postgres).</p>

<h3 id="label-Other">Other<span><a href="#label-Other">&para;</a> <a href="#top">&uarr;</a></span></h3>
<dl class="rdoc-list note-list"><dt>SEQUEL_ASYNC_THREAD_POOL 
<dd>
<p>Use the async_thread_pool extension when running the specs</p>
</dd><dt>SEQUEL_ASYNC_THREAD_POOL_PREEMPT 
<dd>
<p>Use the async_thread_pool extension when running the specs, with the :preempt_async_thread option</p>
</dd><dt>SEQUEL_COLUMNS_INTROSPECTION 
<dd>
<p>Use the columns_introspection extension when running the specs</p>
</dd><dt>SEQUEL_CONNECTION_VALIDATOR 
<dd>
<p>Use the connection validator extension when running the specs</p>
</dd><dt>SEQUEL_DUPLICATE_COLUMNS_HANDLER 
<dd>
<p>Use the duplicate columns handler extension with value given when running the specs</p>
</dd><dt>SEQUEL_CONCURRENT_EAGER_LOADING 
<dd>
<p>Use the async_thread_pool extension and concurrent_eager_loading plugin when running the specs</p>
</dd><dt>SEQUEL_ERROR_SQL 
<dd>
<p>Use the error_sql extension when running the specs</p>
</dd><dt>SEQUEL_INDEX_CACHING 
<dd>
<p>Use the index_caching extension when running the specs</p>
</dd><dt>SEQUEL_FIBER_CONCURRENCY 
<dd>
<p>Use the fiber_concurrency extension when running the adapter and integration specs</p>
</dd><dt>SEQUEL_FREEZE_DATABASE 
<dd>
<p>Freeze the database before running the integration specs</p>
</dd><dt>SEQUEL_IDENTIFIER_MANGLING 
<dd>
<p>Use the identifier_mangling extension when running the specs</p>
</dd><dt>SEQUEL_INTEGER64 
<dd>
<p>Use the integer64 extension when running the adapter or integration specs</p>
</dd><dt>SEQUEL_MODEL_PREPARED_STATEMENTS 
<dd>
<p>Use the <a href="prepared_statements_rdoc.html">prepared_statements</a> plugin when running the specs</p>
</dd><dt>SEQUEL_MODEL_THROW_FAILURES 
<dd>
<p>Use the throw_failures plugin when running the specs</p>
</dd><dt>SEQUEL_NO_CACHE_ASSOCIATIONS 
<dd>
<p>Don&#39;t cache association metadata when running the specs</p>
</dd><dt>SEQUEL_CHECK_PENDING 
<dd>
<p>Try running all specs (note, can cause lockups for some adapters), and raise errors for skipped specs that don&#39;t fail</p>
</dd><dt>SEQUEL_NO_PENDING 
<dd>
<p>Don&#39;t skip any specs, try running all specs (note, can cause lockups for some adapters)</p>
</dd><dt>SEQUEL_PG_TIMESTAMPTZ 
<dd>
<p>Use the pg_timestamptz extension when running the postgres specs</p>
</dd><dt>SEQUEL_QUERY_PER_ASSOCIATION_DB_0_URL 
<dd>
<p>Run query-per-association integration tests with multiple databases (all 4 must be set to run)</p>
</dd><dt>SEQUEL_QUERY_PER_ASSOCIATION_DB_1_URL 
<dd>
<p>Run query-per-association integration tests with multiple databases (all 4 must be set to run)</p>
</dd><dt>SEQUEL_QUERY_PER_ASSOCIATION_DB_2_URL 
<dd>
<p>Run query-per-association integration tests with multiple databases (all 4 must be set to run)</p>
</dd><dt>SEQUEL_QUERY_PER_ASSOCIATION_DB_3_URL 
<dd>
<p>Run query-per-association integration tests with multiple databases (all 4 must be set to run)</p>
</dd><dt>SEQUEL_SPLIT_SYMBOLS 
<dd>
<p>Turn on symbol splitting when running the adapter and integration specs</p>
</dd><dt>SEQUEL_SYNCHRONIZE_SQL 
<dd>
<p>Use the synchronize_sql extension when running the specs</p>
</dd><dt>SEQUEL_TZINFO_VERSION 
<dd>
<p>Force the given tzinfo version when running the specs (e.g. &#39;&gt;=2&#39;)</p>
</dd></dl>

</main>



<footer id="validator-badges" role="contentinfo">
  <p><a href="https://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="https://ruby.github.io/rdoc/">RDoc</a> 6.1.2.1.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

