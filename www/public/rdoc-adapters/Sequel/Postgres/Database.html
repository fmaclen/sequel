<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>class Sequel::Postgres::Database - Sequel: The Database Toolkit for Ruby</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "../../";
  var index_rel_prefix = "../../";
</script>

<script src="../../js/navigation.js" defer></script>
<script src="../../js/search.js" defer></script>
<script src="../../js/search_index.js" defer></script>
<script src="../../js/searcher.js" defer></script>
<script src="../../js/darkfish.js" defer></script>

<link href="../../css/fonts.css" rel="stylesheet">
<link href="../../css/rdoc.css" rel="stylesheet">




<body id="top" role="document" class="class">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../../table_of_contents.html#pages">Pages</a>
    <a href="../../table_of_contents.html#classes">Classes</a>
    <a href="../../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="class-metadata">
    
    <div id="parent-class-section" class="nav-section">
  <h3>Parent</h3>

  
  <p class="link">Sequel::Database
  
</div>

    <div id="includes-section" class="nav-section">
  <h3>Included Modules</h3>

  <ul class="link-list">
  
  
    <li><a class="include" href="DatabaseMethods.html">Sequel::Postgres::DatabaseMethods</a>
  
  
  </ul>
</div>

    
    <!-- Method Quickref -->
<div id="method-list-section" class="nav-section">
  <h3>Methods</h3>

  <ul class="link-list" role="directory">
    
    <li ><a href="#method-i-bound_variable_arg">#bound_variable_arg</a>
    
    <li ><a href="#method-i-call_procedure">#call_procedure</a>
    
    <li ><a href="#method-i-connect">#connect</a>
    
    <li ><a href="#method-i-convert_infinite_timestamps">#convert_infinite_timestamps</a>
    
    <li ><a href="#method-i-convert_infinite_timestamps-3D">#convert_infinite_timestamps=</a>
    
    <li ><a href="#method-i-copy_into">#copy_into</a>
    
    <li ><a href="#method-i-copy_table">#copy_table</a>
    
    <li ><a href="#method-i-disconnect_connection">#disconnect_connection</a>
    
    <li ><a href="#method-i-error_info">#error_info</a>
    
    <li ><a href="#method-i-execute">#execute</a>
    
    <li ><a href="#method-i-listen">#listen</a>
    
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-labelledby="class-Sequel::Postgres::Database">
  <h1 id="class-Sequel::Postgres::Database" class="class">
    class Sequel::Postgres::Database
  </h1>

  <section class="description">
    
  </section>

  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    
    <section class="constants-list">
      <header>
        <h3>Constants</h3>
      </header>
      <dl>
      
        <dt id="DATABASE_ERROR_CLASSES">DATABASE_ERROR_CLASSES
        
        <dd>
        
      
      </dl>
    </section>
    

    

    
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Instance Methods</h3>
       </header>

    
      <div id="method-i-bound_variable_arg" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bound_variable_arg</span><span
            class="method-args">(arg, conn)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Convert given argument so that it can be used directly by pg.  Currently, pg doesn&#39;t handle fractional seconds in Time/DateTime or blobs with “0”. Only public for use by the adapter, shouldn&#39;t be used by external code.</p>
          
          

          
          <div class="method-source-code" id="bound_variable_arg-source">
            <pre>    <span class="ruby-comment"># File lib/sequel/adapters/postgres.rb</span>
<span class="line-num">167</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">bound_variable_arg</span>(<span class="ruby-identifier">arg</span>, <span class="ruby-identifier">conn</span>)
<span class="line-num">168</span>   <span class="ruby-keyword">case</span> <span class="ruby-identifier">arg</span>
<span class="line-num">169</span>   <span class="ruby-keyword">when</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">SQL</span><span class="ruby-operator">::</span><span class="ruby-constant">Blob</span>
<span class="line-num">170</span>     {<span class="ruby-value">:value</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">arg</span>, <span class="ruby-value">:type</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">17</span>, <span class="ruby-value">:format</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">1</span>}
<span class="line-num">171</span>   <span class="ruby-keyword">when</span> <span class="ruby-constant">DateTime</span>, <span class="ruby-constant">Time</span>
<span class="line-num">172</span>     <span class="ruby-identifier">literal</span>(<span class="ruby-identifier">arg</span>)
<span class="line-num">173</span>   <span class="ruby-keyword">else</span>
<span class="line-num">174</span>     <span class="ruby-identifier">arg</span>
<span class="line-num">175</span>   <span class="ruby-keyword">end</span>
<span class="line-num">176</span> <span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-call_procedure" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">call_procedure</span><span
            class="method-args">(name, *args)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Call a procedure with the given name and arguments.  Returns a hash if the procedure returns a value, and nil otherwise.  Example:</p>

<pre class="ruby"><span class="ruby-constant">DB</span>.<span class="ruby-identifier">call_procedure</span>(<span class="ruby-value">:foo</span>, <span class="ruby-value">1</span>, <span class="ruby-value">2</span>)
<span class="ruby-comment"># CALL foo(1, 2)</span>
</pre>
          
          

          
          <div class="method-source-code" id="call_procedure-source">
            <pre>    <span class="ruby-comment"># File lib/sequel/adapters/postgres.rb</span>
<span class="line-num">183</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">call_procedure</span>(<span class="ruby-identifier">name</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">args</span>)
<span class="line-num">184</span>   <span class="ruby-identifier">dataset</span>.<span class="ruby-identifier">send</span>(<span class="ruby-value">:call_procedure</span>, <span class="ruby-identifier">name</span>, <span class="ruby-identifier">args</span>)
<span class="line-num">185</span> <span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-connect" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">connect</span><span
            class="method-args">(server)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Connects to the database.  In addition to the standard database options, using the :encoding or :charset option changes the client encoding for the connection, :connect_timeout is a connection timeout in seconds, :sslmode sets whether postgres&#39;s sslmode, and :notice_receiver handles server notices in a proc. :connect_timeout, :driver_options, :sslmode, and :notice_receiver are only supported if the pg driver is used.</p>
          
          

          
          <div class="method-source-code" id="connect-source">
            <pre>    <span class="ruby-comment"># File lib/sequel/adapters/postgres.rb</span>
<span class="line-num">194</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">connect</span>(<span class="ruby-identifier">server</span>)
<span class="line-num">195</span>   <span class="ruby-identifier">opts</span> = <span class="ruby-identifier">server_opts</span>(<span class="ruby-identifier">server</span>)
<span class="line-num">196</span>   <span class="ruby-keyword">if</span> <span class="ruby-constant">USES_PG</span>
<span class="line-num">197</span>     <span class="ruby-identifier">connection_params</span> = {
<span class="line-num">198</span>       <span class="ruby-value">:host</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">opts</span>[<span class="ruby-value">:host</span>],
<span class="line-num">199</span>       <span class="ruby-value">:port</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">opts</span>[<span class="ruby-value">:port</span>],
<span class="line-num">200</span>       <span class="ruby-value">:dbname</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">opts</span>[<span class="ruby-value">:database</span>],
<span class="line-num">201</span>       <span class="ruby-value">:user</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">opts</span>[<span class="ruby-value">:user</span>],
<span class="line-num">202</span>       <span class="ruby-value">:password</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">opts</span>[<span class="ruby-value">:password</span>],
<span class="line-num">203</span>       <span class="ruby-value">:connect_timeout</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">opts</span>[<span class="ruby-value">:connect_timeout</span>] <span class="ruby-operator">||</span> <span class="ruby-value">20</span>,
<span class="line-num">204</span>       <span class="ruby-value">:sslmode</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">opts</span>[<span class="ruby-value">:sslmode</span>],
<span class="line-num">205</span>       <span class="ruby-value">:sslrootcert</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">opts</span>[<span class="ruby-value">:sslrootcert</span>]
<span class="line-num">206</span>     }.<span class="ruby-identifier">delete_if</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">key</span>, <span class="ruby-identifier">value</span><span class="ruby-operator">|</span> <span class="ruby-identifier">blank_object?</span>(<span class="ruby-identifier">value</span>) }
<span class="line-num">207</span>     <span class="ruby-identifier">connection_params</span>.<span class="ruby-identifier">merge!</span>(<span class="ruby-identifier">opts</span>[<span class="ruby-value">:driver_options</span>]) <span class="ruby-keyword">if</span> <span class="ruby-identifier">opts</span>[<span class="ruby-value">:driver_options</span>]
<span class="line-num">208</span>     <span class="ruby-identifier">conn</span> = <span class="ruby-constant">Adapter</span>.<span class="ruby-identifier">connect</span>(<span class="ruby-identifier">opts</span>[<span class="ruby-value">:conn_str</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">connection_params</span>)
<span class="line-num">209</span> 
<span class="line-num">210</span>     <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">instance_variable_set</span>(<span class="ruby-value">:@prepared_statements</span>, {})
<span class="line-num">211</span> 
<span class="line-num">212</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">receiver</span> = <span class="ruby-identifier">opts</span>[<span class="ruby-value">:notice_receiver</span>]
<span class="line-num">213</span>       <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">set_notice_receiver</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">receiver</span>)
<span class="line-num">214</span>     <span class="ruby-keyword">end</span>
<span class="line-num">215</span>   <span class="ruby-keyword">else</span>
<span class="line-num">216</span>     <span class="ruby-keyword">unless</span> <span class="ruby-identifier">typecast_value_boolean</span>(<span class="ruby-ivar">@opts</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-value">:force_standard_strings</span>, <span class="ruby-keyword">true</span>))
<span class="line-num">217</span>       <span class="ruby-identifier">raise</span> <span class="ruby-constant">Error</span>, <span class="ruby-string">&quot;Cannot create connection using postgres-pr unless force_standard_strings is set&quot;</span>
<span class="line-num">218</span>     <span class="ruby-keyword">end</span>
<span class="line-num">219</span> 
<span class="line-num">220</span>     <span class="ruby-identifier">conn</span> = <span class="ruby-constant">Adapter</span>.<span class="ruby-identifier">connect</span>(
<span class="line-num">221</span>       (<span class="ruby-identifier">opts</span>[<span class="ruby-value">:host</span>] <span class="ruby-keyword">unless</span> <span class="ruby-identifier">blank_object?</span>(<span class="ruby-identifier">opts</span>[<span class="ruby-value">:host</span>])),
<span class="line-num">222</span>       <span class="ruby-identifier">opts</span>[<span class="ruby-value">:port</span>] <span class="ruby-operator">||</span> <span class="ruby-value">5432</span>,
<span class="line-num">223</span>       <span class="ruby-keyword">nil</span>, <span class="ruby-string">&#39;&#39;</span>,
<span class="line-num">224</span>       <span class="ruby-identifier">opts</span>[<span class="ruby-value">:database</span>],
<span class="line-num">225</span>       <span class="ruby-identifier">opts</span>[<span class="ruby-value">:user</span>],
<span class="line-num">226</span>       <span class="ruby-identifier">opts</span>[<span class="ruby-value">:password</span>]
<span class="line-num">227</span>     )
<span class="line-num">228</span>   <span class="ruby-keyword">end</span>
<span class="line-num">229</span> 
<span class="line-num">230</span>   <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">instance_variable_set</span>(<span class="ruby-value">:@db</span>, <span class="ruby-keyword">self</span>)
<span class="line-num">231</span>   <span class="ruby-keyword">if</span> <span class="ruby-constant">USES_PG</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:type_map_for_queries=</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-keyword">defined?</span>(<span class="ruby-constant">PG_QUERY_TYPE_MAP</span>)
<span class="line-num">232</span>     <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">type_map_for_queries</span> = <span class="ruby-constant">PG_QUERY_TYPE_MAP</span>
<span class="line-num">233</span>   <span class="ruby-keyword">end</span>
<span class="line-num">234</span> 
<span class="line-num">235</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">encoding</span> = <span class="ruby-identifier">opts</span>[<span class="ruby-value">:encoding</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">opts</span>[<span class="ruby-value">:charset</span>]
<span class="line-num">236</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:set_client_encoding</span>)
<span class="line-num">237</span>       <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">set_client_encoding</span>(<span class="ruby-identifier">encoding</span>)
<span class="line-num">238</span>     <span class="ruby-keyword">else</span>
<span class="line-num">239</span>       <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">async_exec</span>(<span class="ruby-node">&quot;set client_encoding to &#39;#{encoding}&#39;&quot;</span>)
<span class="line-num">240</span>     <span class="ruby-keyword">end</span>
<span class="line-num">241</span>   <span class="ruby-keyword">end</span>
<span class="line-num">242</span> 
<span class="line-num">243</span>   <span class="ruby-identifier">connection_configuration_sqls</span>(<span class="ruby-identifier">opts</span>).<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">sql</span><span class="ruby-operator">|</span> <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-identifier">sql</span>)}
<span class="line-num">244</span>   <span class="ruby-identifier">conn</span>
<span class="line-num">245</span> <span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-convert_infinite_timestamps" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">convert_infinite_timestamps</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Always false, support was moved to pg_extended_date_support extension. Needs to stay defined here so that sequel_pg works.</p>
          
          

          
          <div class="method-source-code" id="convert_infinite_timestamps-source">
            <pre>    <span class="ruby-comment"># File lib/sequel/adapters/postgres.rb</span>
<span class="line-num">249</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">convert_infinite_timestamps</span>
<span class="line-num">250</span>   <span class="ruby-keyword">false</span>
<span class="line-num">251</span> <span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-convert_infinite_timestamps-3D" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">convert_infinite_timestamps=</span><span
            class="method-args">(v)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Enable pg_extended_date_support extension if symbol or string is given.</p>
          
          

          
          <div class="method-source-code" id="convert_infinite_timestamps-3D-source">
            <pre>    <span class="ruby-comment"># File lib/sequel/adapters/postgres.rb</span>
<span class="line-num">254</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">convert_infinite_timestamps=</span>(<span class="ruby-identifier">v</span>)
<span class="line-num">255</span>   <span class="ruby-keyword">case</span> <span class="ruby-identifier">v</span>
<span class="line-num">256</span>   <span class="ruby-keyword">when</span> <span class="ruby-constant">Symbol</span>, <span class="ruby-constant">String</span>, <span class="ruby-keyword">true</span>
<span class="line-num">257</span>     <span class="ruby-identifier">extension</span>(<span class="ruby-value">:pg_extended_date_support</span>)
<span class="line-num">258</span>     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">convert_infinite_timestamps</span> = <span class="ruby-identifier">v</span>
<span class="line-num">259</span>   <span class="ruby-keyword">end</span>
<span class="line-num">260</span> <span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-copy_into" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">copy_into</span><span
            class="method-args">(table, opts=OPTS) { || ... }</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p><code>copy_into</code> uses PostgreSQL&#39;s +COPY FROM STDIN+ SQL statement to do very fast inserts  into a table using input preformatting in either CSV or PostgreSQL text format. This method is only supported if pg 0.14.0+ is the underlying ruby driver. This method should only be called if you want results returned to the client.  If you are using +COPY FROM+ with a filename, you should just use <code>run</code> instead of this method.</p>

<p>The following options are respected:</p>
<dl class="rdoc-list note-list"><dt>:columns 
<dd>
<p>The columns to insert into, with the same order as the columns in the input data.  If this isn&#39;t given, uses all columns in the table.</p>
</dd><dt>:data 
<dd>
<p>The data to copy to PostgreSQL, which should already be in CSV or PostgreSQL text format.  This can be either a string, or any object that responds to each and yields string.</p>
</dd><dt>:format 
<dd>
<p>The format to use.  text is the default, so this should be :csv or :binary.</p>
</dd><dt>:options 
<dd>
<p>An options SQL string to use, which should contain comma separated options.</p>
</dd><dt>:server 
<dd>
<p>The server on which to run the query.</p>
</dd></dl>

<p>If a block is provided and :data option is not, this will yield to the block repeatedly. The block should return a string, or nil to signal that it is finished.</p>
          
          

          
          <div class="method-source-code" id="copy_into-source">
            <pre>    <span class="ruby-comment"># File lib/sequel/adapters/postgres.rb</span>
<span class="line-num">397</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">copy_into</span>(<span class="ruby-identifier">table</span>, <span class="ruby-identifier">opts</span>=<span class="ruby-constant">OPTS</span>)
<span class="line-num">398</span>   <span class="ruby-identifier">data</span> = <span class="ruby-identifier">opts</span>[<span class="ruby-value">:data</span>]
<span class="line-num">399</span>   <span class="ruby-identifier">data</span> = <span class="ruby-constant">Array</span>(<span class="ruby-identifier">data</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">String</span>)
<span class="line-num">400</span> 
<span class="line-num">401</span>   <span class="ruby-keyword">if</span> <span class="ruby-keyword">defined?</span>(<span class="ruby-keyword">yield</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">data</span>
<span class="line-num">402</span>     <span class="ruby-identifier">raise</span> <span class="ruby-constant">Error</span>, <span class="ruby-string">&quot;Cannot provide both a :data option and a block to copy_into&quot;</span>
<span class="line-num">403</span>   <span class="ruby-keyword">elsif</span> <span class="ruby-operator">!</span><span class="ruby-keyword">defined?</span>(<span class="ruby-keyword">yield</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">data</span>
<span class="line-num">404</span>     <span class="ruby-identifier">raise</span> <span class="ruby-constant">Error</span>, <span class="ruby-string">&quot;Must provide either a :data option or a block to copy_into&quot;</span>
<span class="line-num">405</span>   <span class="ruby-keyword">end</span>
<span class="line-num">406</span> 
<span class="line-num">407</span>   <span class="ruby-identifier">synchronize</span>(<span class="ruby-identifier">opts</span>[<span class="ruby-value">:server</span>]) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">conn</span><span class="ruby-operator">|</span>
<span class="line-num">408</span>     <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-identifier">copy_into_sql</span>(<span class="ruby-identifier">table</span>, <span class="ruby-identifier">opts</span>))
<span class="line-num">409</span>     <span class="ruby-keyword">begin</span>
<span class="line-num">410</span>       <span class="ruby-keyword">if</span> <span class="ruby-keyword">defined?</span>(<span class="ruby-keyword">yield</span>)
<span class="line-num">411</span>         <span class="ruby-keyword">while</span> <span class="ruby-identifier">buf</span> = <span class="ruby-keyword">yield</span>
<span class="line-num">412</span>           <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">put_copy_data</span>(<span class="ruby-identifier">buf</span>)
<span class="line-num">413</span>         <span class="ruby-keyword">end</span>
<span class="line-num">414</span>       <span class="ruby-keyword">else</span>
<span class="line-num">415</span>         <span class="ruby-identifier">data</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">buff</span><span class="ruby-operator">|</span> <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">put_copy_data</span>(<span class="ruby-identifier">buff</span>)}
<span class="line-num">416</span>       <span class="ruby-keyword">end</span>
<span class="line-num">417</span>     <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Exception</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
<span class="line-num">418</span>       <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">put_copy_end</span>(<span class="ruby-string">&quot;ruby exception occurred while copying data into PostgreSQL&quot;</span>)
<span class="line-num">419</span>     <span class="ruby-keyword">ensure</span>
<span class="line-num">420</span>       <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">put_copy_end</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">e</span>
<span class="line-num">421</span>       <span class="ruby-keyword">while</span> <span class="ruby-identifier">res</span> = <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">get_result</span>
<span class="line-num">422</span>         <span class="ruby-identifier">raise</span> <span class="ruby-identifier">e</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">e</span>
<span class="line-num">423</span>         <span class="ruby-identifier">check_database_errors</span>{<span class="ruby-identifier">res</span>.<span class="ruby-identifier">check</span>}
<span class="line-num">424</span>       <span class="ruby-keyword">end</span>
<span class="line-num">425</span>     <span class="ruby-keyword">end</span>
<span class="line-num">426</span>   <span class="ruby-keyword">end</span> 
<span class="line-num">427</span> <span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-copy_table" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">copy_table</span><span
            class="method-args">(table, opts=OPTS) { || ... }</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p><code>copy_table</code> uses PostgreSQL&#39;s +COPY TO STDOUT+ SQL statement to return formatted results directly to the caller.  This method is only supported if pg is the underlying ruby driver.  This method should only be called if you want results returned to the client.  If you are using +COPY TO+ with a filename, you should just use <code>run</code> instead of this method.</p>

<p>The table argument supports the following types:</p>
<dl class="rdoc-list note-list"><dt>String 
<dd>
<p>Uses the first argument directly as literal SQL. If you are using a version of PostgreSQL before 9.0, you will probably want to use a string if you are using any options at all, as the syntax <a href="../../Sequel.html"><code>Sequel</code></a> uses for options is only compatible with PostgreSQL 9.0+. This should be the full COPY statement passed to PostgreSQL, not just the SELECT query.  If a string is given, the :format and :options options are ignored.</p>
</dd><dt><a href="Dataset.html"><code>Dataset</code></a> 
<dd>
<p>Uses a query instead of a table name when copying.</p>
</dd><dt>other 
<dd>
<p>Uses a table name (usually a symbol) when copying.</p>
</dd></dl>

<p>The following options are respected:</p>
<dl class="rdoc-list note-list"><dt>:format 
<dd>
<p>The format to use.  text is the default, so this should be :csv or :binary.</p>
</dd><dt>:options 
<dd>
<p>An options SQL string to use, which should contain comma separated options.</p>
</dd><dt>:server 
<dd>
<p>The server on which to run the query.</p>
</dd></dl>

<p>If a block is provided, the method continually yields to the block, one yield per row.  If a block is not provided, a single string is returned with all of the data.</p>
          
          

          
          <div class="method-source-code" id="copy_table-source">
            <pre>    <span class="ruby-comment"># File lib/sequel/adapters/postgres.rb</span>
<span class="line-num">347</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">copy_table</span>(<span class="ruby-identifier">table</span>, <span class="ruby-identifier">opts</span>=<span class="ruby-constant">OPTS</span>)
<span class="line-num">348</span>   <span class="ruby-identifier">synchronize</span>(<span class="ruby-identifier">opts</span>[<span class="ruby-value">:server</span>]) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">conn</span><span class="ruby-operator">|</span>
<span class="line-num">349</span>     <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-identifier">copy_table_sql</span>(<span class="ruby-identifier">table</span>, <span class="ruby-identifier">opts</span>))
<span class="line-num">350</span>     <span class="ruby-keyword">begin</span>
<span class="line-num">351</span>       <span class="ruby-keyword">if</span> <span class="ruby-keyword">defined?</span>(<span class="ruby-keyword">yield</span>)
<span class="line-num">352</span>         <span class="ruby-keyword">while</span> <span class="ruby-identifier">buf</span> = <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">get_copy_data</span>
<span class="line-num">353</span>           <span class="ruby-keyword">yield</span> <span class="ruby-identifier">buf</span>
<span class="line-num">354</span>         <span class="ruby-keyword">end</span>
<span class="line-num">355</span>         <span class="ruby-identifier">b</span> = <span class="ruby-keyword">nil</span>
<span class="line-num">356</span>       <span class="ruby-keyword">else</span>
<span class="line-num">357</span>         <span class="ruby-identifier">b</span> = <span class="ruby-constant">String</span>.<span class="ruby-identifier">new</span>
<span class="line-num">358</span>         <span class="ruby-identifier">b</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">buf</span> <span class="ruby-keyword">while</span> <span class="ruby-identifier">buf</span> = <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">get_copy_data</span>
<span class="line-num">359</span>       <span class="ruby-keyword">end</span>
<span class="line-num">360</span> 
<span class="line-num">361</span>       <span class="ruby-identifier">res</span> = <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">get_last_result</span>
<span class="line-num">362</span>       <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">res</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">res</span>.<span class="ruby-identifier">result_status</span> <span class="ruby-operator">!=</span> <span class="ruby-value">1</span>
<span class="line-num">363</span>         <span class="ruby-identifier">raise</span> <span class="ruby-constant">PG</span><span class="ruby-operator">::</span><span class="ruby-constant">NotAllCopyDataRetrieved</span>, <span class="ruby-string">&quot;Not all COPY data retrieved&quot;</span>
<span class="line-num">364</span>       <span class="ruby-keyword">end</span>
<span class="line-num">365</span> 
<span class="line-num">366</span>       <span class="ruby-identifier">b</span>
<span class="line-num">367</span>     <span class="ruby-keyword">rescue</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
<span class="line-num">368</span>       <span class="ruby-identifier">raise_error</span>(<span class="ruby-identifier">e</span>, <span class="ruby-value">:disconnect</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">true</span>)
<span class="line-num">369</span>     <span class="ruby-keyword">ensure</span>
<span class="line-num">370</span>       <span class="ruby-keyword">if</span> <span class="ruby-identifier">buf</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">e</span>
<span class="line-num">371</span>         <span class="ruby-identifier">raise</span> <span class="ruby-constant">DatabaseDisconnectError</span>, <span class="ruby-string">&quot;disconnecting as a partial COPY may leave the connection in an unusable state&quot;</span>
<span class="line-num">372</span>       <span class="ruby-keyword">end</span>
<span class="line-num">373</span>     <span class="ruby-keyword">end</span>
<span class="line-num">374</span>   <span class="ruby-keyword">end</span> 
<span class="line-num">375</span> <span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-disconnect_connection" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">disconnect_connection</span><span
            class="method-args">(conn)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="disconnect_connection-source">
            <pre>    <span class="ruby-comment"># File lib/sequel/adapters/postgres.rb</span>
<span class="line-num">262</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">disconnect_connection</span>(<span class="ruby-identifier">conn</span>)
<span class="line-num">263</span>   <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">finish</span>
<span class="line-num">264</span> <span class="ruby-keyword">rescue</span> <span class="ruby-constant">PGError</span>, <span class="ruby-constant">IOError</span>
<span class="line-num">265</span>   <span class="ruby-keyword">nil</span>
<span class="line-num">266</span> <span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-error_info" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">error_info</span><span
            class="method-args">(e)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Return a hash of information about the related PGError (or Sequel::DatabaseError that wraps a PGError), with the following entries (any of which may be <code>nil</code>):</p>
<dl class="rdoc-list note-list"><dt>:schema 
<dd>
<p>The schema name related to the error</p>
</dd><dt>:table 
<dd>
<p>The table name related to the error</p>
</dd><dt>:column 
<dd>
<p>the column name related to the error</p>
</dd><dt>:constraint 
<dd>
<p>The constraint name related to the error</p>
</dd><dt>:type 
<dd>
<p>The datatype name related to the error</p>
</dd><dt>:severity 
<dd>
<p>The severity of the error (e.g. “ERROR”)</p>
</dd><dt>:sql_state 
<dd>
<p>The SQL state code related to the error</p>
</dd><dt>:message_primary 
<dd>
<p>A single line message related to the error</p>
</dd><dt>:message_detail 
<dd>
<p>Any detail supplementing the primary message</p>
</dd><dt>:message_hint 
<dd>
<p>Possible suggestion about how to fix the problem</p>
</dd><dt>:statement_position 
<dd>
<p>Character offset in statement submitted by client where error occurred (starting at 1)</p>
</dd><dt>:internal_position 
<dd>
<p>Character offset in internal statement where error occurred (starting at 1)</p>
</dd><dt>:internal_query 
<dd>
<p>Text of internally-generated statement where error occurred</p>
</dd><dt>:source_file 
<dd>
<p>PostgreSQL source file where the error occurred</p>
</dd><dt>:source_line 
<dd>
<p>Line number of PostgreSQL source file where the error occurred</p>
</dd><dt>:source_function 
<dd>
<p>Function in PostgreSQL source file where the error occurred</p>
</dd></dl>

<p>This requires a PostgreSQL 9.3+ server and 9.3+ client library, and ruby-pg 0.16.0+ to be supported.</p>
          
          

          
          <div class="method-source-code" id="error_info-source">
            <pre>    <span class="ruby-comment"># File lib/sequel/adapters/postgres.rb</span>
<span class="line-num">291</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">error_info</span>(<span class="ruby-identifier">e</span>)
<span class="line-num">292</span>   <span class="ruby-identifier">e</span> = <span class="ruby-identifier">e</span>.<span class="ruby-identifier">wrapped_exception</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">DatabaseError</span>)
<span class="line-num">293</span>   <span class="ruby-identifier">r</span> = <span class="ruby-identifier">e</span>.<span class="ruby-identifier">result</span>
<span class="line-num">294</span>   {
<span class="line-num">295</span>     <span class="ruby-value">:schema</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">error_field</span>(<span class="ruby-operator">::</span><span class="ruby-constant">PG</span><span class="ruby-operator">::</span><span class="ruby-constant">PG_DIAG_SCHEMA_NAME</span>),
<span class="line-num">296</span>     <span class="ruby-value">:table</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">error_field</span>(<span class="ruby-operator">::</span><span class="ruby-constant">PG</span><span class="ruby-operator">::</span><span class="ruby-constant">PG_DIAG_TABLE_NAME</span>),
<span class="line-num">297</span>     <span class="ruby-value">:column</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">error_field</span>(<span class="ruby-operator">::</span><span class="ruby-constant">PG</span><span class="ruby-operator">::</span><span class="ruby-constant">PG_DIAG_COLUMN_NAME</span>),
<span class="line-num">298</span>     <span class="ruby-value">:constraint</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">error_field</span>(<span class="ruby-operator">::</span><span class="ruby-constant">PG</span><span class="ruby-operator">::</span><span class="ruby-constant">PG_DIAG_CONSTRAINT_NAME</span>),
<span class="line-num">299</span>     <span class="ruby-value">:type</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">error_field</span>(<span class="ruby-operator">::</span><span class="ruby-constant">PG</span><span class="ruby-operator">::</span><span class="ruby-constant">PG_DIAG_DATATYPE_NAME</span>),
<span class="line-num">300</span>     <span class="ruby-value">:severity</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">error_field</span>(<span class="ruby-operator">::</span><span class="ruby-constant">PG</span><span class="ruby-operator">::</span><span class="ruby-constant">PG_DIAG_SEVERITY</span>),
<span class="line-num">301</span>     <span class="ruby-value">:sql_state</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">error_field</span>(<span class="ruby-operator">::</span><span class="ruby-constant">PG</span><span class="ruby-operator">::</span><span class="ruby-constant">PG_DIAG_SQLSTATE</span>),
<span class="line-num">302</span>     <span class="ruby-value">:message_primary</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">error_field</span>(<span class="ruby-operator">::</span><span class="ruby-constant">PG</span><span class="ruby-operator">::</span><span class="ruby-constant">PG_DIAG_MESSAGE_PRIMARY</span>),
<span class="line-num">303</span>     <span class="ruby-value">:message_detail</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">error_field</span>(<span class="ruby-operator">::</span><span class="ruby-constant">PG</span><span class="ruby-operator">::</span><span class="ruby-constant">PG_DIAG_MESSAGE_DETAIL</span>),
<span class="line-num">304</span>     <span class="ruby-value">:message_hint</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">error_field</span>(<span class="ruby-operator">::</span><span class="ruby-constant">PG</span><span class="ruby-operator">::</span><span class="ruby-constant">PG_DIAG_MESSAGE_HINT</span>),
<span class="line-num">305</span>     <span class="ruby-value">:statement_position</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">error_field</span>(<span class="ruby-operator">::</span><span class="ruby-constant">PG</span><span class="ruby-operator">::</span><span class="ruby-constant">PG_DIAG_STATEMENT_POSITION</span>),
<span class="line-num">306</span>     <span class="ruby-value">:internal_position</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">error_field</span>(<span class="ruby-operator">::</span><span class="ruby-constant">PG</span><span class="ruby-operator">::</span><span class="ruby-constant">PG_DIAG_INTERNAL_POSITION</span>),
<span class="line-num">307</span>     <span class="ruby-value">:internal_query</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">error_field</span>(<span class="ruby-operator">::</span><span class="ruby-constant">PG</span><span class="ruby-operator">::</span><span class="ruby-constant">PG_DIAG_INTERNAL_QUERY</span>),
<span class="line-num">308</span>     <span class="ruby-value">:source_file</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">error_field</span>(<span class="ruby-operator">::</span><span class="ruby-constant">PG</span><span class="ruby-operator">::</span><span class="ruby-constant">PG_DIAG_SOURCE_FILE</span>),
<span class="line-num">309</span>     <span class="ruby-value">:source_line</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">error_field</span>(<span class="ruby-operator">::</span><span class="ruby-constant">PG</span><span class="ruby-operator">::</span><span class="ruby-constant">PG_DIAG_SOURCE_LINE</span>),
<span class="line-num">310</span>     <span class="ruby-value">:source_function</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">error_field</span>(<span class="ruby-operator">::</span><span class="ruby-constant">PG</span><span class="ruby-operator">::</span><span class="ruby-constant">PG_DIAG_SOURCE_FUNCTION</span>)
<span class="line-num">311</span>   }
<span class="line-num">312</span> <span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-execute" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">execute</span><span
            class="method-args">(sql, opts=OPTS, &amp;block)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="execute-source">
            <pre>    <span class="ruby-comment"># File lib/sequel/adapters/postgres.rb</span>
<span class="line-num">315</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">execute</span>(<span class="ruby-identifier">sql</span>, <span class="ruby-identifier">opts</span>=<span class="ruby-constant">OPTS</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
<span class="line-num">316</span>   <span class="ruby-identifier">synchronize</span>(<span class="ruby-identifier">opts</span>[<span class="ruby-value">:server</span>]){<span class="ruby-operator">|</span><span class="ruby-identifier">conn</span><span class="ruby-operator">|</span> <span class="ruby-identifier">check_database_errors</span>{<span class="ruby-identifier">_execute</span>(<span class="ruby-identifier">conn</span>, <span class="ruby-identifier">sql</span>, <span class="ruby-identifier">opts</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)}}
<span class="line-num">317</span> <span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-listen" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">listen</span><span
            class="method-args">(channels, opts=OPTS, &amp;block)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Listens on the given channel (or multiple channels if channel is an array), waiting for notifications. After a notification is received, or the timeout has passed, stops listening to the channel. Options:</p>
<dl class="rdoc-list note-list"><dt>:after_listen 
<dd>
<p>An object that responds to <code>call</code> that is called with the underlying connection after the LISTEN statement is sent, but before the connection starts waiting for notifications.</p>
</dd><dt>:loop 
<dd>
<p>Whether to continually wait for notifications, instead of just waiting for a single notification. If this option is given, a block must be provided.  If this object responds to <code>call</code>, it is called with the underlying connection after each notification is received (after the block is called). If a :timeout option is used, and a callable object is given, the object will also be called if the timeout expires.  If :loop is used and you want to stop listening, you can either break from inside the block given to <a href="Database.html#method-i-listen"><code>listen</code></a>, or you can throw :stop from inside the :loop object&#39;s call method or the block.</p>
</dd><dt>:server 
<dd>
<p>The server on which to listen, if the sharding support is being used.</p>
</dd><dt>:timeout 
<dd>
<p>How long to wait for a notification, in seconds (can provide a float value for fractional seconds). If this object responds to <code>call</code>, it will be called and should return the number of seconds to wait. If the loop option is also specified, the object will be called on each iteration to obtain a new timeout value.  If not given or nil, waits indefinitely.</p>
</dd></dl>

<p>This method is only supported if pg is used as the underlying ruby driver.  It returns the channel the notification was sent to (as a string), unless :loop was used, in which case it returns nil. If a block is given, it is yielded 3 arguments:</p>
<ul><li>
<p>the channel the notification was sent to (as a string)</p>
</li><li>
<p>the backend pid of the notifier (as an integer),</p>
</li><li>
<p>and the payload of the notification (as a string or nil).</p>
</li></ul>
          
          

          
          <div class="method-source-code" id="listen-source">
            <pre>    <span class="ruby-comment"># File lib/sequel/adapters/postgres.rb</span>
<span class="line-num">452</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">listen</span>(<span class="ruby-identifier">channels</span>, <span class="ruby-identifier">opts</span>=<span class="ruby-constant">OPTS</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
<span class="line-num">453</span>   <span class="ruby-identifier">check_database_errors</span> <span class="ruby-keyword">do</span>
<span class="line-num">454</span>     <span class="ruby-identifier">synchronize</span>(<span class="ruby-identifier">opts</span>[<span class="ruby-value">:server</span>]) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">conn</span><span class="ruby-operator">|</span>
<span class="line-num">455</span>       <span class="ruby-keyword">begin</span>
<span class="line-num">456</span>         <span class="ruby-identifier">channels</span> = <span class="ruby-constant">Array</span>(<span class="ruby-identifier">channels</span>)
<span class="line-num">457</span>         <span class="ruby-identifier">channels</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">channel</span><span class="ruby-operator">|</span>
<span class="line-num">458</span>           <span class="ruby-identifier">sql</span> = <span class="ruby-string">&quot;LISTEN &quot;</span>.<span class="ruby-identifier">dup</span>
<span class="line-num">459</span>           <span class="ruby-identifier">dataset</span>.<span class="ruby-identifier">send</span>(<span class="ruby-value">:identifier_append</span>, <span class="ruby-identifier">sql</span>, <span class="ruby-identifier">channel</span>)
<span class="line-num">460</span>           <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-identifier">sql</span>)
<span class="line-num">461</span>         <span class="ruby-keyword">end</span>
<span class="line-num">462</span>         <span class="ruby-identifier">opts</span>[<span class="ruby-value">:after_listen</span>].<span class="ruby-identifier">call</span>(<span class="ruby-identifier">conn</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">opts</span>[<span class="ruby-value">:after_listen</span>]
<span class="line-num">463</span>         <span class="ruby-identifier">timeout</span> = <span class="ruby-identifier">opts</span>[<span class="ruby-value">:timeout</span>]
<span class="line-num">464</span>         <span class="ruby-keyword">if</span> <span class="ruby-identifier">timeout</span>
<span class="line-num">465</span>           <span class="ruby-identifier">timeout_block</span> = <span class="ruby-identifier">timeout</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:call</span>) <span class="ruby-operator">?</span> <span class="ruby-identifier">timeout</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">proc</span>{<span class="ruby-identifier">timeout</span>}
<span class="line-num">466</span>         <span class="ruby-keyword">end</span>
<span class="line-num">467</span> 
<span class="line-num">468</span>         <span class="ruby-keyword">if</span> <span class="ruby-identifier">l</span> = <span class="ruby-identifier">opts</span>[<span class="ruby-value">:loop</span>]
<span class="line-num">469</span>           <span class="ruby-identifier">raise</span> <span class="ruby-constant">Error</span>, <span class="ruby-string">&#39;calling #listen with :loop requires a block&#39;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">block</span>
<span class="line-num">470</span>           <span class="ruby-identifier">loop_call</span> = <span class="ruby-identifier">l</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:call</span>)
<span class="line-num">471</span>           <span class="ruby-identifier">catch</span>(<span class="ruby-value">:stop</span>) <span class="ruby-keyword">do</span>
<span class="line-num">472</span>             <span class="ruby-keyword">while</span> <span class="ruby-keyword">true</span>
<span class="line-num">473</span>               <span class="ruby-identifier">t</span> = <span class="ruby-identifier">timeout_block</span> <span class="ruby-operator">?</span> [<span class="ruby-identifier">timeout_block</span>.<span class="ruby-identifier">call</span>] <span class="ruby-operator">:</span> []
<span class="line-num">474</span>               <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">wait_for_notify</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">t</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
<span class="line-num">475</span>               <span class="ruby-identifier">l</span>.<span class="ruby-identifier">call</span>(<span class="ruby-identifier">conn</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">loop_call</span>
<span class="line-num">476</span>             <span class="ruby-keyword">end</span>
<span class="line-num">477</span>           <span class="ruby-keyword">end</span>
<span class="line-num">478</span>           <span class="ruby-keyword">nil</span>
<span class="line-num">479</span>         <span class="ruby-keyword">else</span>
<span class="line-num">480</span>           <span class="ruby-identifier">t</span> = <span class="ruby-identifier">timeout_block</span> <span class="ruby-operator">?</span> [<span class="ruby-identifier">timeout_block</span>.<span class="ruby-identifier">call</span>] <span class="ruby-operator">:</span> []
<span class="line-num">481</span>           <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">wait_for_notify</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">t</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
<span class="line-num">482</span>         <span class="ruby-keyword">end</span>
<span class="line-num">483</span>       <span class="ruby-keyword">ensure</span>
<span class="line-num">484</span>         <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-string">&quot;UNLISTEN *&quot;</span>)
<span class="line-num">485</span>       <span class="ruby-keyword">end</span>
<span class="line-num">486</span>     <span class="ruby-keyword">end</span>
<span class="line-num">487</span>   <span class="ruby-keyword">end</span>
<span class="line-num">488</span> <span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
  </section>

</main>


<footer id="validator-badges" role="contentinfo">
  <p><a href="https://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="https://ruby.github.io/rdoc/">RDoc</a> 6.1.2.1.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

